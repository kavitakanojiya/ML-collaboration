<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
<meta charset="utf-8"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="https://machinelearningmastery.com/xmlrpc.php" rel="pingback"/>
<!--  Mobile viewport scale -->
<meta content="initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" name="viewport"/>
<!-- This site is optimized with the Yoast SEO plugin v9.2.1 - https://yoast.com/wordpress/plugins/seo/ -->
<title>How to Develop LSTM Models for Multi-Step Time Series Forecasting of Household Power Consumption</title>
<link href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/" rel="canonical"/>
<link href="https://plus.google.com/u/0/b/117073416089354242117/+MachinelearningmasteryHome/" rel="publisher"/>
<meta content="en_US" property="og:locale"/>
<meta content="article" property="og:type"/>
<meta content="How to Develop LSTM Models for Multi-Step Time Series Forecasting of Household Power Consumption" property="og:title"/>
<meta content="Given the rise of smart electricity meters and the wide adoption of electricity generation technology like solar panels, there is a wealth of electricity usage data available. This data represents a multivariate time series of power-related variables that in turn could be used to model and even forecast future electricity consumption. Unlike other machine learning …" property="og:description"/>
<meta content="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/" property="og:url"/>
<meta content="Machine Learning Mastery" property="og:site_name"/>
<meta content="https://www.facebook.com/Machine-Learning-Mastery-1429846323896563/" property="article:publisher"/>
<meta content="https://www.facebook.com/jason.brownlee.39" property="article:author"/>
<meta content="Deep Learning for Time Series" property="article:section"/>
<meta content="2018-10-09T18:00:36+00:00" property="article:published_time"/>
<meta content="2018-08-30T00:33:55+00:00" property="article:modified_time"/>
<meta content="2018-08-30T00:33:55+00:00" property="og:updated_time"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/10/How-to-Develop-LSTM-Models-for-Multi-Step-Time-Series-Forecasting-of-Household-Power-Consumption.jpg" property="og:image"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/10/How-to-Develop-LSTM-Models-for-Multi-Step-Time-Series-Forecasting-of-Household-Power-Consumption.jpg" property="og:image:secure_url"/>
<meta content="640" property="og:image:width"/>
<meta content="425" property="og:image:height"/>
<meta content="How to Develop LSTM Models for Multi-Step Time Series Forecasting of Household Power Consumption" property="og:image:alt"/>
<script type="application/ld+json">{"@context":"https:\/\/schema.org","@type":"Organization","url":"https:\/\/machinelearningmastery.com\/","sameAs":["https:\/\/www.facebook.com\/Machine-Learning-Mastery-1429846323896563\/","https:\/\/www.linkedin.com\/in\/jasonbrownlee","https:\/\/plus.google.com\/u\/0\/b\/117073416089354242117\/+MachinelearningmasteryHome\/","https:\/\/twitter.com\/TeachTheMachine"],"@id":"https:\/\/machinelearningmastery.com\/#organization","name":"Machine Learning Mastery","logo":"https:\/\/machinelearningmastery.com\/wp-content\/uploads\/2016\/09\/cropped-icon.png"}</script>
<!-- / Yoast SEO plugin. -->
<link href="//s.w.org" rel="dns-prefetch"/>
<link href="https://feeds.feedburner.com/MachineLearningMastery" rel="alternate" title="Machine Learning Mastery » Feed" type="application/rss+xml"/>
<link href="https://machinelearningmastery.com/comments/feed/" rel="alternate" title="Machine Learning Mastery » Comments Feed" type="application/rss+xml"/>
<link href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/feed/" rel="alternate" title="Machine Learning Mastery » How to Develop LSTM Models for Multi-Step Time Series Forecasting of Household Power Consumption Comments Feed" type="application/rss+xml"/>
<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/machinelearningmastery.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.9.8"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56760,9792,65039],[55358,56760,8203,9792,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<style media="all" type="text/css">
.wpautoterms-footer{background-color:#ffffff;text-align:center;}
.wpautoterms-footer a{color:#000000;font-family:Arial, sans-serif;font-size:14px;}
.wpautoterms-footer .separator{color:#cccccc;font-family:Arial, sans-serif;font-size:14px;}</style>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta" id="crayon-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta" id="crayon-theme-classic-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta" id="crayon-font-monaco-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/auto-terms-of-service-and-privacy-policy/css/wpautoterms.css?ver=4.9.8" id="wpautoterms_css-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/contact-form-7/includes/css/styles.css?ver=5.0.5" id="contact-form-7-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/simple-social-buttons/assets/css/front.css?ver=2.0.20" id="ssb-front-css-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/ultimate-faqs/css/ewd-ufaq-styles.css?ver=4.9.8" id="ewd-ufaq-style-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/ultimate-faqs/css/rrssb-min.css?ver=4.9.8" id="ewd-ufaq-rrssb-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/integrations/testimonials/css/testimonials.css?ver=4.9.8" id="woo-testimonials-css-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/style.css?ver=5.9.21" id="theme-stylesheet-css" media="all" rel="stylesheet" type="text/css"/>
<!--[if lt IE 9]>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/css/non-responsive.css" rel="stylesheet" type="text/css" />
<style type="text/css">.col-full, #wrapper { width: 960px; max-width: 960px; } #inner-wrapper { padding: 0; } body.full-width #header, #nav-container, body.full-width #content, body.full-width #footer-widgets, body.full-width #footer { padding-left: 0; padding-right: 0; } body.fixed-mobile #top, body.fixed-mobile #header-container, body.fixed-mobile #footer-container, body.fixed-mobile #nav-container, body.fixed-mobile #footer-widgets-container { min-width: 960px; padding: 0 1em; } body.full-width #content { width: auto; padding: 0 1em;}</style>
<![endif]-->
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery.js?ver=1.12.4" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/machinelearningmastery.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/simple-social-buttons/assets/js/front.js?ver=2.0.20" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/third-party.min.js?ver=4.9.8" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/modernizr.min.js?ver=2.6.2" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/general.min.js?ver=4.9.8" type="text/javascript"></script>
<link href="https://machinelearningmastery.com/wp-json/" rel="https://api.w.org/"/>
<link href="https://machinelearningmastery.com/xmlrpc.php?rsd" rel="EditURI" title="RSD" type="application/rsd+xml"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/wlwmanifest.xml" rel="wlwmanifest" type="application/wlwmanifest+xml"/>
<link href="https://machinelearningmastery.com/?p=6286" rel="shortlink"/>
<link href="https://machinelearningmastery.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmachinelearningmastery.com%2Fhow-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption%2F" rel="alternate" type="application/json+oembed"/>
<link href="https://machinelearningmastery.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmachinelearningmastery.com%2Fhow-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption%2F&amp;format=xml" rel="alternate" type="text/xml+oembed"/>
<!-- Start Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44039733-3', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->
<style media="screen">

        .simplesocialbuttons.simplesocialbuttons_inline .ssb-fb-like {
      margin: ;
    }
         /*inline margin*/
    
  
  
  
  
  
          .simplesocialbuttons.simplesocialbuttons_inline.simplesocial-simple-icons button{
         margin: ;
     }

          /*margin-digbar*/

  
  
  
  
 
   
   

</style>
<script type="text/javascript">
        var ajaxurl = 'https://machinelearningmastery.com/wp-admin/admin-ajax.php';
    </script>
<!-- Custom CSS Styling -->
<style type="text/css">
#logo .site-title, #logo .site-description { display:none; }
body {background-repeat:no-repeat;background-position:top left;background-attachment:scroll;border-top:0px solid #000000;}
#header {background-repeat:no-repeat;background-position:left top;margin-top:0px;margin-bottom:0px;padding-top:10px;padding-bottom:10px;border:0px solid ;}
#logo .site-title a {font:bold 40px/1em "Helvetica Neue", Helvetica, sans-serif;color:#222222;}
#logo .site-description {font:normal 13px/1em "Helvetica Neue", Helvetica, sans-serif;color:#999999;}
body, p { font:normal 14px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#555555; }
h1 { font:bold 28px/1.2em "Helvetica Neue", Helvetica, sans-serif;color:#222222; }h2 { font:bold 24px/1.2em "Helvetica Neue", Helvetica, sans-serif;color:#222222; }h3 { font:bold 20px/1.2em "Helvetica Neue", Helvetica, sans-serif;color:#222222; }h4 { font:bold 16px/1.2em "Helvetica Neue", Helvetica, sans-serif;color:#222222; }h5 { font:bold 14px/1.2em "Helvetica Neue", Helvetica, sans-serif;color:#222222; }h6 { font:bold 12px/1.2em "Helvetica Neue", Helvetica, sans-serif;color:#222222; }
.page-title, .post .title, .page .title {font:bold 28px/1.1em "Helvetica Neue", Helvetica, sans-serif;color:#222222;}
.post .title a:link, .post .title a:visited, .page .title a:link, .page .title a:visited {color:#222222}
.post-meta { font:normal 12px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#999999; }
.entry, .entry p{ font:normal 15px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#555555; }
.post-more {font:normal 13px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:;border-top:0px solid #e6e6e6;border-bottom:0px solid #e6e6e6;}
#post-author, #connect {border-top:1px solid #e6e6e6;border-bottom:1px solid #e6e6e6;border-left:1px solid #e6e6e6;border-right:1px solid #e6e6e6;border-radius:5px;-moz-border-radius:5px;-webkit-border-radius:5px;background-color:#fafafa}
.nav-entries a, .woo-pagination { font:normal 13px/1em "Helvetica Neue", Helvetica, sans-serif;color:#888; }
.woo-pagination a, .woo-pagination a:hover {color:#888!important}
.widget h3 {font:bold 14px/1.2em "Helvetica Neue", Helvetica, sans-serif;color:#555555;border-bottom:1px solid #e6e6e6;}
.widget_recent_comments li, #twitter li { border-color: #e6e6e6;}
.widget p, .widget .textwidget { font:normal 13px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#555555; }
.widget {font:normal 13px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#555555;border-radius:0px;-moz-border-radius:0px;-webkit-border-radius:0px;}
#tabs .inside li a, .widget_woodojo_tabs .tabbable .tab-pane li a { font:bold 12px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#555555; }
#tabs .inside li span.meta, .widget_woodojo_tabs .tabbable .tab-pane li span.meta { font:300 11px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#999999; }
#tabs ul.wooTabs li a, .widget_woodojo_tabs .tabbable .nav-tabs li a { font:300 11px/2em "Helvetica Neue", Helvetica, sans-serif;color:#999999; }
@media only screen and (min-width:768px) {
ul.nav li a, #navigation ul.rss a, #navigation ul.cart a.cart-contents, #navigation .cart-contents #navigation ul.rss, #navigation ul.nav-search, #navigation ul.nav-search a { font:bold 18px/1.2em "Helvetica Neue", Helvetica, sans-serif;color:#4c89bf; } #navigation ul.rss li a:before, #navigation ul.nav-search a.search-contents:before { color:#4c89bf;}
#navigation ul.nav > li a:hover, #navigation ul.nav > li:hover a, #navigation ul.nav li ul li a, #navigation ul.cart > li:hover > a, #navigation ul.cart > li > ul > div, #navigation ul.cart > li > ul > div p, #navigation ul.cart > li > ul span, #navigation ul.cart .cart_list a, #navigation ul.nav li.current_page_item a, #navigation ul.nav li.current_page_parent a, #navigation ul.nav li.current-menu-ancestor a, #navigation ul.nav li.current-cat a, #navigation ul.nav li.current-menu-item a { color:#4c89bf!important; }
#navigation ul.nav > li a:hover, #navigation ul.nav > li:hover, #navigation ul.nav li ul, #navigation ul.cart li:hover a.cart-contents, #navigation ul.nav-search li:hover a.search-contents, #navigation ul.nav-search a.search-contents + ul, #navigation ul.cart a.cart-contents + ul, #navigation ul.nav li.current_page_item a, #navigation ul.nav li.current_page_parent a, #navigation ul.nav li.current-menu-ancestor a, #navigation ul.nav li.current-cat a, #navigation ul.nav li.current-menu-item a{background-color:#ffffff!important}
#navigation ul.nav li ul, #navigation ul.cart > li > ul > div  { border: 0px solid #dbdbdb; }
#navigation ul.nav > li:hover > ul  { left: 0; }
#navigation ul.nav > li  { border-right: 0px solid #dbdbdb; }#navigation ul.nav > li:hover > ul  { left: 0; }
#navigation { box-shadow: none; -moz-box-shadow: none; -webkit-box-shadow: none; }#navigation ul li:first-child, #navigation ul li:first-child a { border-radius:0px 0 0 0px; -moz-border-radius:0px 0 0 0px; -webkit-border-radius:0px 0 0 0px; }
#navigation {background:#ffffff;border-top:0px solid #dbdbdb;border-bottom:0px solid #dbdbdb;border-left:0px solid #dbdbdb;border-right:0px solid #dbdbdb;border-radius:0px; -moz-border-radius:0px; -webkit-border-radius:0px;}
#top ul.nav li a { font:normal 12px/1.6em "Helvetica Neue", Helvetica, sans-serif;color:#ddd; }
}
#footer, #footer p { font:normal 13px/1.4em "Helvetica Neue", Helvetica, sans-serif;color:#999999; }
#footer {border-top:1px solid #dbdbdb;border-bottom:0px solid ;border-left:0px solid ;border-right:0px solid ;border-radius:0px; -moz-border-radius:0px; -webkit-border-radius:0px;}
.magazine #loopedSlider .content h2.title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-magazine .slide-title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.magazine #loopedSlider .content .excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-magazine .slide-content p, .wooslider-theme-magazine .slide-excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.magazine .block .post .title a {font:bold 18px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }
#loopedSlider.business-slider .content h2 { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
#loopedSlider.business-slider .content h2.title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-business .has-featured-image .slide-title { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-business .has-featured-image .slide-title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
#wrapper #loopedSlider.business-slider .content p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-business .has-featured-image .slide-content p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-business .has-featured-image .slide-excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.archive_header { font:bold 18px/1em Arial, sans-serif;color:#222222; }
.archive_header {border-bottom:1px solid #e6e6e6;}
.archive_header .catrss { display:none; }
</style>
<!-- Woo Shortcodes CSS -->
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/functions/css/shortcodes.css" rel="stylesheet" type="text/css"/>
<!-- Custom Stylesheet -->
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/custom.css" rel="stylesheet" type="text/css"/>
<!-- Theme version -->
<meta content="Canvas 5.9.21" name="generator"/>
<meta content="WooFramework 6.2.9" name="generator"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-32x32.png" rel="icon" sizes="32x32"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-192x192.png" rel="icon" sizes="192x192"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-180x180.png" rel="apple-touch-icon-precomposed"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-270x270.png" name="msapplication-TileImage"/>
</head>
<body class="post-template-default single single-post postid-6286 single-format-standard chrome alt-style-default two-col-left width-960 two-col-left-960">
<div id="wrapper">
<div id="inner-wrapper">
<h3 class="nav-toggle icon"><a href="#navigation">Navigation</a></h3>
<header class="col-full" id="header">
<div id="logo">
<a href="https://machinelearningmastery.com/" title="Making developers awesome at machine learning"><img alt="Machine Learning Mastery" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/09/icon-100x100.png"/></a>
<span class="site-title"><a href="https://machinelearningmastery.com/">Machine Learning Mastery</a></span>
<span class="site-description">Making developers awesome at machine learning</span>
</div>
<div class="header-widget">
<div class="widget widget_text" id="text-53"> <div class="textwidget"><p>Want help with deep learning for time series? <a href="https://machinelearningmastery.lpages.co/deep-learning-for-time-series-forecasting-mini-course/">Take the FREE Mini-Course</a></p>
</div>
</div><div class="widget widget_search" id="search-3"><div class="search_main">
<form action="https://machinelearningmastery.com/" class="searchform" method="get">
<input class="field s" name="s" onblur="if (this.value == '') {this.value = 'Search...';}" onfocus="if (this.value == 'Search...') {this.value = '';}" type="text" value="Search..."/>
<input name="post_type" type="hidden" value="post"/>
<button class="fa fa-search submit" name="submit" type="submit" value="Search"></button>
</form>
<div class="fix"></div>
</div></div> </div>
</header>
<nav class="col-full" id="navigation" role="navigation">
<section class="menus">
<a class="nav-home" href="https://machinelearningmastery.com"><span>Home</span></a>
<h3>Main Menu</h3><ul class="nav fl" id="main-nav"><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6503" id="menu-item-6503"><a href="https://machinelearningmastery.com/start-here/">Start Here</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page current_page_parent menu-item-6501" id="menu-item-6501"><a href="https://machinelearningmastery.com/blog/">Blog</a></li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-6506" id="menu-item-6506"><a href="#">Topics</a>
<ul class="sub-menu">
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6508" id="menu-item-6508"><a href="https://machinelearningmastery.com/category/deep-learning/">Deep Learning (Keras)</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6511" id="menu-item-6511"><a href="https://machinelearningmastery.com/category/lstm/">LSTMs</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-6509" id="menu-item-6509"><a href="https://machinelearningmastery.com/category/deep-learning-time-series/">Deep Learning for Time Series</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6515" id="menu-item-6515"><a href="https://machinelearningmastery.com/category/natural-language-processing/">Deep Learning for NLP</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6512" id="menu-item-6512"><a href="https://machinelearningmastery.com/category/machine-learning-algorithms/">Understand Algorithms</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6507" id="menu-item-6507"><a href="https://machinelearningmastery.com/category/algorithms-from-scratch/">Code Algorithms (Python)</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6513" id="menu-item-6513"><a href="https://machinelearningmastery.com/category/machine-learning-process/">Machine Learning Process</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6516" id="menu-item-6516"><a href="https://machinelearningmastery.com/category/python-machine-learning/">Python (scikit-learn)</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6517" id="menu-item-6517"><a href="https://machinelearningmastery.com/category/r-machine-learning/">R (caret)</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6522" id="menu-item-6522"><a href="https://machinelearningmastery.com/category/weka-machine-learning/">Weka (no code)</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6518" id="menu-item-6518"><a href="https://machinelearningmastery.com/category/start-machine-learning/">Getting Started</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6510" id="menu-item-6510"><a href="https://machinelearningmastery.com/category/linear-algebra/">Linear Algebra</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6519" id="menu-item-6519"><a href="https://machinelearningmastery.com/category/statistical-methods/">Statistical Methods</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6520" id="menu-item-6520"><a href="https://machinelearningmastery.com/category/time-series/">Time Series (introductory)</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6523" id="menu-item-6523"><a href="https://machinelearningmastery.com/category/xgboost/">XGBoost</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6514" id="menu-item-6514"><a href="https://machinelearningmastery.com/category/machine-learning-resources/">Resources</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6502" id="menu-item-6502"><a href="https://machinelearningmastery.com/products/">Ebooks</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6500" id="menu-item-6500"><a href="https://machinelearningmastery.com/faq/">FAQ</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6504" id="menu-item-6504"><a href="https://machinelearningmastery.com/about/">About</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6505" id="menu-item-6505"><a href="https://machinelearningmastery.com/contact/">Contact</a></li>
</ul> <div class="side-nav">
</div><!-- /#side-nav -->
</section><!-- /.menus -->
<a class="nav-close" href="#top"><span>Return to Content</span></a>
</nav>
<!-- #content Starts -->
<div class="col-full" id="content">
<div id="main-sidebar-container">
<!-- #main Starts -->
<section id="main">
<article class="post-6286 post type-post status-publish format-standard has-post-thumbnail hentry category-deep-learning-time-series">
<header>
<h1 class="title entry-title">How to Develop LSTM Models for Multi-Step Time Series Forecasting of Household Power Consumption</h1> </header>
<div class="post-meta"><span class="small">By</span> <span class="author vcard"><span class="fn"><a href="https://machinelearningmastery.com/author/jasonb/" rel="author" title="Posts by Jason Brownlee">Jason Brownlee</a></span></span> <span class="small">on</span> <abbr class="date time published updated" title="2018-10-10T05:00:36+1100">October 10, 2018</abbr> <span class="small">in</span> <span class="categories"><a href="https://machinelearningmastery.com/category/deep-learning-time-series/" title="View all items in Deep Learning for Time Series">Deep Learning for Time Series</a></span> </div>
<section class="entry">
<div class="simplesocialbuttons simplesocial-simple-icons simplesocialbuttons_inline simplesocialbuttons-align-left post-6286 post simplesocialbuttons-inline-no-animation">
<button class="ssb_tweet-icon" data-href="https://twitter.com/share?text=How+to+Develop+LSTM+Models+for+Multi-Step+Time+Series+Forecasting+of+Household+Power+Consumption&amp;url=https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/" onclick="javascript:window.open(this.dataset.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;" rel="nofollow">
<span class="icon"><svg viewbox="0 0 72 72" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h72v72H0z" fill="none"></path><path class="icon" d="M68.812 15.14c-2.348 1.04-4.87 1.744-7.52 2.06 2.704-1.62 4.78-4.186 5.757-7.243-2.53 1.5-5.33 2.592-8.314 3.176C56.35 10.59 52.948 9 49.182 9c-7.23 0-13.092 5.86-13.092 13.093 0 1.026.118 2.02.338 2.98C25.543 24.527 15.9 19.318 9.44 11.396c-1.125 1.936-1.77 4.184-1.77 6.58 0 4.543 2.312 8.552 5.824 10.9-2.146-.07-4.165-.658-5.93-1.64-.002.056-.002.11-.002.163 0 6.345 4.513 11.638 10.504 12.84-1.1.298-2.256.457-3.45.457-.845 0-1.666-.078-2.464-.23 1.667 5.2 6.5 8.985 12.23 9.09-4.482 3.51-10.13 5.605-16.26 5.605-1.055 0-2.096-.06-3.122-.184 5.794 3.717 12.676 5.882 20.067 5.882 24.083 0 37.25-19.95 37.25-37.25 0-.565-.013-1.133-.038-1.693 2.558-1.847 4.778-4.15 6.532-6.774z" fill="#fff"></path></svg></span><i class="simplesocialtxt">Tweet </i></button>
<button class="ssb_fbshare-icon" data-href="https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/" onclick="javascript:window.open(this.dataset.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;" target="_blank">
<span class="icon"><svg class="_1pbq" color="#ffffff" viewbox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path class="icon" d="M8 14H3.667C2.733 13.9 2 13.167 2 12.233V3.667A1.65 1.65 0 0 1 3.667 2h8.666A1.65 1.65 0 0 1 14 3.667v8.566c0 .934-.733 1.667-1.667 1.767H10v-3.967h1.3l.7-2.066h-2V6.933c0-.466.167-.9.867-.9H12v-1.8c.033 0-.933-.266-1.533-.266-1.267 0-2.434.7-2.467 2.133v1.867H6v2.066h2V14z" fill="#ffffff" fill-rule="evenodd"></path></svg></span>
<span class="simplesocialtxt">Share </span> </button>
<button class="ssb_linkedin-icon" data-href="https://www.linkedin.com/cws/share?url=https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/" onclick="javascript:window.open(this.dataset.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
<span class="icon"> <svg enable-background="new -301.4 387.5 15 14.1" height="14.1px" id="Layer_1" version="1.1" viewbox="-301.4 387.5 15 14.1" width="15px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"> <g id="XMLID_398_"> <path d="M-296.2,401.6c0-3.2,0-6.3,0-9.5h0.1c1,0,2,0,2.9,0c0.1,0,0.1,0,0.1,0.1c0,0.4,0,0.8,0,1.2 c0.1-0.1,0.2-0.3,0.3-0.4c0.5-0.7,1.2-1,2.1-1.1c0.8-0.1,1.5,0,2.2,0.3c0.7,0.4,1.2,0.8,1.5,1.4c0.4,0.8,0.6,1.7,0.6,2.5 c0,1.8,0,3.6,0,5.4v0.1c-1.1,0-2.1,0-3.2,0c0-0.1,0-0.1,0-0.2c0-1.6,0-3.2,0-4.8c0-0.4,0-0.8-0.2-1.2c-0.2-0.7-0.8-1-1.6-1 c-0.8,0.1-1.3,0.5-1.6,1.2c-0.1,0.2-0.1,0.5-0.1,0.8c0,1.7,0,3.4,0,5.1c0,0.2,0,0.2-0.2,0.2c-1,0-1.9,0-2.9,0 C-296.1,401.6-296.2,401.6-296.2,401.6z" fill="#FFFFFF" id="XMLID_399_"></path> <path d="M-298,401.6L-298,401.6c-1.1,0-2.1,0-3,0c-0.1,0-0.1,0-0.1-0.1c0-3.1,0-6.1,0-9.2 c0-0.1,0-0.1,0.1-0.1c1,0,2,0,2.9,0h0.1C-298,395.3-298,398.5-298,401.6z" fill="#FFFFFF" id="XMLID_400_"></path> <path d="M-299.6,390.9c-0.7-0.1-1.2-0.3-1.6-0.8c-0.5-0.8-0.2-2.1,1-2.4c0.6-0.2,1.2-0.1,1.8,0.2 c0.5,0.4,0.7,0.9,0.6,1.5c-0.1,0.7-0.5,1.1-1.1,1.3C-299.1,390.8-299.4,390.8-299.6,390.9L-299.6,390.9z" fill="#FFFFFF" id="XMLID_401_"></path> </g> </svg> </span>
<span class="simplesocialtxt">Share</span> </button>
<button class="ssb_gplus-icon" data-href="https://plus.google.com/share?url=https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/" onclick="javascript:window.open(this.dataset.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
<span class="icon"><svg class="ozWidgetRioButtonSvg_ ozWidgetRioButtonPlusOne_" height="18px" preserveaspectratio="xMidYMid meet" version="1.1" viewbox="-10 -6 60 36" width="30px" xmlns="http://www.w3.org/2000/svg"><path d="M30 7h-3v4h-4v3h4v4h3v-4h4v-3h-4V7z"></path><path d="M11 9.9v4h5.4C16 16.3 14 18 11 18c-3.3 0-5.9-2.8-5.9-6S7.7 6 11 6c1.5 0 2.8.5 3.8 1.5l2.9-2.9C15.9 3 13.7 2 11 2 5.5 2 1 6.5 1 12s4.5 10 10 10c5.8 0 9.6-4.1 9.6-9.8 0-.7-.1-1.5-.2-2.2H11z"></path></svg></span>
<span class="simplesocialtxt">Google Plus </span></button>
</div>
<p>Given the rise of smart electricity meters and the wide adoption of electricity generation technology like solar panels, there is a wealth of electricity usage data available.</p>
<p>This data represents a multivariate time series of power-related variables that in turn could be used to model and even forecast future electricity consumption.</p>
<p>Unlike other machine learning algorithms, long short-term memory recurrent neural networks are capable of automatically learning features from sequence data, support multiple-variate data, and can output a variable length sequences that can be used for multi-step forecasting.</p>
<p>In this tutorial, you will discover how to develop long short-term memory recurrent neural networks for multi-step time series forecasting of household power consumption.</p>
<p>After completing this tutorial, you will know:</p>
<ul>
<li>How to develop and evaluate Univariate and multivariate Encoder-Decoder LSTMs for multi-step time series forecasting.</li>
<li>How to develop and evaluate an CNN-LSTM Encoder-Decoder model for multi-step time series forecasting.</li>
<li>How to develop and evaluate a ConvLSTM Encoder-Decoder model for multi-step time series forecasting.</li>
</ul>
<p>Let’s get started.</p>
<div class="wp-caption aligncenter" id="attachment_6293" style="width: 650px"><img alt="How to Develop LSTM Models for Multi-Step Time Series Forecasting of Household Power Consumption" class="size-full wp-image-6293" height="425" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/10/How-to-Develop-LSTM-Models-for-Multi-Step-Time-Series-Forecasting-of-Household-Power-Consumption.jpg" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/10/How-to-Develop-LSTM-Models-for-Multi-Step-Time-Series-Forecasting-of-Household-Power-Consumption.jpg 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/10/How-to-Develop-LSTM-Models-for-Multi-Step-Time-Series-Forecasting-of-Household-Power-Consumption-300x199.jpg 300w" width="640"/><p class="wp-caption-text">How to Develop LSTM Models for Multi-Step Time Series Forecasting of Household Power Consumption<br/>Photo by <a href="https://www.flickr.com/photos/imuttoo/4257813689/">Ian Muttoo</a>, some rights reserved.</p></div>
<h2>Tutorial Overview</h2>
<p>This tutorial is divided into nine parts; they are:</p>
<ol>
<li>Problem Description</li>
<li>Load and Prepare Dataset</li>
<li>Model Evaluation</li>
<li>LSTMs for Multi-Step Forecasting</li>
<li>LSTM Model With Univariate Input and Vector Output</li>
<li>Encoder-Decoder LSTM Model With Univariate Input</li>
<li>Encoder-Decoder LSTM Model With Multivariate Input</li>
<li>CNN-LSTM Encoder-Decoder Model With Univariate Input</li>
<li>ConvLSTM Encoder-Decoder Model With Univariate Input</li>
</ol>
<h2>Problem Description</h2>
<p>The ‘<a href="https://archive.ics.uci.edu/ml/datasets/individual+household+electric+power+consumption">Household Power Consumption</a>‘ dataset is a multivariate time series dataset that describes the electricity consumption for a single household over four years.</p>
<p>The data was collected between December 2006 and November 2010 and observations of power consumption within the household were collected every minute.</p>
<p>It is a multivariate series comprised of seven variables (besides the date and time); they are:</p>
<ul>
<li><strong>global_active_power</strong>: The total active power consumed by the household (kilowatts).</li>
<li><strong>global_reactive_power</strong>: The total reactive power consumed by the household (kilowatts).</li>
<li><strong>voltage</strong>: Average voltage (volts).</li>
<li><strong>global_intensity</strong>: Average current intensity (amps).</li>
<li><strong>sub_metering_1</strong>: Active energy for kitchen (watt-hours of active energy).</li>
<li><strong>sub_metering_2</strong>: Active energy for laundry (watt-hours of active energy).</li>
<li><strong>sub_metering_3</strong>: Active energy for climate control systems (watt-hours of active energy).</li>
</ul>
<p>Active and reactive energy refer to the technical details of <a href="https://en.wikipedia.org/wiki/AC_power">alternative current</a>.</p>
<p>A fourth sub-metering variable can be created by subtracting the sum of three defined sub-metering variables from the total active energy as follows:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80b7a924485823" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
sub_metering_remainder = (global_active_power * 1000 / 60) - (sub_metering_1 + sub_metering_2 + sub_metering_3)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80b7a924485823-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80b7a924485823-1">sub_metering_remainder = (global_active_power * 1000 / 60) - (sub_metering_1 + sub_metering_2 + sub_metering_3)</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>
<h2>Load and Prepare Dataset</h2>
<p>The dataset can be downloaded from the UCI Machine Learning repository as a single 20 megabyte .zip file:</p>
<ul>
<li><a href="https://archive.ics.uci.edu/ml/machine-learning-databases/00235/household_power_consumption.zip">household_power_consumption.zip</a></li>
</ul>
<p>Download the dataset and unzip it into your current working directory. You will now have the file “<em>household_power_consumption.txt</em>” that is about 127 megabytes in size and contains all of the observations.</p>
<p>We can use the <em>read_csv()</em> function to load the data and combine the first two columns into a single date-time column that we can use as an index.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80b83120371806" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load all data
dataset = read_csv('household_power_consumption.txt', sep=';', header=0, low_memory=False, infer_datetime_format=True, parse_dates={'datetime':[0,1]}, index_col=['datetime'])</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80b83120371806-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b83120371806-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80b83120371806-1"><span class="crayon-p"># load all data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b83120371806-2"><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'household_power_consumption.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">sep</span><span class="crayon-o">=</span><span class="crayon-s">';'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">low_memory</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">infer_datetime_format</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">parse_dates</span><span class="crayon-o">=</span><span class="crayon-sy">{</span><span class="crayon-s">'datetime'</span><span class="crayon-o">:</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index_col</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'datetime'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0004 seconds] -->
<p>Next, we can mark all <a href="https://machinelearningmastery.com/handle-missing-timesteps-sequence-prediction-problems-python/">missing values</a> indicated with a ‘<em>?</em>‘ character with a <em>NaN</em> value, which is a float.</p>
<p>This will allow us to work with the data as one array of floating point values rather than mixed types (less efficient.)</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80b85116778958" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# mark all missing values
dataset.replace('?', nan, inplace=True)
# make dataset numeric
dataset = dataset.astype('float32')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80b85116778958-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b85116778958-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b85116778958-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b85116778958-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80b85116778958-1"><span class="crayon-p"># mark all missing values</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b85116778958-2"><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">replace</span><span class="crayon-sy">(</span><span class="crayon-s">'?'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nan</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inplace</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b85116778958-3"><span class="crayon-p"># make dataset numeric</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b85116778958-4"><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">astype</span><span class="crayon-sy">(</span><span class="crayon-s">'float32'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>We also need to fill in the missing values now that they have been marked.</p>
<p>A very simple approach would be to copy the observation from the same time the day before. We can implement this in a function named <em>fill_missing()</em> that will take the NumPy array of the data and copy values from exactly 24 hours ago.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80b87871450467" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# fill missing values with a value at the same time one day ago
def fill_missing(values):
	one_day = 60 * 24
	for row in range(values.shape[0]):
		for col in range(values.shape[1]):
			if isnan(values[row, col]):
				values[row, col] = values[row - one_day, col]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80b87871450467-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b87871450467-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b87871450467-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b87871450467-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b87871450467-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b87871450467-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b87871450467-7">7</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80b87871450467-1"><span class="crayon-p"># fill missing values with a value at the same time one day ago</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b87871450467-2"><span class="crayon-e">def </span><span class="crayon-e">fill_missing</span><span class="crayon-sy">(</span><span class="crayon-v">values</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b87871450467-3"><span class="crayon-h"> </span><span class="crayon-v">one_day</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">60</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-cn">24</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b87871450467-4"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">row </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">values</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b87871450467-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">col </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">values</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b87871450467-6"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">isnan</span><span class="crayon-sy">(</span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-v">row</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">col</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b87871450467-7"><span class="crayon-h"> </span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-v">row</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">col</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-v">row</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">one_day</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">col</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0006 seconds] -->
<p>We can apply this function directly to the data within the DataFrame.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80b89128542034" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# fill missing
fill_missing(dataset.values)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80b89128542034-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b89128542034-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80b89128542034-1"><span class="crayon-p"># fill missing</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b89128542034-2"><span class="crayon-e">fill_missing</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-v">values</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Now we can create a new column that contains the remainder of the sub-metering, using the calculation from the previous section.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80b8a786419512" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# add a column for for the remainder of sub metering
values = dataset.values
dataset['sub_metering_4'] = (values[:,0] * 1000 / 60) - (values[:,4] + values[:,5] + values[:,6])</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80b8a786419512-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8a786419512-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b8a786419512-3">3</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80b8a786419512-1"><span class="crayon-p"># add a column for for the remainder of sub metering</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8a786419512-2"><span class="crayon-v">values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">values</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b8a786419512-3"><span class="crayon-v">dataset</span><span class="crayon-sy">[</span><span class="crayon-s">'sub_metering_4'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-cn">1000</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-cn">60</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-cn">4</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-cn">5</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-cn">6</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>We can now save the cleaned-up version of the dataset to a new file; in this case we will just change the file extension to .csv and save the dataset as ‘<em>household_power_consumption.csv</em>‘.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80b8c402745799" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# save updated dataset
dataset.to_csv('household_power_consumption.csv')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80b8c402745799-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8c402745799-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80b8c402745799-1"><span class="crayon-p"># save updated dataset</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8c402745799-2"><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">to_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'household_power_consumption.csv'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Tying all of this together, the complete example of loading, cleaning-up, and saving the dataset is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80b8d088487574" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load and clean-up data
from numpy import nan
from numpy import isnan
from pandas import read_csv
from pandas import to_numeric

# fill missing values with a value at the same time one day ago
def fill_missing(values):
	one_day = 60 * 24
	for row in range(values.shape[0]):
		for col in range(values.shape[1]):
			if isnan(values[row, col]):
				values[row, col] = values[row - one_day, col]

# load all data
dataset = read_csv('household_power_consumption.txt', sep=';', header=0, low_memory=False, infer_datetime_format=True, parse_dates={'datetime':[0,1]}, index_col=['datetime'])
# mark all missing values
dataset.replace('?', nan, inplace=True)
# make dataset numeric
dataset = dataset.astype('float32')
# fill missing
fill_missing(dataset.values)
# add a column for for the remainder of sub metering
values = dataset.values
dataset['sub_metering_4'] = (values[:,0] * 1000 / 60) - (values[:,4] + values[:,5] + values[:,6])
# save updated dataset
dataset.to_csv('household_power_consumption.csv')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80b8d088487574-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8d088487574-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b8d088487574-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8d088487574-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b8d088487574-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8d088487574-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b8d088487574-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8d088487574-8">8</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b8d088487574-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8d088487574-10">10</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b8d088487574-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8d088487574-12">12</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b8d088487574-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8d088487574-14">14</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b8d088487574-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8d088487574-16">16</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b8d088487574-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8d088487574-18">18</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b8d088487574-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8d088487574-20">20</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b8d088487574-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8d088487574-22">22</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b8d088487574-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8d088487574-24">24</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b8d088487574-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8d088487574-26">26</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b8d088487574-27">27</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80b8d088487574-1"><span class="crayon-p"># load and clean-up data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8d088487574-2"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">nan</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b8d088487574-3"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">isnan</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8d088487574-4"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">read_csv</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b8d088487574-5"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-v">to_numeric</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8d088487574-6"> </div><div class="crayon-line" id="crayon-5c0c9e4d80b8d088487574-7"><span class="crayon-p"># fill missing values with a value at the same time one day ago</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8d088487574-8"><span class="crayon-e">def </span><span class="crayon-e">fill_missing</span><span class="crayon-sy">(</span><span class="crayon-v">values</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b8d088487574-9"><span class="crayon-h"> </span><span class="crayon-v">one_day</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">60</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-cn">24</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8d088487574-10"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">row </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">values</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b8d088487574-11"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">col </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">values</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8d088487574-12"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">isnan</span><span class="crayon-sy">(</span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-v">row</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">col</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b8d088487574-13"><span class="crayon-h"> </span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-v">row</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">col</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-v">row</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">one_day</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">col</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8d088487574-14"> </div><div class="crayon-line" id="crayon-5c0c9e4d80b8d088487574-15"><span class="crayon-p"># load all data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8d088487574-16"><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'household_power_consumption.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">sep</span><span class="crayon-o">=</span><span class="crayon-s">';'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">low_memory</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">infer_datetime_format</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">parse_dates</span><span class="crayon-o">=</span><span class="crayon-sy">{</span><span class="crayon-s">'datetime'</span><span class="crayon-o">:</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index_col</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'datetime'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b8d088487574-17"><span class="crayon-p"># mark all missing values</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8d088487574-18"><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">replace</span><span class="crayon-sy">(</span><span class="crayon-s">'?'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nan</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inplace</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b8d088487574-19"><span class="crayon-p"># make dataset numeric</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8d088487574-20"><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">astype</span><span class="crayon-sy">(</span><span class="crayon-s">'float32'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b8d088487574-21"><span class="crayon-p"># fill missing</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8d088487574-22"><span class="crayon-e">fill_missing</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-v">values</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b8d088487574-23"><span class="crayon-p"># add a column for for the remainder of sub metering</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8d088487574-24"><span class="crayon-v">values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">values</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b8d088487574-25"><span class="crayon-v">dataset</span><span class="crayon-sy">[</span><span class="crayon-s">'sub_metering_4'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-cn">1000</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-cn">60</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-cn">4</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-cn">5</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-cn">6</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8d088487574-26"><span class="crayon-p"># save updated dataset</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b8d088487574-27"><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">to_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'household_power_consumption.csv'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0017 seconds] -->
<p>Running the example creates the new file ‘<em>household_power_consumption.csv</em>‘ that we can use as the starting point for our modeling project.</p>
<p></p><div class="woo-sc-hr"></div>
<center>
<h3>Need help with Deep Learning for Time Series?</h3>
<p>Take my free 7-day email crash course now (with sample code).</p>
<p>Click to sign-up and also get a free PDF Ebook version of the course.</p>
<p><a href="https://machinelearningmastery.lpages.co/leadbox/14531ee73f72a2%3A164f8be4f346dc/5630742793027584/" style="background: rgb(255, 206, 10); color: rgb(255, 255, 255); text-decoration: none; font-family: Helvetica, Arial, sans-serif; font-weight: bold; font-size: 16px; line-height: 20px; padding: 10px; display: inline-block; max-width: 300px; border-radius: 5px; text-shadow: rgba(0, 0, 0, 0.25) 0px -1px 1px; box-shadow: rgba(255, 255, 255, 0.5) 0px 1px 3px inset, rgba(0, 0, 0, 0.5) 0px 1px 3px;" target="_blank">Download Your FREE Mini-Course</a><script data-config="%7B%7D" data-leadbox="14531ee73f72a2:164f8be4f346dc" data-url="https://machinelearningmastery.lpages.co/leadbox/14531ee73f72a2%3A164f8be4f346dc/5630742793027584/" src="https://machinelearningmastery.lpages.co/leadbox-1534880695.js" type="text/javascript"></script></p>
</center>
<p></p><div class="woo-sc-hr"></div>
<h2>Model Evaluation</h2>
<p>In this section, we will consider how we can develop and evaluate predictive models for the household power dataset.</p>
<p>This section is divided into four parts; they are:</p>
<ol>
<li>Problem Framing</li>
<li>Evaluation Metric</li>
<li>Train and Test Sets</li>
<li>Walk-Forward Validation</li>
</ol>
<h3>Problem Framing</h3>
<p>There are many ways to harness and explore the household power consumption dataset.</p>
<p>In this tutorial, we will use the data to explore a very specific question; that is:</p>
<blockquote><p>Given recent power consumption, what is the expected power consumption for the week ahead?</p></blockquote>
<p>This requires that a predictive model forecast the total active power for each day over the next seven days.</p>
<p>Technically, this framing of the problem is referred to as a multi-step time series forecasting problem, given the multiple forecast steps. A model that makes use of multiple input variables may be referred to as a multivariate multi-step time series forecasting model.</p>
<p>A model of this type could be helpful within the household in planning expenditures. It could also be helpful on the supply side for planning electricity demand for a specific household.</p>
<p>This framing of the dataset also suggests that it would be useful to downsample the per-minute observations of power consumption to daily totals. This is not required, but makes sense, given that we are interested in total power per day.</p>
<p>We can achieve this easily using the <a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.resample.html">resample() function</a> on the pandas DataFrame. Calling this function with the argument ‘<em>D</em>‘ allows the loaded data indexed by date-time to be grouped by day (<a href="http://pandas.pydata.org/pandas-docs/stable/timeseries.html#offset-aliases">see all offset aliases</a>). We can then calculate the sum of all observations for each day and create a new dataset of daily power consumption data for each of the eight variables.</p>
<p>The complete example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80b8f392463971" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# resample minute data to total for each day
from pandas import read_csv
# load the new file
dataset = read_csv('household_power_consumption.csv', header=0, infer_datetime_format=True, parse_dates=['datetime'], index_col=['datetime'])
# resample data to daily
daily_groups = dataset.resample('D')
daily_data = daily_groups.sum()
# summarize
print(daily_data.shape)
print(daily_data.head())
# save
daily_data.to_csv('household_power_consumption_days.csv')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80b8f392463971-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8f392463971-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b8f392463971-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8f392463971-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b8f392463971-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8f392463971-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b8f392463971-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8f392463971-8">8</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b8f392463971-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8f392463971-10">10</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b8f392463971-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b8f392463971-12">12</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80b8f392463971-1"><span class="crayon-p"># resample minute data to total for each day</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8f392463971-2"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-v">read_csv</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b8f392463971-3"><span class="crayon-p"># load the new file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8f392463971-4"><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'household_power_consumption.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">infer_datetime_format</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">parse_dates</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'datetime'</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index_col</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'datetime'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b8f392463971-5"><span class="crayon-p"># resample data to daily</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8f392463971-6"><span class="crayon-v">daily_groups</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">resample</span><span class="crayon-sy">(</span><span class="crayon-s">'D'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b8f392463971-7"><span class="crayon-v">daily_data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">daily_groups</span><span class="crayon-sy">.</span><span class="crayon-e">sum</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8f392463971-8"><span class="crayon-p"># summarize</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b8f392463971-9"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">daily_data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8f392463971-10"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">daily_data</span><span class="crayon-sy">.</span><span class="crayon-e">head</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b8f392463971-11"><span class="crayon-p"># save</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b8f392463971-12"><span class="crayon-v">daily_data</span><span class="crayon-sy">.</span><span class="crayon-e">to_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'household_power_consumption_days.csv'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0006 seconds] -->
<p>Running the example creates a new daily total power consumption dataset and saves the result into a separate file named ‘<em>household_power_consumption_days.csv</em>‘.</p>
<p>We can use this as the dataset for fitting and evaluating predictive models for the chosen framing of the problem.</p>
<h3>Evaluation Metric</h3>
<p>A forecast will be comprised of seven values, one for each day of the week ahead.</p>
<p>It is common with multi-step forecasting problems to evaluate each forecasted time step separately. This is helpful for a few reasons:</p>
<ul>
<li>To comment on the skill at a specific lead time (e.g. +1 day vs +3 days).</li>
<li>To contrast models based on their skills at different lead times (e.g. models good at +1 day vs models good at days +5).</li>
</ul>
<p>The units of the total power are kilowatts and it would be useful to have an error metric that was also in the same units. Both Root Mean Squared Error (RMSE) and Mean Absolute Error (MAE) fit this bill, although RMSE is more commonly used and will be adopted in this tutorial. Unlike MAE, RMSE is more punishing of forecast errors.</p>
<p>The performance metric for this problem will be the RMSE for each lead time from day 1 to day 7.</p>
<p>As a short-cut, it may be useful to summarize the performance of a model using a single score in order to aide in model selection.</p>
<p>One possible score that could be used would be the RMSE across all forecast days.</p>
<p>The function <em>evaluate_forecasts()</em> below will implement this behavior and return the performance of a model based on multiple seven-day forecasts.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80b94114434942" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# evaluate one or more weekly forecasts against expected values
def evaluate_forecasts(actual, predicted):
	scores = list()
	# calculate an RMSE score for each day
	for i in range(actual.shape[1]):
		# calculate mse
		mse = mean_squared_error(actual[:, i], predicted[:, i])
		# calculate rmse
		rmse = sqrt(mse)
		# store
		scores.append(rmse)
	# calculate overall RMSE
	s = 0
	for row in range(actual.shape[0]):
		for col in range(actual.shape[1]):
			s += (actual[row, col] - predicted[row, col])**2
	score = sqrt(s / (actual.shape[0] * actual.shape[1]))
	return score, scores</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80b94114434942-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b94114434942-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b94114434942-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b94114434942-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b94114434942-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b94114434942-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b94114434942-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b94114434942-8">8</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b94114434942-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b94114434942-10">10</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b94114434942-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b94114434942-12">12</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b94114434942-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b94114434942-14">14</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b94114434942-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b94114434942-16">16</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b94114434942-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b94114434942-18">18</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80b94114434942-1"><span class="crayon-p"># evaluate one or more weekly forecasts against expected values</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b94114434942-2"><span class="crayon-e">def </span><span class="crayon-e">evaluate_forecasts</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b94114434942-3"><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b94114434942-4"><span class="crayon-h"> </span><span class="crayon-p"># calculate an RMSE score for each day</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b94114434942-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b94114434942-6"><span class="crayon-h"> </span><span class="crayon-p"># calculate mse</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b94114434942-7"><span class="crayon-h"> </span><span class="crayon-v">mse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">mean_squared_error</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b94114434942-8"><span class="crayon-h"> </span><span class="crayon-p"># calculate rmse</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b94114434942-9"><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sqrt</span><span class="crayon-sy">(</span><span class="crayon-v">mse</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b94114434942-10"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b94114434942-11"><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b94114434942-12"><span class="crayon-h"> </span><span class="crayon-p"># calculate overall RMSE</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b94114434942-13"><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b94114434942-14"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">row </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b94114434942-15"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">col </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b94114434942-16"><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">[</span><span class="crayon-v">row</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">col</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">[</span><span class="crayon-v">row</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">col</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-cn">2</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b94114434942-17"><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sqrt</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b94114434942-18"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0012 seconds] -->
<p>Running the function will first return the overall RMSE regardless of day, then an array of RMSE scores for each day.</p>
<h3>Train and Test Sets</h3>
<p>We will use the first three years of data for training predictive models and the final year for evaluating models.</p>
<p>The data in a given dataset will be divided into standard weeks. These are weeks that begin on a Sunday and end on a Saturday.</p>
<p>This is a realistic and useful way for using the chosen framing of the model, where the power consumption for the week ahead can be predicted. It is also helpful with modeling, where models can be used to predict a specific day (e.g. Wednesday) or the entire sequence.</p>
<p>We will split the data into standard weeks, working backwards from the test dataset.</p>
<p>The final year of the data is in 2010 and the first Sunday for 2010 was January 3rd. The data ends in mid November 2010 and the closest final Saturday in the data is November 20th. This gives 46 weeks of test data.</p>
<p>The first and last rows of daily data for the test dataset are provided below for confirmation.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80b96513039685" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
2010-01-03,2083.4539999999984,191.61000000000055,350992.12000000034,8703.600000000033,3842.0,4920.0,10074.0,15888.233355799992
...
2010-11-20,2197.006000000004,153.76800000000028,346475.9999999998,9320.20000000002,4367.0,2947.0,11433.0,17869.76663959999</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80b96513039685-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b96513039685-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b96513039685-3">3</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80b96513039685-1">2010-01-03,2083.4539999999984,191.61000000000055,350992.12000000034,8703.600000000033,3842.0,4920.0,10074.0,15888.233355799992</div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b96513039685-2">...</div><div class="crayon-line" id="crayon-5c0c9e4d80b96513039685-3">2010-11-20,2197.006000000004,153.76800000000028,346475.9999999998,9320.20000000002,4367.0,2947.0,11433.0,17869.76663959999</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>The daily data starts in late 2006.</p>
<p>The first Sunday in the dataset is December 17th, which is the second row of data.</p>
<p>Organizing the data into standard weeks gives 159 full standard weeks for training a predictive model.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80b98354867749" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
2006-12-17,3390.46,226.0059999999994,345725.32000000024,14398.59999999998,2033.0,4187.0,13341.0,36946.66673200004
...
2010-01-02,1309.2679999999998,199.54600000000016,352332.8399999997,5489.7999999999865,801.0,298.0,6425.0,14297.133406600002</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80b98354867749-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b98354867749-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b98354867749-3">3</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80b98354867749-1">2006-12-17,3390.46,226.0059999999994,345725.32000000024,14398.59999999998,2033.0,4187.0,13341.0,36946.66673200004</div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b98354867749-2">...</div><div class="crayon-line" id="crayon-5c0c9e4d80b98354867749-3">2010-01-02,1309.2679999999998,199.54600000000016,352332.8399999997,5489.7999999999865,801.0,298.0,6425.0,14297.133406600002</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>The function <em>split_dataset()</em> below splits the daily data into train and test sets and organizes each into standard weeks.</p>
<p>Specific row offsets are used to split the data using knowledge of the dataset. The split datasets are then organized into weekly data using the NumPy <a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.split.html">split() function</a>.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80b9a907752657" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# split a univariate dataset into train/test sets
def split_dataset(data):
	# split into standard weeks
	train, test = data[1:-328], data[-328:-6]
	# restructure into windows of weekly data
	train = array(split(train, len(train)/7))
	test = array(split(test, len(test)/7))
	return train, test</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80b9a907752657-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b9a907752657-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b9a907752657-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b9a907752657-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b9a907752657-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b9a907752657-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b9a907752657-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b9a907752657-8">8</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80b9a907752657-1"><span class="crayon-p"># split a univariate dataset into train/test sets</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b9a907752657-2"><span class="crayon-e">def </span><span class="crayon-e">split_dataset</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b9a907752657-3"><span class="crayon-h"> </span><span class="crayon-p"># split into standard weeks</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b9a907752657-4"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">328</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">328</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">6</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b9a907752657-5"><span class="crayon-h"> </span><span class="crayon-p"># restructure into windows of weekly data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b9a907752657-6"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b9a907752657-7"><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b9a907752657-8"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0006 seconds] -->
<p>We can test this function out by loading the daily dataset and printing the first and last rows of data from both the train and test sets to confirm they match the expectations above.</p>
<p>The complete code example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80b9b356177885" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# split into standard weeks
from numpy import split
from numpy import array
from pandas import read_csv

# split a univariate dataset into train/test sets
def split_dataset(data):
	# split into standard weeks
	train, test = data[1:-328], data[-328:-6]
	# restructure into windows of weekly data
	train = array(split(train, len(train)/7))
	test = array(split(test, len(test)/7))
	return train, test

# load the new file
dataset = read_csv('household_power_consumption_days.csv', header=0, infer_datetime_format=True, parse_dates=['datetime'], index_col=['datetime'])
train, test = split_dataset(dataset.values)
# validate train data
print(train.shape)
print(train[0, 0, 0], train[-1, -1, 0])
# validate test
print(test.shape)
print(test[0, 0, 0], test[-1, -1, 0])</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80b9b356177885-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b9b356177885-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b9b356177885-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b9b356177885-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b9b356177885-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b9b356177885-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b9b356177885-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b9b356177885-8">8</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b9b356177885-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b9b356177885-10">10</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b9b356177885-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b9b356177885-12">12</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b9b356177885-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b9b356177885-14">14</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b9b356177885-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b9b356177885-16">16</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b9b356177885-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b9b356177885-18">18</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b9b356177885-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b9b356177885-20">20</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b9b356177885-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b9b356177885-22">22</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b9b356177885-23">23</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80b9b356177885-1"><span class="crayon-p"># split into standard weeks</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b9b356177885-2"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">split</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b9b356177885-3"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-t">array</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b9b356177885-4"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-v">read_csv</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b9b356177885-5"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b9b356177885-6"><span class="crayon-p"># split a univariate dataset into train/test sets</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b9b356177885-7"><span class="crayon-e">def </span><span class="crayon-e">split_dataset</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b9b356177885-8"><span class="crayon-h"> </span><span class="crayon-p"># split into standard weeks</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b9b356177885-9"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">328</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">328</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">6</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b9b356177885-10"><span class="crayon-h"> </span><span class="crayon-p"># restructure into windows of weekly data</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b9b356177885-11"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b9b356177885-12"><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b9b356177885-13"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b9b356177885-14"> </div><div class="crayon-line" id="crayon-5c0c9e4d80b9b356177885-15"><span class="crayon-p"># load the new file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b9b356177885-16"><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'household_power_consumption_days.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">infer_datetime_format</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">parse_dates</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'datetime'</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index_col</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'datetime'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b9b356177885-17"><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">split_dataset</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-v">values</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b9b356177885-18"><span class="crayon-p"># validate train data</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b9b356177885-19"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b9b356177885-20"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b9b356177885-21"><span class="crayon-p"># validate test</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b9b356177885-22"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80b9b356177885-23"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0017 seconds] -->
<p>Running the example shows that indeed the train dataset has 159 weeks of data, whereas the test dataset has 46 weeks.</p>
<p>We can see that the total active power for the train and test dataset for the first and last rows match the data for the specific dates that we defined as the bounds on the standard weeks for each set.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80b9d588476910" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
(159, 7, 8)
3390.46 1309.2679999999998
(46, 7, 8)
2083.4539999999984 2197.006000000004</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80b9d588476910-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b9d588476910-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b9d588476910-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b9d588476910-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80b9d588476910-1">(159, 7, 8)</div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b9d588476910-2">3390.46 1309.2679999999998</div><div class="crayon-line" id="crayon-5c0c9e4d80b9d588476910-3">(46, 7, 8)</div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b9d588476910-4">2083.4539999999984 2197.006000000004</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p></p>
<h3>Walk-Forward Validation</h3>
<p>Models will be evaluated using a scheme called <a href="https://machinelearningmastery.com/backtest-machine-learning-models-time-series-forecasting/">walk-forward validation</a>.</p>
<p>This is where a model is required to make a one week prediction, then the actual data for that week is made available to the model so that it can be used as the basis for making a prediction on the subsequent week. This is both realistic for how the model may be used in practice and beneficial to the models allowing them to make use of the best available data.</p>
<p>We can demonstrate this below with separation of input data and output/predicted data.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80b9f106957836" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Input, 						Predict
[Week1]						Week2
[Week1 + Week2]				Week3
[Week1 + Week2 + Week3]		Week4
...</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80b9f106957836-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b9f106957836-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b9f106957836-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80b9f106957836-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80b9f106957836-5">5</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80b9f106957836-1">Input, 						Predict</div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b9f106957836-2">[Week1]						Week2</div><div class="crayon-line" id="crayon-5c0c9e4d80b9f106957836-3">[Week1 + Week2]				Week3</div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80b9f106957836-4">[Week1 + Week2 + Week3]		Week4</div><div class="crayon-line" id="crayon-5c0c9e4d80b9f106957836-5">...</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>The walk-forward validation approach to evaluating predictive models on this dataset is provided below named <em>evaluate_model()</em>.</p>
<p>The train and test datasets in standard-week format are provided to the function as arguments. An additional argument n_input is provided that is used to define the number of prior observations that the model will use as input in order to make a prediction.</p>
<p>Two new functions are called: one to build a model from the training data called <em>build_model()</em> and another that uses the model to make forecasts for each new standard week called <em>forecast()</em>. These will be covered in subsequent sections.</p>
<p>We are working with neural networks, and as such, they are generally slow to train but fast to evaluate. This means that the preferred usage of the models is to build them once on historical data and to use them to forecast each step of the walk-forward validation. The models are static (i.e. not updated) during their evaluation.</p>
<p>This is different to other models that are faster to train where a model may be re-fit or updated each step of the walk-forward validation as new data is made available. With sufficient resources, it is possible to use neural networks this way, but we will not in this tutorial.</p>
<p>The complete <em>evaluate_model()</em> function is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80ba1836171987" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# evaluate a single model
def evaluate_model(train, test, n_input):
	# fit model
	model = build_model(train, n_input)
	# history is a list of weekly data
	history = [x for x in train]
	# walk-forward validation over each week
	predictions = list()
	for i in range(len(test)):
		# predict the week
		yhat_sequence = forecast(model, history, n_input)
		# store the predictions
		predictions.append(yhat_sequence)
		# get real observation and add to history for predicting the next week
		history.append(test[i, :])
	# evaluate predictions days for each week
	predictions = array(predictions)
	score, scores = evaluate_forecasts(test[:, :, 0], predictions)
	return score, scores</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80ba1836171987-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80ba1836171987-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80ba1836171987-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80ba1836171987-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80ba1836171987-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80ba1836171987-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80ba1836171987-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80ba1836171987-8">8</div><div class="crayon-num" data-line="crayon-5c0c9e4d80ba1836171987-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80ba1836171987-10">10</div><div class="crayon-num" data-line="crayon-5c0c9e4d80ba1836171987-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80ba1836171987-12">12</div><div class="crayon-num" data-line="crayon-5c0c9e4d80ba1836171987-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80ba1836171987-14">14</div><div class="crayon-num" data-line="crayon-5c0c9e4d80ba1836171987-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80ba1836171987-16">16</div><div class="crayon-num" data-line="crayon-5c0c9e4d80ba1836171987-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80ba1836171987-18">18</div><div class="crayon-num" data-line="crayon-5c0c9e4d80ba1836171987-19">19</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80ba1836171987-1"><span class="crayon-p"># evaluate a single model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80ba1836171987-2"><span class="crayon-e">def </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80ba1836171987-3"><span class="crayon-h"> </span><span class="crayon-p"># fit model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80ba1836171987-4"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">build_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80ba1836171987-5"><span class="crayon-h"> </span><span class="crayon-p"># history is a list of weekly data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80ba1836171987-6"><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-i">x</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">x</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80ba1836171987-7"><span class="crayon-h"> </span><span class="crayon-p"># walk-forward validation over each week</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80ba1836171987-8"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80ba1836171987-9"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80ba1836171987-10"><span class="crayon-h"> </span><span class="crayon-p"># predict the week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80ba1836171987-11"><span class="crayon-h"> </span><span class="crayon-v">yhat_sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">forecast</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80ba1836171987-12"><span class="crayon-h"> </span><span class="crayon-p"># store the predictions</span></div><div class="crayon-line" id="crayon-5c0c9e4d80ba1836171987-13"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat_sequence</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80ba1836171987-14"><span class="crayon-h"> </span><span class="crayon-p"># get real observation and add to history for predicting the next week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80ba1836171987-15"><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80ba1836171987-16"><span class="crayon-h"> </span><span class="crayon-p"># evaluate predictions days for each week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80ba1836171987-17"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">predictions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80ba1836171987-18"><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">evaluate_forecasts</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80ba1836171987-19"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0010 seconds] -->
<p>Once we have the evaluation for a model, we can summarize the performance.</p>
<p>The function below named <em>summarize_scores()</em> will display the performance of a model as a single line for easy comparison with other models.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80ba3500705392" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# summarize scores
def summarize_scores(name, score, scores):
	s_scores = ', '.join(['%.1f' % s for s in scores])
	print('%s: [%.3f] %s' % (name, score, s_scores))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80ba3500705392-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80ba3500705392-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80ba3500705392-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80ba3500705392-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80ba3500705392-1"><span class="crayon-p"># summarize scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80ba3500705392-2"><span class="crayon-e">def </span><span class="crayon-e">summarize_scores</span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80ba3500705392-3"><span class="crayon-h"> </span><span class="crayon-v">s_scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">', '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-s">'%.1f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80ba3500705392-4"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'%s: [%.3f] %s'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">s_scores</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0004 seconds] -->
<p>We now have all of the elements to begin evaluating predictive models on the dataset.</p>
<h2>LSTMs for Multi-Step Forecasting</h2>
<p>Recurrent neural networks, or RNNs, are specifically designed to work, learn, and predict sequence data.</p>
<p>A recurrent neural network is a neural network where the output of the network from one time step is provided as an input in the subsequent time step. This allows the model to make a decision as to what to predict based on both the input for the current time step and direct knowledge of what was output in the prior time step.</p>
<p>Perhaps the most successful and widely used RNN is the long short-term memory network, or LSTM for short. It is successful because it overcomes the challenges involved in training a recurrent neural network, resulting in stable models. In addition to harnessing the recurrent connection of the outputs from the prior time step, LSTMs also have an internal memory that operates like a local variable, allowing them to accumulate state over the input sequence.</p>
<p>For more information about Recurrent Neural Networks, see the post:</p>
<ul>
<li><a href="https://machinelearningmastery.com/crash-course-recurrent-neural-networks-deep-learning/">Crash Course in Recurrent Neural Networks for Deep Learning</a></li>
</ul>
<p>For more information about Long Short-Term Memory networks, see the post:</p>
<ul>
<li><a href="https://machinelearningmastery.com/gentle-introduction-long-short-term-memory-networks-experts/">A Gentle Introduction to Long Short-Term Memory Networks by the Experts</a></li>
</ul>
<p>LSTMs offer a number of benefits when it comes to multi-step time series forecasting; they are:</p>
<ul>
<li><strong>Native Support for Sequences</strong>. LSTMs are a type of recurrent network, and as such are designed to take sequence data as input, unlike other models where lag observations must be presented as input features.</li>
<li><strong>Multivariate Inputs</strong>. LSTMs directly support multiple parallel input sequences for multivariate inputs, unlike other models where multivariate inputs are presented in a flat structure.</li>
<li><strong>Vector Output</strong>. Like other neural networks, LSTMs are able to map input data directly to an output vector that may represent multiple output time steps.</li>
</ul>
<p>Further, specialized architectures have been developed that are specifically designed to make multi-step sequence predictions, generally referred to as sequence-to-sequence prediction, or seq2seq for short. This is useful as multi-step time series forecasting is a type of seq2seq prediction.</p>
<p>An example of a recurrent neural network architecture designed for seq2seq problems is the encoder-decoder LSTM.</p>
<p>An encoder-decoder LSTM is a model comprised of two sub-models: one called the encoder that reads the input sequences and compresses it to a fixed-length internal representation, and an output model called the decoder that interprets the internal representation and uses it to predict the output sequence.</p>
<p>The encoder-decoder approach to sequence prediction has proven much more effective than outputting a vector directly and is the preferred approach.</p>
<p>Generally, LSTMs have been found to not be very effective at auto-regression type problems. These are problems where forecasting the next time step is a function of recent time steps.</p>
<p>For more on this issue, see the post:</p>
<ul>
<li><a href="https://machinelearningmastery.com/suitability-long-short-term-memory-networks-time-series-forecasting/">On the Suitability of LSTMs for Time Series Forecasting</a></li>
</ul>
<p>One-dimensional convolutional neural networks, or CNNs, have proven effective at automatically learning features from input sequences.</p>
<p>A popular approach has been to combine CNNs with LSTMs, where the CNN is as an encoder to learn features from sub-sequences of input data which are provided as time steps to an LSTM. This architecture is called a <a href="https://machinelearningmastery.com/cnn-long-short-term-memory-networks/">CNN-LSTM</a>.</p>
<p>For more information on this architecture, see the post:</p>
<ul>
<li><a href="https://machinelearningmastery.com/cnn-long-short-term-memory-networks/">CNN Long Short-Term Memory Networks</a></li>
</ul>
<p>A power variation on the CNN LSTM architecture is the ConvLSTM that uses the convolutional reading of input subsequences directly within an LSTM’s units. This approach has proven very effective for time series classification and can be adapted for use in multi-step time series forecasting.</p>
<p>In this tutorial, we will explore a suite of LSTM architectures for multi-step time series forecasting. Specifically, we will look at how to develop the following models:</p>
<ul>
<li><strong>LSTM</strong> model with vector output for multi-step forecasting with univariate input data.</li>
<li><strong>Encoder-Decoder LSTM</strong> model for multi-step forecasting with univariate input data.</li>
<li><strong>Encoder-Decoder LSTM</strong> model for multi-step forecasting with multivariate input data.</li>
<li><strong>CNN-LSTM Encoder-Decoder</strong> model for multi-step forecasting with univariate input data.</li>
<li><strong>ConvLSTM Encoder-Decoder</strong> model for multi-step forecasting with univariate input data.</li>
</ul>
<p>The models will be developed and demonstrated on the household power prediction problem. A model is considered skillful if it achieves performance better than a naive model, which is an overall RMSE of about 465 kilowatts across a seven day forecast.</p>
<p>We will not focus on the tuning of these models to achieve optimal performance; instead, we will stop short at skillful models as compared to a naive forecast. The chosen structures and hyperparameters are chosen with a little trial and error. The scores should be taken as just an example rather than a study of the optimal model or configuration for the problem.</p>
<p>Given the stochastic nature of the models, it is <a href="https://machinelearningmastery.com/evaluate-skill-deep-learning-models/">good practice</a> to evaluate a given model multiple times and report the mean performance on a test dataset. In the interest of brevity and keeping the code simple, we will instead present single-runs of models in this tutorial.</p>
<p>We cannot know which approach will be the most effective for a given multi-step forecasting problem. It is a good idea to explore a suite of methods in order to discover what works best on your specific dataset.</p>
<h2>LSTM Model With Univariate Input and Vector Output</h2>
<p>We will start off by developing a simple or vanilla LSTM model that reads in a sequence of days of total daily power consumption and predicts a vector output of the next standard week of daily power consumption.</p>
<p>This will provide the foundation for the more elaborate models developed in subsequent sections.</p>
<p>The number of prior days used as input defines the one-dimensional (1D) subsequence of data that the LSTM will read and learn to extract features. Some ideas on the size and nature of this input include:</p>
<ul>
<li>All prior days, up to years worth of data.</li>
<li>The prior seven days.</li>
<li>The prior two weeks.</li>
<li>The prior one month.</li>
<li>The prior one year.</li>
<li>The prior week and the week to be predicted from one year ago.</li>
</ul>
<p>There is no right answer; instead, each approach and more can be tested and the performance of the model can be used to choose the nature of the input that results in the best model performance.</p>
<p>These choices define a few things:</p>
<ul>
<li>How the training data must be prepared in order to fit the model.</li>
<li>How the test data must be prepared in order to evaluate the model.</li>
<li>How to use the model to make predictions with a final model in the future.</li>
</ul>
<p>A good starting point would be to use the prior seven days.</p>
<p>An LSTM model expects data to have the shape:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80ba6080101384" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
[samples, timesteps, features]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80ba6080101384-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80ba6080101384-1">[samples, timesteps, features]</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>One sample will be comprised of seven time steps with one feature for the seven days of total daily power consumed.</p>
<p>The training dataset has 159 weeks of data, so the shape of the training dataset would be:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80ba9338729700" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
[159, 7, 1]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80ba9338729700-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80ba9338729700-1">[159, 7, 1]</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>This is a good start. The data in this format would use the prior standard week to predict the next standard week. A problem is that 159 instances is not a lot to train a neural network.</p>
<p>A way to create a lot more training data is to change the problem during training to predict the next seven days given the prior seven days, regardless of the standard week.</p>
<p>This only impacts the training data, and the test problem remains the same: predict the daily power consumption for the next standard week given the prior standard week.</p>
<p>This will require a little preparation of the training data.</p>
<p>The training data is provided in standard weeks with eight variables, specifically in the shape [<em>159, 7, 8</em>]. The first step is to flatten the data so that we have eight time series sequences.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bab270182380" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# flatten data
data = train.reshape((train.shape[0]*train.shape[1], train.shape[2]))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bab270182380-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bab270182380-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bab270182380-1"><span class="crayon-p"># flatten data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bab270182380-2"><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-o">*</span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>We then need to iterate over the time steps and divide the data into overlapping windows; each iteration moves along one time step and predicts the subsequent seven days.</p>
<p>For example:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bad986587538" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Input, Output
[d01, d02, d03, d04, d05, d06, d07], [d08, d09, d10, d11, d12, d13, d14]
[d02, d03, d04, d05, d06, d07, d08], [d09, d10, d11, d12, d13, d14, d15]
...</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bad986587538-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bad986587538-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bad986587538-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bad986587538-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bad986587538-1">Input, Output</div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bad986587538-2">[d01, d02, d03, d04, d05, d06, d07], [d08, d09, d10, d11, d12, d13, d14]</div><div class="crayon-line" id="crayon-5c0c9e4d80bad986587538-3">[d02, d03, d04, d05, d06, d07, d08], [d09, d10, d11, d12, d13, d14, d15]</div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bad986587538-4">...</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>We can do this by keeping track of start and end indexes for the inputs and outputs as we iterate across the length of the flattened data in terms of time steps.</p>
<p>We can also do this in a way where the number of inputs and outputs are parameterized (e.g. <em>n_input</em>, <em>n_out</em>) so that you can experiment with different values or adapt it for your own problem.</p>
<p>Below is a function named <em>to_supervised()</em> that takes a list of weeks (history) and the number of time steps to use as inputs and outputs and returns the data in the overlapping moving window format.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80baf980596423" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# convert history into inputs and outputs
def to_supervised(train, n_input, n_out=7):
	# flatten data
	data = train.reshape((train.shape[0]*train.shape[1], train.shape[2]))
	X, y = list(), list()
	in_start = 0
	# step over the entire history one time step at a time
	for _ in range(len(data)):
		# define the end of the input sequence
		in_end = in_start + n_input
		out_end = in_end + n_out
		# ensure we have enough data for this instance
		if out_end &lt; len(data):
			x_input = data[in_start:in_end, 0]
			x_input = x_input.reshape((len(x_input), 1))
			X.append(x_input)
			y.append(data[in_end:out_end, 0])
		# move along one time step
		in_start += 1
	return array(X), array(y)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80baf980596423-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80baf980596423-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80baf980596423-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80baf980596423-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80baf980596423-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80baf980596423-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80baf980596423-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80baf980596423-8">8</div><div class="crayon-num" data-line="crayon-5c0c9e4d80baf980596423-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80baf980596423-10">10</div><div class="crayon-num" data-line="crayon-5c0c9e4d80baf980596423-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80baf980596423-12">12</div><div class="crayon-num" data-line="crayon-5c0c9e4d80baf980596423-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80baf980596423-14">14</div><div class="crayon-num" data-line="crayon-5c0c9e4d80baf980596423-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80baf980596423-16">16</div><div class="crayon-num" data-line="crayon-5c0c9e4d80baf980596423-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80baf980596423-18">18</div><div class="crayon-num" data-line="crayon-5c0c9e4d80baf980596423-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80baf980596423-20">20</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80baf980596423-1"><span class="crayon-p"># convert history into inputs and outputs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80baf980596423-2"><span class="crayon-e">def </span><span class="crayon-e">to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_out</span><span class="crayon-o">=</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80baf980596423-3"><span class="crayon-h"> </span><span class="crayon-p"># flatten data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80baf980596423-4"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-o">*</span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80baf980596423-5"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80baf980596423-6"><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line" id="crayon-5c0c9e4d80baf980596423-7"><span class="crayon-h"> </span><span class="crayon-p"># step over the entire history one time step at a time</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80baf980596423-8"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80baf980596423-9"><span class="crayon-h"> </span><span class="crayon-p"># define the end of the input sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80baf980596423-10"><span class="crayon-h"> </span><span class="crayon-v">in_end</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">n_input</span></div><div class="crayon-line" id="crayon-5c0c9e4d80baf980596423-11"><span class="crayon-e"> </span><span class="crayon-v">out_end</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">in_end</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">n_out</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80baf980596423-12"><span class="crayon-h"> </span><span class="crayon-p"># ensure we have enough data for this instance</span></div><div class="crayon-line" id="crayon-5c0c9e4d80baf980596423-13"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">out_end</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80baf980596423-14"><span class="crayon-h"> </span><span class="crayon-v">x_input</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-v">in_start</span><span class="crayon-o">:</span><span class="crayon-v">in_end</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80baf980596423-15"><span class="crayon-h"> </span><span class="crayon-v">x_input</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">x_input</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">x_input</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80baf980596423-16"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">x_input</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80baf980596423-17"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-v">in_end</span><span class="crayon-o">:</span><span class="crayon-v">out_end</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80baf980596423-18"><span class="crayon-h"> </span><span class="crayon-p"># move along one time step</span></div><div class="crayon-line" id="crayon-5c0c9e4d80baf980596423-19"><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80baf980596423-20"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0016 seconds] -->
<p>When we run this function on the entire training dataset, we transform 159 samples into 1,099; specifically, the transformed dataset has the shapes <em>X=[1099, 7, 1]</em> and <em>y=[1099, 7].</em></p>
<p>Next, we can define and fit the LSTM model on the training data.</p>
<p>This multi-step time series forecasting problem is an autoregression. That means it is likely best modeled where that the next seven days is some function of observations at prior time steps. This and the relatively small amount of data means that a small model is required.</p>
<p>We will develop a model with a single hidden LSTM layer with 200 units. The number of units in the hidden layer is unrelated to the number of time steps in the input sequences. The LSTM layer is followed by a fully connected layer with 200 nodes that will interpret the features learned by the LSTM layer. Finally, an output layer will directly predict a vector with seven elements, one for each day in the output sequence.</p>
<p>We will use the mean squared error loss function as it is a good match for our chosen error metric of RMSE. We will use the efficient <a href="https://machinelearningmastery.com/adam-optimization-algorithm-for-deep-learning/">Adam implementation</a> of stochastic gradient descent and fit the model for 70 epochs with a batch size of 16.</p>
<p>The small batch size and the stochastic nature of the algorithm means that the same model will learn a slightly different mapping of inputs to outputs each time it is trained. This means results may vary when the model is evaluated. You can try running the model multiple times and calculate an average of model performance.</p>
<p>The <em>build_model()</em> below prepares the training data, defines the model, and fits the model on the training data, returning the fit model ready for making predictions.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bb0171269207" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# train the model
def build_model(train, n_input):
	# prepare data
	train_x, train_y = to_supervised(train, n_input)
	# define parameters
	verbose, epochs, batch_size = 0, 70, 16
	n_timesteps, n_features, n_outputs = train_x.shape[1], train_x.shape[2], train_y.shape[1]
	# define model
	model = Sequential()
	model.add(LSTM(200, activation='relu', input_shape=(n_timesteps, n_features)))
	model.add(Dense(100, activation='relu'))
	model.add(Dense(n_outputs))
	model.compile(loss='mse', optimizer='adam')
	# fit network
	model.fit(train_x, train_y, epochs=epochs, batch_size=batch_size, verbose=verbose)
	return model</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bb0171269207-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bb0171269207-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bb0171269207-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bb0171269207-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bb0171269207-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bb0171269207-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bb0171269207-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bb0171269207-8">8</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bb0171269207-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bb0171269207-10">10</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bb0171269207-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bb0171269207-12">12</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bb0171269207-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bb0171269207-14">14</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bb0171269207-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bb0171269207-16">16</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bb0171269207-1"><span class="crayon-p"># train the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bb0171269207-2"><span class="crayon-e">def </span><span class="crayon-e">build_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bb0171269207-3"><span class="crayon-h"> </span><span class="crayon-p"># prepare data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bb0171269207-4"><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bb0171269207-5"><span class="crayon-h"> </span><span class="crayon-p"># define parameters</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bb0171269207-6"><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">70</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">16</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bb0171269207-7"><span class="crayon-h"> </span><span class="crayon-v">n_timesteps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bb0171269207-8"><span class="crayon-h"> </span><span class="crayon-p"># define model</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bb0171269207-9"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bb0171269207-10"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">200</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bb0171269207-11"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">100</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bb0171269207-12"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">n_outputs</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bb0171269207-13"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'mse'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bb0171269207-14"><span class="crayon-h"> </span><span class="crayon-p"># fit network</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bb0171269207-15"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">train_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-v">epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-v">verbose</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bb0171269207-16"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0012 seconds] -->
<p>Now that we know how to fit the model, we can look at how the model can be used to make a prediction.</p>
<p>Generally, the model expects data to have the same three dimensional shape when making a prediction.</p>
<p>In this case, the expected shape of an input pattern is one sample, seven days of one feature for the daily power consumed:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bb3942839660" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
[1, 7, 1]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bb3942839660-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bb3942839660-1">[1, 7, 1]</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>Data must have this shape when making predictions for the test set and when a final model is being used to make predictions in the future. If you change the number if input days to 14, then the shape of the training data and the shape of new samples when making predictions must be changed accordingly to have 14 time steps. It is a modeling choice that you must carry forward when using the model.</p>
<p>We are using walk-forward validation to evaluate the model as described in the previous section.</p>
<p>This means that we have the observations available for the prior week in order to predict the coming week. These are collected into an array of standard weeks called history.</p>
<p>In order to predict the next standard week, we need to retrieve the last days of observations. As with the training data, we must first flatten the history data to remove the weekly structure so that we end up with eight parallel time series.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bb5606943838" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# flatten data
data = data.reshape((data.shape[0]*data.shape[1], data.shape[2]))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bb5606943838-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bb5606943838-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bb5606943838-1"><span class="crayon-p"># flatten data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bb5606943838-2"><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-o">*</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>Next, we need to retrieve the last seven days of daily total power consumed (feature index 0).</p>
<p>We will parameterize this as we did for the training data so that the number of prior days used as input by the model can be modified in the future.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bb6385127160" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# retrieve last observations for input data
input_x = data[-n_input:, 0]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bb6385127160-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bb6385127160-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bb6385127160-1"><span class="crayon-p"># retrieve last observations for input data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bb6385127160-2"><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-v">n_input</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Next, we reshape the input into the expected three-dimensional structure.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bb8877111467" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# reshape into [1, n_input, 1]
input_x = input_x.reshape((1, len(input_x), 1))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bb8877111467-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bb8877111467-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bb8877111467-1"><span class="crayon-p"># reshape into [1, n_input, 1]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bb8877111467-2"><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">input_x</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>We then make a prediction using the fit model and the input data and retrieve the vector of seven days of output.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bba491031039" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# forecast the next week
yhat = model.predict(input_x, verbose=0)
# we only want the vector forecast
yhat = yhat[0]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bba491031039-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bba491031039-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bba491031039-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bba491031039-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bba491031039-1"><span class="crayon-p"># forecast the next week</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bba491031039-2"><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">input_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bba491031039-3"><span class="crayon-p"># we only want the vector forecast</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bba491031039-4"><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>The <em>forecast()</em> function below implements this and takes as arguments the model fit on the training dataset, the history of data observed so far, and the number of input time steps expected by the model.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bbb414863906" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# make a forecast
def forecast(model, history, n_input):
	# flatten data
	data = array(history)
	data = data.reshape((data.shape[0]*data.shape[1], data.shape[2]))
	# retrieve last observations for input data
	input_x = data[-n_input:, 0]
	# reshape into [1, n_input, 1]
	input_x = input_x.reshape((1, len(input_x), 1))
	# forecast the next week
	yhat = model.predict(input_x, verbose=0)
	# we only want the vector forecast
	yhat = yhat[0]
	return yhat</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bbb414863906-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbb414863906-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbb414863906-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbb414863906-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbb414863906-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbb414863906-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbb414863906-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbb414863906-8">8</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbb414863906-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbb414863906-10">10</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbb414863906-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbb414863906-12">12</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbb414863906-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbb414863906-14">14</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bbb414863906-1"><span class="crayon-p"># make a forecast</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbb414863906-2"><span class="crayon-e">def </span><span class="crayon-e">forecast</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbb414863906-3"><span class="crayon-h"> </span><span class="crayon-p"># flatten data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbb414863906-4"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">history</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbb414863906-5"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-o">*</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbb414863906-6"><span class="crayon-h"> </span><span class="crayon-p"># retrieve last observations for input data</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbb414863906-7"><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-v">n_input</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbb414863906-8"><span class="crayon-h"> </span><span class="crayon-p"># reshape into [1, n_input, 1]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbb414863906-9"><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">input_x</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbb414863906-10"><span class="crayon-h"> </span><span class="crayon-p"># forecast the next week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbb414863906-11"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">input_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbb414863906-12"><span class="crayon-h"> </span><span class="crayon-p"># we only want the vector forecast</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbb414863906-13"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbb414863906-14"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0009 seconds] -->
<p>That’s it; we now have everything we need to make multi-step time series forecasts with an LSTM model on the daily total power consumed univariate dataset.</p>
<p>We can tie all of this together. The complete example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bbd272608574" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# univariate multi-step lstm
from math import sqrt
from numpy import split
from numpy import array
from pandas import read_csv
from sklearn.metrics import mean_squared_error
from matplotlib import pyplot
from keras.models import Sequential
from keras.layers import Dense
from keras.layers import Flatten
from keras.layers import LSTM

# split a univariate dataset into train/test sets
def split_dataset(data):
	# split into standard weeks
	train, test = data[1:-328], data[-328:-6]
	# restructure into windows of weekly data
	train = array(split(train, len(train)/7))
	test = array(split(test, len(test)/7))
	return train, test

# evaluate one or more weekly forecasts against expected values
def evaluate_forecasts(actual, predicted):
	scores = list()
	# calculate an RMSE score for each day
	for i in range(actual.shape[1]):
		# calculate mse
		mse = mean_squared_error(actual[:, i], predicted[:, i])
		# calculate rmse
		rmse = sqrt(mse)
		# store
		scores.append(rmse)
	# calculate overall RMSE
	s = 0
	for row in range(actual.shape[0]):
		for col in range(actual.shape[1]):
			s += (actual[row, col] - predicted[row, col])**2
	score = sqrt(s / (actual.shape[0] * actual.shape[1]))
	return score, scores

# summarize scores
def summarize_scores(name, score, scores):
	s_scores = ', '.join(['%.1f' % s for s in scores])
	print('%s: [%.3f] %s' % (name, score, s_scores))

# convert history into inputs and outputs
def to_supervised(train, n_input, n_out=7):
	# flatten data
	data = train.reshape((train.shape[0]*train.shape[1], train.shape[2]))
	X, y = list(), list()
	in_start = 0
	# step over the entire history one time step at a time
	for _ in range(len(data)):
		# define the end of the input sequence
		in_end = in_start + n_input
		out_end = in_end + n_out
		# ensure we have enough data for this instance
		if out_end &lt; len(data):
			x_input = data[in_start:in_end, 0]
			x_input = x_input.reshape((len(x_input), 1))
			X.append(x_input)
			y.append(data[in_end:out_end, 0])
		# move along one time step
		in_start += 1
	return array(X), array(y)

# train the model
def build_model(train, n_input):
	# prepare data
	train_x, train_y = to_supervised(train, n_input)
	# define parameters
	verbose, epochs, batch_size = 0, 70, 16
	n_timesteps, n_features, n_outputs = train_x.shape[1], train_x.shape[2], train_y.shape[1]
	# define model
	model = Sequential()
	model.add(LSTM(200, activation='relu', input_shape=(n_timesteps, n_features)))
	model.add(Dense(100, activation='relu'))
	model.add(Dense(n_outputs))
	model.compile(loss='mse', optimizer='adam')
	# fit network
	model.fit(train_x, train_y, epochs=epochs, batch_size=batch_size, verbose=verbose)
	return model

# make a forecast
def forecast(model, history, n_input):
	# flatten data
	data = array(history)
	data = data.reshape((data.shape[0]*data.shape[1], data.shape[2]))
	# retrieve last observations for input data
	input_x = data[-n_input:, 0]
	# reshape into [1, n_input, 1]
	input_x = input_x.reshape((1, len(input_x), 1))
	# forecast the next week
	yhat = model.predict(input_x, verbose=0)
	# we only want the vector forecast
	yhat = yhat[0]
	return yhat

# evaluate a single model
def evaluate_model(train, test, n_input):
	# fit model
	model = build_model(train, n_input)
	# history is a list of weekly data
	history = [x for x in train]
	# walk-forward validation over each week
	predictions = list()
	for i in range(len(test)):
		# predict the week
		yhat_sequence = forecast(model, history, n_input)
		# store the predictions
		predictions.append(yhat_sequence)
		# get real observation and add to history for predicting the next week
		history.append(test[i, :])
	# evaluate predictions days for each week
	predictions = array(predictions)
	score, scores = evaluate_forecasts(test[:, :, 0], predictions)
	return score, scores

# load the new file
dataset = read_csv('household_power_consumption_days.csv', header=0, infer_datetime_format=True, parse_dates=['datetime'], index_col=['datetime'])
# split into train and test
train, test = split_dataset(dataset.values)
# evaluate model and get scores
n_input = 7
score, scores = evaluate_model(train, test, n_input)
# summarize scores
summarize_scores('lstm', score, scores)
# plot scores
days = ['sun', 'mon', 'tue', 'wed', 'thr', 'fri', 'sat']
pyplot.plot(days, scores, marker='o', label='lstm')
pyplot.show()</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-8">8</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-10">10</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-12">12</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-14">14</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-16">16</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-18">18</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-20">20</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-22">22</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-24">24</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-26">26</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-28">28</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-30">30</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-32">32</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-34">34</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-36">36</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-38">38</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-40">40</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-42">42</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-44">44</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-46">46</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-48">48</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-50">50</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-52">52</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-54">54</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-56">56</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-58">58</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-60">60</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-62">62</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-64">64</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-66">66</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-68">68</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-70">70</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-72">72</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-74">74</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-76">76</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-78">78</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-80">80</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-82">82</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-84">84</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-86">86</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-88">88</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-90">90</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-92">92</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-94">94</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-96">96</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-98">98</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-100">100</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-101">101</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-102">102</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-103">103</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-104">104</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-105">105</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-106">106</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-107">107</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-108">108</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-109">109</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-110">110</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-111">111</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-112">112</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-113">113</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-114">114</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-115">115</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-116">116</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-117">117</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-118">118</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-119">119</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-120">120</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-121">121</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-122">122</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-123">123</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-124">124</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-125">125</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-126">126</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-127">127</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-128">128</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-129">129</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bbd272608574-130">130</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bbd272608574-131">131</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-1"><span class="crayon-p"># univariate multi-step lstm</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-2"><span class="crayon-e">from </span><span class="crayon-e">math </span><span class="crayon-e">import </span><span class="crayon-e">sqrt</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-3"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">split</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-4"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-t">array</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-5"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">read_csv</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-6"><span class="crayon-e">from </span><span class="crayon-v">sklearn</span><span class="crayon-sy">.</span><span class="crayon-e">metrics </span><span class="crayon-e">import </span><span class="crayon-e">mean_squared_error</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-7"><span class="crayon-e">from </span><span class="crayon-e">matplotlib </span><span class="crayon-e">import </span><span class="crayon-e">pyplot</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-8"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-e">Sequential</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-9"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Dense</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-10"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Flatten</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-11"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-v">LSTM</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-12"> </div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-13"><span class="crayon-p"># split a univariate dataset into train/test sets</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-14"><span class="crayon-e">def </span><span class="crayon-e">split_dataset</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-15"><span class="crayon-h"> </span><span class="crayon-p"># split into standard weeks</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-16"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">328</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">328</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">6</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-17"><span class="crayon-h"> </span><span class="crayon-p"># restructure into windows of weekly data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-18"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-19"><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-20"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-21"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-22"><span class="crayon-p"># evaluate one or more weekly forecasts against expected values</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-23"><span class="crayon-e">def </span><span class="crayon-e">evaluate_forecasts</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-24"><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-25"><span class="crayon-h"> </span><span class="crayon-p"># calculate an RMSE score for each day</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-26"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-27"><span class="crayon-h"> </span><span class="crayon-p"># calculate mse</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-28"><span class="crayon-h"> </span><span class="crayon-v">mse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">mean_squared_error</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-29"><span class="crayon-h"> </span><span class="crayon-p"># calculate rmse</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-30"><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sqrt</span><span class="crayon-sy">(</span><span class="crayon-v">mse</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-31"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-32"><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-33"><span class="crayon-h"> </span><span class="crayon-p"># calculate overall RMSE</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-34"><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-35"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">row </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-36"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">col </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-37"><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">[</span><span class="crayon-v">row</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">col</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">[</span><span class="crayon-v">row</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">col</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-cn">2</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-38"><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sqrt</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-39"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-40"> </div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-41"><span class="crayon-p"># summarize scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-42"><span class="crayon-e">def </span><span class="crayon-e">summarize_scores</span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-43"><span class="crayon-h"> </span><span class="crayon-v">s_scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">', '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-s">'%.1f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-44"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'%s: [%.3f] %s'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">s_scores</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-45"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-46"><span class="crayon-p"># convert history into inputs and outputs</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-47"><span class="crayon-e">def </span><span class="crayon-e">to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_out</span><span class="crayon-o">=</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-48"><span class="crayon-h"> </span><span class="crayon-p"># flatten data</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-49"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-o">*</span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-50"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-51"><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-52"><span class="crayon-h"> </span><span class="crayon-p"># step over the entire history one time step at a time</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-53"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-54"><span class="crayon-h"> </span><span class="crayon-p"># define the end of the input sequence</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-55"><span class="crayon-h"> </span><span class="crayon-v">in_end</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">n_input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-56"><span class="crayon-e"> </span><span class="crayon-v">out_end</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">in_end</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">n_out</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-57"><span class="crayon-h"> </span><span class="crayon-p"># ensure we have enough data for this instance</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-58"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">out_end</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-59"><span class="crayon-h"> </span><span class="crayon-v">x_input</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-v">in_start</span><span class="crayon-o">:</span><span class="crayon-v">in_end</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-60"><span class="crayon-h"> </span><span class="crayon-v">x_input</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">x_input</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">x_input</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-61"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">x_input</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-62"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-v">in_end</span><span class="crayon-o">:</span><span class="crayon-v">out_end</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-63"><span class="crayon-h"> </span><span class="crayon-p"># move along one time step</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-64"><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-65"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-66"> </div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-67"><span class="crayon-p"># train the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-68"><span class="crayon-e">def </span><span class="crayon-e">build_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-69"><span class="crayon-h"> </span><span class="crayon-p"># prepare data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-70"><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-71"><span class="crayon-h"> </span><span class="crayon-p"># define parameters</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-72"><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">70</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">16</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-73"><span class="crayon-h"> </span><span class="crayon-v">n_timesteps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-74"><span class="crayon-h"> </span><span class="crayon-p"># define model</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-75"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-76"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">200</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-77"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">100</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-78"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">n_outputs</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-79"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'mse'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-80"><span class="crayon-h"> </span><span class="crayon-p"># fit network</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-81"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">train_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-v">epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-v">verbose</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-82"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-83"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-84"><span class="crayon-p"># make a forecast</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-85"><span class="crayon-e">def </span><span class="crayon-e">forecast</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-86"><span class="crayon-h"> </span><span class="crayon-p"># flatten data</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-87"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">history</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-88"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-o">*</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-89"><span class="crayon-h"> </span><span class="crayon-p"># retrieve last observations for input data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-90"><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-v">n_input</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-91"><span class="crayon-h"> </span><span class="crayon-p"># reshape into [1, n_input, 1]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-92"><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">input_x</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-93"><span class="crayon-h"> </span><span class="crayon-p"># forecast the next week</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-94"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">input_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-95"><span class="crayon-h"> </span><span class="crayon-p"># we only want the vector forecast</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-96"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-97"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-98"> </div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-99"><span class="crayon-p"># evaluate a single model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-100"><span class="crayon-e">def </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-101"><span class="crayon-h"> </span><span class="crayon-p"># fit model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-102"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">build_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-103"><span class="crayon-h"> </span><span class="crayon-p"># history is a list of weekly data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-104"><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-i">x</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">x</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-105"><span class="crayon-h"> </span><span class="crayon-p"># walk-forward validation over each week</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-106"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-107"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-108"><span class="crayon-h"> </span><span class="crayon-p"># predict the week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-109"><span class="crayon-h"> </span><span class="crayon-v">yhat_sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">forecast</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-110"><span class="crayon-h"> </span><span class="crayon-p"># store the predictions</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-111"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat_sequence</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-112"><span class="crayon-h"> </span><span class="crayon-p"># get real observation and add to history for predicting the next week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-113"><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-114"><span class="crayon-h"> </span><span class="crayon-p"># evaluate predictions days for each week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-115"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">predictions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-116"><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">evaluate_forecasts</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-117"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-118"> </div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-119"><span class="crayon-p"># load the new file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-120"><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'household_power_consumption_days.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">infer_datetime_format</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">parse_dates</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'datetime'</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index_col</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'datetime'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-121"><span class="crayon-p"># split into train and test</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-122"><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">split_dataset</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-v">values</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-123"><span class="crayon-p"># evaluate model and get scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-124"><span class="crayon-v">n_input</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">7</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-125"><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-126"><span class="crayon-p"># summarize scores</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-127"><span class="crayon-e">summarize_scores</span><span class="crayon-sy">(</span><span class="crayon-s">'lstm'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-128"><span class="crayon-p"># plot scores</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-129"><span class="crayon-v">days</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">'sun'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'mon'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'tue'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'wed'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'thr'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'fri'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'sat'</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bbd272608574-130"><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">plot</span><span class="crayon-sy">(</span><span class="crayon-v">days</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">marker</span><span class="crayon-o">=</span><span class="crayon-s">'o'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">label</span><span class="crayon-o">=</span><span class="crayon-s">'lstm'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bbd272608574-131"><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">show</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0077 seconds] -->
<p>Running the example fits and evaluates the model, printing the overall RMSE across all seven days, and the per-day RMSE for each lead time.</p>
<p>Your specific results may vary given the stochastic nature of the algorithm. You may want to try running the example a few times.</p>
<p>We can see that in this case, the model was skillful as compared to a naive forecast, achieving an overall RMSE of about 399 kilowatts, less than 465 kilowatts achieved by a naive model.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bc0860897721" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
lstm: [399.456] 419.4, 422.1, 384.5, 395.1, 403.9, 317.7, 441.5</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bc0860897721-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bc0860897721-1">lstm: [399.456] 419.4, 422.1, 384.5, 395.1, 403.9, 317.7, 441.5</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>A plot of the daily RMSE is also created.</p>
<p>The plot shows that perhaps Tuesdays and Fridays are easier days to forecast than the other days and that perhaps Saturday at the end of the standard week is the hardest day to forecast.</p>
<div class="wp-caption aligncenter" id="attachment_6287" style="width: 1290px"><img alt="Line Plot of RMSE per Day for Univariate LSTM with Vector Output and 7-day Inputs" class="size-full wp-image-6287" height="960" sizes="(max-width: 1280px) 100vw, 1280px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-LSTM-with-Vector-Output-and-7-day-Inputs.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-LSTM-with-Vector-Output-and-7-day-Inputs.png 1280w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-LSTM-with-Vector-Output-and-7-day-Inputs-300x225.png 300w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-LSTM-with-Vector-Output-and-7-day-Inputs-768x576.png 768w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-LSTM-with-Vector-Output-and-7-day-Inputs-1024x768.png 1024w" width="1280"/><p class="wp-caption-text">Line Plot of RMSE per Day for Univariate LSTM with Vector Output and 7-day Inputs</p></div>
<p>We can increase the number of prior days to use as input from seven to 14 by changing the <em>n_input</em> variable.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bc2236301222" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# evaluate model and get scores
n_input = 14</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bc2236301222-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bc2236301222-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bc2236301222-1"><span class="crayon-p"># evaluate model and get scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bc2236301222-2"><span class="crayon-v">n_input</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">14</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Re-running the example with this change first prints a summary of performance of the model.</p>
<p>Your specific results may vary; try running the example a few times.</p>
<p>In this case, we can see a further drop in the overall RMSE to about 370 kilowatts, suggesting that further tuning of the input size and perhaps the number of nodes in the model may result in better performance.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bc4433696991" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
lstm: [370.028] 387.4, 377.9, 334.0, 371.2, 367.1, 330.4, 415.1</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bc4433696991-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bc4433696991-1">lstm: [370.028] 387.4, 377.9, 334.0, 371.2, 367.1, 330.4, 415.1</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>Comparing the per-day RMSE scores we see some are better and some are worse than using seven-day inputs.</p>
<p>This may suggest benefit in using the two different sized inputs in some way, such as an ensemble of the two approaches or perhaps a single model (e.g. a multi-headed model) that reads the training data in different ways.</p>
<div class="wp-caption aligncenter" id="attachment_6288" style="width: 1290px"><img alt="Line Plot of RMSE per Day for Univariate LSTM with Vector Output and 14-day Inputs" class="size-full wp-image-6288" height="960" sizes="(max-width: 1280px) 100vw, 1280px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-LSTM-with-Vector-Output-and-14-day-Inputs.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-LSTM-with-Vector-Output-and-14-day-Inputs.png 1280w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-LSTM-with-Vector-Output-and-14-day-Inputs-300x225.png 300w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-LSTM-with-Vector-Output-and-14-day-Inputs-768x576.png 768w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-LSTM-with-Vector-Output-and-14-day-Inputs-1024x768.png 1024w" width="1280"/><p class="wp-caption-text">Line Plot of RMSE per Day for Univariate LSTM with Vector Output and 14-day Inputs</p></div>
<h2>Encoder-Decoder LSTM Model With Univariate Input</h2>
<p>In this section, we can update the vanilla LSTM to use an encoder-decoder model.</p>
<p>This means that the model will not output a vector sequence directly. Instead, the model will be comprised of two sub models, the encoder to read and encode the input sequence, and the decoder that will read the encoded input sequence and make a one-step prediction for each element in the output sequence.</p>
<p>The difference is subtle, as in practice both approaches do in fact predict a sequence output.</p>
<p>The important difference is that an LSTM model is used in the decoder, allowing it to both know what was predicted for the prior day in the sequence and accumulate internal state while outputting the sequence.</p>
<p>Let’s take a closer look at how this model is defined.</p>
<p>As before, we define an LSTM hidden layer with 200 units. This is the decoder model that will read the input sequence and will output a 200 element vector (one output per unit) that captures features from the input sequence. We will use 14 days of total power consumption as input.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bc6355758670" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define model
model = Sequential()
model.add(LSTM(200, activation='relu', input_shape=(n_timesteps, n_features)))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bc6355758670-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bc6355758670-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bc6355758670-3">3</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bc6355758670-1"><span class="crayon-p"># define model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bc6355758670-2"><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bc6355758670-3"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">200</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>We will use a simple encoder-decoder architecture that is easy to implement in Keras, that has a lot of similarity to the architecture of an LSTM autoencoder.</p>
<p>First, the internal representation of the input sequence is repeated multiple times, once for each time step in the output sequence. This sequence of vectors will be presented to the LSTM decoder.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bc8341517507" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
model.add(RepeatVector(7))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bc8341517507-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bc8341517507-1"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>We then define the decoder as an LSTM hidden layer with 200 units. Importantly, the decoder will output the entire sequence, not just the output at the end of the sequence as we did with the encoder. This means that each of the 200 units will output a value for each of the seven days, representing the basis for what to predict for each day in the output sequence.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bc9537387354" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
model.add(LSTM(200, activation='relu', return_sequences=True))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bc9537387354-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bc9537387354-1"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">200</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>We will then use a fully connected layer to interpret each time step in the output sequence before the final output layer. Importantly, the output layer predicts a single step in the output sequence, not all seven days at a time,</p>
<p>This means that we will use the same layers applied to each step in the output sequence. It means that the same fully connected layer and output layer will be used to process each time step provided by the decoder. To achieve this, we will wrap the interpretation layer and the output layer in a <a href="https://machinelearningmastery.com/timedistributed-layer-for-long-short-term-memory-networks-in-python/">TimeDistributed wrapper</a> that allows the wrapped layers to be used for each time step from the decoder.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bcb108760977" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
model.add(TimeDistributed(Dense(100, activation='relu')))
model.add(TimeDistributed(Dense(1)))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bcb108760977-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bcb108760977-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bcb108760977-1"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">100</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bcb108760977-2"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>This allows the LSTM decoder to figure out the context required for each step in the output sequence and the wrapped dense layers to interpret each time step separately, yet reusing the same weights to perform the interpretation. An alternative would be to flatten all of the structure created by the LSTM decoder and to output the vector directly. You can try this as an extension to see how it compares.</p>
<p>The network therefore outputs a three-dimensional vector with the same structure as the input, with the dimensions [<em>samples, timesteps, features</em>].</p>
<p>There is a single feature, the daily total power consumed, and there are always seven features. A single one-week prediction will therefore have the size: [<em>1, 7, 1</em>].</p>
<p>Therefore, when training the model, we must restructure the output data (<em>y</em>) to have the three-dimensional structure instead of the two-dimensional structure of [<em>samples, features</em>] used in the previous section.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bcd226492924" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# reshape output into [samples, timesteps, features]
train_y = train_y.reshape((train_y.shape[0], train_y.shape[1], 1))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bcd226492924-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bcd226492924-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bcd226492924-1"><span class="crayon-p"># reshape output into [samples, timesteps, features]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bcd226492924-2"><span class="crayon-v">train_y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>We can tie all of this together into the updated <em>build_model()</em> function listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bce905253965" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# train the model
def build_model(train, n_input):
	# prepare data
	train_x, train_y = to_supervised(train, n_input)
	# define parameters
	verbose, epochs, batch_size = 0, 20, 16
	n_timesteps, n_features, n_outputs = train_x.shape[1], train_x.shape[2], train_y.shape[1]
	# reshape output into [samples, timesteps, features]
	train_y = train_y.reshape((train_y.shape[0], train_y.shape[1], 1))
	# define model
	model = Sequential()
	model.add(LSTM(200, activation='relu', input_shape=(n_timesteps, n_features)))
	model.add(RepeatVector(n_outputs))
	model.add(LSTM(200, activation='relu', return_sequences=True))
	model.add(TimeDistributed(Dense(100, activation='relu')))
	model.add(TimeDistributed(Dense(1)))
	model.compile(loss='mse', optimizer='adam')
	# fit network
	model.fit(train_x, train_y, epochs=epochs, batch_size=batch_size, verbose=verbose)
	return model</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bce905253965-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bce905253965-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bce905253965-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bce905253965-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bce905253965-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bce905253965-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bce905253965-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bce905253965-8">8</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bce905253965-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bce905253965-10">10</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bce905253965-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bce905253965-12">12</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bce905253965-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bce905253965-14">14</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bce905253965-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bce905253965-16">16</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bce905253965-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bce905253965-18">18</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bce905253965-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bce905253965-20">20</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bce905253965-1"><span class="crayon-p"># train the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bce905253965-2"><span class="crayon-e">def </span><span class="crayon-e">build_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bce905253965-3"><span class="crayon-h"> </span><span class="crayon-p"># prepare data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bce905253965-4"><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bce905253965-5"><span class="crayon-h"> </span><span class="crayon-p"># define parameters</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bce905253965-6"><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">20</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">16</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bce905253965-7"><span class="crayon-h"> </span><span class="crayon-v">n_timesteps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bce905253965-8"><span class="crayon-h"> </span><span class="crayon-p"># reshape output into [samples, timesteps, features]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bce905253965-9"><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bce905253965-10"><span class="crayon-h"> </span><span class="crayon-p"># define model</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bce905253965-11"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bce905253965-12"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">200</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bce905253965-13"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">n_outputs</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bce905253965-14"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">200</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bce905253965-15"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">100</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bce905253965-16"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bce905253965-17"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'mse'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bce905253965-18"><span class="crayon-h"> </span><span class="crayon-p"># fit network</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bce905253965-19"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">train_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-v">epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-v">verbose</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bce905253965-20"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0016 seconds] -->
<p>The complete example with the encoder-decoder model is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bd0364644173" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# univariate multi-step encoder-decoder lstm
from math import sqrt
from numpy import split
from numpy import array
from pandas import read_csv
from sklearn.metrics import mean_squared_error
from matplotlib import pyplot
from keras.models import Sequential
from keras.layers import Dense
from keras.layers import Flatten
from keras.layers import LSTM
from keras.layers import RepeatVector
from keras.layers import TimeDistributed

# split a univariate dataset into train/test sets
def split_dataset(data):
	# split into standard weeks
	train, test = data[1:-328], data[-328:-6]
	# restructure into windows of weekly data
	train = array(split(train, len(train)/7))
	test = array(split(test, len(test)/7))
	return train, test

# evaluate one or more weekly forecasts against expected values
def evaluate_forecasts(actual, predicted):
	scores = list()
	# calculate an RMSE score for each day
	for i in range(actual.shape[1]):
		# calculate mse
		mse = mean_squared_error(actual[:, i], predicted[:, i])
		# calculate rmse
		rmse = sqrt(mse)
		# store
		scores.append(rmse)
	# calculate overall RMSE
	s = 0
	for row in range(actual.shape[0]):
		for col in range(actual.shape[1]):
			s += (actual[row, col] - predicted[row, col])**2
	score = sqrt(s / (actual.shape[0] * actual.shape[1]))
	return score, scores

# summarize scores
def summarize_scores(name, score, scores):
	s_scores = ', '.join(['%.1f' % s for s in scores])
	print('%s: [%.3f] %s' % (name, score, s_scores))

# convert history into inputs and outputs
def to_supervised(train, n_input, n_out=7):
	# flatten data
	data = train.reshape((train.shape[0]*train.shape[1], train.shape[2]))
	X, y = list(), list()
	in_start = 0
	# step over the entire history one time step at a time
	for _ in range(len(data)):
		# define the end of the input sequence
		in_end = in_start + n_input
		out_end = in_end + n_out
		# ensure we have enough data for this instance
		if out_end &lt; len(data):
			x_input = data[in_start:in_end, 0]
			x_input = x_input.reshape((len(x_input), 1))
			X.append(x_input)
			y.append(data[in_end:out_end, 0])
		# move along one time step
		in_start += 1
	return array(X), array(y)

# train the model
def build_model(train, n_input):
	# prepare data
	train_x, train_y = to_supervised(train, n_input)
	# define parameters
	verbose, epochs, batch_size = 0, 20, 16
	n_timesteps, n_features, n_outputs = train_x.shape[1], train_x.shape[2], train_y.shape[1]
	# reshape output into [samples, timesteps, features]
	train_y = train_y.reshape((train_y.shape[0], train_y.shape[1], 1))
	# define model
	model = Sequential()
	model.add(LSTM(200, activation='relu', input_shape=(n_timesteps, n_features)))
	model.add(RepeatVector(n_outputs))
	model.add(LSTM(200, activation='relu', return_sequences=True))
	model.add(TimeDistributed(Dense(100, activation='relu')))
	model.add(TimeDistributed(Dense(1)))
	model.compile(loss='mse', optimizer='adam')
	# fit network
	model.fit(train_x, train_y, epochs=epochs, batch_size=batch_size, verbose=verbose)
	return model

# make a forecast
def forecast(model, history, n_input):
	# flatten data
	data = array(history)
	data = data.reshape((data.shape[0]*data.shape[1], data.shape[2]))
	# retrieve last observations for input data
	input_x = data[-n_input:, 0]
	# reshape into [1, n_input, 1]
	input_x = input_x.reshape((1, len(input_x), 1))
	# forecast the next week
	yhat = model.predict(input_x, verbose=0)
	# we only want the vector forecast
	yhat = yhat[0]
	return yhat

# evaluate a single model
def evaluate_model(train, test, n_input):
	# fit model
	model = build_model(train, n_input)
	# history is a list of weekly data
	history = [x for x in train]
	# walk-forward validation over each week
	predictions = list()
	for i in range(len(test)):
		# predict the week
		yhat_sequence = forecast(model, history, n_input)
		# store the predictions
		predictions.append(yhat_sequence)
		# get real observation and add to history for predicting the next week
		history.append(test[i, :])
	# evaluate predictions days for each week
	predictions = array(predictions)
	score, scores = evaluate_forecasts(test[:, :, 0], predictions)
	return score, scores

# load the new file
dataset = read_csv('household_power_consumption_days.csv', header=0, infer_datetime_format=True, parse_dates=['datetime'], index_col=['datetime'])
# split into train and test
train, test = split_dataset(dataset.values)
# evaluate model and get scores
n_input = 14
score, scores = evaluate_model(train, test, n_input)
# summarize scores
summarize_scores('lstm', score, scores)
# plot scores
days = ['sun', 'mon', 'tue', 'wed', 'thr', 'fri', 'sat']
pyplot.plot(days, scores, marker='o', label='lstm')
pyplot.show()</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-8">8</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-10">10</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-12">12</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-14">14</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-16">16</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-18">18</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-20">20</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-22">22</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-24">24</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-26">26</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-28">28</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-30">30</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-32">32</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-34">34</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-36">36</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-38">38</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-40">40</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-42">42</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-44">44</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-46">46</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-48">48</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-50">50</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-52">52</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-54">54</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-56">56</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-58">58</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-60">60</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-62">62</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-64">64</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-66">66</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-68">68</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-70">70</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-72">72</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-74">74</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-76">76</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-78">78</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-80">80</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-82">82</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-84">84</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-86">86</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-88">88</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-90">90</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-92">92</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-94">94</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-96">96</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-98">98</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-100">100</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-101">101</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-102">102</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-103">103</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-104">104</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-105">105</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-106">106</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-107">107</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-108">108</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-109">109</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-110">110</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-111">111</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-112">112</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-113">113</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-114">114</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-115">115</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-116">116</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-117">117</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-118">118</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-119">119</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-120">120</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-121">121</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-122">122</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-123">123</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-124">124</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-125">125</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-126">126</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-127">127</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-128">128</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-129">129</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-130">130</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-131">131</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-132">132</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-133">133</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-134">134</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-135">135</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd0364644173-136">136</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd0364644173-137">137</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-1"><span class="crayon-p"># univariate multi-step encoder-decoder lstm</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-2"><span class="crayon-e">from </span><span class="crayon-e">math </span><span class="crayon-e">import </span><span class="crayon-e">sqrt</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-3"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">split</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-4"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-t">array</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-5"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">read_csv</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-6"><span class="crayon-e">from </span><span class="crayon-v">sklearn</span><span class="crayon-sy">.</span><span class="crayon-e">metrics </span><span class="crayon-e">import </span><span class="crayon-e">mean_squared_error</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-7"><span class="crayon-e">from </span><span class="crayon-e">matplotlib </span><span class="crayon-e">import </span><span class="crayon-e">pyplot</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-8"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-e">Sequential</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-9"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Dense</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-10"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Flatten</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-11"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">LSTM</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-12"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">RepeatVector</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-13"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-v">TimeDistributed</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-14"> </div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-15"><span class="crayon-p"># split a univariate dataset into train/test sets</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-16"><span class="crayon-e">def </span><span class="crayon-e">split_dataset</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-17"><span class="crayon-h"> </span><span class="crayon-p"># split into standard weeks</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-18"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">328</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">328</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">6</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-19"><span class="crayon-h"> </span><span class="crayon-p"># restructure into windows of weekly data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-20"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-21"><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-22"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-23"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-24"><span class="crayon-p"># evaluate one or more weekly forecasts against expected values</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-25"><span class="crayon-e">def </span><span class="crayon-e">evaluate_forecasts</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-26"><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-27"><span class="crayon-h"> </span><span class="crayon-p"># calculate an RMSE score for each day</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-28"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-29"><span class="crayon-h"> </span><span class="crayon-p"># calculate mse</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-30"><span class="crayon-h"> </span><span class="crayon-v">mse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">mean_squared_error</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-31"><span class="crayon-h"> </span><span class="crayon-p"># calculate rmse</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-32"><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sqrt</span><span class="crayon-sy">(</span><span class="crayon-v">mse</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-33"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-34"><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-35"><span class="crayon-h"> </span><span class="crayon-p"># calculate overall RMSE</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-36"><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-37"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">row </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-38"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">col </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-39"><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">[</span><span class="crayon-v">row</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">col</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">[</span><span class="crayon-v">row</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">col</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-cn">2</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-40"><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sqrt</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-41"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-42"> </div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-43"><span class="crayon-p"># summarize scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-44"><span class="crayon-e">def </span><span class="crayon-e">summarize_scores</span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-45"><span class="crayon-h"> </span><span class="crayon-v">s_scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">', '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-s">'%.1f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-46"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'%s: [%.3f] %s'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">s_scores</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-47"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-48"><span class="crayon-p"># convert history into inputs and outputs</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-49"><span class="crayon-e">def </span><span class="crayon-e">to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_out</span><span class="crayon-o">=</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-50"><span class="crayon-h"> </span><span class="crayon-p"># flatten data</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-51"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-o">*</span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-52"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-53"><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-54"><span class="crayon-h"> </span><span class="crayon-p"># step over the entire history one time step at a time</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-55"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-56"><span class="crayon-h"> </span><span class="crayon-p"># define the end of the input sequence</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-57"><span class="crayon-h"> </span><span class="crayon-v">in_end</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">n_input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-58"><span class="crayon-e"> </span><span class="crayon-v">out_end</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">in_end</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">n_out</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-59"><span class="crayon-h"> </span><span class="crayon-p"># ensure we have enough data for this instance</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-60"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">out_end</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-61"><span class="crayon-h"> </span><span class="crayon-v">x_input</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-v">in_start</span><span class="crayon-o">:</span><span class="crayon-v">in_end</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-62"><span class="crayon-h"> </span><span class="crayon-v">x_input</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">x_input</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">x_input</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-63"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">x_input</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-64"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-v">in_end</span><span class="crayon-o">:</span><span class="crayon-v">out_end</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-65"><span class="crayon-h"> </span><span class="crayon-p"># move along one time step</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-66"><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-67"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-68"> </div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-69"><span class="crayon-p"># train the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-70"><span class="crayon-e">def </span><span class="crayon-e">build_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-71"><span class="crayon-h"> </span><span class="crayon-p"># prepare data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-72"><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-73"><span class="crayon-h"> </span><span class="crayon-p"># define parameters</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-74"><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">20</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">16</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-75"><span class="crayon-h"> </span><span class="crayon-v">n_timesteps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-76"><span class="crayon-h"> </span><span class="crayon-p"># reshape output into [samples, timesteps, features]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-77"><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-78"><span class="crayon-h"> </span><span class="crayon-p"># define model</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-79"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-80"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">200</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-81"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">n_outputs</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-82"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">200</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-83"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">100</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-84"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-85"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'mse'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-86"><span class="crayon-h"> </span><span class="crayon-p"># fit network</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-87"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">train_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-v">epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-v">verbose</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-88"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-89"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-90"><span class="crayon-p"># make a forecast</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-91"><span class="crayon-e">def </span><span class="crayon-e">forecast</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-92"><span class="crayon-h"> </span><span class="crayon-p"># flatten data</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-93"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">history</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-94"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-o">*</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-95"><span class="crayon-h"> </span><span class="crayon-p"># retrieve last observations for input data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-96"><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-v">n_input</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-97"><span class="crayon-h"> </span><span class="crayon-p"># reshape into [1, n_input, 1]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-98"><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">input_x</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-99"><span class="crayon-h"> </span><span class="crayon-p"># forecast the next week</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-100"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">input_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-101"><span class="crayon-h"> </span><span class="crayon-p"># we only want the vector forecast</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-102"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-103"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-104"> </div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-105"><span class="crayon-p"># evaluate a single model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-106"><span class="crayon-e">def </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-107"><span class="crayon-h"> </span><span class="crayon-p"># fit model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-108"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">build_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-109"><span class="crayon-h"> </span><span class="crayon-p"># history is a list of weekly data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-110"><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-i">x</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">x</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-111"><span class="crayon-h"> </span><span class="crayon-p"># walk-forward validation over each week</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-112"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-113"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-114"><span class="crayon-h"> </span><span class="crayon-p"># predict the week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-115"><span class="crayon-h"> </span><span class="crayon-v">yhat_sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">forecast</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-116"><span class="crayon-h"> </span><span class="crayon-p"># store the predictions</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-117"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat_sequence</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-118"><span class="crayon-h"> </span><span class="crayon-p"># get real observation and add to history for predicting the next week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-119"><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-120"><span class="crayon-h"> </span><span class="crayon-p"># evaluate predictions days for each week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-121"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">predictions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-122"><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">evaluate_forecasts</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-123"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-124"> </div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-125"><span class="crayon-p"># load the new file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-126"><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'household_power_consumption_days.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">infer_datetime_format</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">parse_dates</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'datetime'</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index_col</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'datetime'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-127"><span class="crayon-p"># split into train and test</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-128"><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">split_dataset</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-v">values</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-129"><span class="crayon-p"># evaluate model and get scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-130"><span class="crayon-v">n_input</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">14</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-131"><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-132"><span class="crayon-p"># summarize scores</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-133"><span class="crayon-e">summarize_scores</span><span class="crayon-sy">(</span><span class="crayon-s">'lstm'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-134"><span class="crayon-p"># plot scores</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-135"><span class="crayon-v">days</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">'sun'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'mon'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'tue'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'wed'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'thr'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'fri'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'sat'</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd0364644173-136"><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">plot</span><span class="crayon-sy">(</span><span class="crayon-v">days</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">marker</span><span class="crayon-o">=</span><span class="crayon-s">'o'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">label</span><span class="crayon-o">=</span><span class="crayon-s">'lstm'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd0364644173-137"><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">show</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0078 seconds] -->
<p>Running the example fits the model and summarizes the performance on the test dataset.</p>
<p>Your specific results may vary given the stochastic nature of the algorithm. You may want to try running the example a few times.</p>
<p>We can see that in this case, the model is skillful, achieving an overall RMSE score of about 372 kilowatts.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bd3840636603" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
lstm: [372.595] 379.5, 399.8, 339.6, 372.2, 370.9, 309.9, 424.8</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bd3840636603-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bd3840636603-1">lstm: [372.595] 379.5, 399.8, 339.6, 372.2, 370.9, 309.9, 424.8</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>A line plot of the per-day RMSE is also created showing a similar pattern in error as was seen in the previous section.</p>
<div class="wp-caption aligncenter" id="attachment_6289" style="width: 1290px"><img alt="Line Plot of RMSE per Day for Univariate Encoder-Decoder LSTM with 14-day Inputs" class="size-full wp-image-6289" height="960" sizes="(max-width: 1280px) 100vw, 1280px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-Encoder-Decoder-LSTM-with-14-day-Inputs.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-Encoder-Decoder-LSTM-with-14-day-Inputs.png 1280w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-Encoder-Decoder-LSTM-with-14-day-Inputs-300x225.png 300w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-Encoder-Decoder-LSTM-with-14-day-Inputs-768x576.png 768w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-Encoder-Decoder-LSTM-with-14-day-Inputs-1024x768.png 1024w" width="1280"/><p class="wp-caption-text">Line Plot of RMSE per Day for Univariate Encoder-Decoder LSTM with 14-day Inputs</p></div>
<h2>Encoder-Decoder LSTM Model With Multivariate Input</h2>
<p>In this section, we will update the Encoder-Decoder LSTM developed in the previous section to use each of the eight time series variables to predict the next standard week of daily total power consumption.</p>
<p>We will do this by providing each one-dimensional time series to the model as a separate sequence of input.</p>
<p>The LSTM will in turn create an internal representation of each input sequence that will together be interpreted by the decoder.</p>
<p>Using multivariate inputs is helpful for those problems where the output sequence is some function of the observations at prior time steps from multiple different features, not just (or including) the feature being forecasted. It is unclear whether this is the case in the power consumption problem, but we can explore it nonetheless.</p>
<p>First, we must update the preparation of the training data to include all of the eight features, not just the one total daily power consumed. It requires a single line change:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bd6029217309" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
X.append(data[in_start:in_end, :])</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bd6029217309-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bd6029217309-1"><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-v">in_start</span><span class="crayon-o">:</span><span class="crayon-v">in_end</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>The complete <em>to_supervised()</em> function with this change is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bd8956975435" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# convert history into inputs and outputs
def to_supervised(train, n_input, n_out=7):
	# flatten data
	data = train.reshape((train.shape[0]*train.shape[1], train.shape[2]))
	X, y = list(), list()
	in_start = 0
	# step over the entire history one time step at a time
	for _ in range(len(data)):
		# define the end of the input sequence
		in_end = in_start + n_input
		out_end = in_end + n_out
		# ensure we have enough data for this instance
		if out_end &lt; len(data):
			X.append(data[in_start:in_end, :])
			y.append(data[in_end:out_end, 0])
		# move along one time step
		in_start += 1
	return array(X), array(y)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bd8956975435-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd8956975435-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd8956975435-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd8956975435-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd8956975435-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd8956975435-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd8956975435-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd8956975435-8">8</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd8956975435-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd8956975435-10">10</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd8956975435-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd8956975435-12">12</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd8956975435-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd8956975435-14">14</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd8956975435-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd8956975435-16">16</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bd8956975435-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bd8956975435-18">18</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bd8956975435-1"><span class="crayon-p"># convert history into inputs and outputs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd8956975435-2"><span class="crayon-e">def </span><span class="crayon-e">to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_out</span><span class="crayon-o">=</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd8956975435-3"><span class="crayon-h"> </span><span class="crayon-p"># flatten data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd8956975435-4"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-o">*</span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd8956975435-5"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd8956975435-6"><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd8956975435-7"><span class="crayon-h"> </span><span class="crayon-p"># step over the entire history one time step at a time</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd8956975435-8"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd8956975435-9"><span class="crayon-h"> </span><span class="crayon-p"># define the end of the input sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd8956975435-10"><span class="crayon-h"> </span><span class="crayon-v">in_end</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">n_input</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd8956975435-11"><span class="crayon-e"> </span><span class="crayon-v">out_end</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">in_end</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">n_out</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd8956975435-12"><span class="crayon-h"> </span><span class="crayon-p"># ensure we have enough data for this instance</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd8956975435-13"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">out_end</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd8956975435-14"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-v">in_start</span><span class="crayon-o">:</span><span class="crayon-v">in_end</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd8956975435-15"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-v">in_end</span><span class="crayon-o">:</span><span class="crayon-v">out_end</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd8956975435-16"><span class="crayon-h"> </span><span class="crayon-p"># move along one time step</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bd8956975435-17"><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bd8956975435-18"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0012 seconds] -->
<p>We also must update the function used to make forecasts with the fit model to use all eight features from the prior time steps.</p>
<p>Again, another small change:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bda046881907" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# retrieve last observations for input data
input_x = data[-n_input:, :]
# reshape into [1, n_input, n]
input_x = input_x.reshape((1, input_x.shape[0], input_x.shape[1]))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bda046881907-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bda046881907-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bda046881907-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bda046881907-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bda046881907-1"><span class="crayon-p"># retrieve last observations for input data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bda046881907-2"><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-v">n_input</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bda046881907-3"><span class="crayon-p"># reshape into [1, n_input, n]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bda046881907-4"><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>The complete <em>forecast()</em> function with this change is listed below:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bdc886681923" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# make a forecast
def forecast(model, history, n_input):
	# flatten data
	data = array(history)
	data = data.reshape((data.shape[0]*data.shape[1], data.shape[2]))
	# retrieve last observations for input data
	input_x = data[-n_input:, :]
	# reshape into [1, n_input, n]
	input_x = input_x.reshape((1, input_x.shape[0], input_x.shape[1]))
	# forecast the next week
	yhat = model.predict(input_x, verbose=0)
	# we only want the vector forecast
	yhat = yhat[0]
	return yhat</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bdc886681923-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bdc886681923-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bdc886681923-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bdc886681923-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bdc886681923-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bdc886681923-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bdc886681923-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bdc886681923-8">8</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bdc886681923-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bdc886681923-10">10</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bdc886681923-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bdc886681923-12">12</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bdc886681923-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bdc886681923-14">14</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bdc886681923-1"><span class="crayon-p"># make a forecast</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bdc886681923-2"><span class="crayon-e">def </span><span class="crayon-e">forecast</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bdc886681923-3"><span class="crayon-h"> </span><span class="crayon-p"># flatten data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bdc886681923-4"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">history</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bdc886681923-5"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-o">*</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bdc886681923-6"><span class="crayon-h"> </span><span class="crayon-p"># retrieve last observations for input data</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bdc886681923-7"><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-v">n_input</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bdc886681923-8"><span class="crayon-h"> </span><span class="crayon-p"># reshape into [1, n_input, n]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bdc886681923-9"><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bdc886681923-10"><span class="crayon-h"> </span><span class="crayon-p"># forecast the next week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bdc886681923-11"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">input_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bdc886681923-12"><span class="crayon-h"> </span><span class="crayon-p"># we only want the vector forecast</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bdc886681923-13"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bdc886681923-14"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0009 seconds] -->
<p>The same model architecture and configuration is used directly, although we will increase the number of training epochs from 20 to 50 given the 8-fold increase in the amount of input data.</p>
<p>The complete example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bde987452293" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# multivariate multi-step encoder-decoder lstm
from math import sqrt
from numpy import split
from numpy import array
from pandas import read_csv
from sklearn.metrics import mean_squared_error
from matplotlib import pyplot
from keras.models import Sequential
from keras.layers import Dense
from keras.layers import Flatten
from keras.layers import LSTM
from keras.layers import RepeatVector
from keras.layers import TimeDistributed

# split a univariate dataset into train/test sets
def split_dataset(data):
	# split into standard weeks
	train, test = data[1:-328], data[-328:-6]
	# restructure into windows of weekly data
	train = array(split(train, len(train)/7))
	test = array(split(test, len(test)/7))
	return train, test

# evaluate one or more weekly forecasts against expected values
def evaluate_forecasts(actual, predicted):
	scores = list()
	# calculate an RMSE score for each day
	for i in range(actual.shape[1]):
		# calculate mse
		mse = mean_squared_error(actual[:, i], predicted[:, i])
		# calculate rmse
		rmse = sqrt(mse)
		# store
		scores.append(rmse)
	# calculate overall RMSE
	s = 0
	for row in range(actual.shape[0]):
		for col in range(actual.shape[1]):
			s += (actual[row, col] - predicted[row, col])**2
	score = sqrt(s / (actual.shape[0] * actual.shape[1]))
	return score, scores

# summarize scores
def summarize_scores(name, score, scores):
	s_scores = ', '.join(['%.1f' % s for s in scores])
	print('%s: [%.3f] %s' % (name, score, s_scores))

# convert history into inputs and outputs
def to_supervised(train, n_input, n_out=7):
	# flatten data
	data = train.reshape((train.shape[0]*train.shape[1], train.shape[2]))
	X, y = list(), list()
	in_start = 0
	# step over the entire history one time step at a time
	for _ in range(len(data)):
		# define the end of the input sequence
		in_end = in_start + n_input
		out_end = in_end + n_out
		# ensure we have enough data for this instance
		if out_end &lt; len(data):
			X.append(data[in_start:in_end, :])
			y.append(data[in_end:out_end, 0])
		# move along one time step
		in_start += 1
	return array(X), array(y)

# train the model
def build_model(train, n_input):
	# prepare data
	train_x, train_y = to_supervised(train, n_input)
	# define parameters
	verbose, epochs, batch_size = 0, 50, 16
	n_timesteps, n_features, n_outputs = train_x.shape[1], train_x.shape[2], train_y.shape[1]
	# reshape output into [samples, timesteps, features]
	train_y = train_y.reshape((train_y.shape[0], train_y.shape[1], 1))
	# define model
	model = Sequential()
	model.add(LSTM(200, activation='relu', input_shape=(n_timesteps, n_features)))
	model.add(RepeatVector(n_outputs))
	model.add(LSTM(200, activation='relu', return_sequences=True))
	model.add(TimeDistributed(Dense(100, activation='relu')))
	model.add(TimeDistributed(Dense(1)))
	model.compile(loss='mse', optimizer='adam')
	# fit network
	model.fit(train_x, train_y, epochs=epochs, batch_size=batch_size, verbose=verbose)
	return model

# make a forecast
def forecast(model, history, n_input):
	# flatten data
	data = array(history)
	data = data.reshape((data.shape[0]*data.shape[1], data.shape[2]))
	# retrieve last observations for input data
	input_x = data[-n_input:, :]
	# reshape into [1, n_input, n]
	input_x = input_x.reshape((1, input_x.shape[0], input_x.shape[1]))
	# forecast the next week
	yhat = model.predict(input_x, verbose=0)
	# we only want the vector forecast
	yhat = yhat[0]
	return yhat

# evaluate a single model
def evaluate_model(train, test, n_input):
	# fit model
	model = build_model(train, n_input)
	# history is a list of weekly data
	history = [x for x in train]
	# walk-forward validation over each week
	predictions = list()
	for i in range(len(test)):
		# predict the week
		yhat_sequence = forecast(model, history, n_input)
		# store the predictions
		predictions.append(yhat_sequence)
		# get real observation and add to history for predicting the next week
		history.append(test[i, :])
	# evaluate predictions days for each week
	predictions = array(predictions)
	score, scores = evaluate_forecasts(test[:, :, 0], predictions)
	return score, scores

# load the new file
dataset = read_csv('household_power_consumption_days.csv', header=0, infer_datetime_format=True, parse_dates=['datetime'], index_col=['datetime'])
# split into train and test
train, test = split_dataset(dataset.values)
# evaluate model and get scores
n_input = 14
score, scores = evaluate_model(train, test, n_input)
# summarize scores
summarize_scores('lstm', score, scores)
# plot scores
days = ['sun', 'mon', 'tue', 'wed', 'thr', 'fri', 'sat']
pyplot.plot(days, scores, marker='o', label='lstm')
pyplot.show()</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-8">8</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-10">10</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-12">12</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-14">14</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-16">16</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-18">18</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-20">20</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-22">22</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-24">24</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-26">26</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-28">28</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-30">30</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-32">32</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-34">34</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-36">36</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-38">38</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-40">40</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-42">42</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-44">44</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-46">46</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-48">48</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-50">50</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-52">52</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-54">54</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-56">56</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-58">58</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-60">60</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-62">62</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-64">64</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-66">66</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-68">68</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-70">70</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-72">72</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-74">74</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-76">76</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-78">78</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-80">80</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-82">82</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-84">84</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-86">86</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-88">88</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-90">90</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-92">92</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-94">94</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-96">96</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-98">98</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-100">100</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-101">101</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-102">102</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-103">103</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-104">104</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-105">105</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-106">106</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-107">107</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-108">108</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-109">109</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-110">110</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-111">111</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-112">112</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-113">113</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-114">114</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-115">115</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-116">116</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-117">117</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-118">118</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-119">119</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-120">120</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-121">121</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-122">122</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-123">123</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-124">124</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-125">125</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-126">126</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-127">127</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-128">128</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-129">129</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-130">130</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-131">131</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-132">132</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-133">133</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bde987452293-134">134</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bde987452293-135">135</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-1"><span class="crayon-p"># multivariate multi-step encoder-decoder lstm</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-2"><span class="crayon-e">from </span><span class="crayon-e">math </span><span class="crayon-e">import </span><span class="crayon-e">sqrt</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-3"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">split</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-4"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-t">array</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-5"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">read_csv</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-6"><span class="crayon-e">from </span><span class="crayon-v">sklearn</span><span class="crayon-sy">.</span><span class="crayon-e">metrics </span><span class="crayon-e">import </span><span class="crayon-e">mean_squared_error</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-7"><span class="crayon-e">from </span><span class="crayon-e">matplotlib </span><span class="crayon-e">import </span><span class="crayon-e">pyplot</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-8"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-e">Sequential</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-9"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Dense</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-10"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Flatten</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-11"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">LSTM</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-12"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">RepeatVector</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-13"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-v">TimeDistributed</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-14"> </div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-15"><span class="crayon-p"># split a univariate dataset into train/test sets</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-16"><span class="crayon-e">def </span><span class="crayon-e">split_dataset</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-17"><span class="crayon-h"> </span><span class="crayon-p"># split into standard weeks</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-18"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">328</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">328</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">6</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-19"><span class="crayon-h"> </span><span class="crayon-p"># restructure into windows of weekly data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-20"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-21"><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-22"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-23"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-24"><span class="crayon-p"># evaluate one or more weekly forecasts against expected values</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-25"><span class="crayon-e">def </span><span class="crayon-e">evaluate_forecasts</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-26"><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-27"><span class="crayon-h"> </span><span class="crayon-p"># calculate an RMSE score for each day</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-28"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-29"><span class="crayon-h"> </span><span class="crayon-p"># calculate mse</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-30"><span class="crayon-h"> </span><span class="crayon-v">mse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">mean_squared_error</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-31"><span class="crayon-h"> </span><span class="crayon-p"># calculate rmse</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-32"><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sqrt</span><span class="crayon-sy">(</span><span class="crayon-v">mse</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-33"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-34"><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-35"><span class="crayon-h"> </span><span class="crayon-p"># calculate overall RMSE</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-36"><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-37"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">row </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-38"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">col </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-39"><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">[</span><span class="crayon-v">row</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">col</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">[</span><span class="crayon-v">row</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">col</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-cn">2</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-40"><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sqrt</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-41"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-42"> </div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-43"><span class="crayon-p"># summarize scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-44"><span class="crayon-e">def </span><span class="crayon-e">summarize_scores</span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-45"><span class="crayon-h"> </span><span class="crayon-v">s_scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">', '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-s">'%.1f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-46"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'%s: [%.3f] %s'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">s_scores</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-47"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-48"><span class="crayon-p"># convert history into inputs and outputs</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-49"><span class="crayon-e">def </span><span class="crayon-e">to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_out</span><span class="crayon-o">=</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-50"><span class="crayon-h"> </span><span class="crayon-p"># flatten data</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-51"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-o">*</span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-52"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-53"><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-54"><span class="crayon-h"> </span><span class="crayon-p"># step over the entire history one time step at a time</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-55"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-56"><span class="crayon-h"> </span><span class="crayon-p"># define the end of the input sequence</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-57"><span class="crayon-h"> </span><span class="crayon-v">in_end</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">n_input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-58"><span class="crayon-e"> </span><span class="crayon-v">out_end</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">in_end</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">n_out</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-59"><span class="crayon-h"> </span><span class="crayon-p"># ensure we have enough data for this instance</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-60"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">out_end</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-61"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-v">in_start</span><span class="crayon-o">:</span><span class="crayon-v">in_end</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-62"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-v">in_end</span><span class="crayon-o">:</span><span class="crayon-v">out_end</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-63"><span class="crayon-h"> </span><span class="crayon-p"># move along one time step</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-64"><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-65"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-66"> </div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-67"><span class="crayon-p"># train the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-68"><span class="crayon-e">def </span><span class="crayon-e">build_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-69"><span class="crayon-h"> </span><span class="crayon-p"># prepare data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-70"><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-71"><span class="crayon-h"> </span><span class="crayon-p"># define parameters</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-72"><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">50</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">16</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-73"><span class="crayon-h"> </span><span class="crayon-v">n_timesteps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-74"><span class="crayon-h"> </span><span class="crayon-p"># reshape output into [samples, timesteps, features]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-75"><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-76"><span class="crayon-h"> </span><span class="crayon-p"># define model</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-77"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-78"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">200</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-79"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">n_outputs</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-80"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">200</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-81"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">100</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-82"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-83"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'mse'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-84"><span class="crayon-h"> </span><span class="crayon-p"># fit network</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-85"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">train_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-v">epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-v">verbose</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-86"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-87"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-88"><span class="crayon-p"># make a forecast</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-89"><span class="crayon-e">def </span><span class="crayon-e">forecast</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-90"><span class="crayon-h"> </span><span class="crayon-p"># flatten data</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-91"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">history</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-92"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-o">*</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-93"><span class="crayon-h"> </span><span class="crayon-p"># retrieve last observations for input data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-94"><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-v">n_input</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-95"><span class="crayon-h"> </span><span class="crayon-p"># reshape into [1, n_input, n]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-96"><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-97"><span class="crayon-h"> </span><span class="crayon-p"># forecast the next week</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-98"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">input_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-99"><span class="crayon-h"> </span><span class="crayon-p"># we only want the vector forecast</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-100"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-101"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-102"> </div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-103"><span class="crayon-p"># evaluate a single model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-104"><span class="crayon-e">def </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-105"><span class="crayon-h"> </span><span class="crayon-p"># fit model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-106"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">build_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-107"><span class="crayon-h"> </span><span class="crayon-p"># history is a list of weekly data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-108"><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-i">x</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">x</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-109"><span class="crayon-h"> </span><span class="crayon-p"># walk-forward validation over each week</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-110"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-111"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-112"><span class="crayon-h"> </span><span class="crayon-p"># predict the week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-113"><span class="crayon-h"> </span><span class="crayon-v">yhat_sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">forecast</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-114"><span class="crayon-h"> </span><span class="crayon-p"># store the predictions</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-115"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat_sequence</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-116"><span class="crayon-h"> </span><span class="crayon-p"># get real observation and add to history for predicting the next week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-117"><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-118"><span class="crayon-h"> </span><span class="crayon-p"># evaluate predictions days for each week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-119"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">predictions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-120"><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">evaluate_forecasts</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-121"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-122"> </div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-123"><span class="crayon-p"># load the new file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-124"><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'household_power_consumption_days.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">infer_datetime_format</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">parse_dates</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'datetime'</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index_col</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'datetime'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-125"><span class="crayon-p"># split into train and test</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-126"><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">split_dataset</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-v">values</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-127"><span class="crayon-p"># evaluate model and get scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-128"><span class="crayon-v">n_input</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">14</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-129"><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-130"><span class="crayon-p"># summarize scores</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-131"><span class="crayon-e">summarize_scores</span><span class="crayon-sy">(</span><span class="crayon-s">'lstm'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-132"><span class="crayon-p"># plot scores</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-133"><span class="crayon-v">days</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">'sun'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'mon'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'tue'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'wed'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'thr'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'fri'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'sat'</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bde987452293-134"><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">plot</span><span class="crayon-sy">(</span><span class="crayon-v">days</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">marker</span><span class="crayon-o">=</span><span class="crayon-s">'o'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">label</span><span class="crayon-o">=</span><span class="crayon-s">'lstm'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bde987452293-135"><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">show</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0078 seconds] -->
<p>Running the example fits the model and summarizes the performance on the test dataset.</p>
<p>Experimentation found that this model appears less stable than the univariate case and may be related to the differing scales of the input eight variables.</p>
<p>Your specific results may vary given the stochastic nature of the algorithm. You may want to try running the example a few times.</p>
<p>We can see that in this case, the model is skillful, achieving an overall RMSE score of about 376 kilowatts.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80be0040954258" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
lstm: [376.273] 378.5, 381.5, 328.4, 388.3, 361.2, 308.0, 467.2</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80be0040954258-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80be0040954258-1">lstm: [376.273] 378.5, 381.5, 328.4, 388.3, 361.2, 308.0, 467.2</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>A line plot of the per-day RMSE is also created.</p>
<div class="wp-caption aligncenter" id="attachment_6290" style="width: 1290px"><img alt="Line Plot of RMSE per Day for Multivariate Encoder-Decoder LSTM with 14-day Inputs" class="size-full wp-image-6290" height="960" sizes="(max-width: 1280px) 100vw, 1280px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Multivariate-Encoder-Decoder-LSTM-with-14-day-Inputs.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Multivariate-Encoder-Decoder-LSTM-with-14-day-Inputs.png 1280w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Multivariate-Encoder-Decoder-LSTM-with-14-day-Inputs-300x225.png 300w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Multivariate-Encoder-Decoder-LSTM-with-14-day-Inputs-768x576.png 768w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Multivariate-Encoder-Decoder-LSTM-with-14-day-Inputs-1024x768.png 1024w" width="1280"/><p class="wp-caption-text">Line Plot of RMSE per Day for Multivariate Encoder-Decoder LSTM with 14-day Inputs</p></div>
<h2>CNN-LSTM Encoder-Decoder Model With Univariate Input</h2>
<p>A convolutional neural network, or CNN, can be used as the encoder in an encoder-decoder architecture.</p>
<p>The CNN does not directly support sequence input; instead, a 1D CNN is capable of reading across sequence input and automatically learning the salient features. These can then be interpreted by an LSTM decoder as per normal. We refer to hybrid models that use a CNN and LSTM as <a href="https://machinelearningmastery.com/cnn-long-short-term-memory-networks/">CNN-LSTM models</a>, and in this case we are using them together in an encoder-decoder architecture.</p>
<p>The CNN expects the input data to have the same 3D structure as the LSTM model, although multiple features are read as different channels that ultimately have the same effect.</p>
<p>We will simplify the example and focus on the CNN-LSTM with univariate input, but it can just as easily be updated to use multivariate input, which is left as an exercise.</p>
<p>As before, we will use input sequences comprised of 14 days of daily total power consumption.</p>
<p>We will define a simple but effective CNN architecture for the encoder that is comprised of two convolutional layers followed by a max pooling layer, the results of which are then flattened.</p>
<p>The first convolutional layer reads across the input sequence and projects the results onto feature maps. The second performs the same operation on the feature maps created by the first layer, attempting to amplify any salient features. We will use 64 feature maps per convolutional layer and read the input sequences with a kernel size of three time steps.</p>
<p>The max pooling layer simplifies the feature maps by keeping 1/4 of the values with the largest (max) signal. The distilled feature maps after the pooling layer are then flattened into one long vector that can then be used as input to the decoding process.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80be4170214150" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
model.add(Conv1D(filters=64, kernel_size=3, activation='relu', input_shape=(n_timesteps,n_features)))
model.add(Conv1D(filters=64, kernel_size=3, activation='relu'))
model.add(MaxPooling1D(pool_size=2))
model.add(Flatten())</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80be4170214150-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be4170214150-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be4170214150-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be4170214150-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80be4170214150-1"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Conv1D</span><span class="crayon-sy">(</span><span class="crayon-v">filters</span><span class="crayon-o">=</span><span class="crayon-cn">64</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kernel_size</span><span class="crayon-o">=</span><span class="crayon-cn">3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps</span><span class="crayon-sy">,</span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be4170214150-2"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Conv1D</span><span class="crayon-sy">(</span><span class="crayon-v">filters</span><span class="crayon-o">=</span><span class="crayon-cn">64</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kernel_size</span><span class="crayon-o">=</span><span class="crayon-cn">3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be4170214150-3"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">MaxPooling1D</span><span class="crayon-sy">(</span><span class="crayon-v">pool_size</span><span class="crayon-o">=</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be4170214150-4"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Flatten</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>The decoder is the same as was defined in previous sections.</p>
<p>The only other change is to set the number of training epochs to 20.</p>
<p>The <em>build_model()</em> function with these changes is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80be6798526715" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# train the model
def build_model(train, n_input):
	# prepare data
	train_x, train_y = to_supervised(train, n_input)
	# define parameters
	verbose, epochs, batch_size = 0, 20, 16
	n_timesteps, n_features, n_outputs = train_x.shape[1], train_x.shape[2], train_y.shape[1]
	# reshape output into [samples, timesteps, features]
	train_y = train_y.reshape((train_y.shape[0], train_y.shape[1], 1))
	# define model
	model = Sequential()
	model.add(Conv1D(filters=64, kernel_size=3, activation='relu', input_shape=(n_timesteps,n_features)))
	model.add(Conv1D(filters=64, kernel_size=3, activation='relu'))
	model.add(MaxPooling1D(pool_size=2))
	model.add(Flatten())
	model.add(RepeatVector(n_outputs))
	model.add(LSTM(200, activation='relu', return_sequences=True))
	model.add(TimeDistributed(Dense(100, activation='relu')))
	model.add(TimeDistributed(Dense(1)))
	model.compile(loss='mse', optimizer='adam')
	# fit network
	model.fit(train_x, train_y, epochs=epochs, batch_size=batch_size, verbose=verbose)
	return model</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80be6798526715-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be6798526715-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be6798526715-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be6798526715-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be6798526715-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be6798526715-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be6798526715-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be6798526715-8">8</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be6798526715-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be6798526715-10">10</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be6798526715-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be6798526715-12">12</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be6798526715-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be6798526715-14">14</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be6798526715-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be6798526715-16">16</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be6798526715-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be6798526715-18">18</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be6798526715-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be6798526715-20">20</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be6798526715-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be6798526715-22">22</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be6798526715-23">23</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80be6798526715-1"><span class="crayon-p"># train the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be6798526715-2"><span class="crayon-e">def </span><span class="crayon-e">build_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be6798526715-3"><span class="crayon-h"> </span><span class="crayon-p"># prepare data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be6798526715-4"><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be6798526715-5"><span class="crayon-h"> </span><span class="crayon-p"># define parameters</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be6798526715-6"><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">20</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">16</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be6798526715-7"><span class="crayon-h"> </span><span class="crayon-v">n_timesteps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be6798526715-8"><span class="crayon-h"> </span><span class="crayon-p"># reshape output into [samples, timesteps, features]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be6798526715-9"><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be6798526715-10"><span class="crayon-h"> </span><span class="crayon-p"># define model</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be6798526715-11"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be6798526715-12"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Conv1D</span><span class="crayon-sy">(</span><span class="crayon-v">filters</span><span class="crayon-o">=</span><span class="crayon-cn">64</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kernel_size</span><span class="crayon-o">=</span><span class="crayon-cn">3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps</span><span class="crayon-sy">,</span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be6798526715-13"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Conv1D</span><span class="crayon-sy">(</span><span class="crayon-v">filters</span><span class="crayon-o">=</span><span class="crayon-cn">64</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kernel_size</span><span class="crayon-o">=</span><span class="crayon-cn">3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be6798526715-14"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">MaxPooling1D</span><span class="crayon-sy">(</span><span class="crayon-v">pool_size</span><span class="crayon-o">=</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be6798526715-15"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Flatten</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be6798526715-16"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">n_outputs</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be6798526715-17"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">200</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be6798526715-18"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">100</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be6798526715-19"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be6798526715-20"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'mse'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be6798526715-21"><span class="crayon-h"> </span><span class="crayon-p"># fit network</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be6798526715-22"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">train_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-v">epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-v">verbose</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be6798526715-23"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0020 seconds] -->
<p>We are now ready to try the encoder-decoder architecture with a CNN encoder.</p>
<p>The complete code listing is provided below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80be7305399853" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# univariate multi-step encoder-decoder cnn-lstm
from math import sqrt
from numpy import split
from numpy import array
from pandas import read_csv
from sklearn.metrics import mean_squared_error
from matplotlib import pyplot
from keras.models import Sequential
from keras.layers import Dense
from keras.layers import Flatten
from keras.layers import LSTM
from keras.layers import RepeatVector
from keras.layers import TimeDistributed
from keras.layers.convolutional import Conv1D
from keras.layers.convolutional import MaxPooling1D

# split a univariate dataset into train/test sets
def split_dataset(data):
	# split into standard weeks
	train, test = data[1:-328], data[-328:-6]
	# restructure into windows of weekly data
	train = array(split(train, len(train)/7))
	test = array(split(test, len(test)/7))
	return train, test

# evaluate one or more weekly forecasts against expected values
def evaluate_forecasts(actual, predicted):
	scores = list()
	# calculate an RMSE score for each day
	for i in range(actual.shape[1]):
		# calculate mse
		mse = mean_squared_error(actual[:, i], predicted[:, i])
		# calculate rmse
		rmse = sqrt(mse)
		# store
		scores.append(rmse)
	# calculate overall RMSE
	s = 0
	for row in range(actual.shape[0]):
		for col in range(actual.shape[1]):
			s += (actual[row, col] - predicted[row, col])**2
	score = sqrt(s / (actual.shape[0] * actual.shape[1]))
	return score, scores

# summarize scores
def summarize_scores(name, score, scores):
	s_scores = ', '.join(['%.1f' % s for s in scores])
	print('%s: [%.3f] %s' % (name, score, s_scores))

# convert history into inputs and outputs
def to_supervised(train, n_input, n_out=7):
	# flatten data
	data = train.reshape((train.shape[0]*train.shape[1], train.shape[2]))
	X, y = list(), list()
	in_start = 0
	# step over the entire history one time step at a time
	for _ in range(len(data)):
		# define the end of the input sequence
		in_end = in_start + n_input
		out_end = in_end + n_out
		# ensure we have enough data for this instance
		if out_end &lt; len(data):
			x_input = data[in_start:in_end, 0]
			x_input = x_input.reshape((len(x_input), 1))
			X.append(x_input)
			y.append(data[in_end:out_end, 0])
		# move along one time step
		in_start += 1
	return array(X), array(y)

# train the model
def build_model(train, n_input):
	# prepare data
	train_x, train_y = to_supervised(train, n_input)
	# define parameters
	verbose, epochs, batch_size = 0, 20, 16
	n_timesteps, n_features, n_outputs = train_x.shape[1], train_x.shape[2], train_y.shape[1]
	# reshape output into [samples, timesteps, features]
	train_y = train_y.reshape((train_y.shape[0], train_y.shape[1], 1))
	# define model
	model = Sequential()
	model.add(Conv1D(filters=64, kernel_size=3, activation='relu', input_shape=(n_timesteps,n_features)))
	model.add(Conv1D(filters=64, kernel_size=3, activation='relu'))
	model.add(MaxPooling1D(pool_size=2))
	model.add(Flatten())
	model.add(RepeatVector(n_outputs))
	model.add(LSTM(200, activation='relu', return_sequences=True))
	model.add(TimeDistributed(Dense(100, activation='relu')))
	model.add(TimeDistributed(Dense(1)))
	model.compile(loss='mse', optimizer='adam')
	# fit network
	model.fit(train_x, train_y, epochs=epochs, batch_size=batch_size, verbose=verbose)
	return model

# make a forecast
def forecast(model, history, n_input):
	# flatten data
	data = array(history)
	data = data.reshape((data.shape[0]*data.shape[1], data.shape[2]))
	# retrieve last observations for input data
	input_x = data[-n_input:, 0]
	# reshape into [1, n_input, 1]
	input_x = input_x.reshape((1, len(input_x), 1))
	# forecast the next week
	yhat = model.predict(input_x, verbose=0)
	# we only want the vector forecast
	yhat = yhat[0]
	return yhat

# evaluate a single model
def evaluate_model(train, test, n_input):
	# fit model
	model = build_model(train, n_input)
	# history is a list of weekly data
	history = [x for x in train]
	# walk-forward validation over each week
	predictions = list()
	for i in range(len(test)):
		# predict the week
		yhat_sequence = forecast(model, history, n_input)
		# store the predictions
		predictions.append(yhat_sequence)
		# get real observation and add to history for predicting the next week
		history.append(test[i, :])
	# evaluate predictions days for each week
	predictions = array(predictions)
	score, scores = evaluate_forecasts(test[:, :, 0], predictions)
	return score, scores

# load the new file
dataset = read_csv('household_power_consumption_days.csv', header=0, infer_datetime_format=True, parse_dates=['datetime'], index_col=['datetime'])
# split into train and test
train, test = split_dataset(dataset.values)
# evaluate model and get scores
n_input = 14
score, scores = evaluate_model(train, test, n_input)
# summarize scores
summarize_scores('lstm', score, scores)
# plot scores
days = ['sun', 'mon', 'tue', 'wed', 'thr', 'fri', 'sat']
pyplot.plot(days, scores, marker='o', label='lstm')
pyplot.show()</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-8">8</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-10">10</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-12">12</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-14">14</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-16">16</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-18">18</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-20">20</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-22">22</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-24">24</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-26">26</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-28">28</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-30">30</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-32">32</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-34">34</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-36">36</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-38">38</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-40">40</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-42">42</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-44">44</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-46">46</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-48">48</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-50">50</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-52">52</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-54">54</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-56">56</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-58">58</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-60">60</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-62">62</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-64">64</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-66">66</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-68">68</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-70">70</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-72">72</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-74">74</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-76">76</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-78">78</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-80">80</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-82">82</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-84">84</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-86">86</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-88">88</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-90">90</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-92">92</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-94">94</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-96">96</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-98">98</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-100">100</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-101">101</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-102">102</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-103">103</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-104">104</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-105">105</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-106">106</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-107">107</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-108">108</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-109">109</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-110">110</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-111">111</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-112">112</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-113">113</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-114">114</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-115">115</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-116">116</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-117">117</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-118">118</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-119">119</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-120">120</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-121">121</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-122">122</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-123">123</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-124">124</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-125">125</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-126">126</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-127">127</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-128">128</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-129">129</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-130">130</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-131">131</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-132">132</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-133">133</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-134">134</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-135">135</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-136">136</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-137">137</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-138">138</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-139">139</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-140">140</div><div class="crayon-num" data-line="crayon-5c0c9e4d80be7305399853-141">141</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80be7305399853-142">142</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-1"><span class="crayon-p"># univariate multi-step encoder-decoder cnn-lstm</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-2"><span class="crayon-e">from </span><span class="crayon-e">math </span><span class="crayon-e">import </span><span class="crayon-e">sqrt</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-3"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">split</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-4"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-t">array</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-5"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">read_csv</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-6"><span class="crayon-e">from </span><span class="crayon-v">sklearn</span><span class="crayon-sy">.</span><span class="crayon-e">metrics </span><span class="crayon-e">import </span><span class="crayon-e">mean_squared_error</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-7"><span class="crayon-e">from </span><span class="crayon-e">matplotlib </span><span class="crayon-e">import </span><span class="crayon-e">pyplot</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-8"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-e">Sequential</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-9"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Dense</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-10"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Flatten</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-11"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">LSTM</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-12"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">RepeatVector</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-13"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">TimeDistributed</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-14"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">.</span><span class="crayon-e">convolutional </span><span class="crayon-e">import </span><span class="crayon-e">Conv1D</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-15"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">.</span><span class="crayon-e">convolutional </span><span class="crayon-e">import </span><span class="crayon-v">MaxPooling1D</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-16"> </div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-17"><span class="crayon-p"># split a univariate dataset into train/test sets</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-18"><span class="crayon-e">def </span><span class="crayon-e">split_dataset</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-19"><span class="crayon-h"> </span><span class="crayon-p"># split into standard weeks</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-20"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">328</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">328</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">6</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-21"><span class="crayon-h"> </span><span class="crayon-p"># restructure into windows of weekly data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-22"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-23"><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-24"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-25"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-26"><span class="crayon-p"># evaluate one or more weekly forecasts against expected values</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-27"><span class="crayon-e">def </span><span class="crayon-e">evaluate_forecasts</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-28"><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-29"><span class="crayon-h"> </span><span class="crayon-p"># calculate an RMSE score for each day</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-30"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-31"><span class="crayon-h"> </span><span class="crayon-p"># calculate mse</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-32"><span class="crayon-h"> </span><span class="crayon-v">mse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">mean_squared_error</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-33"><span class="crayon-h"> </span><span class="crayon-p"># calculate rmse</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-34"><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sqrt</span><span class="crayon-sy">(</span><span class="crayon-v">mse</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-35"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-36"><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-37"><span class="crayon-h"> </span><span class="crayon-p"># calculate overall RMSE</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-38"><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-39"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">row </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-40"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">col </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-41"><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">[</span><span class="crayon-v">row</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">col</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">[</span><span class="crayon-v">row</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">col</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-cn">2</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-42"><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sqrt</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-43"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-44"> </div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-45"><span class="crayon-p"># summarize scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-46"><span class="crayon-e">def </span><span class="crayon-e">summarize_scores</span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-47"><span class="crayon-h"> </span><span class="crayon-v">s_scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">', '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-s">'%.1f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-48"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'%s: [%.3f] %s'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">s_scores</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-49"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-50"><span class="crayon-p"># convert history into inputs and outputs</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-51"><span class="crayon-e">def </span><span class="crayon-e">to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_out</span><span class="crayon-o">=</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-52"><span class="crayon-h"> </span><span class="crayon-p"># flatten data</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-53"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-o">*</span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-54"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-55"><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-56"><span class="crayon-h"> </span><span class="crayon-p"># step over the entire history one time step at a time</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-57"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-58"><span class="crayon-h"> </span><span class="crayon-p"># define the end of the input sequence</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-59"><span class="crayon-h"> </span><span class="crayon-v">in_end</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">n_input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-60"><span class="crayon-e"> </span><span class="crayon-v">out_end</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">in_end</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">n_out</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-61"><span class="crayon-h"> </span><span class="crayon-p"># ensure we have enough data for this instance</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-62"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">out_end</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-63"><span class="crayon-h"> </span><span class="crayon-v">x_input</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-v">in_start</span><span class="crayon-o">:</span><span class="crayon-v">in_end</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-64"><span class="crayon-h"> </span><span class="crayon-v">x_input</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">x_input</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">x_input</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-65"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">x_input</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-66"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-v">in_end</span><span class="crayon-o">:</span><span class="crayon-v">out_end</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-67"><span class="crayon-h"> </span><span class="crayon-p"># move along one time step</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-68"><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-69"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-70"> </div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-71"><span class="crayon-p"># train the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-72"><span class="crayon-e">def </span><span class="crayon-e">build_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-73"><span class="crayon-h"> </span><span class="crayon-p"># prepare data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-74"><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-75"><span class="crayon-h"> </span><span class="crayon-p"># define parameters</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-76"><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">20</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">16</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-77"><span class="crayon-h"> </span><span class="crayon-v">n_timesteps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-78"><span class="crayon-h"> </span><span class="crayon-p"># reshape output into [samples, timesteps, features]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-79"><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-80"><span class="crayon-h"> </span><span class="crayon-p"># define model</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-81"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-82"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Conv1D</span><span class="crayon-sy">(</span><span class="crayon-v">filters</span><span class="crayon-o">=</span><span class="crayon-cn">64</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kernel_size</span><span class="crayon-o">=</span><span class="crayon-cn">3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps</span><span class="crayon-sy">,</span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-83"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Conv1D</span><span class="crayon-sy">(</span><span class="crayon-v">filters</span><span class="crayon-o">=</span><span class="crayon-cn">64</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kernel_size</span><span class="crayon-o">=</span><span class="crayon-cn">3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-84"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">MaxPooling1D</span><span class="crayon-sy">(</span><span class="crayon-v">pool_size</span><span class="crayon-o">=</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-85"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Flatten</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-86"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">n_outputs</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-87"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">200</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-88"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">100</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-89"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-90"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'mse'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-91"><span class="crayon-h"> </span><span class="crayon-p"># fit network</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-92"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">train_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-v">epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-v">verbose</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-93"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-94"> </div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-95"><span class="crayon-p"># make a forecast</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-96"><span class="crayon-e">def </span><span class="crayon-e">forecast</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-97"><span class="crayon-h"> </span><span class="crayon-p"># flatten data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-98"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">history</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-99"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-o">*</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-100"><span class="crayon-h"> </span><span class="crayon-p"># retrieve last observations for input data</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-101"><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-v">n_input</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-102"><span class="crayon-h"> </span><span class="crayon-p"># reshape into [1, n_input, 1]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-103"><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">input_x</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-104"><span class="crayon-h"> </span><span class="crayon-p"># forecast the next week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-105"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">input_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-106"><span class="crayon-h"> </span><span class="crayon-p"># we only want the vector forecast</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-107"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-108"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-109"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-110"><span class="crayon-p"># evaluate a single model</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-111"><span class="crayon-e">def </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-112"><span class="crayon-h"> </span><span class="crayon-p"># fit model</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-113"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">build_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-114"><span class="crayon-h"> </span><span class="crayon-p"># history is a list of weekly data</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-115"><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-i">x</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">x</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-116"><span class="crayon-h"> </span><span class="crayon-p"># walk-forward validation over each week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-117"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-118"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-119"><span class="crayon-h"> </span><span class="crayon-p"># predict the week</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-120"><span class="crayon-h"> </span><span class="crayon-v">yhat_sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">forecast</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-121"><span class="crayon-h"> </span><span class="crayon-p"># store the predictions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-122"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat_sequence</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-123"><span class="crayon-h"> </span><span class="crayon-p"># get real observation and add to history for predicting the next week</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-124"><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-125"><span class="crayon-h"> </span><span class="crayon-p"># evaluate predictions days for each week</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-126"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">predictions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-127"><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">evaluate_forecasts</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-128"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-129"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-130"><span class="crayon-p"># load the new file</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-131"><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'household_power_consumption_days.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">infer_datetime_format</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">parse_dates</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'datetime'</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index_col</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'datetime'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-132"><span class="crayon-p"># split into train and test</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-133"><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">split_dataset</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-v">values</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-134"><span class="crayon-p"># evaluate model and get scores</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-135"><span class="crayon-v">n_input</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">14</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-136"><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-137"><span class="crayon-p"># summarize scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-138"><span class="crayon-e">summarize_scores</span><span class="crayon-sy">(</span><span class="crayon-s">'lstm'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-139"><span class="crayon-p"># plot scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-140"><span class="crayon-v">days</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">'sun'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'mon'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'tue'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'wed'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'thr'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'fri'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'sat'</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80be7305399853-141"><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">plot</span><span class="crayon-sy">(</span><span class="crayon-v">days</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">marker</span><span class="crayon-o">=</span><span class="crayon-s">'o'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">label</span><span class="crayon-o">=</span><span class="crayon-s">'lstm'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80be7305399853-142"><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">show</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0082 seconds] -->
<p>Running the example fits the model and summarizes the performance on the test dataset.</p>
<p>A little experimentation showed that using two convolutional layers made the model more stable than using just a single layer.</p>
<p>Your specific results may vary given the stochastic nature of the algorithm. You may want to try running the example a few times.</p>
<p>We can see that in this case the model is skillful, achieving an overall RMSE score of about 372 kilowatts.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bea066747258" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
lstm: [372.055] 383.8, 381.6, 339.1, 371.8, 371.8, 319.6, 427.2</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bea066747258-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bea066747258-1">lstm: [372.055] 383.8, 381.6, 339.1, 371.8, 371.8, 319.6, 427.2</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>A line plot of the per-day RMSE is also created.</p>
<div class="wp-caption aligncenter" id="attachment_6291" style="width: 1290px"><img alt="Line Plot of RMSE per Day for Univariate Encoder-Decoder CNN LSTM with 14-day Inputs" class="size-full wp-image-6291" height="960" sizes="(max-width: 1280px) 100vw, 1280px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-Encoder-Decoder-CNN-LSTM-with-14-day-Inputs.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-Encoder-Decoder-CNN-LSTM-with-14-day-Inputs.png 1280w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-Encoder-Decoder-CNN-LSTM-with-14-day-Inputs-300x225.png 300w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-Encoder-Decoder-CNN-LSTM-with-14-day-Inputs-768x576.png 768w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-Encoder-Decoder-CNN-LSTM-with-14-day-Inputs-1024x768.png 1024w" width="1280"/><p class="wp-caption-text">Line Plot of RMSE per Day for Univariate Encoder-Decoder CNN LSTM with 14-day Inputs</p></div>
<h2>ConvLSTM Encoder-Decoder Model With Univariate Input</h2>
<p>A further extension of the CNN-LSTM approach is to perform the convolutions of the CNN (e.g. how the CNN reads the input sequence data) as part of the LSTM for each time step.</p>
<p>This combination is called a Convolutional LSTM, or ConvLSTM for short, and like the CNN-LSTM is also used for spatio-temporal data.</p>
<p>Unlike an LSTM that reads the data in directly in order to calculate internal state and state transitions, and unlike the CNN-LSTM that is interpreting the output from CNN models, the ConvLSTM is using convolutions directly as part of reading input into the LSTM units themselves.</p>
<p>For more information for how the equations for the ConvLSTM are calculated within the LSTM unit, see the paper:</p>
<ul>
<li><a href="https://arxiv.org/abs/1506.04214v1">Convolutional LSTM Network: A Machine Learning Approach for Precipitation Nowcasting</a>, 2015.</li>
</ul>
<p>The Keras library provides the <a href="https://keras.io/layers/recurrent/#convlstm2d">ConvLSTM2D class</a> that supports the ConvLSTM model for 2D data. It can be configured for 1D multivariate time series forecasting.</p>
<p>The ConvLSTM2D class, by default, expects input data to have the shape:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bed291813788" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
[samples, timesteps, rows, cols, channels]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bed291813788-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bed291813788-1">[samples, timesteps, rows, cols, channels]</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>Where each time step of data is defined as an image of (<em>rows * columns</em>) data points.</p>
<p>We are working with a one-dimensional sequence of total power consumption, which we can interpret as one row with 14 columns, if we assume that we are using two weeks of data as input.</p>
<p>For the ConvLSTM, this would be a single read: that is, the LSTM would read one time step of 14 days and perform a convolution across those time steps.</p>
<p>This is not ideal.</p>
<p>Instead, we can split the 14 days into two subsequences with a length of seven days. The ConvLSTM can then read across the two time steps and perform the CNN process on the seven days of data within each.</p>
<p>For this chosen framing of the problem, the input for the ConvLSTM2D would therefore be:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bef045878121" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
[n, 2, 1, 7, 1]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bef045878121-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bef045878121-1">[n, 2, 1, 7, 1]</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>Or:</p>
<ul>
<li><strong>Samples</strong>: n, for the number of examples in the training dataset.</li>
<li><strong>Time</strong>: 2, for the two subsequences that we split a window of 14 days into.</li>
<li><strong>Rows</strong>: 1, for the one-dimensional shape of each subsequence.</li>
<li><strong>Columns</strong>: 7, for the seven days in each subsequence.</li>
<li><strong>Channels</strong>: 1, for the single feature that we are working with as input.</li>
</ul>
<p>You can explore other configurations, such as providing 21 days of input split into three subsequences of seven days, and/or providing all eight features or channels as input.</p>
<p>We can now prepare the data for the ConvLSTM2D model.</p>
<p>First, we must reshape the training dataset into the expected structure of [<em>samples, timesteps, rows, cols, channels</em>].</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bf1988907319" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# reshape into subsequences [samples, time steps, rows, cols, channels]
train_x = train_x.reshape((train_x.shape[0], n_steps, 1, n_length, n_features))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bf1988907319-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf1988907319-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bf1988907319-1"><span class="crayon-p"># reshape into subsequences [samples, time steps, rows, cols, channels]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf1988907319-2"><span class="crayon-v">train_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>We can then define the encoder as a ConvLSTM hidden layer followed by a flatten layer ready for decoding.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bf2228131178" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
model.add(ConvLSTM2D(filters=64, kernel_size=(1,3), activation='relu', input_shape=(n_steps, 1, n_length, n_features)))
model.add(Flatten())</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bf2228131178-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf2228131178-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bf2228131178-1"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">ConvLSTM2D</span><span class="crayon-sy">(</span><span class="crayon-v">filters</span><span class="crayon-o">=</span><span class="crayon-cn">64</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kernel_size</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-cn">3</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf2228131178-2"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Flatten</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0004 seconds] -->
<p>We will also parameterize the number of subsequences (<em>n_steps</em>) and the length of each subsequence (<em>n_length</em>) and pass them as arguments.</p>
<p>The rest of the model and training is the same. The <em>build_model()</em> function with these changes is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bf4322101253" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# train the model
def build_model(train, n_steps, n_length, n_input):
	# prepare data
	train_x, train_y = to_supervised(train, n_input)
	# define parameters
	verbose, epochs, batch_size = 0, 20, 16
	n_timesteps, n_features, n_outputs = train_x.shape[1], train_x.shape[2], train_y.shape[1]
	# reshape into subsequences [samples, time steps, rows, cols, channels]
	train_x = train_x.reshape((train_x.shape[0], n_steps, 1, n_length, n_features))
	# reshape output into [samples, timesteps, features]
	train_y = train_y.reshape((train_y.shape[0], train_y.shape[1], 1))
	# define model
	model = Sequential()
	model.add(ConvLSTM2D(filters=64, kernel_size=(1,3), activation='relu', input_shape=(n_steps, 1, n_length, n_features)))
	model.add(Flatten())
	model.add(RepeatVector(n_outputs))
	model.add(LSTM(200, activation='relu', return_sequences=True))
	model.add(TimeDistributed(Dense(100, activation='relu')))
	model.add(TimeDistributed(Dense(1)))
	model.compile(loss='mse', optimizer='adam')
	# fit network
	model.fit(train_x, train_y, epochs=epochs, batch_size=batch_size, verbose=verbose)
	return model</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bf4322101253-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf4322101253-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf4322101253-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf4322101253-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf4322101253-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf4322101253-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf4322101253-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf4322101253-8">8</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf4322101253-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf4322101253-10">10</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf4322101253-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf4322101253-12">12</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf4322101253-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf4322101253-14">14</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf4322101253-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf4322101253-16">16</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf4322101253-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf4322101253-18">18</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf4322101253-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf4322101253-20">20</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf4322101253-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf4322101253-22">22</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf4322101253-23">23</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bf4322101253-1"><span class="crayon-p"># train the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf4322101253-2"><span class="crayon-e">def </span><span class="crayon-e">build_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf4322101253-3"><span class="crayon-h"> </span><span class="crayon-p"># prepare data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf4322101253-4"><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf4322101253-5"><span class="crayon-h"> </span><span class="crayon-p"># define parameters</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf4322101253-6"><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">20</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">16</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf4322101253-7"><span class="crayon-h"> </span><span class="crayon-v">n_timesteps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf4322101253-8"><span class="crayon-h"> </span><span class="crayon-p"># reshape into subsequences [samples, time steps, rows, cols, channels]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf4322101253-9"><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf4322101253-10"><span class="crayon-h"> </span><span class="crayon-p"># reshape output into [samples, timesteps, features]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf4322101253-11"><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf4322101253-12"><span class="crayon-h"> </span><span class="crayon-p"># define model</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf4322101253-13"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf4322101253-14"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">ConvLSTM2D</span><span class="crayon-sy">(</span><span class="crayon-v">filters</span><span class="crayon-o">=</span><span class="crayon-cn">64</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kernel_size</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-cn">3</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf4322101253-15"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Flatten</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf4322101253-16"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">n_outputs</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf4322101253-17"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">200</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf4322101253-18"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">100</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf4322101253-19"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf4322101253-20"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'mse'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf4322101253-21"><span class="crayon-h"> </span><span class="crayon-p"># fit network</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf4322101253-22"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">train_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-v">epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-v">verbose</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf4322101253-23"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0022 seconds] -->
<p>This model expects five-dimensional data as input. Therefore, we must also update the preparation of a single sample in the <em>forecast()</em> function when making a prediction.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bf6618592954" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# reshape into [samples, time steps, rows, cols, channels]
input_x = input_x.reshape((1, n_steps, 1, n_length, 1))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bf6618592954-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf6618592954-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bf6618592954-1"><span class="crayon-p"># reshape into [samples, time steps, rows, cols, channels]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf6618592954-2"><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>The <em>forecast()</em> function with this change and with the parameterized subsequences is provided below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bf8363288000" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# make a forecast
def forecast(model, history, n_steps, n_length, n_input):
	# flatten data
	data = array(history)
	data = data.reshape((data.shape[0]*data.shape[1], data.shape[2]))
	# retrieve last observations for input data
	input_x = data[-n_input:, 0]
	# reshape into [samples, time steps, rows, cols, channels]
	input_x = input_x.reshape((1, n_steps, 1, n_length, 1))
	# forecast the next week
	yhat = model.predict(input_x, verbose=0)
	# we only want the vector forecast
	yhat = yhat[0]
	return yhat</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bf8363288000-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf8363288000-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf8363288000-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf8363288000-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf8363288000-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf8363288000-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf8363288000-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf8363288000-8">8</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf8363288000-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf8363288000-10">10</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf8363288000-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf8363288000-12">12</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf8363288000-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf8363288000-14">14</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bf8363288000-1"><span class="crayon-p"># make a forecast</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf8363288000-2"><span class="crayon-e">def </span><span class="crayon-e">forecast</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf8363288000-3"><span class="crayon-h"> </span><span class="crayon-p"># flatten data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf8363288000-4"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">history</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf8363288000-5"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-o">*</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf8363288000-6"><span class="crayon-h"> </span><span class="crayon-p"># retrieve last observations for input data</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf8363288000-7"><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-v">n_input</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf8363288000-8"><span class="crayon-h"> </span><span class="crayon-p"># reshape into [samples, time steps, rows, cols, channels]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf8363288000-9"><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf8363288000-10"><span class="crayon-h"> </span><span class="crayon-p"># forecast the next week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf8363288000-11"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">input_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf8363288000-12"><span class="crayon-h"> </span><span class="crayon-p"># we only want the vector forecast</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf8363288000-13"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf8363288000-14"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0009 seconds] -->
<p>We now have all of the elements for evaluating an encoder-decoder architecture for multi-step time series forecasting where a ConvLSTM is used as the encoder.</p>
<p>The complete code example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bf9981674900" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# univariate multi-step encoder-decoder convlstm
from math import sqrt
from numpy import split
from numpy import array
from pandas import read_csv
from sklearn.metrics import mean_squared_error
from matplotlib import pyplot
from keras.models import Sequential
from keras.layers import Dense
from keras.layers import Flatten
from keras.layers import LSTM
from keras.layers import RepeatVector
from keras.layers import TimeDistributed
from keras.layers import ConvLSTM2D

# split a univariate dataset into train/test sets
def split_dataset(data):
	# split into standard weeks
	train, test = data[1:-328], data[-328:-6]
	# restructure into windows of weekly data
	train = array(split(train, len(train)/7))
	test = array(split(test, len(test)/7))
	return train, test

# evaluate one or more weekly forecasts against expected values
def evaluate_forecasts(actual, predicted):
	scores = list()
	# calculate an RMSE score for each day
	for i in range(actual.shape[1]):
		# calculate mse
		mse = mean_squared_error(actual[:, i], predicted[:, i])
		# calculate rmse
		rmse = sqrt(mse)
		# store
		scores.append(rmse)
	# calculate overall RMSE
	s = 0
	for row in range(actual.shape[0]):
		for col in range(actual.shape[1]):
			s += (actual[row, col] - predicted[row, col])**2
	score = sqrt(s / (actual.shape[0] * actual.shape[1]))
	return score, scores

# summarize scores
def summarize_scores(name, score, scores):
	s_scores = ', '.join(['%.1f' % s for s in scores])
	print('%s: [%.3f] %s' % (name, score, s_scores))

# convert history into inputs and outputs
def to_supervised(train, n_input, n_out=7):
	# flatten data
	data = train.reshape((train.shape[0]*train.shape[1], train.shape[2]))
	X, y = list(), list()
	in_start = 0
	# step over the entire history one time step at a time
	for _ in range(len(data)):
		# define the end of the input sequence
		in_end = in_start + n_input
		out_end = in_end + n_out
		# ensure we have enough data for this instance
		if out_end &lt; len(data):
			x_input = data[in_start:in_end, 0]
			x_input = x_input.reshape((len(x_input), 1))
			X.append(x_input)
			y.append(data[in_end:out_end, 0])
		# move along one time step
		in_start += 1
	return array(X), array(y)

# train the model
def build_model(train, n_steps, n_length, n_input):
	# prepare data
	train_x, train_y = to_supervised(train, n_input)
	# define parameters
	verbose, epochs, batch_size = 0, 20, 16
	n_timesteps, n_features, n_outputs = train_x.shape[1], train_x.shape[2], train_y.shape[1]
	# reshape into subsequences [samples, time steps, rows, cols, channels]
	train_x = train_x.reshape((train_x.shape[0], n_steps, 1, n_length, n_features))
	# reshape output into [samples, timesteps, features]
	train_y = train_y.reshape((train_y.shape[0], train_y.shape[1], 1))
	# define model
	model = Sequential()
	model.add(ConvLSTM2D(filters=64, kernel_size=(1,3), activation='relu', input_shape=(n_steps, 1, n_length, n_features)))
	model.add(Flatten())
	model.add(RepeatVector(n_outputs))
	model.add(LSTM(200, activation='relu', return_sequences=True))
	model.add(TimeDistributed(Dense(100, activation='relu')))
	model.add(TimeDistributed(Dense(1)))
	model.compile(loss='mse', optimizer='adam')
	# fit network
	model.fit(train_x, train_y, epochs=epochs, batch_size=batch_size, verbose=verbose)
	return model

# make a forecast
def forecast(model, history, n_steps, n_length, n_input):
	# flatten data
	data = array(history)
	data = data.reshape((data.shape[0]*data.shape[1], data.shape[2]))
	# retrieve last observations for input data
	input_x = data[-n_input:, 0]
	# reshape into [samples, time steps, rows, cols, channels]
	input_x = input_x.reshape((1, n_steps, 1, n_length, 1))
	# forecast the next week
	yhat = model.predict(input_x, verbose=0)
	# we only want the vector forecast
	yhat = yhat[0]
	return yhat

# evaluate a single model
def evaluate_model(train, test, n_steps, n_length, n_input):
	# fit model
	model = build_model(train, n_steps, n_length, n_input)
	# history is a list of weekly data
	history = [x for x in train]
	# walk-forward validation over each week
	predictions = list()
	for i in range(len(test)):
		# predict the week
		yhat_sequence = forecast(model, history, n_steps, n_length, n_input)
		# store the predictions
		predictions.append(yhat_sequence)
		# get real observation and add to history for predicting the next week
		history.append(test[i, :])
	# evaluate predictions days for each week
	predictions = array(predictions)
	score, scores = evaluate_forecasts(test[:, :, 0], predictions)
	return score, scores

# load the new file
dataset = read_csv('household_power_consumption_days.csv', header=0, infer_datetime_format=True, parse_dates=['datetime'], index_col=['datetime'])
# split into train and test
train, test = split_dataset(dataset.values)
# define the number of subsequences and the length of subsequences
n_steps, n_length = 2, 7
# define the total days to use as input
n_input = n_length * n_steps
score, scores = evaluate_model(train, test, n_steps, n_length, n_input)
# summarize scores
summarize_scores('lstm', score, scores)
# plot scores
days = ['sun', 'mon', 'tue', 'wed', 'thr', 'fri', 'sat']
pyplot.plot(days, scores, marker='o', label='lstm')
pyplot.show()</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-6">6</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-8">8</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-10">10</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-12">12</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-14">14</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-16">16</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-18">18</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-20">20</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-22">22</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-24">24</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-26">26</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-28">28</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-30">30</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-32">32</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-34">34</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-36">36</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-38">38</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-40">40</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-42">42</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-44">44</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-46">46</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-48">48</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-50">50</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-52">52</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-54">54</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-56">56</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-58">58</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-60">60</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-62">62</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-64">64</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-66">66</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-68">68</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-70">70</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-72">72</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-74">74</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-76">76</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-78">78</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-80">80</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-82">82</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-84">84</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-86">86</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-88">88</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-90">90</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-92">92</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-94">94</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-96">96</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-98">98</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-100">100</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-101">101</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-102">102</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-103">103</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-104">104</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-105">105</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-106">106</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-107">107</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-108">108</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-109">109</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-110">110</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-111">111</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-112">112</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-113">113</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-114">114</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-115">115</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-116">116</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-117">117</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-118">118</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-119">119</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-120">120</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-121">121</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-122">122</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-123">123</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-124">124</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-125">125</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-126">126</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-127">127</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-128">128</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-129">129</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-130">130</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-131">131</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-132">132</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-133">133</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-134">134</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-135">135</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-136">136</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-137">137</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-138">138</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-139">139</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-140">140</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-141">141</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d80bf9981674900-142">142</div><div class="crayon-num" data-line="crayon-5c0c9e4d80bf9981674900-143">143</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-1"><span class="crayon-p"># univariate multi-step encoder-decoder convlstm</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-2"><span class="crayon-e">from </span><span class="crayon-e">math </span><span class="crayon-e">import </span><span class="crayon-e">sqrt</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-3"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">split</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-4"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-t">array</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-5"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">read_csv</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-6"><span class="crayon-e">from </span><span class="crayon-v">sklearn</span><span class="crayon-sy">.</span><span class="crayon-e">metrics </span><span class="crayon-e">import </span><span class="crayon-e">mean_squared_error</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-7"><span class="crayon-e">from </span><span class="crayon-e">matplotlib </span><span class="crayon-e">import </span><span class="crayon-e">pyplot</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-8"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-e">Sequential</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-9"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Dense</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-10"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Flatten</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-11"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">LSTM</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-12"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">RepeatVector</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-13"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">TimeDistributed</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-14"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-v">ConvLSTM2D</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-15"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-16"><span class="crayon-p"># split a univariate dataset into train/test sets</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-17"><span class="crayon-e">def </span><span class="crayon-e">split_dataset</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-18"><span class="crayon-h"> </span><span class="crayon-p"># split into standard weeks</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-19"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">328</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">328</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">6</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-20"><span class="crayon-h"> </span><span class="crayon-p"># restructure into windows of weekly data</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-21"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-22"><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-23"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-24"> </div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-25"><span class="crayon-p"># evaluate one or more weekly forecasts against expected values</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-26"><span class="crayon-e">def </span><span class="crayon-e">evaluate_forecasts</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-27"><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-28"><span class="crayon-h"> </span><span class="crayon-p"># calculate an RMSE score for each day</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-29"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-30"><span class="crayon-h"> </span><span class="crayon-p"># calculate mse</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-31"><span class="crayon-h"> </span><span class="crayon-v">mse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">mean_squared_error</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-32"><span class="crayon-h"> </span><span class="crayon-p"># calculate rmse</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-33"><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sqrt</span><span class="crayon-sy">(</span><span class="crayon-v">mse</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-34"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-35"><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-36"><span class="crayon-h"> </span><span class="crayon-p"># calculate overall RMSE</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-37"><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-38"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">row </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-39"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">col </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-40"><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">[</span><span class="crayon-v">row</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">col</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">[</span><span class="crayon-v">row</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">col</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-cn">2</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-41"><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sqrt</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-42"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-43"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-44"><span class="crayon-p"># summarize scores</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-45"><span class="crayon-e">def </span><span class="crayon-e">summarize_scores</span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-46"><span class="crayon-h"> </span><span class="crayon-v">s_scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">', '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-s">'%.1f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-47"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'%s: [%.3f] %s'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">s_scores</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-48"> </div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-49"><span class="crayon-p"># convert history into inputs and outputs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-50"><span class="crayon-e">def </span><span class="crayon-e">to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_out</span><span class="crayon-o">=</span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-51"><span class="crayon-h"> </span><span class="crayon-p"># flatten data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-52"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-o">*</span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-53"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-54"><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-55"><span class="crayon-h"> </span><span class="crayon-p"># step over the entire history one time step at a time</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-56"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-57"><span class="crayon-h"> </span><span class="crayon-p"># define the end of the input sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-58"><span class="crayon-h"> </span><span class="crayon-v">in_end</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">n_input</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-59"><span class="crayon-e"> </span><span class="crayon-v">out_end</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">in_end</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">n_out</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-60"><span class="crayon-h"> </span><span class="crayon-p"># ensure we have enough data for this instance</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-61"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">out_end</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-62"><span class="crayon-h"> </span><span class="crayon-v">x_input</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-v">in_start</span><span class="crayon-o">:</span><span class="crayon-v">in_end</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-63"><span class="crayon-h"> </span><span class="crayon-v">x_input</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">x_input</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">x_input</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-64"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">x_input</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-65"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-v">in_end</span><span class="crayon-o">:</span><span class="crayon-v">out_end</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-66"><span class="crayon-h"> </span><span class="crayon-p"># move along one time step</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-67"><span class="crayon-h"> </span><span class="crayon-v">in_start</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-68"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-69"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-70"><span class="crayon-p"># train the model</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-71"><span class="crayon-e">def </span><span class="crayon-e">build_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-72"><span class="crayon-h"> </span><span class="crayon-p"># prepare data</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-73"><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-74"><span class="crayon-h"> </span><span class="crayon-p"># define parameters</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-75"><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">20</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">16</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-76"><span class="crayon-h"> </span><span class="crayon-v">n_timesteps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-77"><span class="crayon-h"> </span><span class="crayon-p"># reshape into subsequences [samples, time steps, rows, cols, channels]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-78"><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">train_x</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-79"><span class="crayon-h"> </span><span class="crayon-p"># reshape output into [samples, timesteps, features]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-80"><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-81"><span class="crayon-h"> </span><span class="crayon-p"># define model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-82"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-83"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">ConvLSTM2D</span><span class="crayon-sy">(</span><span class="crayon-v">filters</span><span class="crayon-o">=</span><span class="crayon-cn">64</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kernel_size</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-cn">3</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-84"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Flatten</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-85"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">n_outputs</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-86"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">200</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-87"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">100</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-88"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-89"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'mse'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-90"><span class="crayon-h"> </span><span class="crayon-p"># fit network</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-91"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">train_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-v">epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-v">verbose</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-92"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-93"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-94"><span class="crayon-p"># make a forecast</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-95"><span class="crayon-e">def </span><span class="crayon-e">forecast</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-96"><span class="crayon-h"> </span><span class="crayon-p"># flatten data</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-97"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">history</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-98"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-o">*</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-99"><span class="crayon-h"> </span><span class="crayon-p"># retrieve last observations for input data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-100"><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-v">n_input</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-101"><span class="crayon-h"> </span><span class="crayon-p"># reshape into [samples, time steps, rows, cols, channels]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-102"><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input_x</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-103"><span class="crayon-h"> </span><span class="crayon-p"># forecast the next week</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-104"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">input_x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-105"><span class="crayon-h"> </span><span class="crayon-p"># we only want the vector forecast</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-106"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-107"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-108"> </div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-109"><span class="crayon-p"># evaluate a single model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-110"><span class="crayon-e">def </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-111"><span class="crayon-h"> </span><span class="crayon-p"># fit model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-112"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">build_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-113"><span class="crayon-h"> </span><span class="crayon-p"># history is a list of weekly data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-114"><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-i">x</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">x</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-115"><span class="crayon-h"> </span><span class="crayon-p"># walk-forward validation over each week</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-116"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-117"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-118"><span class="crayon-h"> </span><span class="crayon-p"># predict the week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-119"><span class="crayon-h"> </span><span class="crayon-v">yhat_sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">forecast</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-120"><span class="crayon-h"> </span><span class="crayon-p"># store the predictions</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-121"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat_sequence</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-122"><span class="crayon-h"> </span><span class="crayon-p"># get real observation and add to history for predicting the next week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-123"><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-124"><span class="crayon-h"> </span><span class="crayon-p"># evaluate predictions days for each week</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-125"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">predictions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-126"><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">evaluate_forecasts</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-127"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-128"> </div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-129"><span class="crayon-p"># load the new file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-130"><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'household_power_consumption_days.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">infer_datetime_format</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">parse_dates</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'datetime'</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index_col</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'datetime'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-131"><span class="crayon-p"># split into train and test</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-132"><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">split_dataset</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-v">values</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-133"><span class="crayon-p"># define the number of subsequences and the length of subsequences</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-134"><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">7</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-135"><span class="crayon-p"># define the total days to use as input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-136"><span class="crayon-v">n_input</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e ">n_length *</span><span class="crayon-h"> </span><span class="crayon-e">n_steps</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-137"><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-138"><span class="crayon-p"># summarize scores</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-139"><span class="crayon-e">summarize_scores</span><span class="crayon-sy">(</span><span class="crayon-s">'lstm'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-140"><span class="crayon-p"># plot scores</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-141"><span class="crayon-v">days</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">'sun'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'mon'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'tue'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'wed'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'thr'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'fri'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'sat'</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d80bf9981674900-142"><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">plot</span><span class="crayon-sy">(</span><span class="crayon-v">days</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">scores</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">marker</span><span class="crayon-o">=</span><span class="crayon-s">'o'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">label</span><span class="crayon-o">=</span><span class="crayon-s">'lstm'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d80bf9981674900-143"><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">show</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0086 seconds] -->
<p>Running the example fits the model and summarizes the performance on the test dataset.</p>
<p>A little experimentation showed that using two convolutional layers made the model more stable than using just a single layer.</p>
<p>We can see that in this case the model is skillful, achieving an overall RMSE score of about 367 kilowatts.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d80bfc483473478" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
lstm: [367.929] 416.3, 379.7, 334.7, 362.3, 374.7, 284.8, 406.7</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d80bfc483473478-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d80bfc483473478-1">lstm: [367.929] 416.3, 379.7, 334.7, 362.3, 374.7, 284.8, 406.7</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>A line plot of the per-day RMSE is also created.</p>
<div class="wp-caption aligncenter" id="attachment_6292" style="width: 1290px"><img alt="Line Plot of RMSE per Day for Univariate Encoder-Decoder ConvLSTM with 14-day Inputs" class="size-full wp-image-6292" height="960" sizes="(max-width: 1280px) 100vw, 1280px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-Encoder-Decoder-ConvLSTM-with-14-day-Inputs.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-Encoder-Decoder-ConvLSTM-with-14-day-Inputs.png 1280w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-Encoder-Decoder-ConvLSTM-with-14-day-Inputs-300x225.png 300w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-Encoder-Decoder-ConvLSTM-with-14-day-Inputs-768x576.png 768w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/07/Line-Plot-of-RMSE-per-Day-for-Univariate-Encoder-Decoder-ConvLSTM-with-14-day-Inputs-1024x768.png 1024w" width="1280"/><p class="wp-caption-text">Line Plot of RMSE per Day for Univariate Encoder-Decoder ConvLSTM with 14-day Inputs</p></div>
<h2>Extensions</h2>
<p>This section lists some ideas for extending the tutorial that you may wish to explore.</p>
<ul>
<li><strong>Size of Input</strong>. Explore more or fewer number of days used as input for the model, such as three days, 21 days, 30 days, and more.</li>
<li><strong>Model Tuning</strong>. Tune the structure and hyperparameters for a model and further lift model performance on average.</li>
<li><strong>Data Scaling</strong>. Explore whether data scaling, such as standardization and normalization, can be used to improve the performance of any of the LSTM models.</li>
<li><strong>Learning Diagnostics</strong>. Use diagnostics such as learning curves for the train and validation loss and mean squared error to help tune the structure and hyperparameters of a LSTM model.</li>
</ul>
<p>If you explore any of these extensions, I’d love to know.</p>
<h2>Further Reading</h2>
<p>This section provides more resources on the topic if you are looking to go deeper.</p>
<h3>Posts</h3>
<ul>
<li><a href="https://machinelearningmastery.com/multi-step-time-series-forecasting/">4 Strategies for Multi-Step Time Series Forecasting</a></li>
<li><a href="https://machinelearningmastery.com/crash-course-recurrent-neural-networks-deep-learning/">Crash Course in Recurrent Neural Networks for Deep Learning</a></li>
<li><a href="https://machinelearningmastery.com/gentle-introduction-long-short-term-memory-networks-experts/">A Gentle Introduction to Long Short-Term Memory Networks by the Experts</a></li>
<li><a href="https://machinelearningmastery.com/suitability-long-short-term-memory-networks-time-series-forecasting/">On the Suitability of LSTMs for Time Series Forecasting</a></li>
<li><a href="https://machinelearningmastery.com/cnn-long-short-term-memory-networks/">CNN Long Short-Term Memory Networks</a></li>
<li><a href="https://machinelearningmastery.com/develop-encoder-decoder-model-sequence-sequence-prediction-keras/">How to Develop an Encoder-Decoder Model for Sequence-to-Sequence Prediction in Keras</a></li>
</ul>
<h3>API</h3>
<ul>
<li><a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.read_csv.html">pandas.read_csv API</a></li>
<li><a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.resample.html">pandas.DataFrame.resample API</a></li>
<li><a href="http://pandas.pydata.org/pandas-docs/stable/timeseries.html#offset-aliases">Resample Offset Aliases</a></li>
<li><a href="http://scikit-learn.org/stable/modules/generated/sklearn.metrics.mean_squared_error.html">sklearn.metrics.mean_squared_error API</a></li>
<li><a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.split.html">numpy.split API</a></li>
</ul>
<h3>Articles</h3>
<ul>
<li><a href="https://archive.ics.uci.edu/ml/datasets/individual+household+electric+power+consumption">Individual household electric power consumption Data Set, UCI Machine Learning Repository</a>.</li>
<li><a href="https://en.wikipedia.org/wiki/AC_power">AC power, Wikipedia</a>.</li>
<li><a href="https://arxiv.org/abs/1506.04214v1">Convolutional LSTM Network: A Machine Learning Approach for Precipitation Nowcasting</a>, 2015.</li>
</ul>
<h2>Summary</h2>
<p>In this tutorial, you discovered how to develop long short-term memory recurrent neural networks for multi-step time series forecasting of household power consumption.</p>
<p>Specifically, you learned:</p>
<ul>
<li>How to develop and evaluate Univariate and multivariate Encoder-Decoder LSTMs for multi-step time series forecasting.</li>
<li>How to develop and evaluate an CNN-LSTM Encoder-Decoder model for multi-step time series forecasting.</li>
<li>How to develop and evaluate a ConvLSTM Encoder-Decoder model for multi-step time series forecasting.</li>
</ul>
<p>Do you have any questions?<br/>
Ask your questions in the comments below and I will do my best to answer.</p>
<div class="awac-wrapper"><div class="awac widget text-52"> <div class="textwidget"><p></p><center><br/>
<div class="woo-sc-hr"></div>
<h2>Develop Deep Learning models for Time Series Today!</h2>
<p><a href="/deep-learning-for-time-series-forecasting/"><img align="left" alt="Deep Learning for Time Series Forecasting" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/08/Cover-220.png" style="border: 0;"/></a></p>
<h4>Develop Your Own Forecasting models in Minutes</h4>
<p>…with just a few lines of python code</p>
<p>Discover how in my new Ebook:<br/>
<a href="/deep-learning-for-time-series-forecasting/">Deep Learning for Time Series Forecasting</a></p>
<p>It provides <strong>self-study tutorials</strong> on topics like: <em>CNNs</em>, <em>LSTMs</em>,<br/>
<em>Multivariate Forecasting</em>, <em>Multi-Step Forecasting</em> and much more…</p>
<h4>Finally Bring Deep Learning to your Time Series Forecasting Projects</h4>
<p>Skip the Academics. Just Results.</p>
<p><a href="/deep-learning-for-time-series-forecasting/">Click to learn more</a>.<br/>
</p><div class="woo-sc-hr"></div><br/>
</center>
</div>
</div></div><div class="simplesocialbuttons simplesocial-simple-icons simplesocialbuttons_inline simplesocialbuttons-align-left post-6286 post simplesocialbuttons-inline-no-animation">
<button class="ssb_tweet-icon" data-href="https://twitter.com/share?text=How+to+Develop+LSTM+Models+for+Multi-Step+Time+Series+Forecasting+of+Household+Power+Consumption&amp;url=https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/" onclick="javascript:window.open(this.dataset.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;" rel="nofollow">
<span class="icon"><svg viewbox="0 0 72 72" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h72v72H0z" fill="none"></path><path class="icon" d="M68.812 15.14c-2.348 1.04-4.87 1.744-7.52 2.06 2.704-1.62 4.78-4.186 5.757-7.243-2.53 1.5-5.33 2.592-8.314 3.176C56.35 10.59 52.948 9 49.182 9c-7.23 0-13.092 5.86-13.092 13.093 0 1.026.118 2.02.338 2.98C25.543 24.527 15.9 19.318 9.44 11.396c-1.125 1.936-1.77 4.184-1.77 6.58 0 4.543 2.312 8.552 5.824 10.9-2.146-.07-4.165-.658-5.93-1.64-.002.056-.002.11-.002.163 0 6.345 4.513 11.638 10.504 12.84-1.1.298-2.256.457-3.45.457-.845 0-1.666-.078-2.464-.23 1.667 5.2 6.5 8.985 12.23 9.09-4.482 3.51-10.13 5.605-16.26 5.605-1.055 0-2.096-.06-3.122-.184 5.794 3.717 12.676 5.882 20.067 5.882 24.083 0 37.25-19.95 37.25-37.25 0-.565-.013-1.133-.038-1.693 2.558-1.847 4.778-4.15 6.532-6.774z" fill="#fff"></path></svg></span><i class="simplesocialtxt">Tweet </i></button>
<button class="ssb_fbshare-icon" data-href="https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/" onclick="javascript:window.open(this.dataset.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;" target="_blank">
<span class="icon"><svg class="_1pbq" color="#ffffff" viewbox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path class="icon" d="M8 14H3.667C2.733 13.9 2 13.167 2 12.233V3.667A1.65 1.65 0 0 1 3.667 2h8.666A1.65 1.65 0 0 1 14 3.667v8.566c0 .934-.733 1.667-1.667 1.767H10v-3.967h1.3l.7-2.066h-2V6.933c0-.466.167-.9.867-.9H12v-1.8c.033 0-.933-.266-1.533-.266-1.267 0-2.434.7-2.467 2.133v1.867H6v2.066h2V14z" fill="#ffffff" fill-rule="evenodd"></path></svg></span>
<span class="simplesocialtxt">Share </span> </button>
<button class="ssb_linkedin-icon" data-href="https://www.linkedin.com/cws/share?url=https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/" onclick="javascript:window.open(this.dataset.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
<span class="icon"> <svg enable-background="new -301.4 387.5 15 14.1" height="14.1px" id="Layer_1" version="1.1" viewbox="-301.4 387.5 15 14.1" width="15px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"> <g id="XMLID_398_"> <path d="M-296.2,401.6c0-3.2,0-6.3,0-9.5h0.1c1,0,2,0,2.9,0c0.1,0,0.1,0,0.1,0.1c0,0.4,0,0.8,0,1.2 c0.1-0.1,0.2-0.3,0.3-0.4c0.5-0.7,1.2-1,2.1-1.1c0.8-0.1,1.5,0,2.2,0.3c0.7,0.4,1.2,0.8,1.5,1.4c0.4,0.8,0.6,1.7,0.6,2.5 c0,1.8,0,3.6,0,5.4v0.1c-1.1,0-2.1,0-3.2,0c0-0.1,0-0.1,0-0.2c0-1.6,0-3.2,0-4.8c0-0.4,0-0.8-0.2-1.2c-0.2-0.7-0.8-1-1.6-1 c-0.8,0.1-1.3,0.5-1.6,1.2c-0.1,0.2-0.1,0.5-0.1,0.8c0,1.7,0,3.4,0,5.1c0,0.2,0,0.2-0.2,0.2c-1,0-1.9,0-2.9,0 C-296.1,401.6-296.2,401.6-296.2,401.6z" fill="#FFFFFF" id="XMLID_399_"></path> <path d="M-298,401.6L-298,401.6c-1.1,0-2.1,0-3,0c-0.1,0-0.1,0-0.1-0.1c0-3.1,0-6.1,0-9.2 c0-0.1,0-0.1,0.1-0.1c1,0,2,0,2.9,0h0.1C-298,395.3-298,398.5-298,401.6z" fill="#FFFFFF" id="XMLID_400_"></path> <path d="M-299.6,390.9c-0.7-0.1-1.2-0.3-1.6-0.8c-0.5-0.8-0.2-2.1,1-2.4c0.6-0.2,1.2-0.1,1.8,0.2 c0.5,0.4,0.7,0.9,0.6,1.5c-0.1,0.7-0.5,1.1-1.1,1.3C-299.1,390.8-299.4,390.8-299.6,390.9L-299.6,390.9z" fill="#FFFFFF" id="XMLID_401_"></path> </g> </svg> </span>
<span class="simplesocialtxt">Share</span> </button>
<button class="ssb_gplus-icon" data-href="https://plus.google.com/share?url=https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/" onclick="javascript:window.open(this.dataset.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
<span class="icon"><svg class="ozWidgetRioButtonSvg_ ozWidgetRioButtonPlusOne_" height="18px" preserveaspectratio="xMidYMid meet" version="1.1" viewbox="-10 -6 60 36" width="30px" xmlns="http://www.w3.org/2000/svg"><path d="M30 7h-3v4h-4v3h4v4h3v-4h4v-3h-4V7z"></path><path d="M11 9.9v4h5.4C16 16.3 14 18 11 18c-3.3 0-5.9-2.8-5.9-6S7.7 6 11 6c1.5 0 2.8.5 3.8 1.5l2.9-2.9C15.9 3 13.7 2 11 2 5.5 2 1 6.5 1 12s4.5 10 10 10c5.8 0 9.6-4.1 9.6-9.8 0-.7-.1-1.5-.2-2.2H11z"></path></svg></span>
<span class="simplesocialtxt">Google Plus </span></button>
</div>
</section><!-- /.entry -->
<div class="fix"></div>
<aside id="post-author">
<div class="profile-image"><img alt="" class="avatar avatar-80 photo" height="80" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=160&amp;d=mm&amp;r=g 2x" width="80"/></div>
<div class="profile-content">
<h4>About Jason Brownlee</h4>
		Jason Brownlee, PhD is a machine learning specialist who teaches developers how to get results with modern machine learning methods via hands-on tutorials.				<div class="profile-link">
<a href="https://machinelearningmastery.com/author/jasonb/">
				View all posts by Jason Brownlee <span class="meta-nav">→</span> </a>
</div><!--#profile-link-->
</div>
<div class="fix"></div>
</aside>
<div class="post-utility"></div>
</article><!-- /.post -->
<div class="post-entries">
<div class="nav-prev fl"><a href="https://machinelearningmastery.com/how-to-develop-convolutional-neural-networks-for-multi-step-time-series-forecasting/" rel="prev"><i class="fa fa-angle-left"></i> How to Develop Convolutional Neural Networks for Multi-Step Time Series Forecasting</a></div>
<div class="nav-next fr"><a href="https://machinelearningmastery.com/how-to-load-visualize-and-explore-a-complex-multivariate-multistep-time-series-forecasting-dataset/" rel="next">How to Load, Visualize, and Explore a Complex Multivariate Multistep Time Series Forecasting Dataset <i class="fa fa-angle-right"></i></a></div>
<div class="fix"></div>
</div>
<div id="comments"> <h3 id="comments-title">47 Responses to <em>How to Develop LSTM Models for Multi-Step Time Series Forecasting of Household Power Consumption</em></h3>
<ol class="commentlist">
<li class="comment even thread-even depth-1" id="comment-451187">
<div class="comment-container" id="li-comment-451187">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/374d1a98c46b3fcdb98c8b77597ebe68?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/374d1a98c46b3fcdb98c8b77597ebe68?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Konrad</span>
<span class="date">October 10, 2018 at 8:12 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-451187" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>Thanks for another great article. </p>
<p>I’ve got a question about your thoughts about Attention based networks and how do they compere to LSTMs. I heard many voices in favor of the first ones, but I would like to know how this looks in real situations and not competitions-world 😉</p>
<p>Thanks,<br/>
Konrad</p>
<div class="reply">
<a aria-label="Reply to Konrad" class="comment-reply-link" href="#comment-451187" onclick='return addComment.moveForm( "comment-451187", "451187", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-451209">
<div class="comment-container" id="li-comment-451209">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 10, 2018 at 2:58 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-451209" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Attention-based models can offer a lot of benefit on challenging sequence prediction problems.</p>
<p>I have not used attention for time series forecasting though, sorry. Id on’t have good off the cuff advice.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-451209" onclick='return addComment.moveForm( "comment-451209", "451209", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-451277">
<div class="comment-container" id="li-comment-451277">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/374d1a98c46b3fcdb98c8b77597ebe68?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/374d1a98c46b3fcdb98c8b77597ebe68?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Konrad</span>
<span class="date">October 11, 2018 at 6:05 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-451277" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Ok, sure, thanks for reply! 🙂</p>
<div class="reply">
<a aria-label="Reply to Konrad" class="comment-reply-link" href="#comment-451277" onclick='return addComment.moveForm( "comment-451277", "451277", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-451436">
<div class="comment-container" id="li-comment-451436">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1f0788916a9fa130b449673180dc9fa6?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1f0788916a9fa130b449673180dc9fa6?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">shamsul</span>
<span class="date">October 12, 2018 at 1:03 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-451436" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p># model.add(LSTM(200, activation=’relu’, input_shape=(n_timesteps, n_features)))<br/>
# model.add(Dense(100, activation=’relu’))</p>
<p>how do we choose LSTM unit and dense unit? for example, here 200 units for LSTM and 100 units for Dense have been used.  is there any formula out there? should we guess? </p>
<p>it would be great if you could explain!  Thanks in advance.</p>
<div class="reply">
<a aria-label="Reply to shamsul" class="comment-reply-link" href="#comment-451436" onclick='return addComment.moveForm( "comment-451436", "451436", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-451514">
<div class="comment-container" id="li-comment-451514">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 13, 2018 at 6:07 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-451514" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Trial and error. I explain more here:<br/>
<a href="https://machinelearningmastery.com/faq/single-faq/how-many-layers-and-nodes-do-i-need-in-my-neural-network" rel="nofollow">https://machinelearningmastery.com/faq/single-faq/how-many-layers-and-nodes-do-i-need-in-my-neural-network</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-451514" onclick='return addComment.moveForm( "comment-451514", "451514", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-451488">
<div class="comment-container" id="li-comment-451488">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/e9483875b9006c72e3a202b18739b6f5?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/e9483875b9006c72e3a202b18739b6f5?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">NoobAtMl</span>
<span class="date">October 12, 2018 at 11:08 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-451488" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>How to calculate the accuracy of the Convolutional LSTM model of the electricity consumption dataset. Can you please provide the code for that?</p>
<div class="reply">
<a aria-label="Reply to NoobAtMl" class="comment-reply-link" href="#comment-451488" onclick='return addComment.moveForm( "comment-451488", "451488", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-451519">
<div class="comment-container" id="li-comment-451519">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 13, 2018 at 6:13 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-451519" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>It is a regression problem, we cannot calculate accuracy for a regression problem.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-451519" onclick='return addComment.moveForm( "comment-451519", "451519", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-453035">
<div class="comment-container" id="li-comment-453035">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/e9c8a6c0ae0a81f222717e326dce7c1a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/e9c8a6c0ae0a81f222717e326dce7c1a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">luo zhongbin</span>
<span class="date">October 29, 2018 at 2:14 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-453035" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Is it possible to calculate accuracy with mse?</p>
<div class="reply">
<a aria-label="Reply to luo zhongbin" class="comment-reply-link" href="#comment-453035" onclick='return addComment.moveForm( "comment-453035", "453035", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-4" id="comment-453086">
<div class="comment-container" id="li-comment-453086">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 30, 2018 at 5:51 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-453086" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>No, MSE is a calculation of error for regression.Accuracy is a calculation of performance for classification problems.</p>
<p>More details here:<br/>
<a href="https://machinelearningmastery.com/classification-versus-regression-in-machine-learning/" rel="nofollow">https://machinelearningmastery.com/classification-versus-regression-in-machine-learning/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-453086" onclick='return addComment.moveForm( "comment-453086", "453086", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-451523">
<div class="comment-container" id="li-comment-451523">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/d8776005e0f26c7a79b3c8fa208f0a0f?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d8776005e0f26c7a79b3c8fa208f0a0f?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Troy</span>
<span class="date">October 13, 2018 at 7:07 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-451523" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hey Jason,</p>
<p>Great article.  I’m trying to understand how you have your encoder decoder model vs. the official Keras example below:</p>
<p><a href="https://blog.keras.io/a-ten-minute-introduction-to-sequence-to-sequence-learning-in-keras.html" rel="nofollow">https://blog.keras.io/a-ten-minute-introduction-to-sequence-to-sequence-learning-in-keras.html</a></p>
<p>I also worked through this example from JEddy92 where he adopted the Keras method to do time series analysis:</p>
<p><a href="https://github.com/JEddy92/TimeSeries_Seq2Seq/blob/master/notebooks/TS_Seq2Seq_Intro.ipynb" rel="nofollow">https://github.com/JEddy92/TimeSeries_Seq2Seq/blob/master/notebooks/TS_Seq2Seq_Intro.ipynb</a></p>
<p>I’ve tried building the Keras model as similar to your model as possible and running both over the same data.  Your model seems significantly different from their example, and I can’t quite reconcile the differences.  </p>
<p>I actually can’t get the Keras model for sequence to sequence to produce any good results for time series analysis.  Running 1000 epochs and I got RMSE of 466.192.  Have you built any time series models using the approach they are trying? Any ideas why this approach is so much harder to train than the one you have above?</p>
<div class="reply">
<a aria-label="Reply to Troy" class="comment-reply-link" href="#comment-451523" onclick='return addComment.moveForm( "comment-451523", "451523", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-451574">
<div class="comment-container" id="li-comment-451574">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 14, 2018 at 5:56 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-451574" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I use a simple autoencoder LSTM approach which seems to perform better in my tests. The difference is learning an internal representation (autoencoder) vs copying state from the encoder. I explain the latter more here:<br/>
<a href="https://machinelearningmastery.com/develop-encoder-decoder-model-sequence-sequence-prediction-keras/" rel="nofollow">https://machinelearningmastery.com/develop-encoder-decoder-model-sequence-sequence-prediction-keras/</a></p>
<p>I don’t know about the post you’ve linked. I can report better performance in general with CNNs and hybrid models.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-451574" onclick='return addComment.moveForm( "comment-451574", "451574", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-451885">
<div class="comment-container" id="li-comment-451885">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/d14639a6aef18968ead1f0db2b018d6c?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d14639a6aef18968ead1f0db2b018d6c?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">JiaojiaoFu</span>
<span class="date">October 17, 2018 at 2:33 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-451885" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Multivariate prediction is which of these variables is predicted? I did not see the introduction of this part. Is the default giving the first variable of multiple variables?</p>
<div class="reply">
<a aria-label="Reply to JiaojiaoFu" class="comment-reply-link" href="#comment-451885" onclick='return addComment.moveForm( "comment-451885", "451885", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-451941">
<div class="comment-container" id="li-comment-451941">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 18, 2018 at 6:23 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-451941" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Some of the models in the above tutorials take multivariate input and make a multi-step univariate prediction.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-451941" onclick='return addComment.moveForm( "comment-451941", "451941", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-452034">
<div class="comment-container" id="li-comment-452034">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/b5d3f204b81b42a283e23dafe6ecbed9?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/b5d3f204b81b42a283e23dafe6ecbed9?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Hasan</span>
<span class="date">October 19, 2018 at 1:27 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-452034" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>Great article, thanks. </p>
<p>I am trying out image (spectrogram) input sequences for classification output.<br/>
My network looks similar to “CNN-LSTM Encoder-Decoder Model With Univariate Input” with the difference that I am using TimeDistributed(Conv2D) layers and Multivariate Input.<br/>
Your examples do not use TimeDistributed Conv layers , but I was wondering if you have any thoughts ? My intention is to pass every sample of my batch individually through the Conv layer and collectively through the LSTM decoder. This I think would allow me to not have to explicitly preprocess my input data by collecting all samples representing a sequence together.<br/>
I am not sure if that would work okay, any comments would be a great help.<br/>
Thanks</p>
<div class="reply">
<a aria-label="Reply to Hasan" class="comment-reply-link" href="#comment-452034" onclick='return addComment.moveForm( "comment-452034", "452034", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-452067">
<div class="comment-container" id="li-comment-452067">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 19, 2018 at 6:08 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-452067" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You can adapt the above example to use a time distributed conv. </p>
<p>Perhaps try it and see, use results to guide you.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-452067" onclick='return addComment.moveForm( "comment-452067", "452067", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-452806">
<div class="comment-container" id="li-comment-452806">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/b29d54b905970c2cb544a82e5ea910c4?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/b29d54b905970c2cb544a82e5ea910c4?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Silvia Maria</span>
<span class="date">October 26, 2018 at 7:01 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-452806" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>another great article, thank you… and this time it is exactly what I needed for my univariate time series forecasting project! </p>
<p>I learned so much from your tutorials and your book, I cannot be more grateful 🙂</p>
<p>I wanted to ask you a couple of questions, with reference to both proposed models (Vanilla LSTM and Encoder-Decoder):</p>
<p>1) If I wanted to make the (Vanilla LSTM / Encoder-Decoder) networks deeper, how should I insert more layers?</p>
<p>2) Statefulness, i.e., memory between batches: here you are using stateless networks, I guess you do that under the hypothesis that a single training batch contains all the series variability timescales we want to model, is that right? </p>
<p>If I wanted to make the models stateful to see if statefulness leads to better results with my series, how should I do that? I’m not sure in which layers I should set return_sequences = True. </p>
<p>Tank you very much for your attention, best,</p>
<p>Silvia</p>
<div class="reply">
<a aria-label="Reply to Silvia Maria" class="comment-reply-link" href="#comment-452806" onclick='return addComment.moveForm( "comment-452806", "452806", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-452841">
<div class="comment-container" id="li-comment-452841">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 27, 2018 at 5:58 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-452841" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks.</p>
<p>Yes, you can make a model deeper by adding more layers.</p>
<p>Don’t worry about statefulness for now, it does not impact model skill in my experiments.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-452841" onclick='return addComment.moveForm( "comment-452841", "452841", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-452885">
<div class="comment-container" id="li-comment-452885">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/b29d54b905970c2cb544a82e5ea910c4?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/b29d54b905970c2cb544a82e5ea910c4?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Silvia Maria</span>
<span class="date">October 27, 2018 at 7:17 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-452885" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thank you for your prompt answer.<br/>
Now, it is very clear to me how I can add more layers in the Vanilla case, but not so clear in the Encoder-Decoder case. Should I add layers in both the encoder and the decoder? Could you please give me an example? Thank you for your patience, best, Silvia</p>
<div class="reply">
<a aria-label="Reply to Silvia Maria" class="comment-reply-link" href="#comment-452885" onclick='return addComment.moveForm( "comment-452885", "452885", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-452924">
<div class="comment-container" id="li-comment-452924">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 28, 2018 at 6:08 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-452924" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You can add more layers to the encoder or more layers to the decoder.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-452924" onclick='return addComment.moveForm( "comment-452924", "452924", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-452979">
<div class="comment-container" id="li-comment-452979">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/7de504fa39e8724c3da6a386c7c2d35b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/7de504fa39e8724c3da6a386c7c2d35b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Daniel</span>
<span class="date">October 29, 2018 at 1:27 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-452979" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason, I am enjoying a lot these posts! I am trying to replicate the Encoder-Decoder LSTM Model With Multivariate Input, but instead of using daily data, I resampled the data to hourly values. The goal is to predict a full week of values at an hourly level.</p>
<p>I kept the rest of the model as is, except for the number of inputs (one week = 7*24) and the split_database, which now looks like this:</p>
<p>    train, test = data[32:24392], data[24392:34472]<br/>
    plt.plot(train)<br/>
    plt.show()<br/>
    # restructure into windows of weekly data<br/>
    train = array(split(train, len(train)/(7*24)))<br/>
    print(‘[samples(weeks), timesteps(hours), features]: {}’.format(train.shape))<br/>
    test = array(split(test, len(test)/(7*24)))<br/>
    print(‘[samples(weeks), timestemps(hours), features]: {}’.format(test.shape))<br/>
    return train, test</p>
<p>When I train the RNN, I get nan values in the loss function from the very beginning.</p>
<p>I tried to use a MinMaxScaler on the data, and also tried with other optimizers, but I wasn’t successful.</p>
<p>Any insights on this matter? Thanks a lot 🙂</p>
<div class="reply">
<a aria-label="Reply to Daniel" class="comment-reply-link" href="#comment-452979" onclick='return addComment.moveForm( "comment-452979", "452979", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-453005">
<div class="comment-container" id="li-comment-453005">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 29, 2018 at 5:58 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-453005" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps double check your input data does not have any nan’s.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-453005" onclick='return addComment.moveForm( "comment-453005", "453005", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-453012">
<div class="comment-container" id="li-comment-453012">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/7de504fa39e8724c3da6a386c7c2d35b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/7de504fa39e8724c3da6a386c7c2d35b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Daniel</span>
<span class="date">October 29, 2018 at 6:59 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-453012" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I did that, but there were no nans. I got it working using that MinMaxScaler, plus tanh activation functions instead of ReLu for the LSTM layers. Thanks a lot and keep up this awesome work you are doing.</p>
<div class="reply">
<a aria-label="Reply to Daniel" class="comment-reply-link" href="#comment-453012" onclick='return addComment.moveForm( "comment-453012", "453012", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-4" id="comment-453029">
<div class="comment-container" id="li-comment-453029">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 29, 2018 at 2:10 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-453029" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Nice work.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-453029" onclick='return addComment.moveForm( "comment-453029", "453029", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-453465">
<div class="comment-container" id="li-comment-453465">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/dca71fe07dc8ae9d26e3361eafef7c60?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/dca71fe07dc8ae9d26e3361eafef7c60?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Allen</span>
<span class="date">November 2, 2018 at 9:05 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-453465" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>Thank you for the nice tutorial! It helps a lot! I noticed that you used differencing and scaling in the other tutorials for time series data, is there a reason why you don’t use it in this tutorial? Thank you!</p>
<div class="reply">
<a aria-label="Reply to Allen" class="comment-reply-link" href="#comment-453465" onclick='return addComment.moveForm( "comment-453465", "453465", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-453519">
<div class="comment-container" id="li-comment-453519">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 3, 2018 at 7:02 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-453519" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>To try to keep the example simple.</p>
<p>I do recommend scaling input and target variables in general. It will make life easier for the learning algorithm.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-453519" onclick='return addComment.moveForm( "comment-453519", "453519", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-453817">
<div class="comment-container" id="li-comment-453817">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/6e22be886729290f801aafc9e34cff1f?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/6e22be886729290f801aafc9e34cff1f?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Jose Rafael</span>
<span class="date">November 6, 2018 at 11:42 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-453817" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hello Jason Brownlee,</p>
<p>You are one of my best research references, great job!</p>
<p>This article has helped me to understand something about the context, however, I have a question on how I can simulate or predict future values using machine learning or deep learning, but with algorithms and graphs showing clearly, for example, for a set of historical daily temperature data, how could I simulate a possible value for month 6 But 10 years ahead?</p>
<p>Do you have another article or link of any reference?</p>
<p>Thank you very much.</p>
<p>Rafael</p>
<div class="reply">
<a aria-label="Reply to Jose Rafael" class="comment-reply-link" href="#comment-453817" onclick='return addComment.moveForm( "comment-453817", "453817", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-453835">
<div class="comment-container" id="li-comment-453835">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 6, 2018 at 2:18 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-453835" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks Rafael.</p>
<p>The further into the future you forecast, the more error you can expect.</p>
<p>You could train a model to focus on predicting 10 years out.<br/>
Or you can use a short term model and run it out 10 years using outputs as inputs (e.g. recursive).</p>
<p>Perhaps this post will give you some ideas:<br/>
<a href="https://machinelearningmastery.com/multi-step-time-series-forecasting/" rel="nofollow">https://machinelearningmastery.com/multi-step-time-series-forecasting/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-453835" onclick='return addComment.moveForm( "comment-453835", "453835", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-453979">
<div class="comment-container" id="li-comment-453979">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/4d8979042c31b916db08a41347fe3a56?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/4d8979042c31b916db08a41347fe3a56?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Ameni</span>
<span class="date">November 7, 2018 at 6:37 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-453979" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi, thanks for your very nice tutorial.<br/>
My question is about evaluating the overall RMSE during the training phase.<br/>
Is it correct to use this code:</p>
<p>from keras import backend as K</p>
<p>def root_mean_squared_error(y_true, y_pred):<br/>
        return K.sqrt(K.mean(K.square(y_pred – y_true)))</p>
<p>and the use 	model.compile(optimizer = ‘adam’, loss = root_mean_squared_error ,metrics=[root_mean_squared_error])</p>
<p> instead of </p>
<p>model.compile(optimizer = ‘adam’, loss = ‘mse’)</p>
<div class="reply">
<a aria-label="Reply to Ameni" class="comment-reply-link" href="#comment-453979" onclick='return addComment.moveForm( "comment-453979", "453979", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-454015">
<div class="comment-container" id="li-comment-454015">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 8, 2018 at 6:05 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-454015" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I don’t recommend using RMSE for loss, instead I recommend using MSE for loss and RMSE as a metric.</p>
<p>I give an example here:<br/>
<a href="https://machinelearningmastery.com/custom-metrics-deep-learning-keras-python/" rel="nofollow">https://machinelearningmastery.com/custom-metrics-deep-learning-keras-python/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-454015" onclick='return addComment.moveForm( "comment-454015", "454015", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-454320">
<div class="comment-container" id="li-comment-454320">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/d7a1050833521b57a290a6fa813699cd?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d7a1050833521b57a290a6fa813699cd?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Anubhav Srivastava</span>
<span class="date">November 10, 2018 at 8:39 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-454320" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>For the LSTM with multi-step forecasting, curious why you didn’t use LSTM layers with return_sequence=True and a Dense(1) output layer? Instead you have used two Dense layers, one with 100 outputs and an final Dense(7).</p>
<p>Would the return_sequence=True in an LSTM followed by a Dense(1) approach be wrong?</p>
<div class="reply">
<a aria-label="Reply to Anubhav Srivastava" class="comment-reply-link" href="#comment-454320" onclick='return addComment.moveForm( "comment-454320", "454320", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-454368">
<div class="comment-container" id="li-comment-454368">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 11, 2018 at 6:02 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-454368" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Note, we do use this approach in the encoder-decoder, which requires the use of a TimeDistributed wrapper layer.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-454368" onclick='return addComment.moveForm( "comment-454368", "454368", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-454409">
<div class="comment-container" id="li-comment-454409">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/d7a1050833521b57a290a6fa813699cd?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d7a1050833521b57a290a6fa813699cd?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Anubhav Srivastava</span>
<span class="date">November 11, 2018 at 3:29 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-454409" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Got it. So I take that to be a valid approach too?</p>
<div class="reply">
<a aria-label="Reply to Anubhav Srivastava" class="comment-reply-link" href="#comment-454409" onclick='return addComment.moveForm( "comment-454409", "454409", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-4" id="comment-454471">
<div class="comment-container" id="li-comment-454471">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 12, 2018 at 5:36 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-454471" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Valid? I don’t follow, sorry.</p>
<p>Try a suite of models and the one that gives the best performance is the one to use. Whether a model works or not is not enough.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-454471" onclick='return addComment.moveForm( "comment-454471", "454471", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-454912">
<div class="comment-container" id="li-comment-454912">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/08d830b38c321dfd20d7858fc3a37575?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/08d830b38c321dfd20d7858fc3a37575?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Simone Faragalli</span>
<span class="date">November 16, 2018 at 2:44 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-454912" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi, Great Article.</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0c9e4d82b9d106115801" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
On the following code:
def evaluate_model(train, test, n_steps, n_length, n_input):
	# fit model
	model = build_model(train, n_steps, n_length, n_input)
	# history is a list of weekly data
	history = [x for x in train]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0c9e4d82b9d106115801-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d82b9d106115801-2">2</div><div class="crayon-num" data-line="crayon-5c0c9e4d82b9d106115801-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d82b9d106115801-4">4</div><div class="crayon-num" data-line="crayon-5c0c9e4d82b9d106115801-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0c9e4d82b9d106115801-6">6</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0c9e4d82b9d106115801-1"><span class="crayon-e">On </span><span class="crayon-e">the </span><span class="crayon-e">following </span><span class="crayon-v">code</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d82b9d106115801-2"><span class="crayon-e">def </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0c9e4d82b9d106115801-3"><span class="crayon-h"> </span><span class="crayon-p"># fit model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d82b9d106115801-4"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">build_model</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_input</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0c9e4d82b9d106115801-5"><span class="crayon-h"> </span><span class="crayon-p"># history is a list of weekly data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0c9e4d82b9d106115801-6"><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-i">x</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">x</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0005 seconds] -->
<p></p>
<p>Should it not be “test” instead of “train” series?</p>
<p>Many thanks</p>
<div class="reply">
<a aria-label="Reply to Simone Faragalli" class="comment-reply-link" href="#comment-454912" onclick='return addComment.moveForm( "comment-454912", "454912", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-454933">
<div class="comment-container" id="li-comment-454933">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 16, 2018 at 6:17 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-454933" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>No, here we are adding seeding the history with the training set.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-454933" onclick='return addComment.moveForm( "comment-454933", "454933", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-455057">
<div class="comment-container" id="li-comment-455057">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/7de504fa39e8724c3da6a386c7c2d35b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/7de504fa39e8724c3da6a386c7c2d35b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Daniel</span>
<span class="date">November 17, 2018 at 4:20 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-455057" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason! Any insights or rule of thumb to set input_size and batch size? Should these two be related?</p>
<p>Thanks a lot!</p>
<div class="reply">
<a aria-label="Reply to Daniel" class="comment-reply-link" href="#comment-455057" onclick='return addComment.moveForm( "comment-455057", "455057", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-455081">
<div class="comment-container" id="li-comment-455081">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 17, 2018 at 5:52 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-455081" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Unrelated.</p>
<p>Input size for lstms is the shape of each sample, e.g. timesteps and variables.</p>
<p>Batch size is the number of samples to process before estimating the error gradient and updating weights via backprop.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-455081" onclick='return addComment.moveForm( "comment-455081", "455081", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-455145">
<div class="comment-container" id="li-comment-455145">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/7de504fa39e8724c3da6a386c7c2d35b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/7de504fa39e8724c3da6a386c7c2d35b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Daniel</span>
<span class="date">November 17, 2018 at 9:44 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-455145" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks for your reply! So, if I am trying to forecast a full week with hourly granularity, and I have let’s say, a full year of hourly observations, would a large batch size better capture the variation in the dependencies accross variables in the past? Or would it depend only on the input size?</p>
<p>I would like the network to remember not only the recent behaviour, but also the past! 🙂</p>
<p>Thanks a lot!</p>
<div class="reply">
<a aria-label="Reply to Daniel" class="comment-reply-link" href="#comment-455145" onclick='return addComment.moveForm( "comment-455145", "455145", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-455231">
<div class="comment-container" id="li-comment-455231">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 18, 2018 at 6:40 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-455231" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Try it and see.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-455231" onclick='return addComment.moveForm( "comment-455231", "455231", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-455417">
<div class="comment-container" id="li-comment-455417">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/7de504fa39e8724c3da6a386c7c2d35b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/7de504fa39e8724c3da6a386c7c2d35b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Daniel</span>
<span class="date">November 19, 2018 at 5:20 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-455417" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi again, I’d recomend anyone trying so to check out this paper, they give optimal hyperparameters for exactly the focus of this post using LSTM seq2seq 🙂</p>
<p><a href="https://arxiv.org/pdf/1705.04378.pdf" rel="nofollow">https://arxiv.org/pdf/1705.04378.pdf</a></p>
<div class="reply">
<a aria-label="Reply to Daniel" class="comment-reply-link" href="#comment-455417" onclick='return addComment.moveForm( "comment-455417", "455417", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-4" id="comment-455444">
<div class="comment-container" id="li-comment-455444">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 19, 2018 at 6:50 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-455444" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks for sharing.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-455444" onclick='return addComment.moveForm( "comment-455444", "455444", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt depth-3" id="comment-455522">
<div class="comment-container" id="li-comment-455522">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/7de504fa39e8724c3da6a386c7c2d35b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/7de504fa39e8724c3da6a386c7c2d35b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Daniel</span>
<span class="date">November 19, 2018 at 11:26 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-455522" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Another thing worth mentioning when predicting several timesteps using LSTM seq2seq, for me it made a huge impact on the model learning to add L2 regularization rather than dropout, for those who see their model is overfitting! I got the idea from that paper!</p>
<div class="reply">
<a aria-label="Reply to Daniel" class="comment-reply-link" href="#comment-455522" onclick='return addComment.moveForm( "comment-455522", "455522", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-4" id="comment-455564">
<div class="comment-container" id="li-comment-455564">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 20, 2018 at 6:35 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-455564" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Great tip. Yes, weight regularization is often overlooked and performs very well:<br/>
<a href="https://machinelearningmastery.com/weight-regularization-to-reduce-overfitting-of-deep-learning-models/" rel="nofollow">https://machinelearningmastery.com/weight-regularization-to-reduce-overfitting-of-deep-learning-models/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-455564" onclick='return addComment.moveForm( "comment-455564", "455564", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-456748">
<div class="comment-container" id="li-comment-456748">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/a0e59ae595cf05b6cbb8c8831b676a22?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/a0e59ae595cf05b6cbb8c8831b676a22?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Pierre</span>
<span class="date">December 1, 2018 at 2:28 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-456748" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I really like your Tutorial.</p>
<p>I am trying to improve the model by using forecast weather to improve the load forecast.<br/>
I have a dataset with many weather variables. I Want to build a model that use past_load, past_weather and future_weather to forecast future load.<br/>
I would like to know what is the best way to prepare the dataset to optimally use LSTM.<br/>
My problem is how to arrange the data in timesteps and features for each sample when there are some features that are not avalaible at all timesteps.</p>
<p>I have tested many approaches: </p>
<p>1) I have tried training my models with 1 timestep per sample and inputing all past weather and load and future weather as distinct features.<br/>
2) I also tried with many timesteps and one feature per time step but inputting a dummy value in the future load to make such that the model put zero weights in the future loads that will not be available when the model will be used in prediction mode.</p>
<p>I am sure that this is a common prediction problem and I am sure that there is a better way to proceed.</p>
<div class="reply">
<a aria-label="Reply to Pierre" class="comment-reply-link" href="#comment-456748" onclick='return addComment.moveForm( "comment-456748", "456748", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-456765">
<div class="comment-container" id="li-comment-456765">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 1, 2018 at 6:52 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-456765" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>For missing data, you could try using a masking layer and mark the missing values to be ignored.</p>
<p>There is no best way in applied machine learning, I recommend testing a suite of framings of the problem in order to discover what works best for your specific dataset.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-456765" onclick='return addComment.moveForm( "comment-456765", "456765", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-457590">
<div class="comment-container" id="li-comment-457590">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/5b6330e10f35da99b7ae55dca35e1bd3?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/5b6330e10f35da99b7ae55dca35e1bd3?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Abbas</span>
<span class="date">December 6, 2018 at 6:35 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-457590" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi,<br/>
Thanks for your article. I am working on crypto-price prediction, but I have lag in my predicting. I mean that my prediction is only based on my previous data, if price at t is 10 $, my prediction would also be 10 $, it means that at time t+1 we should expect the price to be 10 $; actually, I predict nothing. I have run your article’s code, and found that you may also have lag in your prediction. In addition, I have read your article about determining Base Line of predicting time series and I want to know what is the base line of house holds power consumption? is it greater than 370? can you explain more about LSTM lags?</p>
<div class="reply">
<a aria-label="Reply to Abbas" class="comment-reply-link" href="#comment-457590" onclick='return addComment.moveForm( "comment-457590", "457590", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-457699">
<div class="comment-container" id="li-comment-457699">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 7, 2018 at 5:20 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#comment-457699" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>It suggests that your model has learned a persistence model (e.g. has no skill).</p>
<p>I recommend experimenting with different methods and different framings of your data, including more lag observations (time steps) as input.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-457699" onclick='return addComment.moveForm( "comment-457699", "457699", "respond", "6286" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ol>
</div> <div class="comment-respond" id="respond">
<h3 class="comment-reply-title" id="reply-title">Leave a Reply <small><a href="/how-to-develop-lstm-models-for-multi-step-time-series-forecasting-of-household-power-consumption/#respond" id="cancel-comment-reply-link" rel="nofollow" style="display:none;">Click here to cancel reply.</a></small></h3> <form action="https://machinelearningmastery.com/wp-comments-post.php?wpe-comment-post=mlmastery" class="comment-form" id="commentform" method="post">
<p class="comment-form-comment"><label class="hide" for="comment">Comment</label> <textarea cols="50" id="comment" maxlength="65525" name="comment" required="required" rows="10" tabindex="4"></textarea></p><p class="comment-form-author"><input aria-required="true" class="txt" id="author" name="author" size="30" tabindex="1" type="text" value=""/><label for="author">Name <span class="required">(required)</span></label> </p>
<p class="comment-form-email"><input aria-required="true" class="txt" id="email" name="email" size="30" tabindex="2" type="text" value=""/><label for="email">Email (will not be published) <span class="required">(required)</span></label> </p>
<p class="comment-form-url"><input class="txt" id="url" name="url" size="30" tabindex="3" type="text" value=""/><label for="url">Website</label></p>
<p class="form-submit"><input class="submit" id="submit" name="submit" type="submit" value="Submit Comment"/> <input id="comment_post_ID" name="comment_post_ID" type="hidden" value="6286"/>
<input id="comment_parent" name="comment_parent" type="hidden" value="0"/>
</p><p style="display: none;"><input id="akismet_comment_nonce" name="akismet_comment_nonce" type="hidden" value="05a9474e29"/></p><p style="display: none;"><input id="ak_js" name="ak_js" type="hidden" value="0"/></p> </form>
</div><!-- #respond -->
</section><!-- /#main -->
<aside id="sidebar">
<div class="widget widget_woo_blogauthorinfo" id="woo_blogauthorinfo-2"><h3>Welcome to Machine Learning Mastery!</h3><span class="left"><img alt="" class="avatar avatar-100 photo" height="100" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=100&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=200&amp;d=mm&amp;r=g 2x" width="100"/></span>
<p>Hi, I'm Jason Brownlee, PhD
<br/>
I write tutorials to help developers (<i>like you</i>) get results with machine learning.</p>
<p><a href="/about">Read More</a></p>
<div class="fix"></div>
</div><div class="widget widget_text" id="text-51"> <div class="textwidget"><p></p><center><br/>
<strong>Deep Learning for Time Series</strong><br/>
Forecast the future with MLPs, CNNs, and LSTMs.
<p><a href="/deep-learning-for-time-series-forecasting/">Click to Get Started Now!</a><br/>
<a href="/deep-learning-for-time-series-forecasting/"><img src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/08/Cover-220.png"/></a><br/>
</p></center>
</div>
</div>
<div class="widget widget_woo_tabs" id="woo_tabs-2"> <div id="tabs">
<ul class="wooTabs">
<li class="popular"><a href="#tab-pop">Popular</a></li> </ul>
<div class="clear"></div>
<div class="boxes box inside">
<ul class="list" id="tab-pop">
<li>
<a href="https://machinelearningmastery.com/develop-neural-machine-translation-system-keras/" title="How to Develop a Neural Machine Translation System from Scratch"><img alt="How to Develop a Neural Machine Translation System in Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/01/How-to-Develop-a-Neural-Machine-Translation-System-in-Keras-150x150.jpg" title="How to Develop a Neural Machine Translation System from Scratch" width="45"/></a> <a href="https://machinelearningmastery.com/develop-neural-machine-translation-system-keras/" title="How to Develop a Neural Machine Translation System from Scratch">How to Develop a Neural Machine Translation System from Scratch</a>
<span class="meta">January 10, 2018</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/classification-versus-regression-in-machine-learning/" title="Difference Between Classification and Regression in Machine Learning"><img alt="Difference Between Classification and Regression in Machine Learning" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/12/Difference-Between-Classification-and-Regression-in-Machine-Learning-150x150.jpg" title="Difference Between Classification and Regression in Machine Learning" width="45"/></a> <a href="https://machinelearningmastery.com/classification-versus-regression-in-machine-learning/" title="Difference Between Classification and Regression in Machine Learning">Difference Between Classification and Regression in Machine Learning</a>
<span class="meta">December 11, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/working-machine-learning-problem/" title="So, You are Working on a Machine Learning Problem..."><img alt="So, You are Working on a Machine Learning Problem..." class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/04/So-You-are-Working-on-a-Machine-Learning-Problem...-150x150.jpg" title="So, You are Working on a Machine Learning Problem..." width="45"/></a> <a href="https://machinelearningmastery.com/working-machine-learning-problem/" title="So, You are Working on a Machine Learning Problem…">So, You are Working on a Machine Learning Problem…</a>
<span class="meta">April 4, 2018</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/develop-n-gram-multichannel-convolutional-neural-network-sentiment-analysis/" title="How to Develop an N-gram Multichannel Convolutional Neural Network for Sentiment Analysis"><img alt="Plot of the Multichannel Convolutional Neural Network For Text" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/10/Plot-of-the-Multichannel-Convolutional-Neural-Network-For-Text-150x150.png" title="How to Develop an N-gram Multichannel Convolutional Neural Network for Sentiment Analysis" width="45"/></a> <a href="https://machinelearningmastery.com/develop-n-gram-multichannel-convolutional-neural-network-sentiment-analysis/" title="How to Develop an N-gram Multichannel Convolutional Neural Network for Sentiment Analysis">How to Develop an N-gram Multichannel Convolutional Neural Network for Sentiment Analysis</a>
<span class="meta">January 12, 2018</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/how-to-make-classification-and-regression-predictions-for-deep-learning-models-in-keras/" title="How to Make Predictions with Keras"><img alt="How to Make Classification and Regression Predictions for Deep Learning Models in Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/04/How-to-Make-Classification-and-Regression-Predictions-for-Deep-Learning-Models-in-Keras-150x150.jpg" title="How to Make Predictions with Keras" width="45"/></a> <a href="https://machinelearningmastery.com/how-to-make-classification-and-regression-predictions-for-deep-learning-models-in-keras/" title="How to Make Predictions with Keras">How to Make Predictions with Keras</a>
<span class="meta">April 9, 2018</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/time-series-forecasting-methods-in-python-cheat-sheet/" title="11 Classical Time Series Forecasting Methods in Python (Cheat Sheet)"><img alt="11 Classical Time Series Forecasting Methods in Python (Cheat Sheet)" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/08/11-Classical-Time-Series-Forecasting-Methods-in-Python-Cheat-Sheet-150x150.jpg" title="11 Classical Time Series Forecasting Methods in Python (Cheat Sheet)" width="45"/></a> <a href="https://machinelearningmastery.com/time-series-forecasting-methods-in-python-cheat-sheet/" title="11 Classical Time Series Forecasting Methods in Python (Cheat Sheet)">11 Classical Time Series Forecasting Methods in Python (Cheat Sheet)</a>
<span class="meta">August 6, 2018</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/visualize-deep-learning-neural-network-model-keras/" title="How to Visualize a Deep Learning Neural Network Model in Keras"><img alt="How to Visualize a Deep Learning Neural Network Model in Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/12/How-to-Visualize-a-Deep-Learning-Neural-Network-Model-in-Keras-150x150.jpg" title="How to Visualize a Deep Learning Neural Network Model in Keras" width="45"/></a> <a href="https://machinelearningmastery.com/visualize-deep-learning-neural-network-model-keras/" title="How to Visualize a Deep Learning Neural Network Model in Keras">How to Visualize a Deep Learning Neural Network Model in Keras</a>
<span class="meta">December 13, 2017</span>
<div class="fix"></div>
</li>
</ul>
</div><!-- /.boxes -->
</div><!-- /wooTabs -->
</div> <div class="widget_text widget widget_custom_html" id="custom_html-2"><h3>You might also like…</h3><div class="textwidget custom-html-widget"><ul>
<li><a href="/setup-python-environment-machine-learning-deep-learning-anaconda/">How to Install Python for Machine Learning</a></li>
<li><a href="/machine-learning-in-python-step-by-step/">Your First Machine Learning Project in Python</a></li>
<li><a href="/tutorial-first-neural-network-python-keras/">Your First Neural Network in Python</a></li>
<li><a href="/how-to-run-your-first-classifier-in-weka/">Your First Classifier in Weka</a></li>
<li><a href="/arima-for-time-series-forecasting-with-python/">Your First Time Series Forecasting Project</a></li>
</ul></div></div></aside><!-- /#sidebar -->
</div><!-- /#main-sidebar-container -->
</div><!-- /#content -->
<footer class="col-full" id="footer">
<div class="col-left" id="copyright">
<p>© 2018 Machine Learning Mastery. All Rights Reserved. </p> </div>
<div class="col-right" id="credit">
<p></p><p>
<a href="/privacy/">Privacy</a> | 
<a href="/disclaimer/">Disclaimer</a> | 
<a href="/terms-of-service/">Terms</a> | 
<a href="/contact/">Contact</a>
</p> </div>
</footer>
</div><!-- /#inner-wrapper -->
</div><!-- /#wrapper -->
<div class="fix"></div><!--/.fix-->
<!-- Drip -->
<script type="text/javascript">
  var _dcq = _dcq || [];
  var _dcs = _dcs || {};
  _dcs.account = '9556588';

  (function() {
    var dc = document.createElement('script');
    dc.type = 'text/javascript'; dc.async = true;
    dc.src = '//tag.getdrip.com/9556588.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(dc, s);
  })();
</script>
<!-- end Drip --><!-- Woo Tabs Widget -->
<script type="text/javascript">
jQuery(document).ready(function(){
	// UL = .wooTabs
	// Tab contents = .inside

	var tag_cloud_class = '#tagcloud';

	//Fix for tag clouds - unexpected height before .hide()
	var tag_cloud_height = jQuery( '#tagcloud').height();

	jQuery( '.inside ul li:last-child').css( 'border-bottom','0px' ); // remove last border-bottom from list in tab content
	jQuery( '.wooTabs').each(function(){
		jQuery(this).children( 'li').children( 'a:first').addClass( 'selected' ); // Add .selected class to first tab on load
	});
	jQuery( '.inside > *').hide();
	jQuery( '.inside > *:first-child').show();

	jQuery( '.wooTabs li a').click(function(evt){ // Init Click funtion on Tabs

		var clicked_tab_ref = jQuery(this).attr( 'href' ); // Strore Href value

		jQuery(this).parent().parent().children( 'li').children( 'a').removeClass( 'selected' ); //Remove selected from all tabs
		jQuery(this).addClass( 'selected' );
		jQuery(this).parent().parent().parent().children( '.inside').children( '*').hide();

		jQuery( '.inside ' + clicked_tab_ref).fadeIn(500);

		 evt.preventDefault();

	})
})
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/comment-reply.min.js?ver=4.9.8" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var wpcf7 = {"apiSettings":{"root":"https:\/\/machinelearningmastery.com\/wp-json\/contact-form-7\/v1","namespace":"contact-form-7\/v1"},"recaptcha":{"messages":{"empty":"Please verify that you are not a robot."}},"cached":"1"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/contact-form-7/includes/js/scripts.js?ver=5.0.5" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/wp-embed.min.js?ver=4.9.8" type="text/javascript"></script>
<script async="async" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/akismet/_inc/form.js?ver=4.1" type="text/javascript"></script>
</body>
</html>