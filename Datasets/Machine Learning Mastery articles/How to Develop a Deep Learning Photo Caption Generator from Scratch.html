<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
<meta charset="utf-8"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="https://machinelearningmastery.com/xmlrpc.php" rel="pingback"/>
<!--  Mobile viewport scale -->
<meta content="initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" name="viewport"/>
<!-- This site is optimized with the Yoast SEO plugin v9.2.1 - https://yoast.com/wordpress/plugins/seo/ -->
<title>How to Develop a Deep Learning Photo Caption Generator from Scratch</title>
<link href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/" rel="canonical"/>
<link href="https://plus.google.com/u/0/b/117073416089354242117/+MachinelearningmasteryHome/" rel="publisher"/>
<meta content="en_US" property="og:locale"/>
<meta content="article" property="og:type"/>
<meta content="How to Develop a Deep Learning Photo Caption Generator from Scratch" property="og:title"/>
<meta content="Develop a Deep Learning Model to Automatically Describe Photographs in Python with Keras, Step-by-Step. Caption generation is a challenging artificial intelligence problem where a textual description must be generated for a given photograph. It requires both methods from computer vision to understand the content of the image and a language model from the field of …" property="og:description"/>
<meta content="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/" property="og:url"/>
<meta content="Machine Learning Mastery" property="og:site_name"/>
<meta content="https://www.facebook.com/Machine-Learning-Mastery-1429846323896563/" property="article:publisher"/>
<meta content="https://www.facebook.com/jason.brownlee.39" property="article:author"/>
<meta content="Deep Learning for Natural Language Processing" property="article:section"/>
<meta content="2017-11-26T18:00:59+00:00" property="article:published_time"/>
<meta content="2018-04-05T20:20:11+00:00" property="article:modified_time"/>
<meta content="2018-04-05T20:20:11+00:00" property="og:updated_time"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/example.jpg" property="og:image"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/example.jpg" property="og:image:secure_url"/>
<meta content="640" property="og:image:width"/>
<meta content="512" property="og:image:height"/>
<meta content="Photo of a dog at the beach." property="og:image:alt"/>
<script type="application/ld+json">{"@context":"https:\/\/schema.org","@type":"Organization","url":"https:\/\/machinelearningmastery.com\/","sameAs":["https:\/\/www.facebook.com\/Machine-Learning-Mastery-1429846323896563\/","https:\/\/www.linkedin.com\/in\/jasonbrownlee","https:\/\/plus.google.com\/u\/0\/b\/117073416089354242117\/+MachinelearningmasteryHome\/","https:\/\/twitter.com\/TeachTheMachine"],"@id":"https:\/\/machinelearningmastery.com\/#organization","name":"Machine Learning Mastery","logo":"https:\/\/machinelearningmastery.com\/wp-content\/uploads\/2016\/09\/cropped-icon.png"}</script>
<!-- / Yoast SEO plugin. -->
<link href="//s.w.org" rel="dns-prefetch"/>
<link href="https://feeds.feedburner.com/MachineLearningMastery" rel="alternate" title="Machine Learning Mastery » Feed" type="application/rss+xml"/>
<link href="https://machinelearningmastery.com/comments/feed/" rel="alternate" title="Machine Learning Mastery » Comments Feed" type="application/rss+xml"/>
<link href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/feed/" rel="alternate" title="Machine Learning Mastery » How to Develop a Deep Learning Photo Caption Generator from Scratch Comments Feed" type="application/rss+xml"/>
<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/machinelearningmastery.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.9.8"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56760,9792,65039],[55358,56760,8203,9792,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<style media="all" type="text/css">
.wpautoterms-footer{background-color:#ffffff;text-align:center;}
.wpautoterms-footer a{color:#000000;font-family:Arial, sans-serif;font-size:14px;}
.wpautoterms-footer .separator{color:#cccccc;font-family:Arial, sans-serif;font-size:14px;}</style>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta" id="crayon-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta" id="crayon-theme-classic-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta" id="crayon-font-monaco-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/auto-terms-of-service-and-privacy-policy/css/wpautoterms.css?ver=4.9.8" id="wpautoterms_css-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/contact-form-7/includes/css/styles.css?ver=5.0.5" id="contact-form-7-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/simple-social-buttons/assets/css/front.css?ver=2.0.20" id="ssb-front-css-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/ultimate-faqs/css/ewd-ufaq-styles.css?ver=4.9.8" id="ewd-ufaq-style-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/ultimate-faqs/css/rrssb-min.css?ver=4.9.8" id="ewd-ufaq-rrssb-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/integrations/testimonials/css/testimonials.css?ver=4.9.8" id="woo-testimonials-css-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/style.css?ver=5.9.21" id="theme-stylesheet-css" media="all" rel="stylesheet" type="text/css"/>
<!--[if lt IE 9]>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/css/non-responsive.css" rel="stylesheet" type="text/css" />
<style type="text/css">.col-full, #wrapper { width: 960px; max-width: 960px; } #inner-wrapper { padding: 0; } body.full-width #header, #nav-container, body.full-width #content, body.full-width #footer-widgets, body.full-width #footer { padding-left: 0; padding-right: 0; } body.fixed-mobile #top, body.fixed-mobile #header-container, body.fixed-mobile #footer-container, body.fixed-mobile #nav-container, body.fixed-mobile #footer-widgets-container { min-width: 960px; padding: 0 1em; } body.full-width #content { width: auto; padding: 0 1em;}</style>
<![endif]-->
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery.js?ver=1.12.4" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/machinelearningmastery.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/simple-social-buttons/assets/js/front.js?ver=2.0.20" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/third-party.min.js?ver=4.9.8" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/modernizr.min.js?ver=2.6.2" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/general.min.js?ver=4.9.8" type="text/javascript"></script>
<link href="https://machinelearningmastery.com/wp-json/" rel="https://api.w.org/"/>
<link href="https://machinelearningmastery.com/xmlrpc.php?rsd" rel="EditURI" title="RSD" type="application/rsd+xml"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/wlwmanifest.xml" rel="wlwmanifest" type="application/wlwmanifest+xml"/>
<link href="https://machinelearningmastery.com/?p=4459" rel="shortlink"/>
<link href="https://machinelearningmastery.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmachinelearningmastery.com%2Fdevelop-a-deep-learning-caption-generation-model-in-python%2F" rel="alternate" type="application/json+oembed"/>
<link href="https://machinelearningmastery.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmachinelearningmastery.com%2Fdevelop-a-deep-learning-caption-generation-model-in-python%2F&amp;format=xml" rel="alternate" type="text/xml+oembed"/>
<!-- Start Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44039733-3', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->
<style media="screen">

        .simplesocialbuttons.simplesocialbuttons_inline .ssb-fb-like {
      margin: ;
    }
         /*inline margin*/
    
  
  
  
  
  
          .simplesocialbuttons.simplesocialbuttons_inline.simplesocial-simple-icons button{
         margin: ;
     }

          /*margin-digbar*/

  
  
  
  
 
   
   

</style>
<script type="text/javascript">
        var ajaxurl = 'https://machinelearningmastery.com/wp-admin/admin-ajax.php';
    </script>
<!-- Custom CSS Styling -->
<style type="text/css">
#logo .site-title, #logo .site-description { display:none; }
body {background-repeat:no-repeat;background-position:top left;background-attachment:scroll;border-top:0px solid #000000;}
#header {background-repeat:no-repeat;background-position:left top;margin-top:0px;margin-bottom:0px;padding-top:10px;padding-bottom:10px;border:0px solid ;}
#logo .site-title a {font:bold 40px/1em "Helvetica Neue", Helvetica, sans-serif;color:#222222;}
#logo .site-description {font:normal 13px/1em "Helvetica Neue", Helvetica, sans-serif;color:#999999;}
body, p { font:normal 14px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#555555; }
h1 { font:bold 28px/1.2em "Helvetica Neue", Helvetica, sans-serif;color:#222222; }h2 { font:bold 24px/1.2em "Helvetica Neue", Helvetica, sans-serif;color:#222222; }h3 { font:bold 20px/1.2em "Helvetica Neue", Helvetica, sans-serif;color:#222222; }h4 { font:bold 16px/1.2em "Helvetica Neue", Helvetica, sans-serif;color:#222222; }h5 { font:bold 14px/1.2em "Helvetica Neue", Helvetica, sans-serif;color:#222222; }h6 { font:bold 12px/1.2em "Helvetica Neue", Helvetica, sans-serif;color:#222222; }
.page-title, .post .title, .page .title {font:bold 28px/1.1em "Helvetica Neue", Helvetica, sans-serif;color:#222222;}
.post .title a:link, .post .title a:visited, .page .title a:link, .page .title a:visited {color:#222222}
.post-meta { font:normal 12px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#999999; }
.entry, .entry p{ font:normal 15px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#555555; }
.post-more {font:normal 13px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:;border-top:0px solid #e6e6e6;border-bottom:0px solid #e6e6e6;}
#post-author, #connect {border-top:1px solid #e6e6e6;border-bottom:1px solid #e6e6e6;border-left:1px solid #e6e6e6;border-right:1px solid #e6e6e6;border-radius:5px;-moz-border-radius:5px;-webkit-border-radius:5px;background-color:#fafafa}
.nav-entries a, .woo-pagination { font:normal 13px/1em "Helvetica Neue", Helvetica, sans-serif;color:#888; }
.woo-pagination a, .woo-pagination a:hover {color:#888!important}
.widget h3 {font:bold 14px/1.2em "Helvetica Neue", Helvetica, sans-serif;color:#555555;border-bottom:1px solid #e6e6e6;}
.widget_recent_comments li, #twitter li { border-color: #e6e6e6;}
.widget p, .widget .textwidget { font:normal 13px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#555555; }
.widget {font:normal 13px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#555555;border-radius:0px;-moz-border-radius:0px;-webkit-border-radius:0px;}
#tabs .inside li a, .widget_woodojo_tabs .tabbable .tab-pane li a { font:bold 12px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#555555; }
#tabs .inside li span.meta, .widget_woodojo_tabs .tabbable .tab-pane li span.meta { font:300 11px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#999999; }
#tabs ul.wooTabs li a, .widget_woodojo_tabs .tabbable .nav-tabs li a { font:300 11px/2em "Helvetica Neue", Helvetica, sans-serif;color:#999999; }
@media only screen and (min-width:768px) {
ul.nav li a, #navigation ul.rss a, #navigation ul.cart a.cart-contents, #navigation .cart-contents #navigation ul.rss, #navigation ul.nav-search, #navigation ul.nav-search a { font:bold 18px/1.2em "Helvetica Neue", Helvetica, sans-serif;color:#4c89bf; } #navigation ul.rss li a:before, #navigation ul.nav-search a.search-contents:before { color:#4c89bf;}
#navigation ul.nav > li a:hover, #navigation ul.nav > li:hover a, #navigation ul.nav li ul li a, #navigation ul.cart > li:hover > a, #navigation ul.cart > li > ul > div, #navigation ul.cart > li > ul > div p, #navigation ul.cart > li > ul span, #navigation ul.cart .cart_list a, #navigation ul.nav li.current_page_item a, #navigation ul.nav li.current_page_parent a, #navigation ul.nav li.current-menu-ancestor a, #navigation ul.nav li.current-cat a, #navigation ul.nav li.current-menu-item a { color:#4c89bf!important; }
#navigation ul.nav > li a:hover, #navigation ul.nav > li:hover, #navigation ul.nav li ul, #navigation ul.cart li:hover a.cart-contents, #navigation ul.nav-search li:hover a.search-contents, #navigation ul.nav-search a.search-contents + ul, #navigation ul.cart a.cart-contents + ul, #navigation ul.nav li.current_page_item a, #navigation ul.nav li.current_page_parent a, #navigation ul.nav li.current-menu-ancestor a, #navigation ul.nav li.current-cat a, #navigation ul.nav li.current-menu-item a{background-color:#ffffff!important}
#navigation ul.nav li ul, #navigation ul.cart > li > ul > div  { border: 0px solid #dbdbdb; }
#navigation ul.nav > li:hover > ul  { left: 0; }
#navigation ul.nav > li  { border-right: 0px solid #dbdbdb; }#navigation ul.nav > li:hover > ul  { left: 0; }
#navigation { box-shadow: none; -moz-box-shadow: none; -webkit-box-shadow: none; }#navigation ul li:first-child, #navigation ul li:first-child a { border-radius:0px 0 0 0px; -moz-border-radius:0px 0 0 0px; -webkit-border-radius:0px 0 0 0px; }
#navigation {background:#ffffff;border-top:0px solid #dbdbdb;border-bottom:0px solid #dbdbdb;border-left:0px solid #dbdbdb;border-right:0px solid #dbdbdb;border-radius:0px; -moz-border-radius:0px; -webkit-border-radius:0px;}
#top ul.nav li a { font:normal 12px/1.6em "Helvetica Neue", Helvetica, sans-serif;color:#ddd; }
}
#footer, #footer p { font:normal 13px/1.4em "Helvetica Neue", Helvetica, sans-serif;color:#999999; }
#footer {border-top:1px solid #dbdbdb;border-bottom:0px solid ;border-left:0px solid ;border-right:0px solid ;border-radius:0px; -moz-border-radius:0px; -webkit-border-radius:0px;}
.magazine #loopedSlider .content h2.title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-magazine .slide-title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.magazine #loopedSlider .content .excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-magazine .slide-content p, .wooslider-theme-magazine .slide-excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.magazine .block .post .title a {font:bold 18px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }
#loopedSlider.business-slider .content h2 { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
#loopedSlider.business-slider .content h2.title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-business .has-featured-image .slide-title { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-business .has-featured-image .slide-title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
#wrapper #loopedSlider.business-slider .content p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-business .has-featured-image .slide-content p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-business .has-featured-image .slide-excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.archive_header { font:bold 18px/1em Arial, sans-serif;color:#222222; }
.archive_header {border-bottom:1px solid #e6e6e6;}
.archive_header .catrss { display:none; }
</style>
<!-- Woo Shortcodes CSS -->
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/functions/css/shortcodes.css" rel="stylesheet" type="text/css"/>
<!-- Custom Stylesheet -->
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/custom.css" rel="stylesheet" type="text/css"/>
<!-- Theme version -->
<meta content="Canvas 5.9.21" name="generator"/>
<meta content="WooFramework 6.2.9" name="generator"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-32x32.png" rel="icon" sizes="32x32"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-192x192.png" rel="icon" sizes="192x192"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-180x180.png" rel="apple-touch-icon-precomposed"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-270x270.png" name="msapplication-TileImage"/>
</head>
<body class="post-template-default single single-post postid-4459 single-format-standard chrome alt-style-default two-col-left width-960 two-col-left-960">
<div id="wrapper">
<div id="inner-wrapper">
<h3 class="nav-toggle icon"><a href="#navigation">Navigation</a></h3>
<header class="col-full" id="header">
<div id="logo">
<a href="https://machinelearningmastery.com/" title="Making developers awesome at machine learning"><img alt="Machine Learning Mastery" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/09/icon-100x100.png"/></a>
<span class="site-title"><a href="https://machinelearningmastery.com/">Machine Learning Mastery</a></span>
<span class="site-description">Making developers awesome at machine learning</span>
</div>
<div class="header-widget">
<div class="widget widget_text" id="text-44"> <div class="textwidget"><p>Want help with deep learning for text? <a href="https://machinelearningmastery.lpages.co/dlfnlp-mini-course/">Take the FREE Mini-Course</a></p>
</div>
</div><div class="widget widget_search" id="search-3"><div class="search_main">
<form action="https://machinelearningmastery.com/" class="searchform" method="get">
<input class="field s" name="s" onblur="if (this.value == '') {this.value = 'Search...';}" onfocus="if (this.value == 'Search...') {this.value = '';}" type="text" value="Search..."/>
<input name="post_type" type="hidden" value="post"/>
<button class="fa fa-search submit" name="submit" type="submit" value="Search"></button>
</form>
<div class="fix"></div>
</div></div> </div>
</header>
<nav class="col-full" id="navigation" role="navigation">
<section class="menus">
<a class="nav-home" href="https://machinelearningmastery.com"><span>Home</span></a>
<h3>Main Menu</h3><ul class="nav fl" id="main-nav"><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6503" id="menu-item-6503"><a href="https://machinelearningmastery.com/start-here/">Start Here</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page current_page_parent menu-item-6501" id="menu-item-6501"><a href="https://machinelearningmastery.com/blog/">Blog</a></li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-6506" id="menu-item-6506"><a href="#">Topics</a>
<ul class="sub-menu">
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6508" id="menu-item-6508"><a href="https://machinelearningmastery.com/category/deep-learning/">Deep Learning (Keras)</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6511" id="menu-item-6511"><a href="https://machinelearningmastery.com/category/lstm/">LSTMs</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6509" id="menu-item-6509"><a href="https://machinelearningmastery.com/category/deep-learning-time-series/">Deep Learning for Time Series</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-6515" id="menu-item-6515"><a href="https://machinelearningmastery.com/category/natural-language-processing/">Deep Learning for NLP</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6512" id="menu-item-6512"><a href="https://machinelearningmastery.com/category/machine-learning-algorithms/">Understand Algorithms</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6507" id="menu-item-6507"><a href="https://machinelearningmastery.com/category/algorithms-from-scratch/">Code Algorithms (Python)</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6513" id="menu-item-6513"><a href="https://machinelearningmastery.com/category/machine-learning-process/">Machine Learning Process</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6516" id="menu-item-6516"><a href="https://machinelearningmastery.com/category/python-machine-learning/">Python (scikit-learn)</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6517" id="menu-item-6517"><a href="https://machinelearningmastery.com/category/r-machine-learning/">R (caret)</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6522" id="menu-item-6522"><a href="https://machinelearningmastery.com/category/weka-machine-learning/">Weka (no code)</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6518" id="menu-item-6518"><a href="https://machinelearningmastery.com/category/start-machine-learning/">Getting Started</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6510" id="menu-item-6510"><a href="https://machinelearningmastery.com/category/linear-algebra/">Linear Algebra</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6519" id="menu-item-6519"><a href="https://machinelearningmastery.com/category/statistical-methods/">Statistical Methods</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6520" id="menu-item-6520"><a href="https://machinelearningmastery.com/category/time-series/">Time Series (introductory)</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6523" id="menu-item-6523"><a href="https://machinelearningmastery.com/category/xgboost/">XGBoost</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6514" id="menu-item-6514"><a href="https://machinelearningmastery.com/category/machine-learning-resources/">Resources</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6502" id="menu-item-6502"><a href="https://machinelearningmastery.com/products/">Ebooks</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6500" id="menu-item-6500"><a href="https://machinelearningmastery.com/faq/">FAQ</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6504" id="menu-item-6504"><a href="https://machinelearningmastery.com/about/">About</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6505" id="menu-item-6505"><a href="https://machinelearningmastery.com/contact/">Contact</a></li>
</ul> <div class="side-nav">
</div><!-- /#side-nav -->
</section><!-- /.menus -->
<a class="nav-close" href="#top"><span>Return to Content</span></a>
</nav>
<!-- #content Starts -->
<div class="col-full" id="content">
<div id="main-sidebar-container">
<!-- #main Starts -->
<section id="main">
<article class="post-4459 post type-post status-publish format-standard has-post-thumbnail hentry category-natural-language-processing">
<header>
<h1 class="title entry-title">How to Develop a Deep Learning Photo Caption Generator from Scratch</h1> </header>
<div class="post-meta"><span class="small">By</span> <span class="author vcard"><span class="fn"><a href="https://machinelearningmastery.com/author/jasonb/" rel="author" title="Posts by Jason Brownlee">Jason Brownlee</a></span></span> <span class="small">on</span> <abbr class="date time published updated" title="2017-11-27T05:00:59+1100">November 27, 2017</abbr> <span class="small">in</span> <span class="categories"><a href="https://machinelearningmastery.com/category/natural-language-processing/" title="View all items in Deep Learning for Natural Language Processing">Deep Learning for Natural Language Processing</a></span> </div>
<section class="entry">
<div class="simplesocialbuttons simplesocial-simple-icons simplesocialbuttons_inline simplesocialbuttons-align-left post-4459 post simplesocialbuttons-inline-no-animation">
<button class="ssb_tweet-icon" data-href="https://twitter.com/share?text=How+to+Develop+a+Deep+Learning+Photo+Caption+Generator+from+Scratch&amp;url=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/" onclick="javascript:window.open(this.dataset.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;" rel="nofollow">
<span class="icon"><svg viewbox="0 0 72 72" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h72v72H0z" fill="none"></path><path class="icon" d="M68.812 15.14c-2.348 1.04-4.87 1.744-7.52 2.06 2.704-1.62 4.78-4.186 5.757-7.243-2.53 1.5-5.33 2.592-8.314 3.176C56.35 10.59 52.948 9 49.182 9c-7.23 0-13.092 5.86-13.092 13.093 0 1.026.118 2.02.338 2.98C25.543 24.527 15.9 19.318 9.44 11.396c-1.125 1.936-1.77 4.184-1.77 6.58 0 4.543 2.312 8.552 5.824 10.9-2.146-.07-4.165-.658-5.93-1.64-.002.056-.002.11-.002.163 0 6.345 4.513 11.638 10.504 12.84-1.1.298-2.256.457-3.45.457-.845 0-1.666-.078-2.464-.23 1.667 5.2 6.5 8.985 12.23 9.09-4.482 3.51-10.13 5.605-16.26 5.605-1.055 0-2.096-.06-3.122-.184 5.794 3.717 12.676 5.882 20.067 5.882 24.083 0 37.25-19.95 37.25-37.25 0-.565-.013-1.133-.038-1.693 2.558-1.847 4.778-4.15 6.532-6.774z" fill="#fff"></path></svg></span><i class="simplesocialtxt">Tweet </i></button>
<button class="ssb_fbshare-icon" data-href="https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/" onclick="javascript:window.open(this.dataset.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;" target="_blank">
<span class="icon"><svg class="_1pbq" color="#ffffff" viewbox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path class="icon" d="M8 14H3.667C2.733 13.9 2 13.167 2 12.233V3.667A1.65 1.65 0 0 1 3.667 2h8.666A1.65 1.65 0 0 1 14 3.667v8.566c0 .934-.733 1.667-1.667 1.767H10v-3.967h1.3l.7-2.066h-2V6.933c0-.466.167-.9.867-.9H12v-1.8c.033 0-.933-.266-1.533-.266-1.267 0-2.434.7-2.467 2.133v1.867H6v2.066h2V14z" fill="#ffffff" fill-rule="evenodd"></path></svg></span>
<span class="simplesocialtxt">Share </span> </button>
<button class="ssb_linkedin-icon" data-href="https://www.linkedin.com/cws/share?url=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/" onclick="javascript:window.open(this.dataset.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
<span class="icon"> <svg enable-background="new -301.4 387.5 15 14.1" height="14.1px" id="Layer_1" version="1.1" viewbox="-301.4 387.5 15 14.1" width="15px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"> <g id="XMLID_398_"> <path d="M-296.2,401.6c0-3.2,0-6.3,0-9.5h0.1c1,0,2,0,2.9,0c0.1,0,0.1,0,0.1,0.1c0,0.4,0,0.8,0,1.2 c0.1-0.1,0.2-0.3,0.3-0.4c0.5-0.7,1.2-1,2.1-1.1c0.8-0.1,1.5,0,2.2,0.3c0.7,0.4,1.2,0.8,1.5,1.4c0.4,0.8,0.6,1.7,0.6,2.5 c0,1.8,0,3.6,0,5.4v0.1c-1.1,0-2.1,0-3.2,0c0-0.1,0-0.1,0-0.2c0-1.6,0-3.2,0-4.8c0-0.4,0-0.8-0.2-1.2c-0.2-0.7-0.8-1-1.6-1 c-0.8,0.1-1.3,0.5-1.6,1.2c-0.1,0.2-0.1,0.5-0.1,0.8c0,1.7,0,3.4,0,5.1c0,0.2,0,0.2-0.2,0.2c-1,0-1.9,0-2.9,0 C-296.1,401.6-296.2,401.6-296.2,401.6z" fill="#FFFFFF" id="XMLID_399_"></path> <path d="M-298,401.6L-298,401.6c-1.1,0-2.1,0-3,0c-0.1,0-0.1,0-0.1-0.1c0-3.1,0-6.1,0-9.2 c0-0.1,0-0.1,0.1-0.1c1,0,2,0,2.9,0h0.1C-298,395.3-298,398.5-298,401.6z" fill="#FFFFFF" id="XMLID_400_"></path> <path d="M-299.6,390.9c-0.7-0.1-1.2-0.3-1.6-0.8c-0.5-0.8-0.2-2.1,1-2.4c0.6-0.2,1.2-0.1,1.8,0.2 c0.5,0.4,0.7,0.9,0.6,1.5c-0.1,0.7-0.5,1.1-1.1,1.3C-299.1,390.8-299.4,390.8-299.6,390.9L-299.6,390.9z" fill="#FFFFFF" id="XMLID_401_"></path> </g> </svg> </span>
<span class="simplesocialtxt">Share</span> </button>
<button class="ssb_gplus-icon" data-href="https://plus.google.com/share?url=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/" onclick="javascript:window.open(this.dataset.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
<span class="icon"><svg class="ozWidgetRioButtonSvg_ ozWidgetRioButtonPlusOne_" height="18px" preserveaspectratio="xMidYMid meet" version="1.1" viewbox="-10 -6 60 36" width="30px" xmlns="http://www.w3.org/2000/svg"><path d="M30 7h-3v4h-4v3h4v4h3v-4h4v-3h-4V7z"></path><path d="M11 9.9v4h5.4C16 16.3 14 18 11 18c-3.3 0-5.9-2.8-5.9-6S7.7 6 11 6c1.5 0 2.8.5 3.8 1.5l2.9-2.9C15.9 3 13.7 2 11 2 5.5 2 1 6.5 1 12s4.5 10 10 10c5.8 0 9.6-4.1 9.6-9.8 0-.7-.1-1.5-.2-2.2H11z"></path></svg></span>
<span class="simplesocialtxt">Google Plus </span></button>
</div>
<h4 style="text-align: center;">Develop a Deep Learning Model to Automatically<br/>
Describe Photographs in Python with Keras, Step-by-Step.</h4>
<p>Caption generation is a challenging artificial intelligence problem where a textual description must be generated for a given photograph.</p>
<p>It requires both methods from computer vision to understand the content of the image and a language model from the field of natural language processing to turn the understanding of the image into words in the right order. Recently, deep learning methods have achieved state-of-the-art results on examples of this problem.</p>
<p>Deep learning methods have demonstrated state-of-the-art results on caption generation problems. What is most impressive about these methods is a single end-to-end model can be defined to predict a caption, given a photo, instead of requiring sophisticated data preparation or a pipeline of specifically designed models.</p>
<p>In this tutorial, you will discover how to develop a photo captioning deep learning model from scratch.</p>
<p>After completing this tutorial, you will know:</p>
<ul>
<li>How to prepare photo and text data for training a deep learning model.</li>
<li>How to design and train a deep learning caption generation model.</li>
<li>How to evaluate a train caption generation model and use it to caption entirely new photographs.</li>
</ul>
<p>Let’s get started.</p>
<ul>
<li><strong>Update Nov/2017</strong>: Added note about a bug introduced in Keras 2.1.0 and 2.1.1 that impacts the code in this tutorial.</li>
<li><strong>Update Dec/2017</strong>: Updated a typo in the function name when explaining how to save descriptions to file, thanks Minel.</li>
<li><strong>Update Apr/2018</strong>: Added a new section that shows how to train the model using progressive loading for workstations with minimum RAM.</li>
</ul>
<div class="wp-caption aligncenter" id="attachment_4463" style="width: 650px"><img alt="How to Develop a Deep Learning Caption Generation Model in Python from Scratch" class="size-full wp-image-4463" height="480" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/How-to-Develop-a-Deep-Learning-Caption-Generation-Model-in-Python-from-Scratch.jpg" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/How-to-Develop-a-Deep-Learning-Caption-Generation-Model-in-Python-from-Scratch.jpg 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/How-to-Develop-a-Deep-Learning-Caption-Generation-Model-in-Python-from-Scratch-300x225.jpg 300w" width="640"/><p class="wp-caption-text">How to Develop a Deep Learning Caption Generation Model in Python from Scratch<br/>Photo by <a href="https://www.flickr.com/photos/livinginmonrovia/8069637650/">Living in Monrovia</a>, some rights reserved.</p></div>
<h2>Tutorial Overview</h2>
<p>This tutorial is divided into 6 parts; they are:</p>
<ol>
<li>Photo and Caption Dataset</li>
<li>Prepare Photo Data</li>
<li>Prepare Text Data</li>
<li>Develop Deep Learning Model</li>
<li>Train With Progressive Loading (<strong>NEW</strong>)</li>
<li>Evaluate Model</li>
<li>Generate New Captions</li>
</ol>
<h3>Python Environment</h3>
<p>This tutorial assumes you have a Python SciPy environment installed, ideally with Python 3.</p>
<p>You must have Keras (2.1.5 or higher) installed with either the TensorFlow or Theano backend.</p>
<p>The tutorial also assumes you have scikit-learn, Pandas, NumPy, and Matplotlib installed.</p>
<p>If you need help with your environment, see this tutorial:</p>
<ul>
<li><a href="https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/">How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda</a></li>
</ul>
<p>I recommend running the code on a system with a GPU. You can access GPUs cheaply on Amazon Web Services. Learn how in this tutorial:</p>
<ul>
<li><a href="https://machinelearningmastery.com/develop-evaluate-large-deep-learning-models-keras-amazon-web-services/">How To Develop and Evaluate Large Deep Learning Models with Keras on Amazon Web Services</a></li>
</ul>
<p>Let’s dive in.</p>
<p></p><div class="woo-sc-hr"></div>
<center>
<h3>Need help with Deep Learning for Text Data?</h3>
<p>Take my free 7-day email crash course now (with code).</p>
<p>Click to sign-up and also get a free PDF Ebook version of the course.</p>
<p><a href="https://machinelearningmastery.lpages.co/leadbox/144855173f72a2%3A164f8be4f346dc/5655638436741120/" rel="noopener" style="background: #ffce0a; color: #ffffff; text-decoration: none; font-family: Helvetica, Arial, sans-serif; font-weight: bold; font-size: 16px; line-height: 20px; padding: 10px; display: inline-block; max-width: 300px; border-radius: 5px; text-shadow: rgba(0, 0, 0, 0.25) 0px -1px 1px; box-shadow: rgba(255, 255, 255, 0.5) 0px 1px 3px inset, rgba(0, 0, 0, 0.5) 0px 1px 3px;" target="_blank">Start Your FREE Crash-Course Now</a><script data-config="%7B%7D" data-leadbox="144855173f72a2:164f8be4f346dc" data-url="https://machinelearningmastery.lpages.co/leadbox/144855173f72a2%3A164f8be4f346dc/5655638436741120/" src="https://machinelearningmastery.lpages.co/leadbox-1509466860.js" type="text/javascript"></script></p>
</center>
<p></p><div class="woo-sc-hr"></div>
<h2>Photo and Caption Dataset</h2>
<p>A good dataset to use when getting started with image captioning is the Flickr8K dataset.</p>
<p>The reason is because it is realistic and relatively small so that you can download it and build models on your workstation using a CPU.</p>
<p>The definitive description of the dataset is in the paper “<a href="https://www.jair.org/media/3994/live-3994-7274-jair.pdf">Framing Image Description as a Ranking Task: Data, Models and Evaluation Metrics</a>” from 2013.</p>
<p>The authors describe the dataset as follows:</p>
<blockquote><p>We introduce a new benchmark collection for sentence-based image description and search, consisting of 8,000 images that are each paired with five different captions which provide clear descriptions of the salient entities and events.</p>
<p>…</p>
<p>The images were chosen from six different Flickr groups, and tend not to contain any well-known people or locations, but were manually selected to depict a variety of scenes and situations.</p></blockquote>
<p>— <a href="https://www.jair.org/media/3994/live-3994-7274-jair.pdf">Framing Image Description as a Ranking Task: Data, Models and Evaluation Metrics</a>, 2013.</p>
<p>The dataset is available for free. You must complete a request form and the links to the dataset will be emailed to you. I would love to link to them for you, but the email address expressly requests: “<em>Please do not redistribute the dataset</em>“.</p>
<p>You can use the link below to request the dataset:</p>
<ul>
<li><a href="https://illinois.edu/fb/sec/1713398">Dataset Request Form</a></li>
</ul>
<p>Within a short time, you will receive an email that contains links to two files:</p>
<ul>
<li><strong>Flickr8k_Dataset.zip</strong> (1 Gigabyte) An archive of all photographs.</li>
<li><strong>Flickr8k_text.zip</strong> (2.2 Megabytes) An archive of all text descriptions for photographs.</li>
</ul>
<p>Download the datasets and unzip them into your current working directory. You will have two directories:</p>
<ul>
<li><strong>Flicker8k_Dataset</strong>: Contains 8092 photographs in JPEG format.</li>
<li><strong>Flickr8k_text</strong>: Contains a number of files containing different sources of descriptions for the photographs.</li>
</ul>
<p>The dataset has a pre-defined training dataset (6,000 images), development dataset (1,000 images), and test dataset (1,000 images).</p>
<p>One measure that can be used to evaluate the skill of the model are BLEU scores. For reference, below are some ball-park BLEU scores for skillful models when evaluated on the test dataset (taken from the 2017 paper “<a href="https://arxiv.org/abs/1703.09137">Where to put the Image in an Image Caption Generator</a>“):</p>
<ul>
<li>BLEU-1: 0.401 to 0.578.</li>
<li>BLEU-2: 0.176 to 0.390.</li>
<li>BLEU-3: 0.099 to 0.260.</li>
<li>BLEU-4: 0.059 to 0.170.</li>
</ul>
<p>We describe the BLEU metric more later when we work on evaluating our model.</p>
<p>Next, let’s look at how to load the images.</p>
<h2>Prepare Photo Data</h2>
<p>We will use a pre-trained model to interpret the content of the photos.</p>
<p>There are many models to choose from. In this case, we will use the Oxford Visual Geometry Group, or VGG, model that won the ImageNet competition in 2014. Learn more about the model here:</p>
<ul>
<li><a href="http://www.robots.ox.ac.uk/~vgg/research/very_deep/">Very Deep Convolutional Networks for Large-Scale Visual Recognition</a></li>
</ul>
<p>Keras provides this pre-trained model directly. Note, the first time you use this model, Keras will download the model weights from the Internet, which are about 500 Megabytes. This may take a few minutes depending on your internet connection.</p>
<p>We could use this model as part of a broader image caption model. The problem is, it is a large model and running each photo through the network every time we want to test a new language model configuration (downstream) is redundant.</p>
<p>Instead, we can pre-compute the “photo features” using the pre-trained model and save them to file. We can then load these features later and feed them into our model as the interpretation of a given photo in the dataset. It is no different to running the photo through the full VGG model; it is just we will have done it once in advance.</p>
<p>This is an optimization that will make training our models faster and consume less memory.</p>
<p>We can load the VGG model in Keras using the VGG class. We will remove the last layer from the loaded model, as this is the model used to predict a classification for a photo. We are not interested in classifying images, but we are interested in the internal representation of the photo right before a classification is made. These are the “features” that the model has extracted from the photo.</p>
<p>Keras also provides tools for reshaping the loaded photo into the preferred size for the model (e.g. 3 channel 224 x 224 pixel image).</p>
<p>Below is a function named <em>extract_features()</em> that, given a directory name, will load each photo, prepare it for VGG, and collect the predicted features from the VGG model. The image features are a 1-dimensional 4,096 element vector.</p>
<p>The function returns a dictionary of image identifier to image features.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca373315da938929066" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# extract features from each photo in the directory
def extract_features(directory):
	# load the model
	model = VGG16()
	# re-structure the model
	model.layers.pop()
	model = Model(inputs=model.inputs, outputs=model.layers[-1].output)
	# summarize
	print(model.summary())
	# extract features from each photo
	features = dict()
	for name in listdir(directory):
		# load an image from file
		filename = directory + '/' + name
		image = load_img(filename, target_size=(224, 224))
		# convert the image pixels to a numpy array
		image = img_to_array(image)
		# reshape data for the model
		image = image.reshape((1, image.shape[0], image.shape[1], image.shape[2]))
		# prepare the image for the VGG model
		image = preprocess_input(image)
		# get features
		feature = model.predict(image, verbose=0)
		# get image id
		image_id = name.split('.')[0]
		# store feature
		features[image_id] = feature
		print('&gt;%s' % name)
	return features</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca373315da938929066-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315da938929066-2">2</div><div class="crayon-num" data-line="crayon-5c0ca373315da938929066-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315da938929066-4">4</div><div class="crayon-num" data-line="crayon-5c0ca373315da938929066-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315da938929066-6">6</div><div class="crayon-num" data-line="crayon-5c0ca373315da938929066-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315da938929066-8">8</div><div class="crayon-num" data-line="crayon-5c0ca373315da938929066-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315da938929066-10">10</div><div class="crayon-num" data-line="crayon-5c0ca373315da938929066-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315da938929066-12">12</div><div class="crayon-num" data-line="crayon-5c0ca373315da938929066-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315da938929066-14">14</div><div class="crayon-num" data-line="crayon-5c0ca373315da938929066-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315da938929066-16">16</div><div class="crayon-num" data-line="crayon-5c0ca373315da938929066-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315da938929066-18">18</div><div class="crayon-num" data-line="crayon-5c0ca373315da938929066-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315da938929066-20">20</div><div class="crayon-num" data-line="crayon-5c0ca373315da938929066-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315da938929066-22">22</div><div class="crayon-num" data-line="crayon-5c0ca373315da938929066-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315da938929066-24">24</div><div class="crayon-num" data-line="crayon-5c0ca373315da938929066-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315da938929066-26">26</div><div class="crayon-num" data-line="crayon-5c0ca373315da938929066-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315da938929066-28">28</div><div class="crayon-num" data-line="crayon-5c0ca373315da938929066-29">29</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca373315da938929066-1"><span class="crayon-p"># extract features from each photo in the directory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315da938929066-2"><span class="crayon-e">def </span><span class="crayon-e">extract_features</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315da938929066-3"><span class="crayon-h"> </span><span class="crayon-p"># load the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315da938929066-4"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">VGG16</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315da938929066-5"><span class="crayon-h"> </span><span class="crayon-p"># re-structure the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315da938929066-6"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">.</span><span class="crayon-e">pop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315da938929066-7"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">inputs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">output</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315da938929066-8"><span class="crayon-h"> </span><span class="crayon-p"># summarize</span></div><div class="crayon-line" id="crayon-5c0ca373315da938929066-9"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">summary</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315da938929066-10"><span class="crayon-h"> </span><span class="crayon-p"># extract features from each photo</span></div><div class="crayon-line" id="crayon-5c0ca373315da938929066-11"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315da938929066-12"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">name </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">listdir</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315da938929066-13"><span class="crayon-h"> </span><span class="crayon-p"># load an image from file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315da938929066-14"><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">directory</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'/'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">name</span></div><div class="crayon-line" id="crayon-5c0ca373315da938929066-15"><span class="crayon-e"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_img</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">target_size</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">224</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315da938929066-16"><span class="crayon-h"> </span><span class="crayon-p"># convert the image pixels to a numpy array</span></div><div class="crayon-line" id="crayon-5c0ca373315da938929066-17"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">img_to_array</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315da938929066-18"><span class="crayon-h"> </span><span class="crayon-p"># reshape data for the model</span></div><div class="crayon-line" id="crayon-5c0ca373315da938929066-19"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315da938929066-20"><span class="crayon-h"> </span><span class="crayon-p"># prepare the image for the VGG model</span></div><div class="crayon-line" id="crayon-5c0ca373315da938929066-21"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">preprocess_input</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315da938929066-22"><span class="crayon-h"> </span><span class="crayon-p"># get features</span></div><div class="crayon-line" id="crayon-5c0ca373315da938929066-23"><span class="crayon-h"> </span><span class="crayon-v">feature</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315da938929066-24"><span class="crayon-h"> </span><span class="crayon-p"># get image id</span></div><div class="crayon-line" id="crayon-5c0ca373315da938929066-25"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315da938929066-26"><span class="crayon-h"> </span><span class="crayon-p"># store feature</span></div><div class="crayon-line" id="crayon-5c0ca373315da938929066-27"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">feature</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315da938929066-28"><span class="crayon-e"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'&gt;%s'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315da938929066-29"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0016 seconds] -->
<p>We can call this function to prepare the photo data for testing our models, then save the resulting dictionary to a file named ‘<em>features.pkl</em>‘.</p>
<p>The complete example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca373315e5971911066" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from os import listdir
from pickle import dump
from keras.applications.vgg16 import VGG16
from keras.preprocessing.image import load_img
from keras.preprocessing.image import img_to_array
from keras.applications.vgg16 import preprocess_input
from keras.models import Model

# extract features from each photo in the directory
def extract_features(directory):
	# load the model
	model = VGG16()
	# re-structure the model
	model.layers.pop()
	model = Model(inputs=model.inputs, outputs=model.layers[-1].output)
	# summarize
	print(model.summary())
	# extract features from each photo
	features = dict()
	for name in listdir(directory):
		# load an image from file
		filename = directory + '/' + name
		image = load_img(filename, target_size=(224, 224))
		# convert the image pixels to a numpy array
		image = img_to_array(image)
		# reshape data for the model
		image = image.reshape((1, image.shape[0], image.shape[1], image.shape[2]))
		# prepare the image for the VGG model
		image = preprocess_input(image)
		# get features
		feature = model.predict(image, verbose=0)
		# get image id
		image_id = name.split('.')[0]
		# store feature
		features[image_id] = feature
		print('&gt;%s' % name)
	return features

# extract features from all images
directory = 'Flicker8k_Dataset'
features = extract_features(directory)
print('Extracted Features: %d' % len(features))
# save to file
dump(features, open('features.pkl', 'wb'))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-2">2</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-4">4</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-6">6</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-8">8</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-10">10</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-12">12</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-14">14</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-16">16</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-18">18</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-20">20</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-22">22</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-24">24</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-26">26</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-28">28</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-30">30</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-32">32</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-34">34</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-36">36</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-38">38</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-40">40</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-42">42</div><div class="crayon-num" data-line="crayon-5c0ca373315e5971911066-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e5971911066-44">44</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca373315e5971911066-1"><span class="crayon-e">from </span><span class="crayon-e">os </span><span class="crayon-e">import </span><span class="crayon-e">listdir</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-2"><span class="crayon-e">from </span><span class="crayon-e">pickle </span><span class="crayon-e">import </span><span class="crayon-e">dump</span></div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-3"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">applications</span><span class="crayon-sy">.</span><span class="crayon-e">vgg16 </span><span class="crayon-e">import </span><span class="crayon-e">VGG16</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-4"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">load_img</span></div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-5"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">img_to_array</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-6"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">applications</span><span class="crayon-sy">.</span><span class="crayon-e">vgg16 </span><span class="crayon-e">import </span><span class="crayon-e">preprocess_input</span></div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-7"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-v">Model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-8"> </div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-9"><span class="crayon-p"># extract features from each photo in the directory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-10"><span class="crayon-e">def </span><span class="crayon-e">extract_features</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-11"><span class="crayon-h"> </span><span class="crayon-p"># load the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-12"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">VGG16</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-13"><span class="crayon-h"> </span><span class="crayon-p"># re-structure the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-14"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">.</span><span class="crayon-e">pop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-15"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">inputs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">output</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-16"><span class="crayon-h"> </span><span class="crayon-p"># summarize</span></div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-17"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">summary</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-18"><span class="crayon-h"> </span><span class="crayon-p"># extract features from each photo</span></div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-19"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-20"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">name </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">listdir</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-21"><span class="crayon-h"> </span><span class="crayon-p"># load an image from file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-22"><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">directory</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'/'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">name</span></div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-23"><span class="crayon-e"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_img</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">target_size</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">224</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-24"><span class="crayon-h"> </span><span class="crayon-p"># convert the image pixels to a numpy array</span></div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-25"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">img_to_array</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-26"><span class="crayon-h"> </span><span class="crayon-p"># reshape data for the model</span></div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-27"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-28"><span class="crayon-h"> </span><span class="crayon-p"># prepare the image for the VGG model</span></div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-29"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">preprocess_input</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-30"><span class="crayon-h"> </span><span class="crayon-p"># get features</span></div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-31"><span class="crayon-h"> </span><span class="crayon-v">feature</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-32"><span class="crayon-h"> </span><span class="crayon-p"># get image id</span></div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-33"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-34"><span class="crayon-h"> </span><span class="crayon-p"># store feature</span></div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-35"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">feature</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-36"><span class="crayon-e"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'&gt;%s'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-37"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-38"> </div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-39"><span class="crayon-p"># extract features from all images</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-40"><span class="crayon-v">directory</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flicker8k_Dataset'</span></div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-41"><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">extract_features</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-42"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Extracted Features: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315e5971911066-43"><span class="crayon-p"># save to file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e5971911066-44"><span class="crayon-e">dump</span><span class="crayon-sy">(</span><span class="crayon-v">features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-s">'features.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'wb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0021 seconds] -->
<p>Running this data preparation step may take a while depending on your hardware, perhaps one hour on the CPU with a modern workstation.</p>
<p>At the end of the run, you will have the extracted features stored in ‘<em>features.pkl</em>‘ for later use. This file will be about 127 Megabytes in size.</p>
<h2>Prepare Text Data</h2>
<p>The dataset contains multiple descriptions for each photograph and the text of the descriptions requires some minimal cleaning.</p>
<p>First, we will load the file containing all of the descriptions.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca373315e7365685562" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

filename = 'Flickr8k_text/Flickr8k.token.txt'
# load descriptions
doc = load_doc(filename)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca373315e7365685562-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e7365685562-2">2</div><div class="crayon-num" data-line="crayon-5c0ca373315e7365685562-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e7365685562-4">4</div><div class="crayon-num" data-line="crayon-5c0ca373315e7365685562-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e7365685562-6">6</div><div class="crayon-num" data-line="crayon-5c0ca373315e7365685562-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e7365685562-8">8</div><div class="crayon-num" data-line="crayon-5c0ca373315e7365685562-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e7365685562-10">10</div><div class="crayon-num" data-line="crayon-5c0ca373315e7365685562-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315e7365685562-12">12</div><div class="crayon-num" data-line="crayon-5c0ca373315e7365685562-13">13</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca373315e7365685562-1"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e7365685562-2"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315e7365685562-3"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e7365685562-4"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315e7365685562-5"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e7365685562-6"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315e7365685562-7"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e7365685562-8"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315e7365685562-9"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e7365685562-10"> </div><div class="crayon-line" id="crayon-5c0ca373315e7365685562-11"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr8k.token.txt'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315e7365685562-12"><span class="crayon-p"># load descriptions</span></div><div class="crayon-line" id="crayon-5c0ca373315e7365685562-13"><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>Each photo has a unique identifier. This identifier is used on the photo filename and in the text file of descriptions.</p>
<p>Next, we will step through the list of photo descriptions. Below defines a function <em>load_descriptions()</em> that, given the loaded document text, will return a dictionary of photo identifiers to descriptions. Each photo identifier maps to a list of one or more textual descriptions.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca373315ea128001107" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# extract descriptions for images
def load_descriptions(doc):
	mapping = dict()
	# process lines
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		if len(line) &lt; 2:
			continue
		# take the first token as the image id, the rest as the description
		image_id, image_desc = tokens[0], tokens[1:]
		# remove filename from image id
		image_id = image_id.split('.')[0]
		# convert description tokens back to string
		image_desc = ' '.join(image_desc)
		# create the list if needed
		if image_id not in mapping:
			mapping[image_id] = list()
		# store description
		mapping[image_id].append(image_desc)
	return mapping

# parse descriptions
descriptions = load_descriptions(doc)
print('Loaded: %d ' % len(descriptions))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca373315ea128001107-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ea128001107-2">2</div><div class="crayon-num" data-line="crayon-5c0ca373315ea128001107-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ea128001107-4">4</div><div class="crayon-num" data-line="crayon-5c0ca373315ea128001107-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ea128001107-6">6</div><div class="crayon-num" data-line="crayon-5c0ca373315ea128001107-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ea128001107-8">8</div><div class="crayon-num" data-line="crayon-5c0ca373315ea128001107-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ea128001107-10">10</div><div class="crayon-num" data-line="crayon-5c0ca373315ea128001107-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ea128001107-12">12</div><div class="crayon-num" data-line="crayon-5c0ca373315ea128001107-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ea128001107-14">14</div><div class="crayon-num" data-line="crayon-5c0ca373315ea128001107-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ea128001107-16">16</div><div class="crayon-num" data-line="crayon-5c0ca373315ea128001107-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ea128001107-18">18</div><div class="crayon-num" data-line="crayon-5c0ca373315ea128001107-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ea128001107-20">20</div><div class="crayon-num" data-line="crayon-5c0ca373315ea128001107-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ea128001107-22">22</div><div class="crayon-num" data-line="crayon-5c0ca373315ea128001107-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ea128001107-24">24</div><div class="crayon-num" data-line="crayon-5c0ca373315ea128001107-25">25</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca373315ea128001107-1"><span class="crayon-p"># extract descriptions for images</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ea128001107-2"><span class="crayon-e">def </span><span class="crayon-e">load_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">doc</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315ea128001107-3"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ea128001107-4"><span class="crayon-h"> </span><span class="crayon-p"># process lines</span></div><div class="crayon-line" id="crayon-5c0ca373315ea128001107-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ea128001107-6"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line" id="crayon-5c0ca373315ea128001107-7"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ea128001107-8"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315ea128001107-9"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ea128001107-10"><span class="crayon-h"> </span><span class="crayon-p"># take the first token as the image id, the rest as the description</span></div><div class="crayon-line" id="crayon-5c0ca373315ea128001107-11"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ea128001107-12"><span class="crayon-h"> </span><span class="crayon-p"># remove filename from image id</span></div><div class="crayon-line" id="crayon-5c0ca373315ea128001107-13"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ea128001107-14"><span class="crayon-h"> </span><span class="crayon-p"># convert description tokens back to string</span></div><div class="crayon-line" id="crayon-5c0ca373315ea128001107-15"><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ea128001107-16"><span class="crayon-h"> </span><span class="crayon-p"># create the list if needed</span></div><div class="crayon-line" id="crayon-5c0ca373315ea128001107-17"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ea128001107-18"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315ea128001107-19"><span class="crayon-h"> </span><span class="crayon-p"># store description</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ea128001107-20"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315ea128001107-21"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">mapping</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ea128001107-22"> </div><div class="crayon-line" id="crayon-5c0ca373315ea128001107-23"><span class="crayon-p"># parse descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ea128001107-24"><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">doc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315ea128001107-25"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Loaded: %d '</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0011 seconds] -->
<p>Next, we need to clean the description text. The descriptions are already tokenized and easy to work with.</p>
<p>We will clean the text in the following ways in order to reduce the size of the vocabulary of words we will need to work with:</p>
<ul>
<li>Convert all words to lowercase.</li>
<li>Remove all punctuation.</li>
<li>Remove all words that are one character or less in length (e.g. ‘a’).</li>
<li>Remove all words with numbers in them.</li>
</ul>
<p>Below defines the <em>clean_descriptions()</em> function that, given the dictionary of image identifiers to descriptions, steps through each description and cleans the text.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca373315ec062631059" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
import string

def clean_descriptions(descriptions):
	# prepare translation table for removing punctuation
	table = str.maketrans('', '', string.punctuation)
	for key, desc_list in descriptions.items():
		for i in range(len(desc_list)):
			desc = desc_list[i]
			# tokenize
			desc = desc.split()
			# convert to lower case
			desc = [word.lower() for word in desc]
			# remove punctuation from each token
			desc = [w.translate(table) for w in desc]
			# remove hanging 's' and 'a'
			desc = [word for word in desc if len(word)&gt;1]
			# remove tokens with numbers in them
			desc = [word for word in desc if word.isalpha()]
			# store as string
			desc_list[i] =  ' '.join(desc)

# clean descriptions
clean_descriptions(descriptions)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca373315ec062631059-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ec062631059-2">2</div><div class="crayon-num" data-line="crayon-5c0ca373315ec062631059-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ec062631059-4">4</div><div class="crayon-num" data-line="crayon-5c0ca373315ec062631059-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ec062631059-6">6</div><div class="crayon-num" data-line="crayon-5c0ca373315ec062631059-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ec062631059-8">8</div><div class="crayon-num" data-line="crayon-5c0ca373315ec062631059-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ec062631059-10">10</div><div class="crayon-num" data-line="crayon-5c0ca373315ec062631059-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ec062631059-12">12</div><div class="crayon-num" data-line="crayon-5c0ca373315ec062631059-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ec062631059-14">14</div><div class="crayon-num" data-line="crayon-5c0ca373315ec062631059-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ec062631059-16">16</div><div class="crayon-num" data-line="crayon-5c0ca373315ec062631059-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ec062631059-18">18</div><div class="crayon-num" data-line="crayon-5c0ca373315ec062631059-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ec062631059-20">20</div><div class="crayon-num" data-line="crayon-5c0ca373315ec062631059-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ec062631059-22">22</div><div class="crayon-num" data-line="crayon-5c0ca373315ec062631059-23">23</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca373315ec062631059-1"><span class="crayon-e">import </span><span class="crayon-t">string</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ec062631059-2"> </div><div class="crayon-line" id="crayon-5c0ca373315ec062631059-3"><span class="crayon-e">def </span><span class="crayon-e">clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ec062631059-4"><span class="crayon-h"> </span><span class="crayon-p"># prepare translation table for removing punctuation</span></div><div class="crayon-line" id="crayon-5c0ca373315ec062631059-5"><span class="crayon-h"> </span><span class="crayon-v">table</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">str</span><span class="crayon-sy">.</span><span class="crayon-e">maketrans</span><span class="crayon-sy">(</span><span class="crayon-s">''</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">''</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-sy">.</span><span class="crayon-v">punctuation</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ec062631059-6"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc_list </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315ec062631059-7"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">desc_list</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ec062631059-8"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca373315ec062631059-9"><span class="crayon-h"> </span><span class="crayon-p"># tokenize</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ec062631059-10"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315ec062631059-11"><span class="crayon-h"> </span><span class="crayon-p"># convert to lower case</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ec062631059-12"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-sy">.</span><span class="crayon-e">lower</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca373315ec062631059-13"><span class="crayon-h"> </span><span class="crayon-p"># remove punctuation from each token</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ec062631059-14"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">w</span><span class="crayon-sy">.</span><span class="crayon-e">translate</span><span class="crayon-sy">(</span><span class="crayon-v">table</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca373315ec062631059-15"><span class="crayon-h"> </span><span class="crayon-p"># remove hanging 's' and 'a'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ec062631059-16"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-t">word</span><span class="crayon-sy">)</span><span class="crayon-o">&gt;</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca373315ec062631059-17"><span class="crayon-h"> </span><span class="crayon-p"># remove tokens with numbers in them</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ec062631059-18"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-sy">.</span><span class="crayon-e">isalpha</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca373315ec062631059-19"><span class="crayon-h"> </span><span class="crayon-p"># store as string</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ec062631059-20"><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h">  </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315ec062631059-21"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ec062631059-22"><span class="crayon-p"># clean descriptions</span></div><div class="crayon-line" id="crayon-5c0ca373315ec062631059-23"><span class="crayon-e">clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0013 seconds] -->
<p>Once cleaned, we can summarize the size of the vocabulary.</p>
<p>Ideally, we want a vocabulary that is both expressive and as small as possible. A smaller vocabulary will result in a smaller model that will train faster.</p>
<p>For reference, we can transform the clean descriptions into a set and print its size to get an idea of the size of our dataset vocabulary.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca373315ee993252404" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# convert the loaded descriptions into a vocabulary of words
def to_vocabulary(descriptions):
	# build a list of all description strings
	all_desc = set()
	for key in descriptions.keys():
		[all_desc.update(d.split()) for d in descriptions[key]]
	return all_desc

# summarize vocabulary
vocabulary = to_vocabulary(descriptions)
print('Vocabulary Size: %d' % len(vocabulary))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca373315ee993252404-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ee993252404-2">2</div><div class="crayon-num" data-line="crayon-5c0ca373315ee993252404-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ee993252404-4">4</div><div class="crayon-num" data-line="crayon-5c0ca373315ee993252404-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ee993252404-6">6</div><div class="crayon-num" data-line="crayon-5c0ca373315ee993252404-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ee993252404-8">8</div><div class="crayon-num" data-line="crayon-5c0ca373315ee993252404-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ee993252404-10">10</div><div class="crayon-num" data-line="crayon-5c0ca373315ee993252404-11">11</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca373315ee993252404-1"><span class="crayon-p"># convert the loaded descriptions into a vocabulary of words</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ee993252404-2"><span class="crayon-e">def </span><span class="crayon-e">to_vocabulary</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315ee993252404-3"><span class="crayon-h"> </span><span class="crayon-p"># build a list of all description strings</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ee993252404-4"><span class="crayon-h"> </span><span class="crayon-v">all_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315ee993252404-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">key </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">keys</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ee993252404-6"><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">all_desc</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca373315ee993252404-7"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">all_desc</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ee993252404-8"> </div><div class="crayon-line" id="crayon-5c0ca373315ee993252404-9"><span class="crayon-p"># summarize vocabulary</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ee993252404-10"><span class="crayon-v">vocabulary</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_vocabulary</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315ee993252404-11"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">vocabulary</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0006 seconds] -->
<p>Finally, we can save the dictionary of image identifiers and descriptions to a new file named <em>descriptions.txt</em>, with one image identifier and description per line.</p>
<p>Below defines the <em>save_descriptions()</em> function that, given a dictionary containing the mapping of identifiers to descriptions and a filename, saves the mapping to file.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca373315f0096842014" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# save descriptions to file, one per line
def save_descriptions(descriptions, filename):
	lines = list()
	for key, desc_list in descriptions.items():
		for desc in desc_list:
			lines.append(key + ' ' + desc)
	data = '\n'.join(lines)
	file = open(filename, 'w')
	file.write(data)
	file.close()

# save descriptions
save_descriptions(descriptions, 'descriptions.txt')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca373315f0096842014-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f0096842014-2">2</div><div class="crayon-num" data-line="crayon-5c0ca373315f0096842014-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f0096842014-4">4</div><div class="crayon-num" data-line="crayon-5c0ca373315f0096842014-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f0096842014-6">6</div><div class="crayon-num" data-line="crayon-5c0ca373315f0096842014-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f0096842014-8">8</div><div class="crayon-num" data-line="crayon-5c0ca373315f0096842014-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f0096842014-10">10</div><div class="crayon-num" data-line="crayon-5c0ca373315f0096842014-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f0096842014-12">12</div><div class="crayon-num" data-line="crayon-5c0ca373315f0096842014-13">13</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca373315f0096842014-1"><span class="crayon-p"># save descriptions to file, one per line</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f0096842014-2"><span class="crayon-e">def </span><span class="crayon-e">save_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315f0096842014-3"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f0096842014-4"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc_list </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315f0096842014-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f0096842014-6"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">key</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f0096842014-7"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'\n'</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f0096842014-8"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'w'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f0096842014-9"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">write</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f0096842014-10"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f0096842014-11"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f0096842014-12"><span class="crayon-p"># save descriptions</span></div><div class="crayon-line" id="crayon-5c0ca373315f0096842014-13"><span class="crayon-e">save_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0007 seconds] -->
<p>Putting this all together, the complete listing is provided below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca373315f2330242454" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
import string

# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# extract descriptions for images
def load_descriptions(doc):
	mapping = dict()
	# process lines
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		if len(line) &lt; 2:
			continue
		# take the first token as the image id, the rest as the description
		image_id, image_desc = tokens[0], tokens[1:]
		# remove filename from image id
		image_id = image_id.split('.')[0]
		# convert description tokens back to string
		image_desc = ' '.join(image_desc)
		# create the list if needed
		if image_id not in mapping:
			mapping[image_id] = list()
		# store description
		mapping[image_id].append(image_desc)
	return mapping

def clean_descriptions(descriptions):
	# prepare translation table for removing punctuation
	table = str.maketrans('', '', string.punctuation)
	for key, desc_list in descriptions.items():
		for i in range(len(desc_list)):
			desc = desc_list[i]
			# tokenize
			desc = desc.split()
			# convert to lower case
			desc = [word.lower() for word in desc]
			# remove punctuation from each token
			desc = [w.translate(table) for w in desc]
			# remove hanging 's' and 'a'
			desc = [word for word in desc if len(word)&gt;1]
			# remove tokens with numbers in them
			desc = [word for word in desc if word.isalpha()]
			# store as string
			desc_list[i] =  ' '.join(desc)

# convert the loaded descriptions into a vocabulary of words
def to_vocabulary(descriptions):
	# build a list of all description strings
	all_desc = set()
	for key in descriptions.keys():
		[all_desc.update(d.split()) for d in descriptions[key]]
	return all_desc

# save descriptions to file, one per line
def save_descriptions(descriptions, filename):
	lines = list()
	for key, desc_list in descriptions.items():
		for desc in desc_list:
			lines.append(key + ' ' + desc)
	data = '\n'.join(lines)
	file = open(filename, 'w')
	file.write(data)
	file.close()

filename = 'Flickr8k_text/Flickr8k.token.txt'
# load descriptions
doc = load_doc(filename)
# parse descriptions
descriptions = load_descriptions(doc)
print('Loaded: %d ' % len(descriptions))
# clean descriptions
clean_descriptions(descriptions)
# summarize vocabulary
vocabulary = to_vocabulary(descriptions)
print('Vocabulary Size: %d' % len(vocabulary))
# save to file
save_descriptions(descriptions, 'descriptions.txt')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-2">2</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-4">4</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-6">6</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-8">8</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-10">10</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-12">12</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-14">14</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-16">16</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-18">18</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-20">20</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-22">22</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-24">24</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-26">26</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-28">28</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-30">30</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-32">32</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-34">34</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-36">36</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-38">38</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-40">40</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-42">42</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-44">44</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-46">46</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-48">48</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-50">50</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-52">52</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-54">54</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-56">56</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-58">58</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-60">60</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-62">62</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-64">64</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-66">66</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-68">68</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-70">70</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-72">72</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-74">74</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-76">76</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-78">78</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-80">80</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-82">82</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f2330242454-84">84</div><div class="crayon-num" data-line="crayon-5c0ca373315f2330242454-85">85</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca373315f2330242454-1"><span class="crayon-e">import </span><span class="crayon-t">string</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-2"> </div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-3"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-4"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-5"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-6"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-7"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-8"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-9"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-10"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-11"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-12"> </div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-13"><span class="crayon-p"># extract descriptions for images</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-14"><span class="crayon-e">def </span><span class="crayon-e">load_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">doc</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-15"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-16"><span class="crayon-h"> </span><span class="crayon-p"># process lines</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-17"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-18"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-19"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-20"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-21"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-22"><span class="crayon-h"> </span><span class="crayon-p"># take the first token as the image id, the rest as the description</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-23"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-24"><span class="crayon-h"> </span><span class="crayon-p"># remove filename from image id</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-25"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-26"><span class="crayon-h"> </span><span class="crayon-p"># convert description tokens back to string</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-27"><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-28"><span class="crayon-h"> </span><span class="crayon-p"># create the list if needed</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-29"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-30"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-31"><span class="crayon-h"> </span><span class="crayon-p"># store description</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-32"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-33"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">mapping</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-34"> </div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-35"><span class="crayon-e">def </span><span class="crayon-e">clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-36"><span class="crayon-h"> </span><span class="crayon-p"># prepare translation table for removing punctuation</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-37"><span class="crayon-h"> </span><span class="crayon-v">table</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">str</span><span class="crayon-sy">.</span><span class="crayon-e">maketrans</span><span class="crayon-sy">(</span><span class="crayon-s">''</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">''</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-sy">.</span><span class="crayon-v">punctuation</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-38"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc_list </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-39"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">desc_list</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-40"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-41"><span class="crayon-h"> </span><span class="crayon-p"># tokenize</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-42"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-43"><span class="crayon-h"> </span><span class="crayon-p"># convert to lower case</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-44"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-sy">.</span><span class="crayon-e">lower</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-45"><span class="crayon-h"> </span><span class="crayon-p"># remove punctuation from each token</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-46"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">w</span><span class="crayon-sy">.</span><span class="crayon-e">translate</span><span class="crayon-sy">(</span><span class="crayon-v">table</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-47"><span class="crayon-h"> </span><span class="crayon-p"># remove hanging 's' and 'a'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-48"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-t">word</span><span class="crayon-sy">)</span><span class="crayon-o">&gt;</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-49"><span class="crayon-h"> </span><span class="crayon-p"># remove tokens with numbers in them</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-50"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-sy">.</span><span class="crayon-e">isalpha</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-51"><span class="crayon-h"> </span><span class="crayon-p"># store as string</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-52"><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h">  </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-53"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-54"><span class="crayon-p"># convert the loaded descriptions into a vocabulary of words</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-55"><span class="crayon-e">def </span><span class="crayon-e">to_vocabulary</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-56"><span class="crayon-h"> </span><span class="crayon-p"># build a list of all description strings</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-57"><span class="crayon-h"> </span><span class="crayon-v">all_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-58"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">key </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">keys</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-59"><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">all_desc</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-60"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">all_desc</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-61"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-62"><span class="crayon-p"># save descriptions to file, one per line</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-63"><span class="crayon-e">def </span><span class="crayon-e">save_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-64"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-65"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc_list </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-66"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-67"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">key</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-68"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'\n'</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-69"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'w'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-70"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">write</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-71"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-72"> </div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-73"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr8k.token.txt'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-74"><span class="crayon-p"># load descriptions</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-75"><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-76"><span class="crayon-p"># parse descriptions</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-77"><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">doc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-78"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Loaded: %d '</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-79"><span class="crayon-p"># clean descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-80"><span class="crayon-e">clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-81"><span class="crayon-p"># summarize vocabulary</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-82"><span class="crayon-v">vocabulary</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_vocabulary</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-83"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">vocabulary</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f2330242454-84"><span class="crayon-p"># save to file</span></div><div class="crayon-line" id="crayon-5c0ca373315f2330242454-85"><span class="crayon-e">save_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0038 seconds] -->
<p>Running the example first prints the number of loaded photo descriptions (8,092) and the size of the clean vocabulary (8,763 words).</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca373315f4713739134" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Loaded: 8,092
Vocabulary Size: 8,763</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca373315f4713739134-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f4713739134-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca373315f4713739134-1">Loaded: 8,092</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f4713739134-2">Vocabulary Size: 8,763</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>Finally, the clean descriptions are written to ‘<em>descriptions.txt</em>‘.</p>
<p>Taking a look at the file, we can see that the descriptions are ready for modeling. The order of descriptions in your file may vary.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca373315f6538792480" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
2252123185_487f21e336 bunch on people are seated in stadium
2252123185_487f21e336 crowded stadium is full of people watching an event
2252123185_487f21e336 crowd of people fill up packed stadium
2252123185_487f21e336 crowd sitting in an indoor stadium
2252123185_487f21e336 stadium full of people watch game
...</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca373315f6538792480-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f6538792480-2">2</div><div class="crayon-num" data-line="crayon-5c0ca373315f6538792480-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f6538792480-4">4</div><div class="crayon-num" data-line="crayon-5c0ca373315f6538792480-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f6538792480-6">6</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca373315f6538792480-1">2252123185_487f21e336 bunch on people are seated in stadium</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f6538792480-2">2252123185_487f21e336 crowded stadium is full of people watching an event</div><div class="crayon-line" id="crayon-5c0ca373315f6538792480-3">2252123185_487f21e336 crowd of people fill up packed stadium</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f6538792480-4">2252123185_487f21e336 crowd sitting in an indoor stadium</div><div class="crayon-line" id="crayon-5c0ca373315f6538792480-5">2252123185_487f21e336 stadium full of people watch game</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f6538792480-6">...</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p></p>
<h2>Develop Deep Learning Model</h2>
<p>In this section, we will define the deep learning model and fit it on the training dataset.</p>
<p>This section is divided into the following parts:</p>
<ol>
<li>Loading Data.</li>
<li>Defining the Model.</li>
<li>Fitting the Model.</li>
<li>Complete Example.</li>
</ol>
<h3>Loading Data</h3>
<p>First, we must load the prepared photo and text data so that we can use it to fit the model.</p>
<p>We are going to train the data on all of the photos and captions in the training dataset. While training, we are going to monitor the performance of the model on the development dataset and use that performance to decide when to save models to file.</p>
<p>The train and development dataset have been predefined in the <em>Flickr_8k.trainImages.txt</em> and <em>Flickr_8k.devImages.txt</em> files respectively, that both contain lists of photo file names. From these file names, we can extract the photo identifiers and use these identifiers to filter photos and descriptions for each set.</p>
<p>The function <em>load_set()</em> below will load a pre-defined set of identifiers given the train or development sets filename.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca373315f8533660865" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# load a pre-defined list of photo identifiers
def load_set(filename):
	doc = load_doc(filename)
	dataset = list()
	# process line by line
	for line in doc.split('\n'):
		# skip empty lines
		if len(line) &lt; 1:
			continue
		# get the image identifier
		identifier = line.split('.')[0]
		dataset.append(identifier)
	return set(dataset)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca373315f8533660865-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f8533660865-2">2</div><div class="crayon-num" data-line="crayon-5c0ca373315f8533660865-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f8533660865-4">4</div><div class="crayon-num" data-line="crayon-5c0ca373315f8533660865-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f8533660865-6">6</div><div class="crayon-num" data-line="crayon-5c0ca373315f8533660865-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f8533660865-8">8</div><div class="crayon-num" data-line="crayon-5c0ca373315f8533660865-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f8533660865-10">10</div><div class="crayon-num" data-line="crayon-5c0ca373315f8533660865-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f8533660865-12">12</div><div class="crayon-num" data-line="crayon-5c0ca373315f8533660865-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f8533660865-14">14</div><div class="crayon-num" data-line="crayon-5c0ca373315f8533660865-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f8533660865-16">16</div><div class="crayon-num" data-line="crayon-5c0ca373315f8533660865-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f8533660865-18">18</div><div class="crayon-num" data-line="crayon-5c0ca373315f8533660865-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f8533660865-20">20</div><div class="crayon-num" data-line="crayon-5c0ca373315f8533660865-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315f8533660865-22">22</div><div class="crayon-num" data-line="crayon-5c0ca373315f8533660865-23">23</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca373315f8533660865-1"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f8533660865-2"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315f8533660865-3"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f8533660865-4"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f8533660865-5"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f8533660865-6"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f8533660865-7"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f8533660865-8"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f8533660865-9"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f8533660865-10"> </div><div class="crayon-line" id="crayon-5c0ca373315f8533660865-11"><span class="crayon-p"># load a pre-defined list of photo identifiers</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f8533660865-12"><span class="crayon-e">def </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315f8533660865-13"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f8533660865-14"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f8533660865-15"><span class="crayon-h"> </span><span class="crayon-p"># process line by line</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f8533660865-16"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315f8533660865-17"><span class="crayon-h"> </span><span class="crayon-p"># skip empty lines</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f8533660865-18"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315f8533660865-19"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f8533660865-20"><span class="crayon-h"> </span><span class="crayon-p"># get the image identifier</span></div><div class="crayon-line" id="crayon-5c0ca373315f8533660865-21"><span class="crayon-h"> </span><span class="crayon-v">identifier</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315f8533660865-22"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">identifier</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315f8533660865-23"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0008 seconds] -->
<p>Now, we can load the photos and descriptions using the pre-defined set of train or development identifiers.</p>
<p>Below is the function <em>load_clean_descriptions()</em> that loads the cleaned text descriptions from ‘<em>descriptions.txt</em>‘ for a given set of identifiers and returns a dictionary of identifiers to lists of text descriptions.</p>
<p>The model we will develop will generate a caption given a photo, and the caption will be generated one word at a time. The sequence of previously generated words will be provided as input. Therefore, we will need a ‘<em>first word</em>’ to kick-off the generation process and a ‘<em>last word</em>‘ to signal the end of the caption.</p>
<p>We will use the strings ‘<em>startseq</em>‘ and ‘<em>endseq</em>‘ for this purpose. These tokens are added to the loaded descriptions as they are loaded. It is important to do this now before we encode the text so that the tokens are also encoded correctly.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca373315fb923031610" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load clean descriptions into memory
def load_clean_descriptions(filename, dataset):
	# load document
	doc = load_doc(filename)
	descriptions = dict()
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		# split id from description
		image_id, image_desc = tokens[0], tokens[1:]
		# skip images not in the set
		if image_id in dataset:
			# create list
			if image_id not in descriptions:
				descriptions[image_id] = list()
			# wrap description in tokens
			desc = 'startseq ' + ' '.join(image_desc) + ' endseq'
			# store
			descriptions[image_id].append(desc)
	return descriptions</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca373315fb923031610-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315fb923031610-2">2</div><div class="crayon-num" data-line="crayon-5c0ca373315fb923031610-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315fb923031610-4">4</div><div class="crayon-num" data-line="crayon-5c0ca373315fb923031610-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315fb923031610-6">6</div><div class="crayon-num" data-line="crayon-5c0ca373315fb923031610-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315fb923031610-8">8</div><div class="crayon-num" data-line="crayon-5c0ca373315fb923031610-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315fb923031610-10">10</div><div class="crayon-num" data-line="crayon-5c0ca373315fb923031610-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315fb923031610-12">12</div><div class="crayon-num" data-line="crayon-5c0ca373315fb923031610-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315fb923031610-14">14</div><div class="crayon-num" data-line="crayon-5c0ca373315fb923031610-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315fb923031610-16">16</div><div class="crayon-num" data-line="crayon-5c0ca373315fb923031610-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315fb923031610-18">18</div><div class="crayon-num" data-line="crayon-5c0ca373315fb923031610-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315fb923031610-20">20</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca373315fb923031610-1"><span class="crayon-p"># load clean descriptions into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315fb923031610-2"><span class="crayon-e">def </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315fb923031610-3"><span class="crayon-h"> </span><span class="crayon-p"># load document</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315fb923031610-4"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315fb923031610-5"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315fb923031610-6"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315fb923031610-7"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315fb923031610-8"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315fb923031610-9"><span class="crayon-h"> </span><span class="crayon-p"># split id from description</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315fb923031610-10"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca373315fb923031610-11"><span class="crayon-h"> </span><span class="crayon-p"># skip images not in the set</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315fb923031610-12"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315fb923031610-13"><span class="crayon-h"> </span><span class="crayon-p"># create list</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315fb923031610-14"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315fb923031610-15"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315fb923031610-16"><span class="crayon-h"> </span><span class="crayon-p"># wrap description in tokens</span></div><div class="crayon-line" id="crayon-5c0ca373315fb923031610-17"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' endseq'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315fb923031610-18"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line" id="crayon-5c0ca373315fb923031610-19"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315fb923031610-20"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0010 seconds] -->
<p>Next, we can load the photo features for a given dataset.</p>
<p>Below defines a function named <em>load_photo_features()</em> that loads the entire set of photo descriptions, then returns the subset of interest for a given set of photo identifiers.</p>
<p>This is not very efficient; nevertheless, this will get us up and running quickly.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca373315fd676924133" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load photo features
def load_photo_features(filename, dataset):
	# load all features
	all_features = load(open(filename, 'rb'))
	# filter features
	features = {k: all_features[k] for k in dataset}
	return features</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca373315fd676924133-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315fd676924133-2">2</div><div class="crayon-num" data-line="crayon-5c0ca373315fd676924133-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315fd676924133-4">4</div><div class="crayon-num" data-line="crayon-5c0ca373315fd676924133-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315fd676924133-6">6</div><div class="crayon-num" data-line="crayon-5c0ca373315fd676924133-7">7</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca373315fd676924133-1"><span class="crayon-p"># load photo features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315fd676924133-2"><span class="crayon-e">def </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315fd676924133-3"><span class="crayon-h"> </span><span class="crayon-p"># load all features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315fd676924133-4"><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load</span><span class="crayon-sy">(</span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'rb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315fd676924133-5"><span class="crayon-h"> </span><span class="crayon-p"># filter features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315fd676924133-6"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">k</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">k</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5c0ca373315fd676924133-7"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0004 seconds] -->
<p>We can pause here and test everything developed so far.</p>
<p>The complete code example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca373315ff920326269" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from pickle import load

# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# load a pre-defined list of photo identifiers
def load_set(filename):
	doc = load_doc(filename)
	dataset = list()
	# process line by line
	for line in doc.split('\n'):
		# skip empty lines
		if len(line) &lt; 1:
			continue
		# get the image identifier
		identifier = line.split('.')[0]
		dataset.append(identifier)
	return set(dataset)

# load clean descriptions into memory
def load_clean_descriptions(filename, dataset):
	# load document
	doc = load_doc(filename)
	descriptions = dict()
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		# split id from description
		image_id, image_desc = tokens[0], tokens[1:]
		# skip images not in the set
		if image_id in dataset:
			# create list
			if image_id not in descriptions:
				descriptions[image_id] = list()
			# wrap description in tokens
			desc = 'startseq ' + ' '.join(image_desc) + ' endseq'
			# store
			descriptions[image_id].append(desc)
	return descriptions

# load photo features
def load_photo_features(filename, dataset):
	# load all features
	all_features = load(open(filename, 'rb'))
	# filter features
	features = {k: all_features[k] for k in dataset}
	return features

# load training dataset (6K)
filename = 'Flickr8k_text/Flickr_8k.trainImages.txt'
train = load_set(filename)
print('Dataset: %d' % len(train))
# descriptions
train_descriptions = load_clean_descriptions('descriptions.txt', train)
print('Descriptions: train=%d' % len(train_descriptions))
# photo features
train_features = load_photo_features('features.pkl', train)
print('Photos: train=%d' % len(train_features))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-2">2</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-4">4</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-6">6</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-8">8</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-10">10</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-12">12</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-14">14</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-16">16</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-18">18</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-20">20</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-22">22</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-24">24</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-26">26</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-28">28</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-30">30</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-32">32</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-34">34</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-36">36</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-38">38</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-40">40</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-42">42</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-44">44</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-46">46</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-48">48</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-50">50</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-52">52</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-54">54</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-56">56</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-58">58</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-60">60</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-62">62</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373315ff920326269-64">64</div><div class="crayon-num" data-line="crayon-5c0ca373315ff920326269-65">65</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca373315ff920326269-1"><span class="crayon-e">from </span><span class="crayon-e">pickle </span><span class="crayon-e">import </span><span class="crayon-v">load</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-2"> </div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-3"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-4"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-5"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-6"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-7"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-8"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-9"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-10"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-11"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-12"> </div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-13"><span class="crayon-p"># load a pre-defined list of photo identifiers</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-14"><span class="crayon-e">def </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-15"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-16"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-17"><span class="crayon-h"> </span><span class="crayon-p"># process line by line</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-18"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-19"><span class="crayon-h"> </span><span class="crayon-p"># skip empty lines</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-20"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-21"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-22"><span class="crayon-h"> </span><span class="crayon-p"># get the image identifier</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-23"><span class="crayon-h"> </span><span class="crayon-v">identifier</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-24"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">identifier</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-25"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-26"> </div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-27"><span class="crayon-p"># load clean descriptions into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-28"><span class="crayon-e">def </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-29"><span class="crayon-h"> </span><span class="crayon-p"># load document</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-30"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-31"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-32"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-33"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-34"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-35"><span class="crayon-h"> </span><span class="crayon-p"># split id from description</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-36"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-37"><span class="crayon-h"> </span><span class="crayon-p"># skip images not in the set</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-38"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-39"><span class="crayon-h"> </span><span class="crayon-p"># create list</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-40"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-41"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-42"><span class="crayon-h"> </span><span class="crayon-p"># wrap description in tokens</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-43"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' endseq'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-44"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-45"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-46"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-47"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-48"><span class="crayon-p"># load photo features</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-49"><span class="crayon-e">def </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-50"><span class="crayon-h"> </span><span class="crayon-p"># load all features</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-51"><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load</span><span class="crayon-sy">(</span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'rb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-52"><span class="crayon-h"> </span><span class="crayon-p"># filter features</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-53"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">k</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">k</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-54"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-55"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-56"><span class="crayon-p"># load training dataset (6K)</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-57"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr_8k.trainImages.txt'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-58"><span class="crayon-v">train</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-59"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Dataset: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-60"><span class="crayon-p"># descriptions</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-61"><span class="crayon-v">train_descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-62"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Descriptions: train=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-63"><span class="crayon-p"># photo features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373315ff920326269-64"><span class="crayon-v">train_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-s">'features.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373315ff920326269-65"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Photos: train=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0025 seconds] -->
<p>Running this example first loads the 6,000 photo identifiers in the test dataset. These features are then used to filter and load the cleaned description text and the pre-computed photo features.</p>
<p>We are nearly there.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca37331601259677641" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Dataset: 6,000
Descriptions: train=6,000
Photos: train=6,000</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca37331601259677641-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331601259677641-2">2</div><div class="crayon-num" data-line="crayon-5c0ca37331601259677641-3">3</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca37331601259677641-1">Dataset: 6,000</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331601259677641-2">Descriptions: train=6,000</div><div class="crayon-line" id="crayon-5c0ca37331601259677641-3">Photos: train=6,000</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>The description text will need to be encoded to numbers before it can be presented to the model as in input or compared to the model’s predictions.</p>
<p>The first step in encoding the data is to create a consistent mapping from words to unique integer values. Keras provides the <em>Tokenizer</em> class that can learn this mapping from the loaded description data.</p>
<p>Below defines the <em>to_lines()</em> to convert the dictionary of descriptions into a list of strings and the <em>create_tokenizer()</em> function that will fit a Tokenizer given the loaded photo description text.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca37331603514915769" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# convert a dictionary of clean descriptions to a list of descriptions
def to_lines(descriptions):
	all_desc = list()
	for key in descriptions.keys():
		[all_desc.append(d) for d in descriptions[key]]
	return all_desc

# fit a tokenizer given caption descriptions
def create_tokenizer(descriptions):
	lines = to_lines(descriptions)
	tokenizer = Tokenizer()
	tokenizer.fit_on_texts(lines)
	return tokenizer

# prepare tokenizer
tokenizer = create_tokenizer(train_descriptions)
vocab_size = len(tokenizer.word_index) + 1
print('Vocabulary Size: %d' % vocab_size)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca37331603514915769-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331603514915769-2">2</div><div class="crayon-num" data-line="crayon-5c0ca37331603514915769-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331603514915769-4">4</div><div class="crayon-num" data-line="crayon-5c0ca37331603514915769-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331603514915769-6">6</div><div class="crayon-num" data-line="crayon-5c0ca37331603514915769-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331603514915769-8">8</div><div class="crayon-num" data-line="crayon-5c0ca37331603514915769-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331603514915769-10">10</div><div class="crayon-num" data-line="crayon-5c0ca37331603514915769-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331603514915769-12">12</div><div class="crayon-num" data-line="crayon-5c0ca37331603514915769-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331603514915769-14">14</div><div class="crayon-num" data-line="crayon-5c0ca37331603514915769-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331603514915769-16">16</div><div class="crayon-num" data-line="crayon-5c0ca37331603514915769-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331603514915769-18">18</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca37331603514915769-1"><span class="crayon-p"># convert a dictionary of clean descriptions to a list of descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331603514915769-2"><span class="crayon-e">def </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331603514915769-3"><span class="crayon-h"> </span><span class="crayon-v">all_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331603514915769-4"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">key </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">keys</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331603514915769-5"><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">all_desc</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331603514915769-6"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">all_desc</span></div><div class="crayon-line" id="crayon-5c0ca37331603514915769-7"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331603514915769-8"><span class="crayon-p"># fit a tokenizer given caption descriptions</span></div><div class="crayon-line" id="crayon-5c0ca37331603514915769-9"><span class="crayon-e">def </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331603514915769-10"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331603514915769-11"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Tokenizer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331603514915769-12"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">fit_on_texts</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331603514915769-13"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331603514915769-14"> </div><div class="crayon-line" id="crayon-5c0ca37331603514915769-15"><span class="crayon-p"># prepare tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331603514915769-16"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331603514915769-17"><span class="crayon-v">vocab_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331603514915769-18"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0008 seconds] -->
<p>We can now encode the text.</p>
<p>Each description will be split into words. The model will be provided one word and the photo and generate the next word. Then the first two words of the description will be provided to the model as input with the image to generate the next word. This is how the model will be trained.</p>
<p>For example, the input sequence “<em>little girl running in field</em>” would be split into 6 input-output pairs to train the model:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca37331605189551793" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
X1,		X2 (text sequence), 						y (word)
photo	startseq, 									little
photo	startseq, little,							girl
photo	startseq, little, girl, 					running
photo	startseq, little, girl, running, 			in
photo	startseq, little, girl, running, in, 		field
photo	startseq, little, girl, running, in, field, endseq</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca37331605189551793-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331605189551793-2">2</div><div class="crayon-num" data-line="crayon-5c0ca37331605189551793-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331605189551793-4">4</div><div class="crayon-num" data-line="crayon-5c0ca37331605189551793-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331605189551793-6">6</div><div class="crayon-num" data-line="crayon-5c0ca37331605189551793-7">7</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca37331605189551793-1">X1,		X2 (text sequence), 						y (word)</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331605189551793-2">photo	startseq, 									little</div><div class="crayon-line" id="crayon-5c0ca37331605189551793-3">photo	startseq, little,							girl</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331605189551793-4">photo	startseq, little, girl, 					running</div><div class="crayon-line" id="crayon-5c0ca37331605189551793-5">photo	startseq, little, girl, running, 			in</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331605189551793-6">photo	startseq, little, girl, running, in, 		field</div><div class="crayon-line" id="crayon-5c0ca37331605189551793-7">photo	startseq, little, girl, running, in, field, endseq</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>Later, when the model is used to generate descriptions, the generated words will be concatenated and recursively provided as input to generate a caption for an image.</p>
<p>The function below named <em>create_sequences()</em>, given the tokenizer, a maximum sequence length, and the dictionary of all descriptions and photos, will transform the data into input-output pairs of data for training the model. There are two input arrays to the model: one for photo features and one for the encoded text. There is one output for the model which is the encoded next word in the text sequence.</p>
<p>The input text is encoded as integers, which will be fed to a word embedding layer. The photo features will be fed directly to another part of the model. The model will output a prediction, which will be a probability distribution over all words in the vocabulary.</p>
<p>The output data will therefore be a one-hot encoded version of each word, representing an idealized probability distribution with 0 values at all word positions except the actual word position, which has a value of 1.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca37331607822548513" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# create sequences of images, input sequences and output words for an image
def create_sequences(tokenizer, max_length, descriptions, photos):
	X1, X2, y = list(), list(), list()
	# walk through each image identifier
	for key, desc_list in descriptions.items():
		# walk through each description for the image
		for desc in desc_list:
			# encode the sequence
			seq = tokenizer.texts_to_sequences([desc])[0]
			# split one sequence into multiple X,y pairs
			for i in range(1, len(seq)):
				# split into input and output pair
				in_seq, out_seq = seq[:i], seq[i]
				# pad input sequence
				in_seq = pad_sequences([in_seq], maxlen=max_length)[0]
				# encode output sequence
				out_seq = to_categorical([out_seq], num_classes=vocab_size)[0]
				# store
				X1.append(photos[key][0])
				X2.append(in_seq)
				y.append(out_seq)
	return array(X1), array(X2), array(y)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca37331607822548513-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331607822548513-2">2</div><div class="crayon-num" data-line="crayon-5c0ca37331607822548513-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331607822548513-4">4</div><div class="crayon-num" data-line="crayon-5c0ca37331607822548513-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331607822548513-6">6</div><div class="crayon-num" data-line="crayon-5c0ca37331607822548513-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331607822548513-8">8</div><div class="crayon-num" data-line="crayon-5c0ca37331607822548513-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331607822548513-10">10</div><div class="crayon-num" data-line="crayon-5c0ca37331607822548513-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331607822548513-12">12</div><div class="crayon-num" data-line="crayon-5c0ca37331607822548513-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331607822548513-14">14</div><div class="crayon-num" data-line="crayon-5c0ca37331607822548513-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331607822548513-16">16</div><div class="crayon-num" data-line="crayon-5c0ca37331607822548513-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331607822548513-18">18</div><div class="crayon-num" data-line="crayon-5c0ca37331607822548513-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331607822548513-20">20</div><div class="crayon-num" data-line="crayon-5c0ca37331607822548513-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331607822548513-22">22</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca37331607822548513-1"><span class="crayon-p"># create sequences of images, input sequences and output words for an image</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331607822548513-2"><span class="crayon-e">def </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331607822548513-3"><span class="crayon-h"> </span><span class="crayon-v">X1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331607822548513-4"><span class="crayon-h"> </span><span class="crayon-p"># walk through each image identifier</span></div><div class="crayon-line" id="crayon-5c0ca37331607822548513-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc_list </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331607822548513-6"><span class="crayon-h"> </span><span class="crayon-p"># walk through each description for the image</span></div><div class="crayon-line" id="crayon-5c0ca37331607822548513-7"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331607822548513-8"><span class="crayon-h"> </span><span class="crayon-p"># encode the sequence</span></div><div class="crayon-line" id="crayon-5c0ca37331607822548513-9"><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">desc</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331607822548513-10"><span class="crayon-h"> </span><span class="crayon-p"># split one sequence into multiple X,y pairs</span></div><div class="crayon-line" id="crayon-5c0ca37331607822548513-11"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">seq</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331607822548513-12"><span class="crayon-h"> </span><span class="crayon-p"># split into input and output pair</span></div><div class="crayon-line" id="crayon-5c0ca37331607822548513-13"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331607822548513-14"><span class="crayon-h"> </span><span class="crayon-p"># pad input sequence</span></div><div class="crayon-line" id="crayon-5c0ca37331607822548513-15"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331607822548513-16"><span class="crayon-h"> </span><span class="crayon-p"># encode output sequence</span></div><div class="crayon-line" id="crayon-5c0ca37331607822548513-17"><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">out_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331607822548513-18"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line" id="crayon-5c0ca37331607822548513-19"><span class="crayon-h"> </span><span class="crayon-v">X1</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">photos</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331607822548513-20"><span class="crayon-h"> </span><span class="crayon-v">X2</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">in_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331607822548513-21"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">out_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331607822548513-22"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X1</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X2</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0014 seconds] -->
<p>We will need to calculate the maximum number of words in the longest description. A short helper function named <em>max_length()</em> is defined below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca37331609027493808" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# calculate the length of the description with the most words
def max_length(descriptions):
	lines = to_lines(descriptions)
	return max(len(d.split()) for d in lines)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca37331609027493808-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331609027493808-2">2</div><div class="crayon-num" data-line="crayon-5c0ca37331609027493808-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331609027493808-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca37331609027493808-1"><span class="crayon-p"># calculate the length of the description with the most words</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331609027493808-2"><span class="crayon-e">def </span><span class="crayon-e">max_length</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331609027493808-3"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331609027493808-4"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">max</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>We now have enough to load the data for the training and development datasets and transform the loaded data into input-output pairs for fitting a deep learning model.</p>
<h3>Defining the Model</h3>
<p>We will define a deep learning based on the “<em>merge-model</em>” described by Marc Tanti, et al. in their 2017 papers:</p>
<ul>
<li><a href="https://arxiv.org/abs/1703.09137">Where to put the Image in an Image Caption Generator</a>, 2017.</li>
<li><a href="https://arxiv.org/abs/1708.02043">What is the Role of Recurrent Neural Networks (RNNs) in an Image Caption Generator?</a>, 2017.</li>
</ul>
<p>The authors provide a nice schematic of the model, reproduced below.</p>
<div class="wp-caption aligncenter" id="attachment_4460" style="width: 1134px"><img alt="Schematic of the Merge Model For Image Captioning" class="size-full wp-image-4460" height="300" sizes="(max-width: 1124px) 100vw, 1124px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Schematic-of-the-Merge-Model-For-Image-Captioning.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Schematic-of-the-Merge-Model-For-Image-Captioning.png 1124w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Schematic-of-the-Merge-Model-For-Image-Captioning-300x80.png 300w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Schematic-of-the-Merge-Model-For-Image-Captioning-768x205.png 768w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Schematic-of-the-Merge-Model-For-Image-Captioning-1024x273.png 1024w" width="1124"/><p class="wp-caption-text">Schematic of the Merge Model For Image Captioning</p></div>
<p>We will describe the model in three parts:</p>
<ul>
<li><strong>Photo Feature Extractor</strong>. This is a 16-layer VGG model pre-trained on the ImageNet dataset. We have pre-processed the photos with the VGG model (without the output layer) and will use the extracted features predicted by this model as input.</li>
<li><strong>Sequence Processor</strong>. This is a word embedding layer for handling the text input, followed by a Long Short-Term Memory (LSTM) recurrent neural network layer.</li>
<li><strong>Decoder</strong> (for lack of a better name). Both the feature extractor and sequence processor output a fixed-length vector. These are merged together and processed by a Dense layer to make a final prediction.</li>
</ul>
<p>The Photo Feature Extractor model expects input photo features to be a vector of 4,096 elements. These are processed by a Dense layer to produce a 256 element representation of the photo.</p>
<p>The Sequence Processor model expects input sequences with a pre-defined length (34 words) which are fed into an Embedding layer that uses a mask to ignore padded values. This is followed by an LSTM layer with 256 memory units.</p>
<p>Both the input models produce a 256 element vector. Further, both input models use regularization in the form of 50% dropout. This is to reduce overfitting the training dataset, as this model configuration learns very fast.</p>
<p>The Decoder model merges the vectors from both input models using an addition operation. This is then fed to a Dense 256 neuron layer and then to a final output Dense layer that makes a softmax prediction over the entire output vocabulary for the next word in the sequence.</p>
<p>The function below named <em>define_model()</em> defines and returns the model ready to be fit.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca3733160b336554550" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define the captioning model
def define_model(vocab_size, max_length):
	# feature extractor model
	inputs1 = Input(shape=(4096,))
	fe1 = Dropout(0.5)(inputs1)
	fe2 = Dense(256, activation='relu')(fe1)
	# sequence model
	inputs2 = Input(shape=(max_length,))
	se1 = Embedding(vocab_size, 256, mask_zero=True)(inputs2)
	se2 = Dropout(0.5)(se1)
	se3 = LSTM(256)(se2)
	# decoder model
	decoder1 = add([fe2, se3])
	decoder2 = Dense(256, activation='relu')(decoder1)
	outputs = Dense(vocab_size, activation='softmax')(decoder2)
	# tie it together [image, seq] [word]
	model = Model(inputs=[inputs1, inputs2], outputs=outputs)
	model.compile(loss='categorical_crossentropy', optimizer='adam')
	# summarize model
	print(model.summary())
	plot_model(model, to_file='model.png', show_shapes=True)
	return model</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca3733160b336554550-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160b336554550-2">2</div><div class="crayon-num" data-line="crayon-5c0ca3733160b336554550-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160b336554550-4">4</div><div class="crayon-num" data-line="crayon-5c0ca3733160b336554550-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160b336554550-6">6</div><div class="crayon-num" data-line="crayon-5c0ca3733160b336554550-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160b336554550-8">8</div><div class="crayon-num" data-line="crayon-5c0ca3733160b336554550-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160b336554550-10">10</div><div class="crayon-num" data-line="crayon-5c0ca3733160b336554550-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160b336554550-12">12</div><div class="crayon-num" data-line="crayon-5c0ca3733160b336554550-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160b336554550-14">14</div><div class="crayon-num" data-line="crayon-5c0ca3733160b336554550-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160b336554550-16">16</div><div class="crayon-num" data-line="crayon-5c0ca3733160b336554550-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160b336554550-18">18</div><div class="crayon-num" data-line="crayon-5c0ca3733160b336554550-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160b336554550-20">20</div><div class="crayon-num" data-line="crayon-5c0ca3733160b336554550-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160b336554550-22">22</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca3733160b336554550-1"><span class="crayon-p"># define the captioning model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160b336554550-2"><span class="crayon-e">def </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733160b336554550-3"><span class="crayon-h"> </span><span class="crayon-p"># feature extractor model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160b336554550-4"><span class="crayon-h"> </span><span class="crayon-v">inputs1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">4096</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733160b336554550-5"><span class="crayon-h"> </span><span class="crayon-v">fe1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dropout</span><span class="crayon-sy">(</span><span class="crayon-cn">0.5</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160b336554550-6"><span class="crayon-h"> </span><span class="crayon-v">fe2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733160b336554550-7"><span class="crayon-h"> </span><span class="crayon-p"># sequence model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160b336554550-8"><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733160b336554550-9"><span class="crayon-h"> </span><span class="crayon-v">se1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Embedding</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask_zero</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160b336554550-10"><span class="crayon-h"> </span><span class="crayon-v">se2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dropout</span><span class="crayon-sy">(</span><span class="crayon-cn">0.5</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">se1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733160b336554550-11"><span class="crayon-h"> </span><span class="crayon-v">se3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">se2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160b336554550-12"><span class="crayon-h"> </span><span class="crayon-p"># decoder model</span></div><div class="crayon-line" id="crayon-5c0ca3733160b336554550-13"><span class="crayon-h"> </span><span class="crayon-v">decoder1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">fe2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">se3</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160b336554550-14"><span class="crayon-h"> </span><span class="crayon-v">decoder2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">decoder1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733160b336554550-15"><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">decoder2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160b336554550-16"><span class="crayon-h"> </span><span class="crayon-p"># tie it together [image, seq] [word]</span></div><div class="crayon-line" id="crayon-5c0ca3733160b336554550-17"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">inputs1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">outputs</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160b336554550-18"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733160b336554550-19"><span class="crayon-h"> </span><span class="crayon-p"># summarize model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160b336554550-20"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">summary</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733160b336554550-21"><span class="crayon-h"> </span><span class="crayon-e">plot_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">to_file</span><span class="crayon-o">=</span><span class="crayon-s">'model.png'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">show_shapes</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160b336554550-22"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0015 seconds] -->
<p>To get a sense for the structure of the model, specifically the shapes of the layers, see the summary listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca3733160e319038370" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
____________________________________________________________________________________________________
Layer (type)                     Output Shape          Param #     Connected to
====================================================================================================
input_2 (InputLayer)             (None, 34)            0
____________________________________________________________________________________________________
input_1 (InputLayer)             (None, 4096)          0
____________________________________________________________________________________________________
embedding_1 (Embedding)          (None, 34, 256)       1940224     input_2[0][0]
____________________________________________________________________________________________________
dropout_1 (Dropout)              (None, 4096)          0           input_1[0][0]
____________________________________________________________________________________________________
dropout_2 (Dropout)              (None, 34, 256)       0           embedding_1[0][0]
____________________________________________________________________________________________________
dense_1 (Dense)                  (None, 256)           1048832     dropout_1[0][0]
____________________________________________________________________________________________________
lstm_1 (LSTM)                    (None, 256)           525312      dropout_2[0][0]
____________________________________________________________________________________________________
add_1 (Add)                      (None, 256)           0           dense_1[0][0]
                                                                   lstm_1[0][0]
____________________________________________________________________________________________________
dense_2 (Dense)                  (None, 256)           65792       add_1[0][0]
____________________________________________________________________________________________________
dense_3 (Dense)                  (None, 7579)          1947803     dense_2[0][0]
====================================================================================================
Total params: 5,527,963
Trainable params: 5,527,963
Non-trainable params: 0
____________________________________________________________________________________________________</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca3733160e319038370-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160e319038370-2">2</div><div class="crayon-num" data-line="crayon-5c0ca3733160e319038370-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160e319038370-4">4</div><div class="crayon-num" data-line="crayon-5c0ca3733160e319038370-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160e319038370-6">6</div><div class="crayon-num" data-line="crayon-5c0ca3733160e319038370-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160e319038370-8">8</div><div class="crayon-num" data-line="crayon-5c0ca3733160e319038370-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160e319038370-10">10</div><div class="crayon-num" data-line="crayon-5c0ca3733160e319038370-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160e319038370-12">12</div><div class="crayon-num" data-line="crayon-5c0ca3733160e319038370-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160e319038370-14">14</div><div class="crayon-num" data-line="crayon-5c0ca3733160e319038370-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160e319038370-16">16</div><div class="crayon-num" data-line="crayon-5c0ca3733160e319038370-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160e319038370-18">18</div><div class="crayon-num" data-line="crayon-5c0ca3733160e319038370-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160e319038370-20">20</div><div class="crayon-num" data-line="crayon-5c0ca3733160e319038370-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160e319038370-22">22</div><div class="crayon-num" data-line="crayon-5c0ca3733160e319038370-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160e319038370-24">24</div><div class="crayon-num" data-line="crayon-5c0ca3733160e319038370-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160e319038370-26">26</div><div class="crayon-num" data-line="crayon-5c0ca3733160e319038370-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733160e319038370-28">28</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca3733160e319038370-1">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160e319038370-2">Layer (type)                     Output Shape          Param #     Connected to</div><div class="crayon-line" id="crayon-5c0ca3733160e319038370-3">====================================================================================================</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160e319038370-4">input_2 (InputLayer)             (None, 34)            0</div><div class="crayon-line" id="crayon-5c0ca3733160e319038370-5">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160e319038370-6">input_1 (InputLayer)             (None, 4096)          0</div><div class="crayon-line" id="crayon-5c0ca3733160e319038370-7">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160e319038370-8">embedding_1 (Embedding)          (None, 34, 256)       1940224     input_2[0][0]</div><div class="crayon-line" id="crayon-5c0ca3733160e319038370-9">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160e319038370-10">dropout_1 (Dropout)              (None, 4096)          0           input_1[0][0]</div><div class="crayon-line" id="crayon-5c0ca3733160e319038370-11">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160e319038370-12">dropout_2 (Dropout)              (None, 34, 256)       0           embedding_1[0][0]</div><div class="crayon-line" id="crayon-5c0ca3733160e319038370-13">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160e319038370-14">dense_1 (Dense)                  (None, 256)           1048832     dropout_1[0][0]</div><div class="crayon-line" id="crayon-5c0ca3733160e319038370-15">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160e319038370-16">lstm_1 (LSTM)                    (None, 256)           525312      dropout_2[0][0]</div><div class="crayon-line" id="crayon-5c0ca3733160e319038370-17">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160e319038370-18">add_1 (Add)                      (None, 256)           0           dense_1[0][0]</div><div class="crayon-line" id="crayon-5c0ca3733160e319038370-19">                                                                   lstm_1[0][0]</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160e319038370-20">____________________________________________________________________________________________________</div><div class="crayon-line" id="crayon-5c0ca3733160e319038370-21">dense_2 (Dense)                  (None, 256)           65792       add_1[0][0]</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160e319038370-22">____________________________________________________________________________________________________</div><div class="crayon-line" id="crayon-5c0ca3733160e319038370-23">dense_3 (Dense)                  (None, 7579)          1947803     dense_2[0][0]</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160e319038370-24">====================================================================================================</div><div class="crayon-line" id="crayon-5c0ca3733160e319038370-25">Total params: 5,527,963</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160e319038370-26">Trainable params: 5,527,963</div><div class="crayon-line" id="crayon-5c0ca3733160e319038370-27">Non-trainable params: 0</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733160e319038370-28">____________________________________________________________________________________________________</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>We also create a plot to visualize the structure of the network that better helps understand the two streams of input.</p>
<div class="wp-caption aligncenter" id="attachment_4461" style="width: 847px"><img alt="Plot of the Caption Generation Deep Learning Model" class="size-full wp-image-4461" height="737" sizes="(max-width: 837px) 100vw, 837px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Plot-of-the-Caption-Generation-Deep-Learning-Model.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Plot-of-the-Caption-Generation-Deep-Learning-Model.png 837w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Plot-of-the-Caption-Generation-Deep-Learning-Model-300x264.png 300w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Plot-of-the-Caption-Generation-Deep-Learning-Model-768x676.png 768w" width="837"/><p class="wp-caption-text">Plot of the Caption Generation Deep Learning Model</p></div>
<h3>Fitting the Model</h3>
<p>Now that we know how to define the model, we can fit it on the training dataset.</p>
<p>The model learns fast and quickly overfits the training dataset. For this reason, we will monitor the skill of the trained model on the holdout development dataset. When the skill of the model on the development dataset improves at the end of an epoch, we will save the whole model to file.</p>
<p>At the end of the run, we can then use the saved model with the best skill on the training dataset as our final model.</p>
<p>We can do this by defining a <em>ModelCheckpoint</em> in Keras and specifying it to monitor the minimum loss on the validation dataset and save the model to a file that has both the training and validation loss in the filename.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca37331610814487236" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define checkpoint callback
filepath = 'model-ep{epoch:03d}-loss{loss:.3f}-val_loss{val_loss:.3f}.h5'
checkpoint = ModelCheckpoint(filepath, monitor='val_loss', verbose=1, save_best_only=True, mode='min')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca37331610814487236-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331610814487236-2">2</div><div class="crayon-num" data-line="crayon-5c0ca37331610814487236-3">3</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca37331610814487236-1"><span class="crayon-p"># define checkpoint callback</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331610814487236-2"><span class="crayon-v">filepath</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'model-ep{epoch:03d}-loss{loss:.3f}-val_loss{val_loss:.3f}.h5'</span></div><div class="crayon-line" id="crayon-5c0ca37331610814487236-3"><span class="crayon-v">checkpoint</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">ModelCheckpoint</span><span class="crayon-sy">(</span><span class="crayon-v">filepath</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">monitor</span><span class="crayon-o">=</span><span class="crayon-s">'val_loss'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">save_best_only</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mode</span><span class="crayon-o">=</span><span class="crayon-s">'min'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>We can then specify the checkpoint in the call to <em>fit()</em> via the <em>callbacks</em> argument. We must also specify the development dataset in <em>fit()</em> via the <em>validation_data</em> argument.</p>
<p>We will only fit the model for 20 epochs, but given the amount of training data, each epoch may take 30 minutes on modern hardware.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca37331613886265330" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# fit model
model.fit([X1train, X2train], ytrain, epochs=20, verbose=2, callbacks=[checkpoint], validation_data=([X1test, X2test], ytest))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca37331613886265330-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331613886265330-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca37331613886265330-1"><span class="crayon-p"># fit model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331613886265330-2"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">X1train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X2train</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ytrain</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-cn">20</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">callbacks</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">checkpoint</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">validation_data</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">X1test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X2test</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ytest</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0004 seconds] -->
<p></p>
<h3>Complete Example</h3>
<p>The complete example for fitting the model on the training data is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca37331615609778322" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from numpy import array
from pickle import load
from keras.preprocessing.text import Tokenizer
from keras.preprocessing.sequence import pad_sequences
from keras.utils import to_categorical
from keras.utils import plot_model
from keras.models import Model
from keras.layers import Input
from keras.layers import Dense
from keras.layers import LSTM
from keras.layers import Embedding
from keras.layers import Dropout
from keras.layers.merge import add
from keras.callbacks import ModelCheckpoint

# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# load a pre-defined list of photo identifiers
def load_set(filename):
	doc = load_doc(filename)
	dataset = list()
	# process line by line
	for line in doc.split('\n'):
		# skip empty lines
		if len(line) &lt; 1:
			continue
		# get the image identifier
		identifier = line.split('.')[0]
		dataset.append(identifier)
	return set(dataset)

# load clean descriptions into memory
def load_clean_descriptions(filename, dataset):
	# load document
	doc = load_doc(filename)
	descriptions = dict()
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		# split id from description
		image_id, image_desc = tokens[0], tokens[1:]
		# skip images not in the set
		if image_id in dataset:
			# create list
			if image_id not in descriptions:
				descriptions[image_id] = list()
			# wrap description in tokens
			desc = 'startseq ' + ' '.join(image_desc) + ' endseq'
			# store
			descriptions[image_id].append(desc)
	return descriptions

# load photo features
def load_photo_features(filename, dataset):
	# load all features
	all_features = load(open(filename, 'rb'))
	# filter features
	features = {k: all_features[k] for k in dataset}
	return features

# covert a dictionary of clean descriptions to a list of descriptions
def to_lines(descriptions):
	all_desc = list()
	for key in descriptions.keys():
		[all_desc.append(d) for d in descriptions[key]]
	return all_desc

# fit a tokenizer given caption descriptions
def create_tokenizer(descriptions):
	lines = to_lines(descriptions)
	tokenizer = Tokenizer()
	tokenizer.fit_on_texts(lines)
	return tokenizer

# calculate the length of the description with the most words
def max_length(descriptions):
	lines = to_lines(descriptions)
	return max(len(d.split()) for d in lines)

# create sequences of images, input sequences and output words for an image
def create_sequences(tokenizer, max_length, descriptions, photos):
	X1, X2, y = list(), list(), list()
	# walk through each image identifier
	for key, desc_list in descriptions.items():
		# walk through each description for the image
		for desc in desc_list:
			# encode the sequence
			seq = tokenizer.texts_to_sequences([desc])[0]
			# split one sequence into multiple X,y pairs
			for i in range(1, len(seq)):
				# split into input and output pair
				in_seq, out_seq = seq[:i], seq[i]
				# pad input sequence
				in_seq = pad_sequences([in_seq], maxlen=max_length)[0]
				# encode output sequence
				out_seq = to_categorical([out_seq], num_classes=vocab_size)[0]
				# store
				X1.append(photos[key][0])
				X2.append(in_seq)
				y.append(out_seq)
	return array(X1), array(X2), array(y)

# define the captioning model
def define_model(vocab_size, max_length):
	# feature extractor model
	inputs1 = Input(shape=(4096,))
	fe1 = Dropout(0.5)(inputs1)
	fe2 = Dense(256, activation='relu')(fe1)
	# sequence model
	inputs2 = Input(shape=(max_length,))
	se1 = Embedding(vocab_size, 256, mask_zero=True)(inputs2)
	se2 = Dropout(0.5)(se1)
	se3 = LSTM(256)(se2)
	# decoder model
	decoder1 = add([fe2, se3])
	decoder2 = Dense(256, activation='relu')(decoder1)
	outputs = Dense(vocab_size, activation='softmax')(decoder2)
	# tie it together [image, seq] [word]
	model = Model(inputs=[inputs1, inputs2], outputs=outputs)
	model.compile(loss='categorical_crossentropy', optimizer='adam')
	# summarize model
	print(model.summary())
	plot_model(model, to_file='model.png', show_shapes=True)
	return model

# train dataset

# load training dataset (6K)
filename = 'Flickr8k_text/Flickr_8k.trainImages.txt'
train = load_set(filename)
print('Dataset: %d' % len(train))
# descriptions
train_descriptions = load_clean_descriptions('descriptions.txt', train)
print('Descriptions: train=%d' % len(train_descriptions))
# photo features
train_features = load_photo_features('features.pkl', train)
print('Photos: train=%d' % len(train_features))
# prepare tokenizer
tokenizer = create_tokenizer(train_descriptions)
vocab_size = len(tokenizer.word_index) + 1
print('Vocabulary Size: %d' % vocab_size)
# determine the maximum sequence length
max_length = max_length(train_descriptions)
print('Description Length: %d' % max_length)
# prepare sequences
X1train, X2train, ytrain = create_sequences(tokenizer, max_length, train_descriptions, train_features)

# dev dataset

# load test set
filename = 'Flickr8k_text/Flickr_8k.devImages.txt'
test = load_set(filename)
print('Dataset: %d' % len(test))
# descriptions
test_descriptions = load_clean_descriptions('descriptions.txt', test)
print('Descriptions: test=%d' % len(test_descriptions))
# photo features
test_features = load_photo_features('features.pkl', test)
print('Photos: test=%d' % len(test_features))
# prepare sequences
X1test, X2test, ytest = create_sequences(tokenizer, max_length, test_descriptions, test_features)

# fit model

# define the model
model = define_model(vocab_size, max_length)
# define checkpoint callback
filepath = 'model-ep{epoch:03d}-loss{loss:.3f}-val_loss{val_loss:.3f}.h5'
checkpoint = ModelCheckpoint(filepath, monitor='val_loss', verbose=1, save_best_only=True, mode='min')
# fit model
model.fit([X1train, X2train], ytrain, epochs=20, verbose=2, callbacks=[checkpoint], validation_data=([X1test, X2test], ytest))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-2">2</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-4">4</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-6">6</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-8">8</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-10">10</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-12">12</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-14">14</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-16">16</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-18">18</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-20">20</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-22">22</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-24">24</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-26">26</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-28">28</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-30">30</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-32">32</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-34">34</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-36">36</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-38">38</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-40">40</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-42">42</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-44">44</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-46">46</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-48">48</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-50">50</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-52">52</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-54">54</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-56">56</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-58">58</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-60">60</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-62">62</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-64">64</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-66">66</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-68">68</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-70">70</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-72">72</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-74">74</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-76">76</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-78">78</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-80">80</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-82">82</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-84">84</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-86">86</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-88">88</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-90">90</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-92">92</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-94">94</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-96">96</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-98">98</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-100">100</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-101">101</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-102">102</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-103">103</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-104">104</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-105">105</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-106">106</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-107">107</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-108">108</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-109">109</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-110">110</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-111">111</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-112">112</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-113">113</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-114">114</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-115">115</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-116">116</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-117">117</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-118">118</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-119">119</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-120">120</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-121">121</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-122">122</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-123">123</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-124">124</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-125">125</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-126">126</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-127">127</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-128">128</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-129">129</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-130">130</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-131">131</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-132">132</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-133">133</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-134">134</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-135">135</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-136">136</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-137">137</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-138">138</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-139">139</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-140">140</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-141">141</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-142">142</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-143">143</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-144">144</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-145">145</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-146">146</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-147">147</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-148">148</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-149">149</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-150">150</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-151">151</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-152">152</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-153">153</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-154">154</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-155">155</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-156">156</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-157">157</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-158">158</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-159">159</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-160">160</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-161">161</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-162">162</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-163">163</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-164">164</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-165">165</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-166">166</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-167">167</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-168">168</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-169">169</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-170">170</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-171">171</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-172">172</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-173">173</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-174">174</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-175">175</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-176">176</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-177">177</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331615609778322-178">178</div><div class="crayon-num" data-line="crayon-5c0ca37331615609778322-179">179</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca37331615609778322-1"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-t">array</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-2"><span class="crayon-e">from </span><span class="crayon-e">pickle </span><span class="crayon-e">import </span><span class="crayon-e">load</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-3"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">text </span><span class="crayon-e">import </span><span class="crayon-e">Tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-4"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">sequence </span><span class="crayon-e">import </span><span class="crayon-e">pad_sequences</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-5"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">utils </span><span class="crayon-e">import </span><span class="crayon-e">to_categorical</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-6"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">utils </span><span class="crayon-e">import </span><span class="crayon-e">plot_model</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-7"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-e">Model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-8"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Input</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-9"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Dense</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-10"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">LSTM</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-11"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Embedding</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-12"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Dropout</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-13"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">.</span><span class="crayon-e">merge </span><span class="crayon-e">import </span><span class="crayon-e">add</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-14"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">callbacks </span><span class="crayon-e">import </span><span class="crayon-v">ModelCheckpoint</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-15"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-16"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-17"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-18"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-19"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-20"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-21"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-22"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-23"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-24"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-25"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-26"><span class="crayon-p"># load a pre-defined list of photo identifiers</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-27"><span class="crayon-e">def </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-28"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-29"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-30"><span class="crayon-h"> </span><span class="crayon-p"># process line by line</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-31"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-32"><span class="crayon-h"> </span><span class="crayon-p"># skip empty lines</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-33"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-34"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-35"><span class="crayon-h"> </span><span class="crayon-p"># get the image identifier</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-36"><span class="crayon-h"> </span><span class="crayon-v">identifier</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-37"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">identifier</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-38"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-39"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-40"><span class="crayon-p"># load clean descriptions into memory</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-41"><span class="crayon-e">def </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-42"><span class="crayon-h"> </span><span class="crayon-p"># load document</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-43"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-44"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-45"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-46"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-47"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-48"><span class="crayon-h"> </span><span class="crayon-p"># split id from description</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-49"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-50"><span class="crayon-h"> </span><span class="crayon-p"># skip images not in the set</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-51"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-52"><span class="crayon-h"> </span><span class="crayon-p"># create list</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-53"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-54"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-55"><span class="crayon-h"> </span><span class="crayon-p"># wrap description in tokens</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-56"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' endseq'</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-57"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-58"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-59"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-60"> </div><div class="crayon-line" id="crayon-5c0ca37331615609778322-61"><span class="crayon-p"># load photo features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-62"><span class="crayon-e">def </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-63"><span class="crayon-h"> </span><span class="crayon-p"># load all features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-64"><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load</span><span class="crayon-sy">(</span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'rb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-65"><span class="crayon-h"> </span><span class="crayon-p"># filter features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-66"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">k</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">k</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-67"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-68"> </div><div class="crayon-line" id="crayon-5c0ca37331615609778322-69"><span class="crayon-p"># covert a dictionary of clean descriptions to a list of descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-70"><span class="crayon-e">def </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-71"><span class="crayon-h"> </span><span class="crayon-v">all_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-72"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">key </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">keys</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-73"><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">all_desc</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-74"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">all_desc</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-75"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-76"><span class="crayon-p"># fit a tokenizer given caption descriptions</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-77"><span class="crayon-e">def </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-78"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-79"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Tokenizer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-80"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">fit_on_texts</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-81"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-82"> </div><div class="crayon-line" id="crayon-5c0ca37331615609778322-83"><span class="crayon-p"># calculate the length of the description with the most words</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-84"><span class="crayon-e">def </span><span class="crayon-e">max_length</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-85"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-86"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">max</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-87"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-88"><span class="crayon-p"># create sequences of images, input sequences and output words for an image</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-89"><span class="crayon-e">def </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-90"><span class="crayon-h"> </span><span class="crayon-v">X1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-91"><span class="crayon-h"> </span><span class="crayon-p"># walk through each image identifier</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-92"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc_list </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-93"><span class="crayon-h"> </span><span class="crayon-p"># walk through each description for the image</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-94"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-95"><span class="crayon-h"> </span><span class="crayon-p"># encode the sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-96"><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">desc</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-97"><span class="crayon-h"> </span><span class="crayon-p"># split one sequence into multiple X,y pairs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-98"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">seq</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-99"><span class="crayon-h"> </span><span class="crayon-p"># split into input and output pair</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-100"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-101"><span class="crayon-h"> </span><span class="crayon-p"># pad input sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-102"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-103"><span class="crayon-h"> </span><span class="crayon-p"># encode output sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-104"><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">out_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-105"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-106"><span class="crayon-h"> </span><span class="crayon-v">X1</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">photos</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-107"><span class="crayon-h"> </span><span class="crayon-v">X2</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">in_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-108"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">out_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-109"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X1</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X2</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-110"> </div><div class="crayon-line" id="crayon-5c0ca37331615609778322-111"><span class="crayon-p"># define the captioning model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-112"><span class="crayon-e">def </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-113"><span class="crayon-h"> </span><span class="crayon-p"># feature extractor model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-114"><span class="crayon-h"> </span><span class="crayon-v">inputs1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">4096</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-115"><span class="crayon-h"> </span><span class="crayon-v">fe1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dropout</span><span class="crayon-sy">(</span><span class="crayon-cn">0.5</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-116"><span class="crayon-h"> </span><span class="crayon-v">fe2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-117"><span class="crayon-h"> </span><span class="crayon-p"># sequence model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-118"><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-119"><span class="crayon-h"> </span><span class="crayon-v">se1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Embedding</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask_zero</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-120"><span class="crayon-h"> </span><span class="crayon-v">se2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dropout</span><span class="crayon-sy">(</span><span class="crayon-cn">0.5</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">se1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-121"><span class="crayon-h"> </span><span class="crayon-v">se3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">se2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-122"><span class="crayon-h"> </span><span class="crayon-p"># decoder model</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-123"><span class="crayon-h"> </span><span class="crayon-v">decoder1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">fe2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">se3</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-124"><span class="crayon-h"> </span><span class="crayon-v">decoder2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">decoder1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-125"><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">decoder2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-126"><span class="crayon-h"> </span><span class="crayon-p"># tie it together [image, seq] [word]</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-127"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">inputs1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">outputs</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-128"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-129"><span class="crayon-h"> </span><span class="crayon-p"># summarize model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-130"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">summary</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-131"><span class="crayon-h"> </span><span class="crayon-e">plot_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">to_file</span><span class="crayon-o">=</span><span class="crayon-s">'model.png'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">show_shapes</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-132"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-133"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-134"><span class="crayon-p"># train dataset</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-135"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-136"><span class="crayon-p"># load training dataset (6K)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-137"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr_8k.trainImages.txt'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-138"><span class="crayon-v">train</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-139"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Dataset: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-140"><span class="crayon-p"># descriptions</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-141"><span class="crayon-v">train_descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-142"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Descriptions: train=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-143"><span class="crayon-p"># photo features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-144"><span class="crayon-v">train_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-s">'features.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-145"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Photos: train=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-146"><span class="crayon-p"># prepare tokenizer</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-147"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-148"><span class="crayon-v">vocab_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-149"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-150"><span class="crayon-p"># determine the maximum sequence length</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-151"><span class="crayon-v">max_length</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">max_length</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-152"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Description Length: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-153"><span class="crayon-p"># prepare sequences</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-154"><span class="crayon-v">X1train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X2train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ytrain</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_features</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-155"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-156"><span class="crayon-p"># dev dataset</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-157"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-158"><span class="crayon-p"># load test set</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-159"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr_8k.devImages.txt'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-160"><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-161"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Dataset: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-162"><span class="crayon-p"># descriptions</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-163"><span class="crayon-v">test_descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-164"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Descriptions: test=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-165"><span class="crayon-p"># photo features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-166"><span class="crayon-v">test_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-s">'features.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-167"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Photos: test=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-168"><span class="crayon-p"># prepare sequences</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-169"><span class="crayon-v">X1test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X2test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ytest</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_features</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-170"> </div><div class="crayon-line" id="crayon-5c0ca37331615609778322-171"><span class="crayon-p"># fit model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-172"> </div><div class="crayon-line" id="crayon-5c0ca37331615609778322-173"><span class="crayon-p"># define the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-174"><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-175"><span class="crayon-p"># define checkpoint callback</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-176"><span class="crayon-v">filepath</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'model-ep{epoch:03d}-loss{loss:.3f}-val_loss{val_loss:.3f}.h5'</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-177"><span class="crayon-v">checkpoint</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">ModelCheckpoint</span><span class="crayon-sy">(</span><span class="crayon-v">filepath</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">monitor</span><span class="crayon-o">=</span><span class="crayon-s">'val_loss'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">save_best_only</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mode</span><span class="crayon-o">=</span><span class="crayon-s">'min'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331615609778322-178"><span class="crayon-p"># fit model</span></div><div class="crayon-line" id="crayon-5c0ca37331615609778322-179"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">X1train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X2train</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ytrain</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-cn">20</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">callbacks</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">checkpoint</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">validation_data</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">X1test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X2test</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ytest</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0087 seconds] -->
<p>Running the example first prints a summary of the loaded training and development datasets.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca37331617448086222" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Dataset: 6,000
Descriptions: train=6,000
Photos: train=6,000
Vocabulary Size: 7,579
Description Length: 34
Dataset: 1,000
Descriptions: test=1,000
Photos: test=1,000</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca37331617448086222-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331617448086222-2">2</div><div class="crayon-num" data-line="crayon-5c0ca37331617448086222-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331617448086222-4">4</div><div class="crayon-num" data-line="crayon-5c0ca37331617448086222-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331617448086222-6">6</div><div class="crayon-num" data-line="crayon-5c0ca37331617448086222-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331617448086222-8">8</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca37331617448086222-1">Dataset: 6,000</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331617448086222-2">Descriptions: train=6,000</div><div class="crayon-line" id="crayon-5c0ca37331617448086222-3">Photos: train=6,000</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331617448086222-4">Vocabulary Size: 7,579</div><div class="crayon-line" id="crayon-5c0ca37331617448086222-5">Description Length: 34</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331617448086222-6">Dataset: 1,000</div><div class="crayon-line" id="crayon-5c0ca37331617448086222-7">Descriptions: test=1,000</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331617448086222-8">Photos: test=1,000</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>After the summary of the model, we can get an idea of the total number of training and validation (development) input-output pairs.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca3733161a883394273" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Train on 306,404 samples, validate on 50,903 samples</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca3733161a883394273-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca3733161a883394273-1">Train on 306,404 samples, validate on 50,903 samples</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>The model then runs, saving the best model to .h5 files along the way.</p>
<p>On my run, the best validation results were saved to the file:</p>
<ul>
<li><em>model-ep002-loss3.245-val_loss3.612.h5</em></li>
</ul>
<p>This model was saved at the end of epoch 2 with a loss of 3.245 on the training dataset and a loss of 3.612 on the development dataset</p>
<p>Your specific results will vary.</p>
<p>Let me know what you get in the comments below.</p>
<p>If you ran the example on AWS, copy the model file back to your current working directory. If you need help with commands on AWS, see the post:</p>
<ul>
<li><a href="https://machinelearningmastery.com/command-line-recipes-deep-learning-amazon-web-services/">10 Command Line Recipes for Deep Learning on Amazon Web Services</a></li>
</ul>
<p>Did you get an error like:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca3733161c099630678" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Memory Error</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca3733161c099630678-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca3733161c099630678-1">Memory Error</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>If so, see the next section.</p>
<h2>Train With Progressive Loading</h2>
<p><strong>Note</strong>: If you had no problems in the previous section, <span style="text-decoration: underline;">please skip this section</span>. This section is for those who do not have enough memory to train the model as described in the previous section (e.g. cannot use AWS EC2 for whatever reason).</p>
<p>The training of the caption model does assume you have a lot of RAM.</p>
<p>The code in the previous section is not memory efficient and assumes you are running on a large EC2 instance with 32GB or 64GB of RAM. If you are running the code on a workstation of 8GB of RAM, you cannot train the model.</p>
<p>A workaround is to use progressive loading. This was discussed in detail in the second-last section titled “<em>Progressive Loading</em>” in the post:</p>
<ul>
<li><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/">How to Prepare a Photo Caption Dataset for Training a Deep Learning Model</a></li>
</ul>
<p>I recommend reading that section before continuing.</p>
<p>If you want to use progressive loading, to train this model, this section will show you how.</p>
<p>The first step is we must define a function that we can use as the data generator.</p>
<p>We will keep things very simple and have the data generator yield one photo’s worth of data per batch. This will be all of the sequences generated for a photo and its set of descriptions.</p>
<p>The function below <em>data_generator()</em> will be the data generator and will take the loaded textual descriptions, photo features, tokenizer and max length. Here, I assume that you can fit this training data in memory, which I believe 8GB of RAM should be more than capable.</p>
<p>How does this work? Read the post I just mentioned above that introduces data generators.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca3733161e166237374" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# data generator, intended to be used in a call to model.fit_generator()
def data_generator(descriptions, photos, tokenizer, max_length):
	# loop for ever over images
	while 1:
		for key, desc_list in descriptions.items():
			# retrieve the photo feature
			photo = photos[key][0]
			in_img, in_seq, out_word = create_sequences(tokenizer, max_length, desc_list, photo)
			yield [[in_img, in_seq], out_word]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca3733161e166237374-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733161e166237374-2">2</div><div class="crayon-num" data-line="crayon-5c0ca3733161e166237374-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733161e166237374-4">4</div><div class="crayon-num" data-line="crayon-5c0ca3733161e166237374-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733161e166237374-6">6</div><div class="crayon-num" data-line="crayon-5c0ca3733161e166237374-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733161e166237374-8">8</div><div class="crayon-num" data-line="crayon-5c0ca3733161e166237374-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca3733161e166237374-1"><span class="crayon-p"># data generator, intended to be used in a call to model.fit_generator()</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733161e166237374-2"><span class="crayon-e">def </span><span class="crayon-e">data_generator</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733161e166237374-3"><span class="crayon-h"> </span><span class="crayon-p"># loop for ever over images</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733161e166237374-4"><span class="crayon-h"> </span><span class="crayon-st">while</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733161e166237374-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc_list </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733161e166237374-6"><span class="crayon-h"> </span><span class="crayon-p"># retrieve the photo feature</span></div><div class="crayon-line" id="crayon-5c0ca3733161e166237374-7"><span class="crayon-h"> </span><span class="crayon-v">photo</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733161e166237374-8"><span class="crayon-h"> </span><span class="crayon-v">in_img</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_word</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photo</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733161e166237374-9"><span class="crayon-h"> </span><span class="crayon-i">yield</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-v">in_img</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_word</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0006 seconds] -->
<p>You can see that we are calling the <em>create_sequence()</em> function to create a batch worth of data for a single photo rather than an entire dataset. This means that we must update the <em>create_sequences()</em> function to delete the “iterate over all descriptions” for-loop.</p>
<p>The updated function is as follows:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca37331620643334843" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# create sequences of images, input sequences and output words for an image
def create_sequences(tokenizer, max_length, desc_list, photo):
	X1, X2, y = list(), list(), list()
	# walk through each description for the image
	for desc in desc_list:
		# encode the sequence
		seq = tokenizer.texts_to_sequences([desc])[0]
		# split one sequence into multiple X,y pairs
		for i in range(1, len(seq)):
			# split into input and output pair
			in_seq, out_seq = seq[:i], seq[i]
			# pad input sequence
			in_seq = pad_sequences([in_seq], maxlen=max_length)[0]
			# encode output sequence
			out_seq = to_categorical([out_seq], num_classes=vocab_size)[0]
			# store
			X1.append(photo)
			X2.append(in_seq)
			y.append(out_seq)
	return array(X1), array(X2), array(y)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca37331620643334843-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331620643334843-2">2</div><div class="crayon-num" data-line="crayon-5c0ca37331620643334843-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331620643334843-4">4</div><div class="crayon-num" data-line="crayon-5c0ca37331620643334843-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331620643334843-6">6</div><div class="crayon-num" data-line="crayon-5c0ca37331620643334843-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331620643334843-8">8</div><div class="crayon-num" data-line="crayon-5c0ca37331620643334843-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331620643334843-10">10</div><div class="crayon-num" data-line="crayon-5c0ca37331620643334843-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331620643334843-12">12</div><div class="crayon-num" data-line="crayon-5c0ca37331620643334843-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331620643334843-14">14</div><div class="crayon-num" data-line="crayon-5c0ca37331620643334843-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331620643334843-16">16</div><div class="crayon-num" data-line="crayon-5c0ca37331620643334843-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331620643334843-18">18</div><div class="crayon-num" data-line="crayon-5c0ca37331620643334843-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331620643334843-20">20</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca37331620643334843-1"><span class="crayon-p"># create sequences of images, input sequences and output words for an image</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331620643334843-2"><span class="crayon-e">def </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photo</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331620643334843-3"><span class="crayon-h"> </span><span class="crayon-v">X1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331620643334843-4"><span class="crayon-h"> </span><span class="crayon-p"># walk through each description for the image</span></div><div class="crayon-line" id="crayon-5c0ca37331620643334843-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331620643334843-6"><span class="crayon-h"> </span><span class="crayon-p"># encode the sequence</span></div><div class="crayon-line" id="crayon-5c0ca37331620643334843-7"><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">desc</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331620643334843-8"><span class="crayon-h"> </span><span class="crayon-p"># split one sequence into multiple X,y pairs</span></div><div class="crayon-line" id="crayon-5c0ca37331620643334843-9"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">seq</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331620643334843-10"><span class="crayon-h"> </span><span class="crayon-p"># split into input and output pair</span></div><div class="crayon-line" id="crayon-5c0ca37331620643334843-11"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331620643334843-12"><span class="crayon-h"> </span><span class="crayon-p"># pad input sequence</span></div><div class="crayon-line" id="crayon-5c0ca37331620643334843-13"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331620643334843-14"><span class="crayon-h"> </span><span class="crayon-p"># encode output sequence</span></div><div class="crayon-line" id="crayon-5c0ca37331620643334843-15"><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">out_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331620643334843-16"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line" id="crayon-5c0ca37331620643334843-17"><span class="crayon-h"> </span><span class="crayon-v">X1</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">photo</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331620643334843-18"><span class="crayon-h"> </span><span class="crayon-v">X2</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">in_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331620643334843-19"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">out_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331620643334843-20"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X1</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X2</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0013 seconds] -->
<p>We now have pretty much everything we need.</p>
<p>Note, this is a very basic data generator. The big memory saving it offers is to not have the unrolled sequences of train and test data in memory prior to fitting the model, that these samples (e.g. results from <em>create_sequences()</em>) are created as needed per photo.</p>
<p>Some off-the-cuff ideas for further improving this data generator include:</p>
<ul>
<li>Randomize the order of photos each epoch.</li>
<li>Work with a list of photo ids and load text and photo data as needed to cut even further back on memory.</li>
<li>Yield more than one photo’s worth of samples per batch.</li>
</ul>
<p>I have experienced with these variations myself in the past. Let me know if you do and how you go in the comments.</p>
<p>You can sanity check a data generator by calling it directly, as follows:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca37331622819326028" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# test the data generator
generator = data_generator(train_descriptions, train_features, tokenizer, max_length)
inputs, outputs = next(generator)
print(inputs[0].shape)
print(inputs[1].shape)
print(outputs.shape)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca37331622819326028-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331622819326028-2">2</div><div class="crayon-num" data-line="crayon-5c0ca37331622819326028-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331622819326028-4">4</div><div class="crayon-num" data-line="crayon-5c0ca37331622819326028-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331622819326028-6">6</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca37331622819326028-1"><span class="crayon-p"># test the data generator</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331622819326028-2"><span class="crayon-v">generator</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">data_generator</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331622819326028-3"><span class="crayon-v">inputs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">next</span><span class="crayon-sy">(</span><span class="crayon-v">generator</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331622819326028-4"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331622819326028-5"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331622819326028-6"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">outputs</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0004 seconds] -->
<p>Running this sanity check will show what one batch worth of sequences looks like, in this case 47 samples to train on for the first photo.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca37331624420121319" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
(47, 4096)
(47, 34)
(47, 7579)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca37331624420121319-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331624420121319-2">2</div><div class="crayon-num" data-line="crayon-5c0ca37331624420121319-3">3</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca37331624420121319-1">(47, 4096)</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331624420121319-2">(47, 34)</div><div class="crayon-line" id="crayon-5c0ca37331624420121319-3">(47, 7579)</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>Finally, we can use the <em>fit_generator()</em> function on the model to train the model with this data generator.</p>
<p>In this simple example we will discard the loading of the development dataset and model checkpointing and simply save the model after each training epoch. You can then go back and load/evaluate each saved model after training to find the one we the lowest loss that you can then use in the next section.</p>
<p>The code to train the model with the data generator is as follows:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca37331625682282971" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# train the model, run epochs manually and save after each epoch
epochs = 20
steps = len(train_descriptions)
for i in range(epochs):
	# create the data generator
	generator = data_generator(train_descriptions, train_features, tokenizer, max_length)
	# fit for one epoch
	model.fit_generator(generator, epochs=1, steps_per_epoch=steps, verbose=1)
	# save model
	model.save('model_' + str(i) + '.h5')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca37331625682282971-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331625682282971-2">2</div><div class="crayon-num" data-line="crayon-5c0ca37331625682282971-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331625682282971-4">4</div><div class="crayon-num" data-line="crayon-5c0ca37331625682282971-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331625682282971-6">6</div><div class="crayon-num" data-line="crayon-5c0ca37331625682282971-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331625682282971-8">8</div><div class="crayon-num" data-line="crayon-5c0ca37331625682282971-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331625682282971-10">10</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca37331625682282971-1"><span class="crayon-p"># train the model, run epochs manually and save after each epoch</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331625682282971-2"><span class="crayon-v">epochs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">20</span></div><div class="crayon-line" id="crayon-5c0ca37331625682282971-3"><span class="crayon-v">steps</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331625682282971-4"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">epochs</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331625682282971-5"><span class="crayon-h"> </span><span class="crayon-p"># create the data generator</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331625682282971-6"><span class="crayon-h"> </span><span class="crayon-v">generator</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">data_generator</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331625682282971-7"><span class="crayon-h"> </span><span class="crayon-p"># fit for one epoch</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331625682282971-8"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit_generator</span><span class="crayon-sy">(</span><span class="crayon-v">generator</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">steps_per_epoch</span><span class="crayon-o">=</span><span class="crayon-v">steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331625682282971-9"><span class="crayon-h"> </span><span class="crayon-p"># save model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331625682282971-10"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">save</span><span class="crayon-sy">(</span><span class="crayon-s">'model_'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">str</span><span class="crayon-sy">(</span><span class="crayon-v">i</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'.h5'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0006 seconds] -->
<p>That’s it. You can now train the model using progressive loading and save a ton of RAM. This may also be a lot slower.</p>
<p>The complete updated example with progressive loading (use of the data generator) for training the caption generation model is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca37331627882467475" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from numpy import array
from pickle import load
from keras.preprocessing.text import Tokenizer
from keras.preprocessing.sequence import pad_sequences
from keras.utils import to_categorical
from keras.utils import plot_model
from keras.models import Model
from keras.layers import Input
from keras.layers import Dense
from keras.layers import LSTM
from keras.layers import Embedding
from keras.layers import Dropout
from keras.layers.merge import add
from keras.callbacks import ModelCheckpoint

# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# load a pre-defined list of photo identifiers
def load_set(filename):
	doc = load_doc(filename)
	dataset = list()
	# process line by line
	for line in doc.split('\n'):
		# skip empty lines
		if len(line) &lt; 1:
			continue
		# get the image identifier
		identifier = line.split('.')[0]
		dataset.append(identifier)
	return set(dataset)

# load clean descriptions into memory
def load_clean_descriptions(filename, dataset):
	# load document
	doc = load_doc(filename)
	descriptions = dict()
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		# split id from description
		image_id, image_desc = tokens[0], tokens[1:]
		# skip images not in the set
		if image_id in dataset:
			# create list
			if image_id not in descriptions:
				descriptions[image_id] = list()
			# wrap description in tokens
			desc = 'startseq ' + ' '.join(image_desc) + ' endseq'
			# store
			descriptions[image_id].append(desc)
	return descriptions

# load photo features
def load_photo_features(filename, dataset):
	# load all features
	all_features = load(open(filename, 'rb'))
	# filter features
	features = {k: all_features[k] for k in dataset}
	return features

# covert a dictionary of clean descriptions to a list of descriptions
def to_lines(descriptions):
	all_desc = list()
	for key in descriptions.keys():
		[all_desc.append(d) for d in descriptions[key]]
	return all_desc

# fit a tokenizer given caption descriptions
def create_tokenizer(descriptions):
	lines = to_lines(descriptions)
	tokenizer = Tokenizer()
	tokenizer.fit_on_texts(lines)
	return tokenizer

# calculate the length of the description with the most words
def max_length(descriptions):
	lines = to_lines(descriptions)
	return max(len(d.split()) for d in lines)

# create sequences of images, input sequences and output words for an image
def create_sequences(tokenizer, max_length, desc_list, photo):
	X1, X2, y = list(), list(), list()
	# walk through each description for the image
	for desc in desc_list:
		# encode the sequence
		seq = tokenizer.texts_to_sequences([desc])[0]
		# split one sequence into multiple X,y pairs
		for i in range(1, len(seq)):
			# split into input and output pair
			in_seq, out_seq = seq[:i], seq[i]
			# pad input sequence
			in_seq = pad_sequences([in_seq], maxlen=max_length)[0]
			# encode output sequence
			out_seq = to_categorical([out_seq], num_classes=vocab_size)[0]
			# store
			X1.append(photo)
			X2.append(in_seq)
			y.append(out_seq)
	return array(X1), array(X2), array(y)

# define the captioning model
def define_model(vocab_size, max_length):
	# feature extractor model
	inputs1 = Input(shape=(4096,))
	fe1 = Dropout(0.5)(inputs1)
	fe2 = Dense(256, activation='relu')(fe1)
	# sequence model
	inputs2 = Input(shape=(max_length,))
	se1 = Embedding(vocab_size, 256, mask_zero=True)(inputs2)
	se2 = Dropout(0.5)(se1)
	se3 = LSTM(256)(se2)
	# decoder model
	decoder1 = add([fe2, se3])
	decoder2 = Dense(256, activation='relu')(decoder1)
	outputs = Dense(vocab_size, activation='softmax')(decoder2)
	# tie it together [image, seq] [word]
	model = Model(inputs=[inputs1, inputs2], outputs=outputs)
	# compile model
	model.compile(loss='categorical_crossentropy', optimizer='adam')
	# summarize model
	model.summary()
	plot_model(model, to_file='model.png', show_shapes=True)
	return model

# data generator, intended to be used in a call to model.fit_generator()
def data_generator(descriptions, photos, tokenizer, max_length):
	# loop for ever over images
	while 1:
		for key, desc_list in descriptions.items():
			# retrieve the photo feature
			photo = photos[key][0]
			in_img, in_seq, out_word = create_sequences(tokenizer, max_length, desc_list, photo)
			yield [[in_img, in_seq], out_word]

# load training dataset (6K)
filename = 'Flickr8k_text/Flickr_8k.trainImages.txt'
train = load_set(filename)
print('Dataset: %d' % len(train))
# descriptions
train_descriptions = load_clean_descriptions('descriptions.txt', train)
print('Descriptions: train=%d' % len(train_descriptions))
# photo features
train_features = load_photo_features('features.pkl', train)
print('Photos: train=%d' % len(train_features))
# prepare tokenizer
tokenizer = create_tokenizer(train_descriptions)
vocab_size = len(tokenizer.word_index) + 1
print('Vocabulary Size: %d' % vocab_size)
# determine the maximum sequence length
max_length = max_length(train_descriptions)
print('Description Length: %d' % max_length)

# define the model
model = define_model(vocab_size, max_length)
# train the model, run epochs manually and save after each epoch
epochs = 20
steps = len(train_descriptions)
for i in range(epochs):
	# create the data generator
	generator = data_generator(train_descriptions, train_features, tokenizer, max_length)
	# fit for one epoch
	model.fit_generator(generator, epochs=1, steps_per_epoch=steps, verbose=1)
	# save model
	model.save('model_' + str(i) + '.h5')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-2">2</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-4">4</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-6">6</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-8">8</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-10">10</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-12">12</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-14">14</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-16">16</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-18">18</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-20">20</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-22">22</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-24">24</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-26">26</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-28">28</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-30">30</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-32">32</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-34">34</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-36">36</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-38">38</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-40">40</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-42">42</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-44">44</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-46">46</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-48">48</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-50">50</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-52">52</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-54">54</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-56">56</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-58">58</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-60">60</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-62">62</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-64">64</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-66">66</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-68">68</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-70">70</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-72">72</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-74">74</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-76">76</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-78">78</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-80">80</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-82">82</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-84">84</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-86">86</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-88">88</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-90">90</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-92">92</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-94">94</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-96">96</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-98">98</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-100">100</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-101">101</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-102">102</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-103">103</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-104">104</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-105">105</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-106">106</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-107">107</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-108">108</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-109">109</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-110">110</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-111">111</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-112">112</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-113">113</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-114">114</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-115">115</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-116">116</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-117">117</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-118">118</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-119">119</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-120">120</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-121">121</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-122">122</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-123">123</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-124">124</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-125">125</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-126">126</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-127">127</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-128">128</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-129">129</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-130">130</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-131">131</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-132">132</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-133">133</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-134">134</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-135">135</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-136">136</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-137">137</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-138">138</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-139">139</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-140">140</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-141">141</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-142">142</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-143">143</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-144">144</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-145">145</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-146">146</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-147">147</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-148">148</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-149">149</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-150">150</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-151">151</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-152">152</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-153">153</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-154">154</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-155">155</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-156">156</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-157">157</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-158">158</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-159">159</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-160">160</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-161">161</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-162">162</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-163">163</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-164">164</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-165">165</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-166">166</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-167">167</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-168">168</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-169">169</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-170">170</div><div class="crayon-num" data-line="crayon-5c0ca37331627882467475-171">171</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331627882467475-172">172</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca37331627882467475-1"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-t">array</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-2"><span class="crayon-e">from </span><span class="crayon-e">pickle </span><span class="crayon-e">import </span><span class="crayon-e">load</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-3"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">text </span><span class="crayon-e">import </span><span class="crayon-e">Tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-4"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">sequence </span><span class="crayon-e">import </span><span class="crayon-e">pad_sequences</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-5"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">utils </span><span class="crayon-e">import </span><span class="crayon-e">to_categorical</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-6"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">utils </span><span class="crayon-e">import </span><span class="crayon-e">plot_model</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-7"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-e">Model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-8"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Input</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-9"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Dense</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-10"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">LSTM</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-11"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Embedding</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-12"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Dropout</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-13"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">.</span><span class="crayon-e">merge </span><span class="crayon-e">import </span><span class="crayon-e">add</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-14"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">callbacks </span><span class="crayon-e">import </span><span class="crayon-v">ModelCheckpoint</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-15"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-16"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-17"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-18"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-19"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-20"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-21"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-22"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-23"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-24"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-25"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-26"><span class="crayon-p"># load a pre-defined list of photo identifiers</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-27"><span class="crayon-e">def </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-28"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-29"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-30"><span class="crayon-h"> </span><span class="crayon-p"># process line by line</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-31"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-32"><span class="crayon-h"> </span><span class="crayon-p"># skip empty lines</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-33"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-34"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-35"><span class="crayon-h"> </span><span class="crayon-p"># get the image identifier</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-36"><span class="crayon-h"> </span><span class="crayon-v">identifier</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-37"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">identifier</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-38"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-39"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-40"><span class="crayon-p"># load clean descriptions into memory</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-41"><span class="crayon-e">def </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-42"><span class="crayon-h"> </span><span class="crayon-p"># load document</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-43"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-44"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-45"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-46"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-47"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-48"><span class="crayon-h"> </span><span class="crayon-p"># split id from description</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-49"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-50"><span class="crayon-h"> </span><span class="crayon-p"># skip images not in the set</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-51"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-52"><span class="crayon-h"> </span><span class="crayon-p"># create list</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-53"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-54"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-55"><span class="crayon-h"> </span><span class="crayon-p"># wrap description in tokens</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-56"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' endseq'</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-57"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-58"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-59"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-60"> </div><div class="crayon-line" id="crayon-5c0ca37331627882467475-61"><span class="crayon-p"># load photo features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-62"><span class="crayon-e">def </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-63"><span class="crayon-h"> </span><span class="crayon-p"># load all features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-64"><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load</span><span class="crayon-sy">(</span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'rb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-65"><span class="crayon-h"> </span><span class="crayon-p"># filter features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-66"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">k</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">k</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-67"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-68"> </div><div class="crayon-line" id="crayon-5c0ca37331627882467475-69"><span class="crayon-p"># covert a dictionary of clean descriptions to a list of descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-70"><span class="crayon-e">def </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-71"><span class="crayon-h"> </span><span class="crayon-v">all_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-72"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">key </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">keys</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-73"><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">all_desc</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-74"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">all_desc</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-75"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-76"><span class="crayon-p"># fit a tokenizer given caption descriptions</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-77"><span class="crayon-e">def </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-78"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-79"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Tokenizer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-80"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">fit_on_texts</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-81"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-82"> </div><div class="crayon-line" id="crayon-5c0ca37331627882467475-83"><span class="crayon-p"># calculate the length of the description with the most words</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-84"><span class="crayon-e">def </span><span class="crayon-e">max_length</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-85"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-86"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">max</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-87"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-88"><span class="crayon-p"># create sequences of images, input sequences and output words for an image</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-89"><span class="crayon-e">def </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photo</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-90"><span class="crayon-h"> </span><span class="crayon-v">X1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-91"><span class="crayon-h"> </span><span class="crayon-p"># walk through each description for the image</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-92"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-93"><span class="crayon-h"> </span><span class="crayon-p"># encode the sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-94"><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">desc</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-95"><span class="crayon-h"> </span><span class="crayon-p"># split one sequence into multiple X,y pairs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-96"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">seq</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-97"><span class="crayon-h"> </span><span class="crayon-p"># split into input and output pair</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-98"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-99"><span class="crayon-h"> </span><span class="crayon-p"># pad input sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-100"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-101"><span class="crayon-h"> </span><span class="crayon-p"># encode output sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-102"><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">out_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-103"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-104"><span class="crayon-h"> </span><span class="crayon-v">X1</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">photo</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-105"><span class="crayon-h"> </span><span class="crayon-v">X2</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">in_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-106"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">out_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-107"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X1</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X2</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-108"> </div><div class="crayon-line" id="crayon-5c0ca37331627882467475-109"><span class="crayon-p"># define the captioning model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-110"><span class="crayon-e">def </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-111"><span class="crayon-h"> </span><span class="crayon-p"># feature extractor model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-112"><span class="crayon-h"> </span><span class="crayon-v">inputs1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">4096</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-113"><span class="crayon-h"> </span><span class="crayon-v">fe1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dropout</span><span class="crayon-sy">(</span><span class="crayon-cn">0.5</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-114"><span class="crayon-h"> </span><span class="crayon-v">fe2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-115"><span class="crayon-h"> </span><span class="crayon-p"># sequence model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-116"><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-117"><span class="crayon-h"> </span><span class="crayon-v">se1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Embedding</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask_zero</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-118"><span class="crayon-h"> </span><span class="crayon-v">se2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dropout</span><span class="crayon-sy">(</span><span class="crayon-cn">0.5</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">se1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-119"><span class="crayon-h"> </span><span class="crayon-v">se3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">se2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-120"><span class="crayon-h"> </span><span class="crayon-p"># decoder model</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-121"><span class="crayon-h"> </span><span class="crayon-v">decoder1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">fe2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">se3</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-122"><span class="crayon-h"> </span><span class="crayon-v">decoder2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">decoder1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-123"><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">decoder2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-124"><span class="crayon-h"> </span><span class="crayon-p"># tie it together [image, seq] [word]</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-125"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">inputs1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">outputs</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-126"><span class="crayon-h"> </span><span class="crayon-p"># compile model</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-127"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-128"><span class="crayon-h"> </span><span class="crayon-p"># summarize model</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-129"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">summary</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-130"><span class="crayon-h"> </span><span class="crayon-e">plot_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">to_file</span><span class="crayon-o">=</span><span class="crayon-s">'model.png'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">show_shapes</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-131"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-132"> </div><div class="crayon-line" id="crayon-5c0ca37331627882467475-133"><span class="crayon-p"># data generator, intended to be used in a call to model.fit_generator()</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-134"><span class="crayon-e">def </span><span class="crayon-e">data_generator</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-135"><span class="crayon-h"> </span><span class="crayon-p"># loop for ever over images</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-136"><span class="crayon-h"> </span><span class="crayon-st">while</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-137"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc_list </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-138"><span class="crayon-h"> </span><span class="crayon-p"># retrieve the photo feature</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-139"><span class="crayon-h"> </span><span class="crayon-v">photo</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-140"><span class="crayon-h"> </span><span class="crayon-v">in_img</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_word</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photo</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-141"><span class="crayon-h"> </span><span class="crayon-i">yield</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-v">in_img</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_word</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-142"> </div><div class="crayon-line" id="crayon-5c0ca37331627882467475-143"><span class="crayon-p"># load training dataset (6K)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-144"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr_8k.trainImages.txt'</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-145"><span class="crayon-v">train</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-146"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Dataset: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-147"><span class="crayon-p"># descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-148"><span class="crayon-v">train_descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-149"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Descriptions: train=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-150"><span class="crayon-p"># photo features</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-151"><span class="crayon-v">train_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-s">'features.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-152"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Photos: train=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-153"><span class="crayon-p"># prepare tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-154"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-155"><span class="crayon-v">vocab_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-156"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-157"><span class="crayon-p"># determine the maximum sequence length</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-158"><span class="crayon-v">max_length</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">max_length</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-159"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Description Length: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-160"> </div><div class="crayon-line" id="crayon-5c0ca37331627882467475-161"><span class="crayon-p"># define the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-162"><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-163"><span class="crayon-p"># train the model, run epochs manually and save after each epoch</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-164"><span class="crayon-v">epochs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">20</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-165"><span class="crayon-v">steps</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-166"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">epochs</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-167"><span class="crayon-h"> </span><span class="crayon-p"># create the data generator</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-168"><span class="crayon-h"> </span><span class="crayon-v">generator</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">data_generator</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-169"><span class="crayon-h"> </span><span class="crayon-p"># fit for one epoch</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-170"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit_generator</span><span class="crayon-sy">(</span><span class="crayon-v">generator</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">steps_per_epoch</span><span class="crayon-o">=</span><span class="crayon-v">steps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331627882467475-171"><span class="crayon-h"> </span><span class="crayon-p"># save model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331627882467475-172"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">save</span><span class="crayon-sy">(</span><span class="crayon-s">'model_'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">str</span><span class="crayon-sy">(</span><span class="crayon-v">i</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'.h5'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0078 seconds] -->
<p>Did you use this new addition to the tutorial?</p>
<p>How did you go?</p>
<h2>Evaluate Model</h2>
<p>Once the model is fit, we can evaluate the skill of its predictions on the holdout test dataset.</p>
<p>We will evaluate a model by generating descriptions for all photos in the test dataset and evaluating those predictions with a standard cost function.</p>
<p>First, we need to be able to generate a description for a photo using a trained model.</p>
<p>This involves passing in the start description token ‘<em>startseq</em>‘, generating one word, then calling the model recursively with generated words as input until the end of sequence token is reached ‘<em>endseq</em>‘ or the maximum description length is reached.</p>
<p>The function below named <em>generate_desc()</em> implements this behavior and generates a textual description given a trained model, and a given prepared photo as input. It calls the function <em>word_for_id()</em> in order to map an integer prediction back to a word.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca3733162a570502872" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# map an integer to a word
def word_for_id(integer, tokenizer):
	for word, index in tokenizer.word_index.items():
		if index == integer:
			return word
	return None

# generate a description for an image
def generate_desc(model, tokenizer, photo, max_length):
	# seed the generation process
	in_text = 'startseq'
	# iterate over the whole length of the sequence
	for i in range(max_length):
		# integer encode input sequence
		sequence = tokenizer.texts_to_sequences([in_text])[0]
		# pad input
		sequence = pad_sequences([sequence], maxlen=max_length)
		# predict next word
		yhat = model.predict([photo,sequence], verbose=0)
		# convert probability to integer
		yhat = argmax(yhat)
		# map integer to word
		word = word_for_id(yhat, tokenizer)
		# stop if we cannot map the word
		if word is None:
			break
		# append as input for generating the next word
		in_text += ' ' + word
		# stop if we predict the end of the sequence
		if word == 'endseq':
			break
	return in_text</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca3733162a570502872-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162a570502872-2">2</div><div class="crayon-num" data-line="crayon-5c0ca3733162a570502872-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162a570502872-4">4</div><div class="crayon-num" data-line="crayon-5c0ca3733162a570502872-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162a570502872-6">6</div><div class="crayon-num" data-line="crayon-5c0ca3733162a570502872-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162a570502872-8">8</div><div class="crayon-num" data-line="crayon-5c0ca3733162a570502872-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162a570502872-10">10</div><div class="crayon-num" data-line="crayon-5c0ca3733162a570502872-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162a570502872-12">12</div><div class="crayon-num" data-line="crayon-5c0ca3733162a570502872-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162a570502872-14">14</div><div class="crayon-num" data-line="crayon-5c0ca3733162a570502872-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162a570502872-16">16</div><div class="crayon-num" data-line="crayon-5c0ca3733162a570502872-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162a570502872-18">18</div><div class="crayon-num" data-line="crayon-5c0ca3733162a570502872-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162a570502872-20">20</div><div class="crayon-num" data-line="crayon-5c0ca3733162a570502872-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162a570502872-22">22</div><div class="crayon-num" data-line="crayon-5c0ca3733162a570502872-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162a570502872-24">24</div><div class="crayon-num" data-line="crayon-5c0ca3733162a570502872-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162a570502872-26">26</div><div class="crayon-num" data-line="crayon-5c0ca3733162a570502872-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162a570502872-28">28</div><div class="crayon-num" data-line="crayon-5c0ca3733162a570502872-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162a570502872-30">30</div><div class="crayon-num" data-line="crayon-5c0ca3733162a570502872-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162a570502872-32">32</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca3733162a570502872-1"><span class="crayon-p"># map an integer to a word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162a570502872-2"><span class="crayon-e">def </span><span class="crayon-e">word_for_id</span><span class="crayon-sy">(</span><span class="crayon-t">integer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733162a570502872-3"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">index </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162a570502872-4"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">index</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-t">integer</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733162a570502872-5"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162a570502872-6"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">None</span></div><div class="crayon-line" id="crayon-5c0ca3733162a570502872-7"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162a570502872-8"><span class="crayon-p"># generate a description for an image</span></div><div class="crayon-line" id="crayon-5c0ca3733162a570502872-9"><span class="crayon-e">def </span><span class="crayon-e">generate_desc</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photo</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162a570502872-10"><span class="crayon-h"> </span><span class="crayon-p"># seed the generation process</span></div><div class="crayon-line" id="crayon-5c0ca3733162a570502872-11"><span class="crayon-h"> </span><span class="crayon-v">in_text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162a570502872-12"><span class="crayon-h"> </span><span class="crayon-p"># iterate over the whole length of the sequence</span></div><div class="crayon-line" id="crayon-5c0ca3733162a570502872-13"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162a570502872-14"><span class="crayon-h"> </span><span class="crayon-p"># integer encode input sequence</span></div><div class="crayon-line" id="crayon-5c0ca3733162a570502872-15"><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_text</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162a570502872-16"><span class="crayon-h"> </span><span class="crayon-p"># pad input</span></div><div class="crayon-line" id="crayon-5c0ca3733162a570502872-17"><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">sequence</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162a570502872-18"><span class="crayon-h"> </span><span class="crayon-p"># predict next word</span></div><div class="crayon-line" id="crayon-5c0ca3733162a570502872-19"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">photo</span><span class="crayon-sy">,</span><span class="crayon-v">sequence</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162a570502872-20"><span class="crayon-h"> </span><span class="crayon-p"># convert probability to integer</span></div><div class="crayon-line" id="crayon-5c0ca3733162a570502872-21"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">argmax</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162a570502872-22"><span class="crayon-h"> </span><span class="crayon-p"># map integer to word</span></div><div class="crayon-line" id="crayon-5c0ca3733162a570502872-23"><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">word_for_id</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162a570502872-24"><span class="crayon-h"> </span><span class="crayon-p"># stop if we cannot map the word</span></div><div class="crayon-line" id="crayon-5c0ca3733162a570502872-25"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-v">None</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162a570502872-26"><span class="crayon-h"> </span><span class="crayon-st">break</span></div><div class="crayon-line" id="crayon-5c0ca3733162a570502872-27"><span class="crayon-h"> </span><span class="crayon-p"># append as input for generating the next word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162a570502872-28"><span class="crayon-h"> </span><span class="crayon-v">in_text</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-t">word</span></div><div class="crayon-line" id="crayon-5c0ca3733162a570502872-29"><span class="crayon-h"> </span><span class="crayon-p"># stop if we predict the end of the sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162a570502872-30"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">'endseq'</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733162a570502872-31"><span class="crayon-h"> </span><span class="crayon-st">break</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162a570502872-32"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">in_text</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0013 seconds] -->
<p>We will generate predictions for all photos in the test dataset and in the train dataset.</p>
<p>The function below named <em>evaluate_model()</em> will evaluate a trained model against a given dataset of photo descriptions and photo features. The actual and predicted descriptions are collected and evaluated collectively using the corpus BLEU score that summarizes how close the generated text is to the expected text.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca3733162c221263750" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# evaluate the skill of the model
def evaluate_model(model, descriptions, photos, tokenizer, max_length):
	actual, predicted = list(), list()
	# step over the whole set
	for key, desc_list in descriptions.items():
		# generate description
		yhat = generate_desc(model, tokenizer, photos[key], max_length)
		# store actual and predicted
		references = [d.split() for d in desc_list]
		actual.append(references)
		predicted.append(yhat.split())
	# calculate BLEU score
	print('BLEU-1: %f' % corpus_bleu(actual, predicted, weights=(1.0, 0, 0, 0)))
	print('BLEU-2: %f' % corpus_bleu(actual, predicted, weights=(0.5, 0.5, 0, 0)))
	print('BLEU-3: %f' % corpus_bleu(actual, predicted, weights=(0.3, 0.3, 0.3, 0)))
	print('BLEU-4: %f' % corpus_bleu(actual, predicted, weights=(0.25, 0.25, 0.25, 0.25)))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca3733162c221263750-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162c221263750-2">2</div><div class="crayon-num" data-line="crayon-5c0ca3733162c221263750-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162c221263750-4">4</div><div class="crayon-num" data-line="crayon-5c0ca3733162c221263750-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162c221263750-6">6</div><div class="crayon-num" data-line="crayon-5c0ca3733162c221263750-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162c221263750-8">8</div><div class="crayon-num" data-line="crayon-5c0ca3733162c221263750-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162c221263750-10">10</div><div class="crayon-num" data-line="crayon-5c0ca3733162c221263750-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162c221263750-12">12</div><div class="crayon-num" data-line="crayon-5c0ca3733162c221263750-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162c221263750-14">14</div><div class="crayon-num" data-line="crayon-5c0ca3733162c221263750-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162c221263750-16">16</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca3733162c221263750-1"><span class="crayon-p"># evaluate the skill of the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162c221263750-2"><span class="crayon-e">def </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733162c221263750-3"><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162c221263750-4"><span class="crayon-h"> </span><span class="crayon-p"># step over the whole set</span></div><div class="crayon-line" id="crayon-5c0ca3733162c221263750-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc_list </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162c221263750-6"><span class="crayon-h"> </span><span class="crayon-p"># generate description</span></div><div class="crayon-line" id="crayon-5c0ca3733162c221263750-7"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_desc</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162c221263750-8"><span class="crayon-h"> </span><span class="crayon-p"># store actual and predicted</span></div><div class="crayon-line" id="crayon-5c0ca3733162c221263750-9"><span class="crayon-h"> </span><span class="crayon-v">references</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">d</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162c221263750-10"><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">references</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162c221263750-11"><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162c221263750-12"><span class="crayon-h"> </span><span class="crayon-p"># calculate BLEU score</span></div><div class="crayon-line" id="crayon-5c0ca3733162c221263750-13"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'BLEU-1: %f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">corpus_bleu</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">1.0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162c221263750-14"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'BLEU-2: %f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">corpus_bleu</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">0.5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162c221263750-15"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'BLEU-3: %f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">corpus_bleu</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">0.3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162c221263750-16"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'BLEU-4: %f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">corpus_bleu</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">0.25</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.25</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.25</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.25</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0015 seconds] -->
<p>BLEU scores are used in text translation for evaluating translated text against one or more reference translations.</p>
<p>Here, we compare each generated description against all of the reference descriptions for the photograph. We then calculate BLEU scores for 1, 2, 3 and 4 cumulative n-grams.</p>
<p>You can learn more about the BLEU score here:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/BLEU">BLEU (bilingual evaluation understudy) on Wikipedia</a></li>
</ul>
<p>The <a href="http://www.nltk.org/api/nltk.translate.html">NLTK Python library implements the BLEU score</a> calculation in the <em>corpus_bleu()</em> function. A higher score close to 1.0 is better, a score closer to zero is worse.</p>
<p>We can put all of this together with the functions from the previous section for loading the data. We first need to load the training dataset in order to prepare a Tokenizer so that we can encode generated words as input sequences for the model. It is critical that we encode the generated words using exactly the same encoding scheme as was used when training the model.</p>
<p>We then use these functions for loading the test dataset.</p>
<p>The complete example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca3733162f634619545" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from numpy import argmax
from pickle import load
from keras.preprocessing.text import Tokenizer
from keras.preprocessing.sequence import pad_sequences
from keras.models import load_model
from nltk.translate.bleu_score import corpus_bleu

# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# load a pre-defined list of photo identifiers
def load_set(filename):
	doc = load_doc(filename)
	dataset = list()
	# process line by line
	for line in doc.split('\n'):
		# skip empty lines
		if len(line) &lt; 1:
			continue
		# get the image identifier
		identifier = line.split('.')[0]
		dataset.append(identifier)
	return set(dataset)

# load clean descriptions into memory
def load_clean_descriptions(filename, dataset):
	# load document
	doc = load_doc(filename)
	descriptions = dict()
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		# split id from description
		image_id, image_desc = tokens[0], tokens[1:]
		# skip images not in the set
		if image_id in dataset:
			# create list
			if image_id not in descriptions:
				descriptions[image_id] = list()
			# wrap description in tokens
			desc = 'startseq ' + ' '.join(image_desc) + ' endseq'
			# store
			descriptions[image_id].append(desc)
	return descriptions

# load photo features
def load_photo_features(filename, dataset):
	# load all features
	all_features = load(open(filename, 'rb'))
	# filter features
	features = {k: all_features[k] for k in dataset}
	return features

# covert a dictionary of clean descriptions to a list of descriptions
def to_lines(descriptions):
	all_desc = list()
	for key in descriptions.keys():
		[all_desc.append(d) for d in descriptions[key]]
	return all_desc

# fit a tokenizer given caption descriptions
def create_tokenizer(descriptions):
	lines = to_lines(descriptions)
	tokenizer = Tokenizer()
	tokenizer.fit_on_texts(lines)
	return tokenizer

# calculate the length of the description with the most words
def max_length(descriptions):
	lines = to_lines(descriptions)
	return max(len(d.split()) for d in lines)

# map an integer to a word
def word_for_id(integer, tokenizer):
	for word, index in tokenizer.word_index.items():
		if index == integer:
			return word
	return None

# generate a description for an image
def generate_desc(model, tokenizer, photo, max_length):
	# seed the generation process
	in_text = 'startseq'
	# iterate over the whole length of the sequence
	for i in range(max_length):
		# integer encode input sequence
		sequence = tokenizer.texts_to_sequences([in_text])[0]
		# pad input
		sequence = pad_sequences([sequence], maxlen=max_length)
		# predict next word
		yhat = model.predict([photo,sequence], verbose=0)
		# convert probability to integer
		yhat = argmax(yhat)
		# map integer to word
		word = word_for_id(yhat, tokenizer)
		# stop if we cannot map the word
		if word is None:
			break
		# append as input for generating the next word
		in_text += ' ' + word
		# stop if we predict the end of the sequence
		if word == 'endseq':
			break
	return in_text

# evaluate the skill of the model
def evaluate_model(model, descriptions, photos, tokenizer, max_length):
	actual, predicted = list(), list()
	# step over the whole set
	for key, desc_list in descriptions.items():
		# generate description
		yhat = generate_desc(model, tokenizer, photos[key], max_length)
		# store actual and predicted
		references = [d.split() for d in desc_list]
		actual.append(references)
		predicted.append(yhat.split())
	# calculate BLEU score
	print('BLEU-1: %f' % corpus_bleu(actual, predicted, weights=(1.0, 0, 0, 0)))
	print('BLEU-2: %f' % corpus_bleu(actual, predicted, weights=(0.5, 0.5, 0, 0)))
	print('BLEU-3: %f' % corpus_bleu(actual, predicted, weights=(0.3, 0.3, 0.3, 0)))
	print('BLEU-4: %f' % corpus_bleu(actual, predicted, weights=(0.25, 0.25, 0.25, 0.25)))

# prepare tokenizer on train set

# load training dataset (6K)
filename = 'Flickr8k_text/Flickr_8k.trainImages.txt'
train = load_set(filename)
print('Dataset: %d' % len(train))
# descriptions
train_descriptions = load_clean_descriptions('descriptions.txt', train)
print('Descriptions: train=%d' % len(train_descriptions))
# prepare tokenizer
tokenizer = create_tokenizer(train_descriptions)
vocab_size = len(tokenizer.word_index) + 1
print('Vocabulary Size: %d' % vocab_size)
# determine the maximum sequence length
max_length = max_length(train_descriptions)
print('Description Length: %d' % max_length)

# prepare test set

# load test set
filename = 'Flickr8k_text/Flickr_8k.testImages.txt'
test = load_set(filename)
print('Dataset: %d' % len(test))
# descriptions
test_descriptions = load_clean_descriptions('descriptions.txt', test)
print('Descriptions: test=%d' % len(test_descriptions))
# photo features
test_features = load_photo_features('features.pkl', test)
print('Photos: test=%d' % len(test_features))

# load the model
filename = 'model-ep002-loss3.245-val_loss3.612.h5'
model = load_model(filename)
# evaluate model
evaluate_model(model, test_descriptions, test_features, tokenizer, max_length)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-2">2</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-4">4</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-6">6</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-8">8</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-10">10</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-12">12</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-14">14</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-16">16</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-18">18</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-20">20</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-22">22</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-24">24</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-26">26</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-28">28</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-30">30</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-32">32</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-34">34</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-36">36</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-38">38</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-40">40</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-42">42</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-44">44</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-46">46</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-48">48</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-50">50</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-52">52</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-54">54</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-56">56</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-58">58</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-60">60</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-62">62</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-64">64</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-66">66</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-68">68</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-70">70</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-72">72</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-74">74</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-76">76</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-78">78</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-80">80</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-82">82</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-84">84</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-86">86</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-88">88</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-90">90</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-92">92</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-94">94</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-96">96</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-98">98</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-100">100</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-101">101</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-102">102</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-103">103</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-104">104</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-105">105</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-106">106</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-107">107</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-108">108</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-109">109</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-110">110</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-111">111</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-112">112</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-113">113</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-114">114</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-115">115</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-116">116</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-117">117</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-118">118</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-119">119</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-120">120</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-121">121</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-122">122</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-123">123</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-124">124</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-125">125</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-126">126</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-127">127</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-128">128</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-129">129</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-130">130</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-131">131</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-132">132</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-133">133</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-134">134</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-135">135</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-136">136</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-137">137</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-138">138</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-139">139</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-140">140</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-141">141</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-142">142</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-143">143</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-144">144</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-145">145</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-146">146</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-147">147</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-148">148</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-149">149</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-150">150</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-151">151</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-152">152</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-153">153</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-154">154</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-155">155</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-156">156</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-157">157</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-158">158</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-159">159</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-160">160</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-161">161</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-162">162</div><div class="crayon-num" data-line="crayon-5c0ca3733162f634619545-163">163</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733162f634619545-164">164</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca3733162f634619545-1"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">argmax</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-2"><span class="crayon-e">from </span><span class="crayon-e">pickle </span><span class="crayon-e">import </span><span class="crayon-e">load</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-3"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">text </span><span class="crayon-e">import </span><span class="crayon-e">Tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-4"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">sequence </span><span class="crayon-e">import </span><span class="crayon-e">pad_sequences</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-5"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-e">load_model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-6"><span class="crayon-e">from </span><span class="crayon-v">nltk</span><span class="crayon-sy">.</span><span class="crayon-v">translate</span><span class="crayon-sy">.</span><span class="crayon-e">bleu_score </span><span class="crayon-e">import </span><span class="crayon-v">corpus_bleu</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-7"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-8"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-9"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-10"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-11"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-12"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-13"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-14"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-15"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-16"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-17"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-18"><span class="crayon-p"># load a pre-defined list of photo identifiers</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-19"><span class="crayon-e">def </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-20"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-21"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-22"><span class="crayon-h"> </span><span class="crayon-p"># process line by line</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-23"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-24"><span class="crayon-h"> </span><span class="crayon-p"># skip empty lines</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-25"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-26"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-27"><span class="crayon-h"> </span><span class="crayon-p"># get the image identifier</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-28"><span class="crayon-h"> </span><span class="crayon-v">identifier</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-29"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">identifier</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-30"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-31"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-32"><span class="crayon-p"># load clean descriptions into memory</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-33"><span class="crayon-e">def </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-34"><span class="crayon-h"> </span><span class="crayon-p"># load document</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-35"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-36"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-37"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-38"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-39"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-40"><span class="crayon-h"> </span><span class="crayon-p"># split id from description</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-41"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-42"><span class="crayon-h"> </span><span class="crayon-p"># skip images not in the set</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-43"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-44"><span class="crayon-h"> </span><span class="crayon-p"># create list</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-45"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-46"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-47"><span class="crayon-h"> </span><span class="crayon-p"># wrap description in tokens</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-48"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' endseq'</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-49"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-50"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-51"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-52"> </div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-53"><span class="crayon-p"># load photo features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-54"><span class="crayon-e">def </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-55"><span class="crayon-h"> </span><span class="crayon-p"># load all features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-56"><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load</span><span class="crayon-sy">(</span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'rb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-57"><span class="crayon-h"> </span><span class="crayon-p"># filter features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-58"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">k</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">k</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-59"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-60"> </div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-61"><span class="crayon-p"># covert a dictionary of clean descriptions to a list of descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-62"><span class="crayon-e">def </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-63"><span class="crayon-h"> </span><span class="crayon-v">all_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-64"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">key </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">keys</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-65"><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">all_desc</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-66"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">all_desc</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-67"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-68"><span class="crayon-p"># fit a tokenizer given caption descriptions</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-69"><span class="crayon-e">def </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-70"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-71"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Tokenizer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-72"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">fit_on_texts</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-73"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-74"> </div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-75"><span class="crayon-p"># calculate the length of the description with the most words</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-76"><span class="crayon-e">def </span><span class="crayon-e">max_length</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-77"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-78"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">max</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-79"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-80"><span class="crayon-p"># map an integer to a word</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-81"><span class="crayon-e">def </span><span class="crayon-e">word_for_id</span><span class="crayon-sy">(</span><span class="crayon-t">integer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-82"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">index </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-83"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">index</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-t">integer</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-84"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">word</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-85"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">None</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-86"> </div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-87"><span class="crayon-p"># generate a description for an image</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-88"><span class="crayon-e">def </span><span class="crayon-e">generate_desc</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photo</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-89"><span class="crayon-h"> </span><span class="crayon-p"># seed the generation process</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-90"><span class="crayon-h"> </span><span class="crayon-v">in_text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq'</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-91"><span class="crayon-h"> </span><span class="crayon-p"># iterate over the whole length of the sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-92"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-93"><span class="crayon-h"> </span><span class="crayon-p"># integer encode input sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-94"><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_text</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-95"><span class="crayon-h"> </span><span class="crayon-p"># pad input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-96"><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">sequence</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-97"><span class="crayon-h"> </span><span class="crayon-p"># predict next word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-98"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">photo</span><span class="crayon-sy">,</span><span class="crayon-v">sequence</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-99"><span class="crayon-h"> </span><span class="crayon-p"># convert probability to integer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-100"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">argmax</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-101"><span class="crayon-h"> </span><span class="crayon-p"># map integer to word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-102"><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">word_for_id</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-103"><span class="crayon-h"> </span><span class="crayon-p"># stop if we cannot map the word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-104"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-v">None</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-105"><span class="crayon-h"> </span><span class="crayon-st">break</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-106"><span class="crayon-h"> </span><span class="crayon-p"># append as input for generating the next word</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-107"><span class="crayon-h"> </span><span class="crayon-v">in_text</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-t">word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-108"><span class="crayon-h"> </span><span class="crayon-p"># stop if we predict the end of the sequence</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-109"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">'endseq'</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-110"><span class="crayon-h"> </span><span class="crayon-st">break</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-111"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">in_text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-112"> </div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-113"><span class="crayon-p"># evaluate the skill of the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-114"><span class="crayon-e">def </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-115"><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-116"><span class="crayon-h"> </span><span class="crayon-p"># step over the whole set</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-117"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc_list </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-118"><span class="crayon-h"> </span><span class="crayon-p"># generate description</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-119"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_desc</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-120"><span class="crayon-h"> </span><span class="crayon-p"># store actual and predicted</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-121"><span class="crayon-h"> </span><span class="crayon-v">references</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">d</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-122"><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">references</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-123"><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-124"><span class="crayon-h"> </span><span class="crayon-p"># calculate BLEU score</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-125"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'BLEU-1: %f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">corpus_bleu</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">1.0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-126"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'BLEU-2: %f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">corpus_bleu</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">0.5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-127"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'BLEU-3: %f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">corpus_bleu</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">0.3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-128"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'BLEU-4: %f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">corpus_bleu</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">0.25</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.25</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.25</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.25</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-129"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-130"><span class="crayon-p"># prepare tokenizer on train set</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-131"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-132"><span class="crayon-p"># load training dataset (6K)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-133"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr_8k.trainImages.txt'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-134"><span class="crayon-v">train</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-135"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Dataset: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-136"><span class="crayon-p"># descriptions</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-137"><span class="crayon-v">train_descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-138"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Descriptions: train=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-139"><span class="crayon-p"># prepare tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-140"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-141"><span class="crayon-v">vocab_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-142"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-143"><span class="crayon-p"># determine the maximum sequence length</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-144"><span class="crayon-v">max_length</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">max_length</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-145"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Description Length: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-146"> </div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-147"><span class="crayon-p"># prepare test set</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-148"> </div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-149"><span class="crayon-p"># load test set</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-150"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr_8k.testImages.txt'</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-151"><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-152"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Dataset: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-153"><span class="crayon-p"># descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-154"><span class="crayon-v">test_descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-155"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Descriptions: test=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-156"><span class="crayon-p"># photo features</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-157"><span class="crayon-v">test_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-s">'features.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-158"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Photos: test=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-159"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-160"><span class="crayon-p"># load the model</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-161"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'model-ep002-loss3.245-val_loss3.612.h5'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-162"><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_model</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733162f634619545-163"><span class="crayon-p"># evaluate model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733162f634619545-164"><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0070 seconds] -->
<p>Running the example prints the BLEU scores.</p>
<p>We can see that the scores fit within and close to the top of the expected range of a skillful model on the problem. The chosen model configuration is by no means optimized.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca37331631565252474" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
BLEU-1: 0.579114
BLEU-2: 0.344856
BLEU-3: 0.252154
BLEU-4: 0.131446</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca37331631565252474-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331631565252474-2">2</div><div class="crayon-num" data-line="crayon-5c0ca37331631565252474-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331631565252474-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca37331631565252474-1">BLEU-1: 0.579114</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331631565252474-2">BLEU-2: 0.344856</div><div class="crayon-line" id="crayon-5c0ca37331631565252474-3">BLEU-3: 0.252154</div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331631565252474-4">BLEU-4: 0.131446</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p></p>
<h2>Generate New Captions</h2>
<p>Now that we know how to develop and evaluate a caption generation model, how can we use it?</p>
<p>Almost everything we need to generate captions for entirely new photographs is in the model file.</p>
<p>We also need the Tokenizer for encoding generated words for the model while generating a sequence, and the maximum length of input sequences, used when we defined the model (e.g. 34).</p>
<p>We can hard code the maximum sequence length. With the encoding of text, we can create the tokenizer and save it to a file so that we can load it quickly whenever we need it without needing the entire Flickr8K dataset. An alternative would be to use our own vocabulary file and mapping to integers function during training.</p>
<p>We can create the Tokenizer as before and save it as a pickle file <em>tokenizer.pkl</em>. The complete example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca37331634524983453" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from keras.preprocessing.text import Tokenizer
from pickle import dump

# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# load a pre-defined list of photo identifiers
def load_set(filename):
	doc = load_doc(filename)
	dataset = list()
	# process line by line
	for line in doc.split('\n'):
		# skip empty lines
		if len(line) &lt; 1:
			continue
		# get the image identifier
		identifier = line.split('.')[0]
		dataset.append(identifier)
	return set(dataset)

# load clean descriptions into memory
def load_clean_descriptions(filename, dataset):
	# load document
	doc = load_doc(filename)
	descriptions = dict()
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		# split id from description
		image_id, image_desc = tokens[0], tokens[1:]
		# skip images not in the set
		if image_id in dataset:
			# create list
			if image_id not in descriptions:
				descriptions[image_id] = list()
			# wrap description in tokens
			desc = 'startseq ' + ' '.join(image_desc) + ' endseq'
			# store
			descriptions[image_id].append(desc)
	return descriptions

# covert a dictionary of clean descriptions to a list of descriptions
def to_lines(descriptions):
	all_desc = list()
	for key in descriptions.keys():
		[all_desc.append(d) for d in descriptions[key]]
	return all_desc

# fit a tokenizer given caption descriptions
def create_tokenizer(descriptions):
	lines = to_lines(descriptions)
	tokenizer = Tokenizer()
	tokenizer.fit_on_texts(lines)
	return tokenizer

# load training dataset (6K)
filename = 'Flickr8k_text/Flickr_8k.trainImages.txt'
train = load_set(filename)
print('Dataset: %d' % len(train))
# descriptions
train_descriptions = load_clean_descriptions('descriptions.txt', train)
print('Descriptions: train=%d' % len(train_descriptions))
# prepare tokenizer
tokenizer = create_tokenizer(train_descriptions)
# save the tokenizer
dump(tokenizer, open('tokenizer.pkl', 'wb'))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-2">2</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-4">4</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-6">6</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-8">8</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-10">10</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-12">12</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-14">14</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-16">16</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-18">18</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-20">20</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-22">22</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-24">24</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-26">26</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-28">28</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-30">30</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-32">32</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-34">34</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-36">36</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-38">38</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-40">40</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-42">42</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-44">44</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-46">46</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-48">48</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-50">50</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-52">52</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-54">54</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-56">56</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-58">58</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-60">60</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-62">62</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-64">64</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-66">66</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-68">68</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-70">70</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331634524983453-72">72</div><div class="crayon-num" data-line="crayon-5c0ca37331634524983453-73">73</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca37331634524983453-1"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">text </span><span class="crayon-e">import </span><span class="crayon-e">Tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-2"><span class="crayon-e">from </span><span class="crayon-e">pickle </span><span class="crayon-e">import </span><span class="crayon-v">dump</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-3"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-4"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-5"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-6"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-7"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-8"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-9"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-10"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-11"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-12"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-13"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-14"><span class="crayon-p"># load a pre-defined list of photo identifiers</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-15"><span class="crayon-e">def </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-16"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-17"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-18"><span class="crayon-h"> </span><span class="crayon-p"># process line by line</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-19"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-20"><span class="crayon-h"> </span><span class="crayon-p"># skip empty lines</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-21"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-22"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-23"><span class="crayon-h"> </span><span class="crayon-p"># get the image identifier</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-24"><span class="crayon-h"> </span><span class="crayon-v">identifier</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-25"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">identifier</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-26"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-27"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-28"><span class="crayon-p"># load clean descriptions into memory</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-29"><span class="crayon-e">def </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-30"><span class="crayon-h"> </span><span class="crayon-p"># load document</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-31"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-32"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-33"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-34"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-35"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-36"><span class="crayon-h"> </span><span class="crayon-p"># split id from description</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-37"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-38"><span class="crayon-h"> </span><span class="crayon-p"># skip images not in the set</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-39"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-40"><span class="crayon-h"> </span><span class="crayon-p"># create list</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-41"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-42"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-43"><span class="crayon-h"> </span><span class="crayon-p"># wrap description in tokens</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-44"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' endseq'</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-45"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-46"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-47"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-48"> </div><div class="crayon-line" id="crayon-5c0ca37331634524983453-49"><span class="crayon-p"># covert a dictionary of clean descriptions to a list of descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-50"><span class="crayon-e">def </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-51"><span class="crayon-h"> </span><span class="crayon-v">all_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-52"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">key </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">keys</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-53"><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">all_desc</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-54"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">all_desc</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-55"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-56"><span class="crayon-p"># fit a tokenizer given caption descriptions</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-57"><span class="crayon-e">def </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-58"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-59"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Tokenizer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-60"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">fit_on_texts</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-61"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-62"> </div><div class="crayon-line" id="crayon-5c0ca37331634524983453-63"><span class="crayon-p"># load training dataset (6K)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-64"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr_8k.trainImages.txt'</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-65"><span class="crayon-v">train</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-66"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Dataset: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-67"><span class="crayon-p"># descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-68"><span class="crayon-v">train_descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-69"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Descriptions: train=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-70"><span class="crayon-p"># prepare tokenizer</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-71"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331634524983453-72"><span class="crayon-p"># save the tokenizer</span></div><div class="crayon-line" id="crayon-5c0ca37331634524983453-73"><span class="crayon-e">dump</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-s">'tokenizer.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'wb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0028 seconds] -->
<p>We can now load the tokenizer whenever we need it without having to load the entire training dataset of annotations.</p>
<p>Now, let’s generate a description for a new photograph.</p>
<p>Below is a new photograph that I chose randomly on Flickr (available under a permissive license).</p>
<div class="wp-caption aligncenter" id="attachment_4462" style="width: 650px"><img alt="Photo of a dog at the beach." class="size-full wp-image-4462" height="512" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/example.jpg" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/example.jpg 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/example-300x240.jpg 300w" width="640"/><p class="wp-caption-text">Photo of a dog at the beach.<br/>Photo by <a href="https://www.flickr.com/photos/bambe1964/7837618434/">bambe1964</a>, some rights reserved.</p></div>
<p>We will generate a description for it using our model.</p>
<p>Download the photograph and save it to your local directory with the filename “<em>example.jpg</em>“.</p>
<p>First, we must load the Tokenizer from <em>tokenizer.pkl</em> and define the maximum length of the sequence to generate, needed for padding inputs.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca37331636420962788" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load the tokenizer
tokenizer = load(open('tokenizer.pkl', 'rb'))
# pre-define the max sequence length (from training)
max_length = 34</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca37331636420962788-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331636420962788-2">2</div><div class="crayon-num" data-line="crayon-5c0ca37331636420962788-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331636420962788-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca37331636420962788-1"><span class="crayon-p"># load the tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331636420962788-2"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load</span><span class="crayon-sy">(</span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-s">'tokenizer.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'rb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca37331636420962788-3"><span class="crayon-p"># pre-define the max sequence length (from training)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331636420962788-4"><span class="crayon-v">max_length</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">34</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>Then we must load the model, as before.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca37331638623444987" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load the model
model = load_model('model-ep002-loss3.245-val_loss3.612.h5')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca37331638623444987-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca37331638623444987-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca37331638623444987-1"><span class="crayon-p"># load the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca37331638623444987-2"><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_model</span><span class="crayon-sy">(</span><span class="crayon-s">'model-ep002-loss3.245-val_loss3.612.h5'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Next, we must load the photo we which to describe and extract the features.</p>
<p>We could do this by re-defining the model and adding the VGG-16 model to it, or we can use the VGG model to predict the features and use them as inputs to our existing model. We will do the latter and use a modified version of the <em>extract_features()</em> function used during data preparation, but adapted to work on a single photo.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca3733163a344781822" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# extract features from each photo in the directory
def extract_features(filename):
	# load the model
	model = VGG16()
	# re-structure the model
	model.layers.pop()
	model = Model(inputs=model.inputs, outputs=model.layers[-1].output)
	# load the photo
	image = load_img(filename, target_size=(224, 224))
	# convert the image pixels to a numpy array
	image = img_to_array(image)
	# reshape data for the model
	image = image.reshape((1, image.shape[0], image.shape[1], image.shape[2]))
	# prepare the image for the VGG model
	image = preprocess_input(image)
	# get features
	feature = model.predict(image, verbose=0)
	return feature

# load and prepare the photograph
photo = extract_features('example.jpg')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca3733163a344781822-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163a344781822-2">2</div><div class="crayon-num" data-line="crayon-5c0ca3733163a344781822-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163a344781822-4">4</div><div class="crayon-num" data-line="crayon-5c0ca3733163a344781822-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163a344781822-6">6</div><div class="crayon-num" data-line="crayon-5c0ca3733163a344781822-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163a344781822-8">8</div><div class="crayon-num" data-line="crayon-5c0ca3733163a344781822-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163a344781822-10">10</div><div class="crayon-num" data-line="crayon-5c0ca3733163a344781822-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163a344781822-12">12</div><div class="crayon-num" data-line="crayon-5c0ca3733163a344781822-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163a344781822-14">14</div><div class="crayon-num" data-line="crayon-5c0ca3733163a344781822-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163a344781822-16">16</div><div class="crayon-num" data-line="crayon-5c0ca3733163a344781822-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163a344781822-18">18</div><div class="crayon-num" data-line="crayon-5c0ca3733163a344781822-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163a344781822-20">20</div><div class="crayon-num" data-line="crayon-5c0ca3733163a344781822-21">21</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca3733163a344781822-1"><span class="crayon-p"># extract features from each photo in the directory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163a344781822-2"><span class="crayon-e">def </span><span class="crayon-e">extract_features</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733163a344781822-3"><span class="crayon-h"> </span><span class="crayon-p"># load the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163a344781822-4"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">VGG16</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733163a344781822-5"><span class="crayon-h"> </span><span class="crayon-p"># re-structure the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163a344781822-6"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">.</span><span class="crayon-e">pop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733163a344781822-7"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">inputs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">output</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163a344781822-8"><span class="crayon-h"> </span><span class="crayon-p"># load the photo</span></div><div class="crayon-line" id="crayon-5c0ca3733163a344781822-9"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_img</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">target_size</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">224</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163a344781822-10"><span class="crayon-h"> </span><span class="crayon-p"># convert the image pixels to a numpy array</span></div><div class="crayon-line" id="crayon-5c0ca3733163a344781822-11"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">img_to_array</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163a344781822-12"><span class="crayon-h"> </span><span class="crayon-p"># reshape data for the model</span></div><div class="crayon-line" id="crayon-5c0ca3733163a344781822-13"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163a344781822-14"><span class="crayon-h"> </span><span class="crayon-p"># prepare the image for the VGG model</span></div><div class="crayon-line" id="crayon-5c0ca3733163a344781822-15"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">preprocess_input</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163a344781822-16"><span class="crayon-h"> </span><span class="crayon-p"># get features</span></div><div class="crayon-line" id="crayon-5c0ca3733163a344781822-17"><span class="crayon-h"> </span><span class="crayon-v">feature</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163a344781822-18"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">feature</span></div><div class="crayon-line" id="crayon-5c0ca3733163a344781822-19"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163a344781822-20"><span class="crayon-p"># load and prepare the photograph</span></div><div class="crayon-line" id="crayon-5c0ca3733163a344781822-21"><span class="crayon-v">photo</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">extract_features</span><span class="crayon-sy">(</span><span class="crayon-s">'example.jpg'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0011 seconds] -->
<p>We can then generate a description using the <em>generate_desc()</em> function defined when evaluating the model.</p>
<p>The complete example for generating a description for an entirely new standalone photograph is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca3733163c255370835" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from pickle import load
from numpy import argmax
from keras.preprocessing.sequence import pad_sequences
from keras.applications.vgg16 import VGG16
from keras.preprocessing.image import load_img
from keras.preprocessing.image import img_to_array
from keras.applications.vgg16 import preprocess_input
from keras.models import Model
from keras.models import load_model

# extract features from each photo in the directory
def extract_features(filename):
	# load the model
	model = VGG16()
	# re-structure the model
	model.layers.pop()
	model = Model(inputs=model.inputs, outputs=model.layers[-1].output)
	# load the photo
	image = load_img(filename, target_size=(224, 224))
	# convert the image pixels to a numpy array
	image = img_to_array(image)
	# reshape data for the model
	image = image.reshape((1, image.shape[0], image.shape[1], image.shape[2]))
	# prepare the image for the VGG model
	image = preprocess_input(image)
	# get features
	feature = model.predict(image, verbose=0)
	return feature

# map an integer to a word
def word_for_id(integer, tokenizer):
	for word, index in tokenizer.word_index.items():
		if index == integer:
			return word
	return None

# generate a description for an image
def generate_desc(model, tokenizer, photo, max_length):
	# seed the generation process
	in_text = 'startseq'
	# iterate over the whole length of the sequence
	for i in range(max_length):
		# integer encode input sequence
		sequence = tokenizer.texts_to_sequences([in_text])[0]
		# pad input
		sequence = pad_sequences([sequence], maxlen=max_length)
		# predict next word
		yhat = model.predict([photo,sequence], verbose=0)
		# convert probability to integer
		yhat = argmax(yhat)
		# map integer to word
		word = word_for_id(yhat, tokenizer)
		# stop if we cannot map the word
		if word is None:
			break
		# append as input for generating the next word
		in_text += ' ' + word
		# stop if we predict the end of the sequence
		if word == 'endseq':
			break
	return in_text

# load the tokenizer
tokenizer = load(open('tokenizer.pkl', 'rb'))
# pre-define the max sequence length (from training)
max_length = 34
# load the model
model = load_model('model-ep002-loss3.245-val_loss3.612.h5')
# load and prepare the photograph
photo = extract_features('example.jpg')
# generate description
description = generate_desc(model, tokenizer, photo, max_length)
print(description)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-2">2</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-4">4</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-6">6</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-8">8</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-10">10</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-12">12</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-14">14</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-16">16</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-18">18</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-20">20</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-22">22</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-24">24</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-26">26</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-28">28</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-30">30</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-32">32</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-34">34</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-36">36</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-38">38</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-40">40</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-42">42</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-44">44</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-46">46</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-48">48</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-50">50</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-52">52</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-54">54</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-56">56</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-58">58</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-60">60</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-62">62</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-64">64</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-66">66</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-68">68</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-70">70</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca3733163c255370835-72">72</div><div class="crayon-num" data-line="crayon-5c0ca3733163c255370835-73">73</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca3733163c255370835-1"><span class="crayon-e">from </span><span class="crayon-e">pickle </span><span class="crayon-e">import </span><span class="crayon-e">load</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-2"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">argmax</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-3"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">sequence </span><span class="crayon-e">import </span><span class="crayon-e">pad_sequences</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-4"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">applications</span><span class="crayon-sy">.</span><span class="crayon-e">vgg16 </span><span class="crayon-e">import </span><span class="crayon-e">VGG16</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-5"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">load_img</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-6"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">img_to_array</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-7"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">applications</span><span class="crayon-sy">.</span><span class="crayon-e">vgg16 </span><span class="crayon-e">import </span><span class="crayon-e">preprocess_input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-8"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-e">Model</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-9"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-v">load_model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-10"> </div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-11"><span class="crayon-p"># extract features from each photo in the directory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-12"><span class="crayon-e">def </span><span class="crayon-e">extract_features</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-13"><span class="crayon-h"> </span><span class="crayon-p"># load the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-14"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">VGG16</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-15"><span class="crayon-h"> </span><span class="crayon-p"># re-structure the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-16"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">.</span><span class="crayon-e">pop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-17"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">inputs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">output</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-18"><span class="crayon-h"> </span><span class="crayon-p"># load the photo</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-19"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_img</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">target_size</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">224</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-20"><span class="crayon-h"> </span><span class="crayon-p"># convert the image pixels to a numpy array</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-21"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">img_to_array</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-22"><span class="crayon-h"> </span><span class="crayon-p"># reshape data for the model</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-23"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-24"><span class="crayon-h"> </span><span class="crayon-p"># prepare the image for the VGG model</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-25"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">preprocess_input</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-26"><span class="crayon-h"> </span><span class="crayon-p"># get features</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-27"><span class="crayon-h"> </span><span class="crayon-v">feature</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-28"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">feature</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-29"> </div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-30"><span class="crayon-p"># map an integer to a word</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-31"><span class="crayon-e">def </span><span class="crayon-e">word_for_id</span><span class="crayon-sy">(</span><span class="crayon-t">integer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-32"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">index </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-33"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">index</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-t">integer</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-34"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">word</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-35"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">None</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-36"> </div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-37"><span class="crayon-p"># generate a description for an image</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-38"><span class="crayon-e">def </span><span class="crayon-e">generate_desc</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photo</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-39"><span class="crayon-h"> </span><span class="crayon-p"># seed the generation process</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-40"><span class="crayon-h"> </span><span class="crayon-v">in_text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq'</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-41"><span class="crayon-h"> </span><span class="crayon-p"># iterate over the whole length of the sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-42"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-43"><span class="crayon-h"> </span><span class="crayon-p"># integer encode input sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-44"><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_text</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-45"><span class="crayon-h"> </span><span class="crayon-p"># pad input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-46"><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">sequence</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-47"><span class="crayon-h"> </span><span class="crayon-p"># predict next word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-48"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">photo</span><span class="crayon-sy">,</span><span class="crayon-v">sequence</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-49"><span class="crayon-h"> </span><span class="crayon-p"># convert probability to integer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-50"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">argmax</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-51"><span class="crayon-h"> </span><span class="crayon-p"># map integer to word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-52"><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">word_for_id</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-53"><span class="crayon-h"> </span><span class="crayon-p"># stop if we cannot map the word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-54"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-v">None</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-55"><span class="crayon-h"> </span><span class="crayon-st">break</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-56"><span class="crayon-h"> </span><span class="crayon-p"># append as input for generating the next word</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-57"><span class="crayon-h"> </span><span class="crayon-v">in_text</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-t">word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-58"><span class="crayon-h"> </span><span class="crayon-p"># stop if we predict the end of the sequence</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-59"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">'endseq'</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-60"><span class="crayon-h"> </span><span class="crayon-st">break</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-61"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">in_text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-62"> </div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-63"><span class="crayon-p"># load the tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-64"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load</span><span class="crayon-sy">(</span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-s">'tokenizer.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'rb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-65"><span class="crayon-p"># pre-define the max sequence length (from training)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-66"><span class="crayon-v">max_length</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">34</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-67"><span class="crayon-p"># load the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-68"><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_model</span><span class="crayon-sy">(</span><span class="crayon-s">'model-ep002-loss3.245-val_loss3.612.h5'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-69"><span class="crayon-p"># load and prepare the photograph</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-70"><span class="crayon-v">photo</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">extract_features</span><span class="crayon-sy">(</span><span class="crayon-s">'example.jpg'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-71"><span class="crayon-p"># generate description</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca3733163c255370835-72"><span class="crayon-v">description</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_desc</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photo</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca3733163c255370835-73"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">description</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0031 seconds] -->
<p>In this case, the description generated was as follows:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca3733163d872585758" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
startseq dog is running across the beach endseq</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca3733163d872585758-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca3733163d872585758-1">startseq dog is running across the beach endseq</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>You could remove the start and end tokens and you would have the basis for a nice automatic photo captioning model.</p>
<p>It’s like living in the future guys!</p>
<p>It still completely blows my mind that we can do this. Wow.</p>
<h2>Extensions</h2>
<p>This section lists some ideas for extending the tutorial that you may wish to explore.</p>
<ul>
<li><strong>Alternate Pre-Trained Photo Models</strong>. A small 16-layer VGG model was used for feature extraction. Consider exploring larger models that offer better performance on the ImageNet dataset, such as Inception.</li>
<li><strong>Smaller Vocabulary</strong>. A larger vocabulary of nearly eight thousand words was used in the development of the model. Many of the words supported may be misspellings or only used once in the entire dataset. Refine the vocabulary and reduce the size, perhaps by half.</li>
<li><strong>Pre-trained Word Vectors</strong>. The model learned the word vectors as part of fitting the model. Better performance may be achieved by using word vectors either pre-trained on the training dataset or trained on a much larger corpus of text, such as news articles or Wikipedia.</li>
<li><strong>Tune Model</strong>. The configuration of the model was not tuned on the problem. Explore alternate configurations and see if you can achieve better performance.</li>
</ul>
<p>Did you try any of these extensions? Share your results in the comments below.</p>
<h2>Further Reading</h2>
<p>This section provides more resources on the topic if you are looking go deeper.</p>
<h3>Caption Generation Papers</h3>
<ul>
<li><a href="https://arxiv.org/abs/1411.4555">Show and Tell: A Neural Image Caption Generator</a>, 2015.</li>
<li><a href="https://arxiv.org/abs/1502.03044">Show, Attend and Tell: Neural Image Caption Generation with Visual Attention</a>, 2015.</li>
<li><a href="https://arxiv.org/abs/1703.09137">Where to put the Image in an Image Caption Generator</a>, 2017.</li>
<li><a href="https://arxiv.org/abs/1708.02043">What is the Role of Recurrent Neural Networks (RNNs) in an Image Caption Generator?</a>, 2017.</li>
<li><a href="https://arxiv.org/abs/1601.03896">Automatic Description Generation from Images: A Survey of Models, Datasets, and Evaluation Measures</a>, 2016.</li>
</ul>
<h3>Flickr8K Dataset</h3>
<ul>
<li><a href="http://nlp.cs.illinois.edu/HockenmaierGroup/Framing_Image_Description/KCCA.html">Framing image description as a ranking task: data, models and evaluation metrics</a> (Homepage)</li>
<li><a href="https://www.jair.org/media/3994/live-3994-7274-jair.pdf">Framing Image Description as a Ranking Task: Data, Models and Evaluation Metrics</a>, (PDF) 2013.</li>
<li><a href="https://illinois.edu/fb/sec/1713398">Dataset Request Form</a></li>
<li><a href="http://nlp.cs.illinois.edu/HockenmaierGroup/8k-pictures.html">Old Flicrk8K Homepage</a></li>
</ul>
<h3>API</h3>
<ul>
<li><a href="https://keras.io/models/model/">Keras Model API</a></li>
<li><a href="https://keras.io/preprocessing/sequence/#pad_sequences">Keras pad_sequences() API</a></li>
<li><a href="https://keras.io/preprocessing/text/#tokenizer">Keras Tokenizer API</a></li>
<li><a href="https://keras.io/applications/#vgg16">Keras VGG16 API</a></li>
<li><a href="https://radimrehurek.com/gensim/models/word2vec.html">Gensim word2vec API</a></li>
<li><a href="http://www.nltk.org/api/nltk.translate.html">nltk.translate package API Documentation</a></li>
</ul>
<h2>Summary</h2>
<p>In this tutorial, you discovered how to develop a photo captioning deep learning model from scratch.</p>
<p>Specifically, you learned:</p>
<ul>
<li>How to prepare photo and text data ready for training a deep learning model.</li>
<li>How to design and train a deep learning caption generation model.</li>
<li>How to evaluate a train caption generation model and use it to caption entirely new photographs.</li>
</ul>
<p>Do you have any questions?<br/>
Ask your questions in the comments below and I will do my best to answer.</p>
<div class="awac-wrapper"><div class="awac widget text-42"> <div class="textwidget"><p></p><center><br/>
<div class="woo-sc-hr"></div>
<h2>Develop Deep Learning models for Text Data Today!</h2>
<p><a href="/deep-learning-for-nlp/"><img align="left" alt="Deep Learning for Natural Language Processing" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/DLFNLP-Cover-220.png" style="border: 0;"/></a></p>
<h4>Develop Your Own Text models in Minutes</h4>
<p>…with just a few lines of python code</p>
<p>Discover how in my new Ebook:<br/>
<a href="/deep-learning-for-nlp/">Deep Learning for Natural Language Processing</a></p>
<p>It provides <strong>self-study tutorials</strong> on topics like:<br/>
<em>Bag-of-Words, Word Embedding, Language Models, Caption Generation, Text Translation</em> and much more…</p>
<h4>Finally Bring Deep Learning to your Natural Language Processing Projects</h4>
<p>Skip the Academics. Just Results.</p>
<p><a href="/deep-learning-for-nlp/">Click to learn more</a>.<br/>
</p><div class="woo-sc-hr"></div><br/>
</center>
</div>
</div></div><div class="simplesocialbuttons simplesocial-simple-icons simplesocialbuttons_inline simplesocialbuttons-align-left post-4459 post simplesocialbuttons-inline-no-animation">
<button class="ssb_tweet-icon" data-href="https://twitter.com/share?text=How+to+Develop+a+Deep+Learning+Photo+Caption+Generator+from+Scratch&amp;url=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/" onclick="javascript:window.open(this.dataset.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;" rel="nofollow">
<span class="icon"><svg viewbox="0 0 72 72" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h72v72H0z" fill="none"></path><path class="icon" d="M68.812 15.14c-2.348 1.04-4.87 1.744-7.52 2.06 2.704-1.62 4.78-4.186 5.757-7.243-2.53 1.5-5.33 2.592-8.314 3.176C56.35 10.59 52.948 9 49.182 9c-7.23 0-13.092 5.86-13.092 13.093 0 1.026.118 2.02.338 2.98C25.543 24.527 15.9 19.318 9.44 11.396c-1.125 1.936-1.77 4.184-1.77 6.58 0 4.543 2.312 8.552 5.824 10.9-2.146-.07-4.165-.658-5.93-1.64-.002.056-.002.11-.002.163 0 6.345 4.513 11.638 10.504 12.84-1.1.298-2.256.457-3.45.457-.845 0-1.666-.078-2.464-.23 1.667 5.2 6.5 8.985 12.23 9.09-4.482 3.51-10.13 5.605-16.26 5.605-1.055 0-2.096-.06-3.122-.184 5.794 3.717 12.676 5.882 20.067 5.882 24.083 0 37.25-19.95 37.25-37.25 0-.565-.013-1.133-.038-1.693 2.558-1.847 4.778-4.15 6.532-6.774z" fill="#fff"></path></svg></span><i class="simplesocialtxt">Tweet </i></button>
<button class="ssb_fbshare-icon" data-href="https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/" onclick="javascript:window.open(this.dataset.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;" target="_blank">
<span class="icon"><svg class="_1pbq" color="#ffffff" viewbox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path class="icon" d="M8 14H3.667C2.733 13.9 2 13.167 2 12.233V3.667A1.65 1.65 0 0 1 3.667 2h8.666A1.65 1.65 0 0 1 14 3.667v8.566c0 .934-.733 1.667-1.667 1.767H10v-3.967h1.3l.7-2.066h-2V6.933c0-.466.167-.9.867-.9H12v-1.8c.033 0-.933-.266-1.533-.266-1.267 0-2.434.7-2.467 2.133v1.867H6v2.066h2V14z" fill="#ffffff" fill-rule="evenodd"></path></svg></span>
<span class="simplesocialtxt">Share </span> </button>
<button class="ssb_linkedin-icon" data-href="https://www.linkedin.com/cws/share?url=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/" onclick="javascript:window.open(this.dataset.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
<span class="icon"> <svg enable-background="new -301.4 387.5 15 14.1" height="14.1px" id="Layer_1" version="1.1" viewbox="-301.4 387.5 15 14.1" width="15px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"> <g id="XMLID_398_"> <path d="M-296.2,401.6c0-3.2,0-6.3,0-9.5h0.1c1,0,2,0,2.9,0c0.1,0,0.1,0,0.1,0.1c0,0.4,0,0.8,0,1.2 c0.1-0.1,0.2-0.3,0.3-0.4c0.5-0.7,1.2-1,2.1-1.1c0.8-0.1,1.5,0,2.2,0.3c0.7,0.4,1.2,0.8,1.5,1.4c0.4,0.8,0.6,1.7,0.6,2.5 c0,1.8,0,3.6,0,5.4v0.1c-1.1,0-2.1,0-3.2,0c0-0.1,0-0.1,0-0.2c0-1.6,0-3.2,0-4.8c0-0.4,0-0.8-0.2-1.2c-0.2-0.7-0.8-1-1.6-1 c-0.8,0.1-1.3,0.5-1.6,1.2c-0.1,0.2-0.1,0.5-0.1,0.8c0,1.7,0,3.4,0,5.1c0,0.2,0,0.2-0.2,0.2c-1,0-1.9,0-2.9,0 C-296.1,401.6-296.2,401.6-296.2,401.6z" fill="#FFFFFF" id="XMLID_399_"></path> <path d="M-298,401.6L-298,401.6c-1.1,0-2.1,0-3,0c-0.1,0-0.1,0-0.1-0.1c0-3.1,0-6.1,0-9.2 c0-0.1,0-0.1,0.1-0.1c1,0,2,0,2.9,0h0.1C-298,395.3-298,398.5-298,401.6z" fill="#FFFFFF" id="XMLID_400_"></path> <path d="M-299.6,390.9c-0.7-0.1-1.2-0.3-1.6-0.8c-0.5-0.8-0.2-2.1,1-2.4c0.6-0.2,1.2-0.1,1.8,0.2 c0.5,0.4,0.7,0.9,0.6,1.5c-0.1,0.7-0.5,1.1-1.1,1.3C-299.1,390.8-299.4,390.8-299.6,390.9L-299.6,390.9z" fill="#FFFFFF" id="XMLID_401_"></path> </g> </svg> </span>
<span class="simplesocialtxt">Share</span> </button>
<button class="ssb_gplus-icon" data-href="https://plus.google.com/share?url=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/" onclick="javascript:window.open(this.dataset.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
<span class="icon"><svg class="ozWidgetRioButtonSvg_ ozWidgetRioButtonPlusOne_" height="18px" preserveaspectratio="xMidYMid meet" version="1.1" viewbox="-10 -6 60 36" width="30px" xmlns="http://www.w3.org/2000/svg"><path d="M30 7h-3v4h-4v3h4v4h3v-4h4v-3h-4V7z"></path><path d="M11 9.9v4h5.4C16 16.3 14 18 11 18c-3.3 0-5.9-2.8-5.9-6S7.7 6 11 6c1.5 0 2.8.5 3.8 1.5l2.9-2.9C15.9 3 13.7 2 11 2 5.5 2 1 6.5 1 12s4.5 10 10 10c5.8 0 9.6-4.1 9.6-9.8 0-.7-.1-1.5-.2-2.2H11z"></path></svg></span>
<span class="simplesocialtxt">Google Plus </span></button>
</div>
</section><!-- /.entry -->
<div class="fix"></div>
<aside id="post-author">
<div class="profile-image"><img alt="" class="avatar avatar-80 photo" height="80" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=160&amp;d=mm&amp;r=g 2x" width="80"/></div>
<div class="profile-content">
<h4>About Jason Brownlee</h4>
		Jason Brownlee, PhD is a machine learning specialist who teaches developers how to get results with modern machine learning methods via hands-on tutorials.				<div class="profile-link">
<a href="https://machinelearningmastery.com/author/jasonb/">
				View all posts by Jason Brownlee <span class="meta-nav">→</span> </a>
</div><!--#profile-link-->
</div>
<div class="fix"></div>
</aside>
<div class="post-utility"></div>
</article><!-- /.post -->
<div class="post-entries">
<div class="nav-prev fl"><a href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/" rel="prev"><i class="fa fa-angle-left"></i> How to Use Small Experiments to Develop a Caption Generation Model in Keras</a></div>
<div class="nav-next fr"><a href="https://machinelearningmastery.com/gentle-introduction-text-summarization/" rel="next">A Gentle Introduction to Text Summarization <i class="fa fa-angle-right"></i></a></div>
<div class="fix"></div>
</div>
<div id="comments"> <h3 id="comments-title">401 Responses to <em>How to Develop a Deep Learning Photo Caption Generator from Scratch</em></h3>
<ol class="commentlist">
<li class="comment even thread-even depth-1" id="comment-421397">
<div class="comment-container" id="li-comment-421397">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/cba7595273306c580724556d6969e244?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/cba7595273306c580724556d6969e244?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Christian Beckmann</span>
<span class="date">November 28, 2017 at 3:21 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421397" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>thanks for this great article about image caption!</p>
<p>My results after training were a bit worse (loss 3.566 – val_loss 3.859, then started to overfit) so i decided to try keras.applications.inception_v3.InceptionV3 for the base model. Currently it is still running and i am curious to see if it will do better.</p>
<div class="reply">
<a aria-label="Reply to Christian Beckmann" class="comment-reply-link" href="#comment-421397" onclick='return addComment.moveForm( "comment-421397", "421397", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-421431">
<div class="comment-container" id="li-comment-421431">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 28, 2017 at 8:41 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421431" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Let me know how you go Christian.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-421431" onclick='return addComment.moveForm( "comment-421431", "421431", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-2" id="comment-441452">
<div class="comment-container" id="li-comment-441452">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/29ad3f02d56ea0f65fc54ba55a4f6c8f?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/29ad3f02d56ea0f65fc54ba55a4f6c8f?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">basil</span>
<span class="date">June 21, 2018 at 12:03 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-441452" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Christian / Jason  – instead would Batch normalization help us here. am facing the same issue, over fitting. </p>
<p>BN should also speed up the training and should also give us more accurate results. any inputs ?</p>
<div class="reply">
<a aria-label="Reply to basil" class="comment-reply-link" href="#comment-441452" onclick='return addComment.moveForm( "comment-441452", "441452", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-3" id="comment-441491">
<div class="comment-container" id="li-comment-441491">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 21, 2018 at 6:18 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-441491" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>The model usually does fit in 3-5 epochs.</p>
<p>You can try batchnorm if you like. Not sure if it will help.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-441491" onclick='return addComment.moveForm( "comment-441491", "441491", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-4" id="comment-441702">
<div class="comment-container" id="li-comment-441702">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/3cbe20903f1ff78b9f7c184442ea30e0?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3cbe20903f1ff78b9f7c184442ea30e0?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">basil</span>
<span class="date">June 23, 2018 at 4:34 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-441702" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>yep, i agree… not required..thanks.. </p>
<p>am also trying inceptionV3,  let you know the results..</p>
<div class="reply">
<a aria-label="Reply to basil" class="comment-reply-link" href="#comment-441702" onclick='return addComment.moveForm( "comment-441702", "441702", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-441724">
<div class="comment-container" id="li-comment-441724">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 23, 2018 at 6:20 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-441724" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Great.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-5" id="comment-441848">
<div class="comment-container" id="li-comment-441848">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/2865b62767028520e38d0344d1256a76?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/2865b62767028520e38d0344d1256a76?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Ben</span>
<span class="date">June 24, 2018 at 8:14 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-441848" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hey did anyone try the Inception model? What were the results?</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment odd alt depth-5" id="comment-455195">
<div class="comment-container" id="li-comment-455195">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">November 18, 2018 at 3:37 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-455195" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>hey ben!!!Can you please share the code and results of the inception model?so that we can also try and know more about the inception model.Thanks in advance</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even depth-2" id="comment-451223">
<div class="comment-container" id="li-comment-451223">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/fb162ad89ea00b43823c3788f5e28601?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/fb162ad89ea00b43823c3788f5e28601?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://naturallysavvy.com/AgilityRedirector.htm" rel="external nofollow">Shaurya Pratap Singh</a></span>
<span class="date">October 10, 2018 at 7:25 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-451223" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>can you plz send me the code at <a href="mailto:shauryaprataps261@gmail.com">shauryaprataps261@gmail.com</a></p>
<div class="reply">
<a aria-label="Reply to Shaurya Pratap Singh" class="comment-reply-link" href="#comment-451223" onclick='return addComment.moveForm( "comment-451223", "451223", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment odd alt depth-2" id="comment-455952">
<div class="comment-container" id="li-comment-455952">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ed5f572734616a66102b4b0edf60f1c3?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ed5f572734616a66102b4b0edf60f1c3?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Janarddan Sarkar</span>
<span class="date">November 24, 2018 at 1:16 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-455952" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I am getting the same</p>
<div class="reply">
<a aria-label="Reply to Janarddan Sarkar" class="comment-reply-link" href="#comment-455952" onclick='return addComment.moveForm( "comment-455952", "455952", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-421644">
<div class="comment-container" id="li-comment-421644">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/c68408ea018d67921361ee2d377299da?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/c68408ea018d67921361ee2d377299da?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Akash</span>
<span class="date">November 30, 2017 at 4:56 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421644" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,<br/>
Once again  great Article.<br/>
I ran into some error while executing the code under “Complete example ” section.<br/>
The error I got was<br/>
ValueError: Error when checking target: expected dense_3 to have shape (None, 7579) but got array with shape (306404, 1)<br/>
 Any idea how to fix this?<br/>
Thanks</p>
<div class="reply">
<a aria-label="Reply to Akash" class="comment-reply-link" href="#comment-421644" onclick='return addComment.moveForm( "comment-421644", "421644", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-421673">
<div class="comment-container" id="li-comment-421673">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 30, 2017 at 8:26 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421673" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Akash, nice catch.</p>
<p>The fault appears to have been introduced in a recent version of Keras in the to_categorical() function. I can confirm the fault occurs with Keras 2.1.1.</p>
<p>You can learn more about the fault here:<br/>
<a href="https://github.com/fchollet/keras/issues/8519" rel="nofollow">https://github.com/fchollet/keras/issues/8519</a></p>
<p>There are two options:</p>
<p>1. Downgrade Keras to 2.0.8</p>
<p>or </p>
<p>2. Modify the code, change line 104 in the training code example from:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca373393d6760851265" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
out_seq = to_categorical([out_seq], num_classes=vocab_size)[0]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca373393d6760851265-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca373393d6760851265-1"><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">out_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p></p>
<p>to </p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca373393dc314253772" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
out_seq = to_categorical([out_seq], num_classes=vocab_size)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca373393dc314253772-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca373393dc314253772-1"><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">out_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p></p>
<p>I hope that helps.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-421673" onclick='return addComment.moveForm( "comment-421673", "421673", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-421719">
<div class="comment-container" id="li-comment-421719">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/c68408ea018d67921361ee2d377299da?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/c68408ea018d67921361ee2d377299da?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Akash</span>
<span class="date">November 30, 2017 at 5:38 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421719" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks Jason. It’s working now.<br/>
Can you suggest the changes to be made to use Inception model and word embedding like word2vec.</p>
<div class="reply">
<a aria-label="Reply to Akash" class="comment-reply-link" href="#comment-421719" onclick='return addComment.moveForm( "comment-421719", "421719", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-421791">
<div class="comment-container" id="li-comment-421791">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 1, 2017 at 7:26 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421791" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I’m glad to hear that.</p>
<p>Yes, simply load the inception model and prepare the images.<br/>
<a href="https://keras.io/applications/" rel="nofollow">https://keras.io/applications/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-421791" onclick='return addComment.moveForm( "comment-421791", "421791", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even depth-2" id="comment-445149">
<div class="comment-container" id="li-comment-445149">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/d9ccdaeab22c2462cefa987cd1034eeb?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d9ccdaeab22c2462cefa987cd1034eeb?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Gaurav Anand</span>
<span class="date">August 3, 2018 at 4:02 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-445149" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Akash</p>
<p>Could you please tell how did you git rid of this problem?</p>
<p>I am facing </p>
<p>ValueError: Error when checking input: expected input_1 to have 2 dimensions, but got array with shape (11, 7, 7, 512)</p>
<p>and after changing input structure to inputs1 = Input(shape=(7, 7, 512,)) I am facing </p>
<p>ValueError: Error when checking target: expected dense_3 to have 4 dimensions, but got array with shape (11, 3857)</p>
<p>I have tried with Keras 2.0.8 and latest 2.2.2 versions.<br/>
Any help would be much appreciated.</p>
<p>Thanks</p>
<div class="reply">
<a aria-label="Reply to Gaurav Anand" class="comment-reply-link" href="#comment-445149" onclick='return addComment.moveForm( "comment-445149", "445149", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-445453">
<div class="comment-container" id="li-comment-445453">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/2dc55b4da192112ca7d37e098aea0ebe?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/2dc55b4da192112ca7d37e098aea0ebe?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">anesh</span>
<span class="date">August 7, 2018 at 4:34 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-445453" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Did you used different input shape?.If you changed the input shape then you have to flatten it and add fully connected dense layer of 4096 neurons.</p>
<div class="reply">
<a aria-label="Reply to anesh" class="comment-reply-link" href="#comment-445453" onclick='return addComment.moveForm( "comment-445453", "445453", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-4" id="comment-446063">
<div class="comment-container" id="li-comment-446063">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/d9ccdaeab22c2462cefa987cd1034eeb?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d9ccdaeab22c2462cefa987cd1034eeb?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Gaurav Anand</span>
<span class="date">August 14, 2018 at 2:59 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-446063" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Should I avoid using “include_top = false” while feature extraction ?<br/>
or keep it as true ?</p>
<div class="reply">
<a aria-label="Reply to Gaurav Anand" class="comment-reply-link" href="#comment-446063" onclick='return addComment.moveForm( "comment-446063", "446063", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment odd alt depth-4" id="comment-455197">
<div class="comment-container" id="li-comment-455197">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">November 18, 2018 at 3:45 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-455197" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Anesh how to fix this error?</p>
<p>Error when checking input: expected input_3 to have shape (4096,) but got array with shape (2048,)</p>
<div class="reply">
<a aria-label="Reply to abbas" class="comment-reply-link" href="#comment-455197" onclick='return addComment.moveForm( "comment-455197", "455197", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-5" id="comment-455242">
<div class="comment-container" id="li-comment-455242">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 18, 2018 at 6:48 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-455242" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Change the data to meet the model or change the model to meet the data.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-421755">
<div class="comment-container" id="li-comment-421755">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/9537df9d267d96cec91e9478f70f7a9e?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/9537df9d267d96cec91e9478f70f7a9e?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Zoltan</span>
<span class="date">November 30, 2017 at 11:47 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421755" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason, </p>
<p>Big thumbs up, nicely written, really informative article. I especially like the step by step approach.</p>
<p>But when I tried to go through it, I got an error in load_poto_features saying that “name ‘load’ not defined”. Which is kinda odd.</p>
<p>Otherwise everything seems fine.</p>
<div class="reply">
<a aria-label="Reply to Zoltan" class="comment-reply-link" href="#comment-421755" onclick='return addComment.moveForm( "comment-421755", "421755", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-421807">
<div class="comment-container" id="li-comment-421807">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 1, 2017 at 7:35 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421807" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks.</p>
<p>Perhaps double check you have the load function imported from pickle?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-421807" onclick='return addComment.moveForm( "comment-421807", "421807", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-421847">
<div class="comment-container" id="li-comment-421847">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/df5140ff432d7b5d7af269c6840f1777?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/df5140ff432d7b5d7af269c6840f1777?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Bikram Kachari</span>
<span class="date">December 1, 2017 at 4:59 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421847" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason</p>
<p>I am a regular follower of your tutorials. They are great. I got to learn a lot. Thank you so much. Please keep up the good work</p>
<div class="reply">
<a aria-label="Reply to Bikram Kachari" class="comment-reply-link" href="#comment-421847" onclick='return addComment.moveForm( "comment-421847", "421847", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-421904">
<div class="comment-container" id="li-comment-421904">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 2, 2017 at 8:49 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421904" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You’re welcome!</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-421904" onclick='return addComment.moveForm( "comment-421904", "421904", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-421853">
<div class="comment-container" id="li-comment-421853">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/35819af56db0314e56e202d5e7a3869d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/35819af56db0314e56e202d5e7a3869d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">maibam</span>
<span class="date">December 1, 2017 at 7:05 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421853" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>____________________________________________________________________________________________________<br/>
Layer (type)                     Output Shape          Param #     Connected to<br/>
====================================================================================================<br/>
input_2 (InputLayer)             (None, 34)            0<br/>
____________________________________________________________________________________________________<br/>
input_1 (InputLayer)             (None, 4096)          0<br/>
____________________________________________________________________________________________________<br/>
embedding_1 (Embedding)          (None, 34, 256)       1940224     input_2[0][0]<br/>
____________________________________________________________________________________________________<br/>
dropout_1 (Dropout)              (None, 4096)          0           input_1[0][0]<br/>
____________________________________________________________________________________________________<br/>
dropout_2 (Dropout)              (None, 34, 256)       0           embedding_1[0][0]<br/>
____________________________________________________________________________________________________<br/>
dense_1 (Dense)                  (None, 256)           1048832     dropout_1[0][0]<br/>
____________________________________________________________________________________________________<br/>
lstm_1 (LSTM)                    (None, 256)           525312      dropout_2[0][0]<br/>
____________________________________________________________________________________________________<br/>
add_1 (Add)                      (None, 256)           0           dense_1[0][0]<br/>
                                                                   lstm_1[0][0]<br/>
____________________________________________________________________________________________________<br/>
dense_2 (Dense)                  (None, 256)           65792       add_1[0][0]<br/>
____________________________________________________________________________________________________<br/>
dense_3 (Dense)                  (None, 7579)          1947803     dense_2[0][0]<br/>
====================================================================================================<br/>
Total params: 5,527,963<br/>
Trainable params: 5,527,963<br/>
Non-trainable params: 0<br/>
_________________________</p>
<p>ValueError: Error when checking input: expected input_1 to have 2 dimensions, but got array with shape (306404, 7, 7, 512)</p>
<p>Getting error during mode.fit<br/>
model.fit([X1train, X2train], ytrain, epochs=20, verbose=2, callbacks=[checkpoint], validation_data=([X1test, X2test], ytest))</p>
<p>Keras  2.0.8 with tensorflow<br/>
what is wrong ?</p>
<div class="reply">
<a aria-label="Reply to maibam" class="comment-reply-link" href="#comment-421853" onclick='return addComment.moveForm( "comment-421853", "421853", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-421907">
<div class="comment-container" id="li-comment-421907">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 2, 2017 at 8:51 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421907" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Not sure, did you copy all of the code exactly?</p>
<p>Is your numpy and tensorflow also up to date?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-421907" onclick='return addComment.moveForm( "comment-421907", "421907", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-426681">
<div class="comment-container" id="li-comment-426681">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/cba7595273306c580724556d6969e244?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/cba7595273306c580724556d6969e244?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Christian</span>
<span class="date">January 16, 2018 at 10:09 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-426681" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>This looks like he did change the network for feature extraction. When using include_top=False and wheigts=’imagenet” you get this type of data structure.</p>
<div class="reply">
<a aria-label="Reply to Christian" class="comment-reply-link" href="#comment-426681" onclick='return addComment.moveForm( "comment-426681", "426681", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-4" id="comment-426720">
<div class="comment-container" id="li-comment-426720">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 17, 2018 at 9:58 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-426720" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Nice.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-426720" onclick='return addComment.moveForm( "comment-426720", "426720", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt depth-2" id="comment-442098">
<div class="comment-container" id="li-comment-442098">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/59e5a59704909e4d46a96c1174a50a4a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/59e5a59704909e4d46a96c1174a50a4a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Kingson</span>
<span class="date">June 26, 2018 at 9:54 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442098" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>@maibam did you find the solution?</p>
<p>I am getting similar error –<br/>
ValueError: Error when checking input: expected input_1 to have 2 dimensions, but got array with shape (17952, 7, 7, 512)</p>
<p>Please help me out.<br/>
Thanks!!</p>
<div class="reply">
<a aria-label="Reply to Kingson" class="comment-reply-link" href="#comment-442098" onclick='return addComment.moveForm( "comment-442098", "442098", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-3" id="comment-442136">
<div class="comment-container" id="li-comment-442136">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 27, 2018 at 8:18 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442136" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Ensure your version of Keras is up to date. v2.1.6 or better.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-442136" onclick='return addComment.moveForm( "comment-442136", "442136", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-4" id="comment-442158">
<div class="comment-container" id="li-comment-442158">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/59e5a59704909e4d46a96c1174a50a4a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/59e5a59704909e4d46a96c1174a50a4a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Kingson</span>
<span class="date">June 27, 2018 at 5:26 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442158" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>__________________________________________________________________________________________________<br/>
Layer (type)                    Output Shape         Param #     Connected to<br/>
==================================================================================================<br/>
input_2 (InputLayer)            (None, 27)           0<br/>
__________________________________________________________________________________________________<br/>
input_1 (InputLayer)            (None, 4096)         0<br/>
__________________________________________________________________________________________________<br/>
embedding_1 (Embedding)         (None, 27, 256)      1058048     input_2[0][0]<br/>
__________________________________________________________________________________________________<br/>
dropout_1 (Dropout)             (None, 4096)         0           input_1[0][0]<br/>
__________________________________________________________________________________________________<br/>
dropout_2 (Dropout)             (None, 27, 256)      0           embedding_1[0][0]<br/>
__________________________________________________________________________________________________<br/>
dense_1 (Dense)                 (None, 256)          1048832     dropout_1[0][0]<br/>
__________________________________________________________________________________________________<br/>
lstm_1 (LSTM)                   (None, 256)          525312      dropout_2[0][0]<br/>
__________________________________________________________________________________________________<br/>
add_1 (Add)                     (None, 256)          0           dense_1[0][0]<br/>
                                                                 lstm_1[0][0]<br/>
__________________________________________________________________________________________________<br/>
dense_2 (Dense)                 (None, 256)          65792       add_1[0][0]<br/>
__________________________________________________________________________________________________<br/>
dense_3 (Dense)                 (None, 4133)         1062181     dense_2[0][0]<br/>
==================================================================================================<br/>
Total params: 3,760,165<br/>
Trainable params: 3,760,165<br/>
Non-trainable params: 0<br/>
__________________________________________________________________________________________________<br/>
None<br/>
Traceback (most recent call last):<br/>
  File “train2.py”, line 179, in<br/>
    model.fit([X1train, X2train], ytrain, epochs=20, verbose=2, callbacks=[checkpoint], validation_data=([X1test, X2test], ytest))</p>
<p>ValueError: Error when checking input: expected input_1 to have 2 dimensions, but got array with shape (10931, 7, 7, 512)</p>
<p>keras version is – 2.2.0</p>
<p>Please help me out.</p>
<div class="reply">
<a aria-label="Reply to Kingson" class="comment-reply-link" href="#comment-442158" onclick='return addComment.moveForm( "comment-442158", "442158", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-5" id="comment-442196">
<div class="comment-container" id="li-comment-442196">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 28, 2018 at 6:13 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442196" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Looks like the dimensions of your data do not match the expectations of the model.</p>
<p>You can change the data or change the model.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment odd alt depth-5" id="comment-445454">
<div class="comment-container" id="li-comment-445454">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/2dc55b4da192112ca7d37e098aea0ebe?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/2dc55b4da192112ca7d37e098aea0ebe?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">anesh</span>
<span class="date">August 7, 2018 at 4:36 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-445454" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>If you changed the input shape by include_top=False then you have to flatten it and add two FC dense layer of 4096 neurons.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-421950">
<div class="comment-container" id="li-comment-421950">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/000b71fb827140eef02a19418028d6de?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/000b71fb827140eef02a19418028d6de?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Vik</span>
<span class="date">December 2, 2017 at 7:16 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421950" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thank you for the article. It is great to see full pipeline.<br/>
Always following your articles with admiration</p>
<div class="reply">
<a aria-label="Reply to Vik" class="comment-reply-link" href="#comment-421950" onclick='return addComment.moveForm( "comment-421950", "421950", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-421991">
<div class="comment-container" id="li-comment-421991">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 3, 2017 at 5:24 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421991" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks!</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-421991" onclick='return addComment.moveForm( "comment-421991", "421991", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-422111">
<div class="comment-container" id="li-comment-422111">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/2379782137d7cc566e1dc257762b9952?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/2379782137d7cc566e1dc257762b9952?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Gonzalo Gasca Meza</span>
<span class="date">December 4, 2017 at 10:42 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422111" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>In the prepare data section, if using Python 2.7 there is no str.maketrans method.<br/>
To make this work just comment that line and in line 46 do this:<br/>
desc = [w.translate(None, string.punctuation) for w in desc]</p>
<div class="reply">
<a aria-label="Reply to Gonzalo Gasca Meza" class="comment-reply-link" href="#comment-422111" onclick='return addComment.moveForm( "comment-422111", "422111", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-422122">
<div class="comment-container" id="li-comment-422122">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 4, 2017 at 4:57 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422122" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks Gonzalo!</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-422122" onclick='return addComment.moveForm( "comment-422122", "422122", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-2" id="comment-431527">
<div class="comment-container" id="li-comment-431527">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ab2ef897efe35b04fb16312eaed51eeb?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ab2ef897efe35b04fb16312eaed51eeb?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://machinelearningmastery.com" rel="external nofollow">Bani</a></span>
<span class="date">March 8, 2018 at 4:26 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-431527" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>after using the function to_vocabulary()<br/>
I am getting a vocabulary of size 24 which is too less though I have followed the code line by line.<br/>
Can u help?</p>
<div class="reply">
<a aria-label="Reply to Bani" class="comment-reply-link" href="#comment-431527" onclick='return addComment.moveForm( "comment-431527", "431527", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-3" id="comment-431558">
<div class="comment-container" id="li-comment-431558">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">March 8, 2018 at 6:36 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-431558" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Are you able to confirm that your Python is version 3.5+ and that you have the latest version of all libraries installed?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-431558" onclick='return addComment.moveForm( "comment-431558", "431558", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-422776">
<div class="comment-container" id="li-comment-422776">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/11fe8c12eee8439eec8d7cf30646fba7?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/11fe8c12eee8439eec8d7cf30646fba7?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://www.modyco.fr/fr/component/jsn/minel.html?Itemid=" rel="external nofollow">Minel</a></span>
<span class="date">December 11, 2017 at 6:17 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422776" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,<br/>
I am using your code step by step. There is a light mistake :<br/>
you wrote<br/>
# save descriptions<br/>
save_doc(descriptions, ‘descriptions.txt’)</p>
<p>in fact the right intruction is<br/>
# save descriptions<br/>
save_descriptions(descriptions, ‘descriptions.txt’)</p>
<p>as you wrote in the final example<br/>
best</p>
<div class="reply">
<a aria-label="Reply to Minel" class="comment-reply-link" href="#comment-422776" onclick='return addComment.moveForm( "comment-422776", "422776", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-422822">
<div class="comment-container" id="li-comment-422822">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 12, 2017 at 5:25 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422822" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks Minel, fixed.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-422822" onclick='return addComment.moveForm( "comment-422822", "422822", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-422778">
<div class="comment-container" id="li-comment-422778">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/11fe8c12eee8439eec8d7cf30646fba7?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/11fe8c12eee8439eec8d7cf30646fba7?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://www.modyco.fr/fr/component/jsn/minel.html?Itemid=" rel="external nofollow">Minel</a></span>
<span class="date">December 11, 2017 at 6:34 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422778" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi jason<br/>
Another small detail. I had to write<br/>
from pickle import load<br/>
to run the instruction<br/>
	all_features = load(open(filename, ‘rb’))</p>
<p>Best</p>
<div class="reply">
<a aria-label="Reply to Minel" class="comment-reply-link" href="#comment-422778" onclick='return addComment.moveForm( "comment-422778", "422778", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-422823">
<div class="comment-container" id="li-comment-422823">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 12, 2017 at 5:27 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422823" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Nice catch, fixed. Thanks!</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-422823" onclick='return addComment.moveForm( "comment-422823", "422823", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-422787">
<div class="comment-container" id="li-comment-422787">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/11fe8c12eee8439eec8d7cf30646fba7?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/11fe8c12eee8439eec8d7cf30646fba7?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://www.modyco.fr/fr/component/jsn/minel.html?Itemid=" rel="external nofollow">Minel</a></span>
<span class="date">December 11, 2017 at 9:32 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422787" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,<br/>
I met some trouble running your code. I got a MemoryError on the instruction :<br/>
return array(X1), array(X2), array(y)</p>
<p>I am using a virtual machine with Linux (Debian), Python3,  with 32Giga of memory.<br/>
Could you tell me what was the size of the memory on the computer you used to check your program ?</p>
<p>Best</p>
<div class="reply">
<a aria-label="Reply to Minel" class="comment-reply-link" href="#comment-422787" onclick='return addComment.moveForm( "comment-422787", "422787", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-422826">
<div class="comment-container" id="li-comment-422826">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 12, 2017 at 5:29 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422826" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I expect 8GB of RAM would be enough.</p>
<p>Perhaps try and use progressive loading instead, as described in this post:<br/>
<a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/" rel="nofollow">https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-422826" onclick='return addComment.moveForm( "comment-422826", "422826", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-451226">
<div class="comment-container" id="li-comment-451226">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/fb162ad89ea00b43823c3788f5e28601?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/fb162ad89ea00b43823c3788f5e28601?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Shaurya Pratap Singh</span>
<span class="date">October 10, 2018 at 7:36 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-451226" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>thanks, Jason for a great tutorial!<br/>
from line 96 to 104 in the main complete code.</p>
<p>seq = tokenizer.texts_to_sequences([desc])[0]<br/>
out_seq = to_categorical([out_seq], num_classes=vocab_size)[0]<br/>
seq = tokenizer.texts_to_sequences([desc])[0]</p>
<p>i did not understand why did you do  [0] in  tokenizer.texts_to_sequences([desc])[0], and moreover why did you passed a 2d list?</p>
<p>what does texts_to_sequences do??</p>
<div class="reply">
<a aria-label="Reply to Shaurya Pratap Singh" class="comment-reply-link" href="#comment-451226" onclick='return addComment.moveForm( "comment-451226", "451226", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-451293">
<div class="comment-container" id="li-comment-451293">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 11, 2018 at 7:53 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-451293" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You can learn more about the function here:<br/>
<a href="https://keras.io/preprocessing/text/#text_to_word_sequence" rel="nofollow">https://keras.io/preprocessing/text/#text_to_word_sequence</a></p>
<p>It takes a 2D array, here we provide our 1d array as a 2d array and retrieve the result.</p>
<p>You can learn more about Python array indexing here:<br/>
<a href="https://machinelearningmastery.com/index-slice-reshape-numpy-arrays-machine-learning-python/" rel="nofollow">https://machinelearningmastery.com/index-slice-reshape-numpy-arrays-machine-learning-python/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-451293" onclick='return addComment.moveForm( "comment-451293", "451293", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-5" id="comment-452478">
<div class="comment-container" id="li-comment-452478">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1214a388eb8c81ba62f10edf993483b7?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1214a388eb8c81ba62f10edf993483b7?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Hassaan</span>
<span class="date">October 24, 2018 at 12:29 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-452478" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Please slightly explain that. I am not getting why did you do [0] in tokenizer.texts_to_sequences([desc])[0]  . I have also read  array indexing. How it become 2D array from that? Please explain it</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-452522">
<div class="comment-container" id="li-comment-452522">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 24, 2018 at 6:31 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-452522" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Because the function returns a 2D array and we only need the first dimension.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-422916">
<div class="comment-container" id="li-comment-422916">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/11fe8c12eee8439eec8d7cf30646fba7?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/11fe8c12eee8439eec8d7cf30646fba7?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://www.modyco.fr/fr/component/jsn/minel.html?Itemid=" rel="external nofollow">Minel</a></span>
<span class="date">December 12, 2017 at 11:34 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422916" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thank for the advice.In fact, I upgraded the VM (64Go, 16 cores) and it worked fine (using 45Go of memory)<br/>
Best</p>
<div class="reply">
<a aria-label="Reply to Minel" class="comment-reply-link" href="#comment-422916" onclick='return addComment.moveForm( "comment-422916", "422916", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-422947">
<div class="comment-container" id="li-comment-422947">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 13, 2017 at 5:35 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422947" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Nice! Glad to hear it.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-422947" onclick='return addComment.moveForm( "comment-422947", "422947", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-430927">
<div class="comment-container" id="li-comment-430927">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/5a1911f0943e5f7e1e45421d0827b471?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/5a1911f0943e5f7e1e45421d0827b471?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Vineeth</span>
<span class="date">March 3, 2018 at 12:32 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-430927" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I get the same error even with 64GB VM :/ What to do</p>
<div class="reply">
<a aria-label="Reply to Vineeth" class="comment-reply-link" href="#comment-430927" onclick='return addComment.moveForm( "comment-430927", "430927", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-430965">
<div class="comment-container" id="li-comment-430965">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">March 3, 2018 at 8:13 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-430965" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I’m sorry to hear that, perhaps there is something else going on with your workstation?</p>
<p>I can confirm the example works on workstations and on EC2 instances with and without GPUs.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-430965" onclick='return addComment.moveForm( "comment-430965", "430965", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-5" id="comment-431013">
<div class="comment-container" id="li-comment-431013">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/5a1911f0943e5f7e1e45421d0827b471?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/5a1911f0943e5f7e1e45421d0827b471?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Vineeth</span>
<span class="date">March 3, 2018 at 10:06 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-431013" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>It’s throwing a Value error for input_1 after sometime. I tried everything i can but i am not able to understand. Can you paste the link of your project so i can compare ?</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-431073">
<div class="comment-container" id="li-comment-431073">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">March 4, 2018 at 6:03 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-431073" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Are you able to confirm that your Python environment is up to date?</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-5" id="comment-431016">
<div class="comment-container" id="li-comment-431016">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/5a1911f0943e5f7e1e45421d0827b471?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/5a1911f0943e5f7e1e45421d0827b471?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Vineeth</span>
<span class="date">March 3, 2018 at 10:26 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-431016" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>And sir, You said the pickle size must be about 127Mb but mine turns out to be above 700MB what did i do wrong ?</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-431074">
<div class="comment-container" id="li-comment-431074">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">March 4, 2018 at 6:04 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-431074" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>The size may be different on different platforms (macos/linux/windows).</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-423633">
<div class="comment-container" id="li-comment-423633">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ff89cc762470a4d4682e3b48c67cd781?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ff89cc762470a4d4682e3b48c67cd781?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Josh Ash</span>
<span class="date">December 17, 2017 at 9:56 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-423633" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason – hello from Queensland 🙂<br/>
Your tutorials on applied ML in Python are the best on the net hands down, thanks for putting them together!</p>
<div class="reply">
<a aria-label="Reply to Josh Ash" class="comment-reply-link" href="#comment-423633" onclick='return addComment.moveForm( "comment-423633", "423633", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-423672">
<div class="comment-container" id="li-comment-423672">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 18, 2017 at 5:22 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-423672" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks Josh!</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-423672" onclick='return addComment.moveForm( "comment-423672", "423672", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-423748">
<div class="comment-container" id="li-comment-423748">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/e235b328169e2f5e7221a7cb89601940?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/e235b328169e2f5e7221a7cb89601940?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Madhivarman</span>
<span class="date">December 18, 2017 at 7:12 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-423748" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>hai Jason.. When i run the train.py script my lap freeze…I don’t know whether its training or not.Did anyone face this issue ?</p>
<p>Thanks..!</p>
<div class="reply">
<a aria-label="Reply to Madhivarman" class="comment-reply-link" href="#comment-423748" onclick='return addComment.moveForm( "comment-423748", "423748", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-423781">
<div class="comment-container" id="li-comment-423781">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 19, 2017 at 5:16 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-423781" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Sorry to hear that.</p>
<p>Perhaps try running it on AWS for a few dollars:<br/>
<a href="https://machinelearningmastery.com/develop-evaluate-large-deep-learning-models-keras-amazon-web-services/" rel="nofollow">https://machinelearningmastery.com/develop-evaluate-large-deep-learning-models-keras-amazon-web-services/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-423781" onclick='return addComment.moveForm( "comment-423781", "423781", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-424156">
<div class="comment-container" id="li-comment-424156">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/8a5c42b5ce041dc744347fad1df531fd?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/8a5c42b5ce041dc744347fad1df531fd?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Muhammad Awais</span>
<span class="date">December 20, 2017 at 3:36 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-424156" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks for such a great work. I found an error message when running a code<br/>
FileNotFoundError: [Errno 2] No such file or directory: ‘descriptions.txt’<br/>
Please help</p>
<div class="reply">
<a aria-label="Reply to Muhammad Awais" class="comment-reply-link" href="#comment-424156" onclick='return addComment.moveForm( "comment-424156", "424156", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-424169">
<div class="comment-container" id="li-comment-424169">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 20, 2017 at 3:50 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-424169" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Ensure you generate the descriptions file before running the prior model – check the tutorial steps again and ensure you execute each in turn.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-424169" onclick='return addComment.moveForm( "comment-424169", "424169", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-424237">
<div class="comment-container" id="li-comment-424237">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/08d5f83cd4ba24e4baebd5228176fda6?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/08d5f83cd4ba24e4baebd5228176fda6?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Daniel F</span>
<span class="date">December 21, 2017 at 4:31 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-424237" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>I’m getting a MemoryError when I try to prepare the training sequences: </p>
<p>Traceback (most recent call last):<br/>
  File “C:\Users\Daniel\Desktop\project\deeplearningmodel.py”, line 154, in<br/>
    X1train, X2train, ytrain = create_sequences(tokenizer, max_length, train_descriptions, train_features)<br/>
  File “C:\Users\Daniel\Desktop\project\deeplearningmodel.py”, line 104, in create_sequences<br/>
    out_seq = to_categorical([out_seq], num_classes=vocab_size)[0]<br/>
  File “C:\Program Files\Anaconda3\lib\site-packages\keras\utils\np_utils.py”, line 24, in to_categorical<br/>
    categorical = np.zeros((n, num_classes))<br/>
MemoryError</p>
<p>any advice? I have 8GB of RAM.</p>
<div class="reply">
<a aria-label="Reply to Daniel F" class="comment-reply-link" href="#comment-424237" onclick='return addComment.moveForm( "comment-424237", "424237", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-424258">
<div class="comment-container" id="li-comment-424258">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 21, 2017 at 5:29 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-424258" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps try using progressive loading described in this post:<br/>
<a href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/" rel="nofollow">https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-424258" onclick='return addComment.moveForm( "comment-424258", "424258", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-424392">
<div class="comment-container" id="li-comment-424392">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/08d5f83cd4ba24e4baebd5228176fda6?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/08d5f83cd4ba24e4baebd5228176fda6?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Daniel F</span>
<span class="date">December 22, 2017 at 8:26 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-424392" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Any chance you could show what that would look like functioning with this example? 🙂 I’m struggling a bit to bring a similar generator from the other example to this script.</p>
<div class="reply">
<a aria-label="Reply to Daniel F" class="comment-reply-link" href="#comment-424392" onclick='return addComment.moveForm( "comment-424392", "424392", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-424419">
<div class="comment-container" id="li-comment-424419">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 22, 2017 at 4:13 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-424419" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks for the suggestion, I’ll schedule time to update the example.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-424419" onclick='return addComment.moveForm( "comment-424419", "424419", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-5" id="comment-424455">
<div class="comment-container" id="li-comment-424455">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/08d5f83cd4ba24e4baebd5228176fda6?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/08d5f83cd4ba24e4baebd5228176fda6?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Daniel F</span>
<span class="date">December 22, 2017 at 11:58 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-424455" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Great! Thanks so much </p>
<p>And thanks for the blog, it is really wonderful 🙂 For now I just cut down the training set a lot to work around the memory error and understand.the code better.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-424489">
<div class="comment-container" id="li-comment-424489">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 23, 2017 at 5:19 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-424489" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks Daniel.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-5" id="comment-429331">
<div class="comment-container" id="li-comment-429331">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/5a1911f0943e5f7e1e45421d0827b471?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/5a1911f0943e5f7e1e45421d0827b471?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Vineeth</span>
<span class="date">February 13, 2018 at 7:29 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-429331" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I’m having the same problem. Can you please show the example with progressive generator please ?</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-429385">
<div class="comment-container" id="li-comment-429385">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">February 14, 2018 at 8:17 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-429385" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I provide an example here:<br/>
<a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/" rel="nofollow">https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/</a></p>
<p>Update: I have updated the tutorial to include an example of training using progressive loading (a data generator).</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-424996">
<div class="comment-container" id="li-comment-424996">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ec2c85f0596146bc8af40dc6354bfc32?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ec2c85f0596146bc8af40dc6354bfc32?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">zonetrooper32</span>
<span class="date">December 28, 2017 at 3:12 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-424996" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>Thank you for this amazing article about image captioning.</p>
<p>Currently I am trying to re-implement the whole code, except that I am doing it in pure Tensorflow. I’m curious to see if my re-implementation is working as smooth as yours.</p>
<p>Also a shower thought, it might be better to get a better vector representations for words if using the pretrained word2vec embeddings, for example Glove 6B or GoogleNews. Learning embeddings from scratch with only 8k words might have some performance loss.</p>
<p>Again thank you for putting everything together, it will take quite some time to implement from scratch without your tutorial.</p>
<div class="reply">
<a aria-label="Reply to zonetrooper32" class="comment-reply-link" href="#comment-424996" onclick='return addComment.moveForm( "comment-424996", "424996", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-425014">
<div class="comment-container" id="li-comment-425014">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 28, 2017 at 5:26 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-425014" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Try it and see if it lifts model skill. Let me know how you go.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-425014" onclick='return addComment.moveForm( "comment-425014", "425014", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-425881">
<div class="comment-container" id="li-comment-425881">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/abec5dc1f6ddcc301aa1edddd739122b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/abec5dc1f6ddcc301aa1edddd739122b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Sasikanth</span>
<span class="date">January 8, 2018 at 5:04 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-425881" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hello Jason,<br/>
Is there a R package to perform modeling of images?</p>
<p>regards<br/>
sasikanth</p>
<div class="reply">
<a aria-label="Reply to Sasikanth" class="comment-reply-link" href="#comment-425881" onclick='return addComment.moveForm( "comment-425881", "425881", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-425910">
<div class="comment-container" id="li-comment-425910">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 9, 2018 at 5:24 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-425910" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I don’t know, sorry.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-425910" onclick='return addComment.moveForm( "comment-425910", "425910", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-426679">
<div class="comment-container" id="li-comment-426679">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/00eac6eb851a9c3cda81ac8e1dcf1bb4?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/00eac6eb851a9c3cda81ac8e1dcf1bb4?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Marco</span>
<span class="date">January 16, 2018 at 10:08 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-426679" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason! Thanks for your amazing tutorial! I have a question. I don’t understand the meaning of the number 1 on this line (extract_features):<br/>
image = image.reshape((1, image.shape[0], image.shape[1], image.shape[2]))</p>
<p>Can you explain me what reshape does and the meaning of the arguments?</p>
<p>Thanks in advance.</p>
<div class="reply">
<a aria-label="Reply to Marco" class="comment-reply-link" href="#comment-426679" onclick='return addComment.moveForm( "comment-426679", "426679", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-426719">
<div class="comment-container" id="li-comment-426719">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 17, 2018 at 9:58 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-426719" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Great question, see this post to learn more about numpy arrays:<br/>
<a href="https://machinelearningmastery.com/index-slice-reshape-numpy-arrays-machine-learning-python/" rel="nofollow">https://machinelearningmastery.com/index-slice-reshape-numpy-arrays-machine-learning-python/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-426719" onclick='return addComment.moveForm( "comment-426719", "426719", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-427158">
<div class="comment-container" id="li-comment-427158">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/4495915e7090dd1b81b6a5655833e6c9?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/4495915e7090dd1b81b6a5655833e6c9?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">junhyung yu</span>
<span class="date">January 22, 2018 at 8:54 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-427158" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason! thank you for your great code.<br/>
but i have one question.</p>
<p>How long does it take to execute under code?</p>
<p># define the model<br/>
model = define_model(vocab_size, max_length)</p>
<p>This code does not run during the third day. </p>
<p>I think that  “se3 = LSTM(256)(se2)” code in define_model function is causing the problem.</p>
<p>My computer configuration is like this.</p>
<p>Intel(R) Core(TM) i7-5820K CPU @ 3.30GHz  – 6 core<br/>
Ram 62G<br/>
GeForce GTX TITAN X – 2core</p>
<p>please help me~~</p>
<div class="reply">
<a aria-label="Reply to junhyung yu" class="comment-reply-link" href="#comment-427158" onclick='return addComment.moveForm( "comment-427158", "427158", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-427242">
<div class="comment-container" id="li-comment-427242">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 23, 2018 at 7:55 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-427242" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Ouch, something is wrong. </p>
<p>Perhaps try running on AWS?</p>
<p>Perhaps try other models and test your rig/setup?</p>
<p>Perhaps try fewer epochs or a smaller model to see if your setup can train the model at all?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-427242" onclick='return addComment.moveForm( "comment-427242", "427242", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-427317">
<div class="comment-container" id="li-comment-427317">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/4495915e7090dd1b81b6a5655833e6c9?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/4495915e7090dd1b81b6a5655833e6c9?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">junhyung yu</span>
<span class="date">January 23, 2018 at 3:29 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-427317" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>1. No. i try running on my indicvdual linux server and using jupyter notebook</p>
<p>2. No i am using only your code , no other model, no modify</p>
<p>3. </p>
<p>model.fit([X1train, X2train], ytrain, epochs=20, verbose=1, callbacks=[checkpoint], validation_data=([X1test, X2test], ytest))   </p>
<p>This code has not yet been executed</p>
<p>so I do not think epoch is a problem.</p>
<div class="reply">
<a aria-label="Reply to junhyung yu" class="comment-reply-link" href="#comment-427317" onclick='return addComment.moveForm( "comment-427317", "427317", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-427422">
<div class="comment-container" id="li-comment-427422">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 24, 2018 at 9:50 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-427422" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps run from the command line as a background process without notebook?</p>
<p>Perhaps check memory usage and cpu/gpu utilization?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-427422" onclick='return addComment.moveForm( "comment-427422", "427422", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-427357">
<div class="comment-container" id="li-comment-427357">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/fab8d330f35b60cc6edf0ebc9fac8569?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/fab8d330f35b60cc6edf0ebc9fac8569?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">krishna</span>
<span class="date">January 23, 2018 at 10:41 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-427357" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>ConnectionResetError: [WinError 10054] An existing connection was forcibly closed by the remote host</p>
<p>hi sir… I am getting this error above when i run feature extract code.</p>
<div class="reply">
<a aria-label="Reply to krishna" class="comment-reply-link" href="#comment-427357" onclick='return addComment.moveForm( "comment-427357", "427357", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-427434">
<div class="comment-container" id="li-comment-427434">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 24, 2018 at 9:55 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-427434" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Sorry, I have not seen that error.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-427434" onclick='return addComment.moveForm( "comment-427434", "427434", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-2" id="comment-430517">
<div class="comment-container" id="li-comment-430517">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/610a088a2a4b3801f4a637f7cbe04bed?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/610a088a2a4b3801f4a637f7cbe04bed?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Hiroshi</span>
<span class="date">February 26, 2018 at 1:01 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-430517" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Krishna,</p>
<p>I’m also getting this error time to time. Were  you able to solve this issue?</p>
<div class="reply">
<a aria-label="Reply to Hiroshi" class="comment-reply-link" href="#comment-430517" onclick='return addComment.moveForm( "comment-430517", "430517", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment odd alt depth-2" id="comment-445455">
<div class="comment-container" id="li-comment-445455">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/2dc55b4da192112ca7d37e098aea0ebe?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/2dc55b4da192112ca7d37e098aea0ebe?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">anesh</span>
<span class="date">August 7, 2018 at 4:40 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-445455" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You have to connect to the internet to download the vgg network.</p>
<div class="reply">
<a aria-label="Reply to anesh" class="comment-reply-link" href="#comment-445455" onclick='return addComment.moveForm( "comment-445455", "445455", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-427764">
<div class="comment-container" id="li-comment-427764">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d9c616e308e670ee082c6da867823f5?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d9c616e308e670ee082c6da867823f5?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Sathiya_Chakra</span>
<span class="date">January 28, 2018 at 7:05 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-427764" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason!</p>
<p>Is it possible to run this neural network on a 8GB RAM laptop with 2GB Graphics card with Intel core i5 processor?</p>
<div class="reply">
<a aria-label="Reply to Sathiya_Chakra" class="comment-reply-link" href="#comment-427764" onclick='return addComment.moveForm( "comment-427764", "427764", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-427784">
<div class="comment-container" id="li-comment-427784">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 28, 2018 at 8:28 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-427784" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps.</p>
<p>You might need to adjust it to use progressive loading so that it does not try to hold the entire dataset in RAM.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-427784" onclick='return addComment.moveForm( "comment-427784", "427784", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-455545">
<div class="comment-container" id="li-comment-455545">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/286ecb8bc4770dd1a8ab7d70bb900d65?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/286ecb8bc4770dd1a8ab7d70bb900d65?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">sandhya</span>
<span class="date">November 20, 2018 at 4:56 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-455545" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi jason</p>
<p>Is it possible to run on cpu with progressive loading without any issues??</p>
<div class="reply">
<a aria-label="Reply to sandhya" class="comment-reply-link" href="#comment-455545" onclick='return addComment.moveForm( "comment-455545", "455545", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-455573">
<div class="comment-container" id="li-comment-455573">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 20, 2018 at 6:38 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-455573" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Yes!</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-455573" onclick='return addComment.moveForm( "comment-455573", "455573", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-427868">
<div class="comment-container" id="li-comment-427868">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/95177974351c11bdff820fa945cc363a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/95177974351c11bdff820fa945cc363a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Ajit Tiwari</span>
<span class="date">January 29, 2018 at 10:46 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-427868" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,<br/>
Can you provide a link for the tokenizer as well as the model file.<br/>
I Cannot train this model in my system but would like to see if I can use it to create an Android app</p>
<div class="reply">
<a aria-label="Reply to Ajit Tiwari" class="comment-reply-link" href="#comment-427868" onclick='return addComment.moveForm( "comment-427868", "427868", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-427916">
<div class="comment-container" id="li-comment-427916">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 30, 2018 at 9:51 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-427916" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Sorry, I cannot share the models.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-427916" onclick='return addComment.moveForm( "comment-427916", "427916", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-428138">
<div class="comment-container" id="li-comment-428138">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/5f655fc2f195ccaca30ff1bd91763993?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/5f655fc2f195ccaca30ff1bd91763993?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Soumya</span>
<span class="date">February 1, 2018 at 10:19 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-428138" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>When I am running </p>
<p>tokenizer = Tokenizer()</p>
<p>I am getting error,</p>
<p>Traceback (most recent call last):<br/>
  File “”, line 1, in<br/>
NameError: name ‘Tokenizer’ is not defined</p>
<p>How to solve this. Any idea please.</p>
<div class="reply">
<a aria-label="Reply to Soumya" class="comment-reply-link" href="#comment-428138" onclick='return addComment.moveForm( "comment-428138", "428138", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-428183">
<div class="comment-container" id="li-comment-428183">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">February 2, 2018 at 8:19 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-428183" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Ensure you import the Tokenizer.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-428183" onclick='return addComment.moveForm( "comment-428183", "428183", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-428814">
<div class="comment-container" id="li-comment-428814">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ee5c815320638479baa30320862e4a8a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ee5c815320638479baa30320862e4a8a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Marco</span>
<span class="date">February 9, 2018 at 12:41 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-428814" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason, thanks for the tutorial! I want to ask you if you could explain (or send me some links), to  better understand, how exactly the fitting works.</p>
<p>Example description: the girl is …</p>
<p>The LSTM network during fitting takes the beginning of the sequence of my description (startseq) and it produces a vector with all possible subsequent words. This vector is combined with the vector of the input image features and it is passed within an FF layer where we then take the most probable word (with softmax). it’s right?</p>
<p>At this point how does the fitting go on? Is the new sequence (e.g startseq – the) passed into the LSTM network, predicts all possible next words, etc.? Continuing this way up to endseq?</p>
<p>If the network incorrectly generates the next word, what happens? How are the weights arranged? The fitting continues by taking in input “startseq – wrong_word” or continues with the correct one (eg startseq – the)?</p>
<p>Thanks for your help<br/>
Marco</p>
<div class="reply">
<a aria-label="Reply to Marco" class="comment-reply-link" href="#comment-428814" onclick='return addComment.moveForm( "comment-428814", "428814", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-428847">
<div class="comment-container" id="li-comment-428847">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">February 9, 2018 at 9:10 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-428847" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>This is not fitting, it is inference.</p>
<p>Generating the “wrong” word might not matter, the network could correct.</p>
<p>Also, we can sample the probability distribution of the generated sequence to pull out multiple possible descriptions:<br/>
<a href="https://machinelearningmastery.com/beam-search-decoder-natural-language-processing/" rel="nofollow">https://machinelearningmastery.com/beam-search-decoder-natural-language-processing/</a></p>
<p>To learn more see this post and the referenced papers:<br/>
<a href="https://machinelearningmastery.com/caption-generation-inject-merge-architectures-encoder-decoder-model/" rel="nofollow">https://machinelearningmastery.com/caption-generation-inject-merge-architectures-encoder-decoder-model/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-428847" onclick='return addComment.moveForm( "comment-428847", "428847", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-429322">
<div class="comment-container" id="li-comment-429322">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ede7b722979c4b44693e73728ab1a49c?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ede7b722979c4b44693e73728ab1a49c?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Sumit Das</span>
<span class="date">February 13, 2018 at 6:10 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-429322" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason great article on caption generator i think the best till now available online.. i am a newbee in ML(AI). i extracted the features and stored it to features.pkl file but getting an error on create sequence functions memory error and i can see you have suggested progressive loading i do not get that properly could you suggest my how to use the current code modified for progressive loading::</p>
<p>[‎2/‎13/‎2018 12:34 PM]  Sanchawat, Hardik:<br/>
Using TensorFlow backend.<br/>
Dataset: 6000<br/>
Descriptions: train=6000<br/>
Photos: train=6000<br/>
Vocabulary Size: 7579<br/>
Description Length: 34<br/>
Traceback (most recent call last):<br/>
  File “C:\Users\hardik.sanchawat\Documents\Scripts\flickr\test.py”, line 154, in<br/>
    X1train, X2train, ytrain = create_sequences(tokenizer, max_length, train_descriptions, train_features)<br/>
  File “C:\Users\hardik.sanchawat\Documents\Scripts\flickr\test.py”, line 109, in create_sequences<br/>
    return array(X1), array(X2), array(y)<br/>
MemoryError </p>
<p>My system configuration is :</p>
<p>OS: Windows 10<br/>
Processor: AMD A8 PRO-7150B R5, 10 Compute Cores 4C+6G   1.90 GHz<br/>
Memory(RAM): 16 GB (14.9GB Usable)<br/>
System type: 64-bit OS, x64-based processor</p>
<div class="reply">
<a aria-label="Reply to Sumit Das" class="comment-reply-link" href="#comment-429322" onclick='return addComment.moveForm( "comment-429322", "429322", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-429383">
<div class="comment-container" id="li-comment-429383">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">February 14, 2018 at 8:17 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-429383" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I have an example of progressive loading here:<br/>
<a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/" rel="nofollow">https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/</a></p>
<p>Update: I have updated the tutorial to include an example of training using progressive loading (a data generator).</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-429383" onclick='return addComment.moveForm( "comment-429383", "429383", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-429398">
<div class="comment-container" id="li-comment-429398">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/fef0db851fe99a7bf83c89f2e1c12280?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/fef0db851fe99a7bf83c89f2e1c12280?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Kavya</span>
<span class="date">February 14, 2018 at 8:35 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-429398" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>I am trying to using plot _model . but I getting error</p>
<p>raise ImportError(‘Failed to import pydot. You must install pydot’</p>
<p>ImportError: Failed to import pydot. You must install pydot and graphviz for <code>pydotprint</code> to work.</p>
<p>I tried<br/>
 conda install graphviz<br/>
conda install pydotplus</p>
<p>to install pydot.<br/>
my python version is3.x<br/>
eras vesion is 2.1.3</p>
<p>Could you please help me , to solve this problem</p>
<div class="reply">
<a aria-label="Reply to Kavya" class="comment-reply-link" href="#comment-429398" onclick='return addComment.moveForm( "comment-429398", "429398", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-429432">
<div class="comment-container" id="li-comment-429432">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">February 14, 2018 at 2:40 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-429432" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I’m sorry to hear that.</p>
<p>Perhaps the installed libraries are not available in your current Python environment?</p>
<p>Perhaps try posting the error to stackoverflow? I’m not an expert at debugging workstations.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-429432" onclick='return addComment.moveForm( "comment-429432", "429432", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-2" id="comment-429456">
<div class="comment-container" id="li-comment-429456">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/5a1911f0943e5f7e1e45421d0827b471?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/5a1911f0943e5f7e1e45421d0827b471?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Vineeth</span>
<span class="date">February 14, 2018 at 5:13 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-429456" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>If you are on windows go here and install this, <a href="https://graphviz.gitlab.io/_pages/Download/Download_windows.html" rel="nofollow">https://graphviz.gitlab.io/_pages/Download/Download_windows.html</a>  2.38 stable msi file.</p>
<p>after that, add the graphviz’s bin onto your system PATH variables. Restart your computer and the path should be picked up.</p>
<p>Then you won’t have that error again.</p>
<div class="reply">
<a aria-label="Reply to Vineeth" class="comment-reply-link" href="#comment-429456" onclick='return addComment.moveForm( "comment-429456", "429456", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-429780">
<div class="comment-container" id="li-comment-429780">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/fef0db851fe99a7bf83c89f2e1c12280?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/fef0db851fe99a7bf83c89f2e1c12280?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Kavya</span>
<span class="date">February 17, 2018 at 2:36 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-429780" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks Vinneth,<br/>
I am using Mac. I tried toes pydotplus, but still its giving same error.</p>
<div class="reply">
<a aria-label="Reply to Kavya" class="comment-reply-link" href="#comment-429780" onclick='return addComment.moveForm( "comment-429780", "429780", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even depth-2" id="comment-436441">
<div class="comment-container" id="li-comment-436441">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/4eef2caa00b6257ff3d3bd4558c3aa66?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/4eef2caa00b6257ff3d3bd4558c3aa66?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Precious Angrish</span>
<span class="date">May 2, 2018 at 10:34 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-436441" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>HI </p>
<p>I am getting the same error, how did you fix it?</p>
<p>Regards<br/>
Precious Angrish</p>
<div class="reply">
<a aria-label="Reply to Precious Angrish" class="comment-reply-link" href="#comment-436441" onclick='return addComment.moveForm( "comment-436441", "436441", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment odd alt depth-2" id="comment-437420">
<div class="comment-container" id="li-comment-437420">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/985a10deb076723f0ba92d7559a32d00?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/985a10deb076723f0ba92d7559a32d00?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Sayan</span>
<span class="date">May 14, 2018 at 3:05 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-437420" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hey Kavya i assume this will surely resolve your error , as it also worked for me as well, <a href="https://stackoverflow.com/questions/36869258/how-to-use-graphviz-with-anaconda-spyder" rel="nofollow">https://stackoverflow.com/questions/36869258/how-to-use-graphviz-with-anaconda-spyder</a>.<br/>
Thanks</p>
<div class="reply">
<a aria-label="Reply to Sayan" class="comment-reply-link" href="#comment-437420" onclick='return addComment.moveForm( "comment-437420", "437420", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-429472">
<div class="comment-container" id="li-comment-429472">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/5a1911f0943e5f7e1e45421d0827b471?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/5a1911f0943e5f7e1e45421d0827b471?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Vineeth</span>
<span class="date">February 14, 2018 at 9:02 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-429472" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I used Progressive Loading from <a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-429470" rel="nofollow">https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-429470</a> This tutorial and updated the input layer to inputs1 = Input(shape=(224, 224, 3)) </p>
<p>And i got the error<br/>
ValueError: Error when checking target: expected dense_3 to have 4 dimensions, but got array with shape (13, 4485)</p>
<p>Then i updated to_categorical function as you mentioned and the error changed to this<br/>
ValueError: Error when checking target: expected dense_3 to have 4 dimensions, but got array with shape (13, 1, 4485)</p>
<p>Been trying to figure out the exact input shapes of the model since 2 days please help 🙁</p>
<div class="reply">
<a aria-label="Reply to Vineeth" class="comment-reply-link" href="#comment-429472" onclick='return addComment.moveForm( "comment-429472", "429472", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-2" id="comment-432818">
<div class="comment-container" id="li-comment-432818">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/11edadb302e5ca0b4ed2a5b84c384de0?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/11edadb302e5ca0b4ed2a5b84c384de0?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Srinath Hanumantha Rao</span>
<span class="date">March 21, 2018 at 7:58 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-432818" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hey Vineeth!</p>
<p>Were you able to solve this issue? I am stuck on this for a few days too.</p>
<div class="reply">
<a aria-label="Reply to Srinath Hanumantha Rao" class="comment-reply-link" href="#comment-432818" onclick='return addComment.moveForm( "comment-432818", "432818", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-3" id="comment-432862">
<div class="comment-container" id="li-comment-432862">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">March 22, 2018 at 6:21 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-432862" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Are you able to confirm your Python and Keras versions?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-432862" onclick='return addComment.moveForm( "comment-432862", "432862", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-430059">
<div class="comment-container" id="li-comment-430059">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/8e1b745128d324ae58800448c40f5df6?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/8e1b745128d324ae58800448c40f5df6?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Alex</span>
<span class="date">February 21, 2018 at 12:30 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-430059" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason, why do you apply dropout to the input instead to applying it to the dense layer?</p>
<div class="reply">
<a aria-label="Reply to Alex" class="comment-reply-link" href="#comment-430059" onclick='return addComment.moveForm( "comment-430059", "430059", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-430106">
<div class="comment-container" id="li-comment-430106">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">February 21, 2018 at 6:40 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-430106" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I used a little experimentation to come up with the model.</p>
<p>Try changing it up and see if you can lift skill or reduce training time or model complexity Alex. I’m eager to hear how you go.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-430106" onclick='return addComment.moveForm( "comment-430106", "430106", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-430696">
<div class="comment-container" id="li-comment-430696">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/2cb14881f7247c10c6959066580ea93b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/2cb14881f7247c10c6959066580ea93b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Sunny</span>
<span class="date">February 28, 2018 at 7:23 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-430696" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>I just wanted to know that when you are loading the training data, you are tokenizing the train descriptions. But when you are working with test data, you are not tokenizing the test descriptions, instead working with the previous tokens. Shouldn’t the test descriptions be tokenized too before passing to create_sequence for test ?</p>
<div class="reply">
<a aria-label="Reply to Sunny" class="comment-reply-link" href="#comment-430696" onclick='return addComment.moveForm( "comment-430696", "430696", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-430773">
<div class="comment-container" id="li-comment-430773">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">March 1, 2018 at 6:02 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-430773" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>The train and test data are tokenized.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-430773" onclick='return addComment.moveForm( "comment-430773", "430773", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-431425">
<div class="comment-container" id="li-comment-431425">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/11a17e7e203917ae63837874f967aef0?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/11a17e7e203917ae63837874f967aef0?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Hgarrison</span>
<span class="date">March 7, 2018 at 8:44 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-431425" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>This tutorial is of great help to us all, I think. I have a question: Does the model eventually learn to predict captions not present in the corpus? I mean, is it possible for the model to output sentences that are never seen before? In the example you give, the model predicted “startseq dog is running across the beach endseq”. Is this sentence found in the training corpus, or did the model make it up based on previous observations? And also, If it is possible for the model to combine sentences, how much training data do you think it needs to do that?</p>
<div class="reply">
<a aria-label="Reply to Hgarrison" class="comment-reply-link" href="#comment-431425" onclick='return addComment.moveForm( "comment-431425", "431425", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-431449">
<div class="comment-container" id="li-comment-431449">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">March 7, 2018 at 3:04 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-431449" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>The model attempts to generalize beyond what it has seen during training.</p>
<p>In fact, this is the goal with a machine learning model.</p>
<p>Nevertheless, the model will be bounded by the types of text and images seen during training, just not the specific combinations.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-431449" onclick='return addComment.moveForm( "comment-431449", "431449", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-431503">
<div class="comment-container" id="li-comment-431503">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/08b26586e2110a7312fc077b75340eb2?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/08b26586e2110a7312fc077b75340eb2?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Giuseppe</span>
<span class="date">March 8, 2018 at 12:05 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-431503" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jeson, I have a question. What exactly is the LSTM used for? During fitting it takes an input (eg startseq – girl) and outputs a vector of 256 elements that contain the most probable words after the prefix? Is it trained through backpropagation? The purpose of the fitting is to make sure that given a prefix / input the LSTM gives me back a vector that represents “better” the possible following words (which are then merge with the features, etc …)</p>
<div class="reply">
<a aria-label="Reply to Giuseppe" class="comment-reply-link" href="#comment-431503" onclick='return addComment.moveForm( "comment-431503", "431503", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-431550">
<div class="comment-container" id="li-comment-431550">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">March 8, 2018 at 6:32 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-431550" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>It is used for interpreting the text generated so far, needed to generate the next word.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-431550" onclick='return addComment.moveForm( "comment-431550", "431550", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-432360">
<div class="comment-container" id="li-comment-432360">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/b83acb811644ae0d589be1345bb13e29?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/b83acb811644ae0d589be1345bb13e29?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">fatma</span>
<span class="date">March 16, 2018 at 8:16 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-432360" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>for the line:</p>
<p>features = dict()</p>
<p>I got syntaxerror: invalid syntax </p>
<p>How can I fix this error?</p>
<div class="reply">
<a aria-label="Reply to fatma" class="comment-reply-link" href="#comment-432360" onclick='return addComment.moveForm( "comment-432360", "432360", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-432406">
<div class="comment-container" id="li-comment-432406">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">March 17, 2018 at 8:36 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-432406" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps double check that you have copied the code while maintaining white space?</p>
<p>Perhaps confirm Python 3?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-432406" onclick='return addComment.moveForm( "comment-432406", "432406", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-432725">
<div class="comment-container" id="li-comment-432725">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/b83acb811644ae0d589be1345bb13e29?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/b83acb811644ae0d589be1345bb13e29?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">fatma</span>
<span class="date">March 20, 2018 at 10:21 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-432725" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>is the following line:</p>
<p> model = Model(inputs=model.inputs, outputs=model.layers[-1].output)</p>
<p>means we will save the features of  fc2 layer of the vgg16 model?</p>
<div class="reply">
<a aria-label="Reply to fatma" class="comment-reply-link" href="#comment-432725" onclick='return addComment.moveForm( "comment-432725", "432725", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-432762">
<div class="comment-container" id="li-comment-432762">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">March 21, 2018 at 6:33 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-432762" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>We are creating a new model without the last layer.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-432762" onclick='return addComment.moveForm( "comment-432762", "432762", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-432799">
<div class="comment-container" id="li-comment-432799">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/b83acb811644ae0d589be1345bb13e29?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/b83acb811644ae0d589be1345bb13e29?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">fatma</span>
<span class="date">March 21, 2018 at 3:54 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-432799" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>the new model doesn’t contain any fully connected layer because I read that we can extract the features from the fc2 layers of the pre-trained model also</p>
<div class="reply">
<a aria-label="Reply to fatma" class="comment-reply-link" href="#comment-432799" onclick='return addComment.moveForm( "comment-432799", "432799", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-4" id="comment-432803">
<div class="comment-container" id="li-comment-432803">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/b83acb811644ae0d589be1345bb13e29?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/b83acb811644ae0d589be1345bb13e29?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">fatma</span>
<span class="date">March 21, 2018 at 4:35 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-432803" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>when I run the line model.summary() I got the last layer is :</p>
<p>block5_conv4 (Conv2D)        (None, 14, 14, 512)       2359808 </p>
<p>but according to the VGG16 it should be</p>
<p>fc2 (Dense)                      (None, 4096)          16781312    fc1[0][0]</p>
<p>I don’t know where is the problem?</p>
<div class="reply">
<a aria-label="Reply to fatma" class="comment-reply-link" href="#comment-432803" onclick='return addComment.moveForm( "comment-432803", "432803", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment odd alt depth-4" id="comment-433031">
<div class="comment-container" id="li-comment-433031">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/b83acb811644ae0d589be1345bb13e29?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/b83acb811644ae0d589be1345bb13e29?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">fatma</span>
<span class="date">March 23, 2018 at 9:27 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-433031" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>how we can feed the saved features in the pickle file (features.pkl) to a linear regression model</p>
<div class="reply">
<a aria-label="Reply to fatma" class="comment-reply-link" href="#comment-433031" onclick='return addComment.moveForm( "comment-433031", "433031", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-5" id="comment-433066">
<div class="comment-container" id="li-comment-433066">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">March 24, 2018 at 6:27 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-433066" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>That would be a lot of input features! Sorry, I don’t have a worked example.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-432777">
<div class="comment-container" id="li-comment-432777">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/fea34a444a188af26d09b7c660140f9a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/fea34a444a188af26d09b7c660140f9a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Akash</span>
<span class="date">March 21, 2018 at 7:04 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-432777" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>ValueError: Error when checking input: expected input_1 to have shape (None, 4096) but got array with shape (0, 1)</p>
<p>I am getting this error..can anyone help me understand and fix it?</p>
<div class="reply">
<a aria-label="Reply to Akash" class="comment-reply-link" href="#comment-432777" onclick='return addComment.moveForm( "comment-432777", "432777", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-432792">
<div class="comment-container" id="li-comment-432792">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">March 21, 2018 at 3:03 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-432792" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Are you able to confirm that you have Python3 and all libs up to date?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-432792" onclick='return addComment.moveForm( "comment-432792", "432792", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-432821">
<div class="comment-container" id="li-comment-432821">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/fea34a444a188af26d09b7c660140f9a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/fea34a444a188af26d09b7c660140f9a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Akash</span>
<span class="date">March 21, 2018 at 9:16 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-432821" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Yes all my libraries are upto date, have checked.<br/>
I solved the problem i posted before….my problem was in the data generator.<br/>
I am using progressive loading.After fixing the problem i checked my inputs using this code:</p>
<p>generator = data_generator(descriptions, tokenizer, max_length)<br/>
inputs, outputs = next(generator)<br/>
print(inputs[0].shape)<br/>
print(inputs[1].shape)<br/>
print(outputs.shape)</p>
<p>and it’s giving me an output like this:</p>
<p>(13, 224, 224, 3)<br/>
(13, 28)<br/>
(13, 4485)</p>
<p>but now it’s showing this error:<br/>
ValueError: Error when checking input: expected input_1 to have 2 dimensions, but got array with shape (8, 224, 224, 3)</p>
<p>do i have to change the model architecture for progressive loading??</p>
<p>NOTE:for progressive loading  have used this code:<a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/" rel="nofollow">https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/</a></p>
<div class="reply">
<a aria-label="Reply to Akash" class="comment-reply-link" href="#comment-432821" onclick='return addComment.moveForm( "comment-432821", "432821", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-4" id="comment-432933">
<div class="comment-container" id="li-comment-432933">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/fce041d659785cad2e79cda4324b050b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/fce041d659785cad2e79cda4324b050b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Steven</span>
<span class="date">March 22, 2018 at 9:57 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-432933" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I am stock with the same issue. The example above runs me into memory problems even when I tried it using AWS EC2 g2.2xlarge instance or a laptop with 16 GB RAM. So I tried the progressive loading example you referred to frequently but I have the same trouble with the input of the model. I tried to use inputs[0] as inputs1 for the define_model  function but that returned the error ‘Error when checking input: expected input_13 to have 5 dimensions, but got array with shape (13, 224, 224, 3)’. Do I have to reshape input[0], or is the problem in inputs2?</p>
<div class="reply">
<a aria-label="Reply to Steven" class="comment-reply-link" href="#comment-432933" onclick='return addComment.moveForm( "comment-432933", "432933", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-5" id="comment-433022">
<div class="comment-container" id="li-comment-433022">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/fea34a444a188af26d09b7c660140f9a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/fea34a444a188af26d09b7c660140f9a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Akash</span>
<span class="date">March 23, 2018 at 6:29 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-433022" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I think the model architecture needs to be changed for the progressive loading example particularly the input shapes.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even depth-2" id="comment-433928">
<div class="comment-container" id="li-comment-433928">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/65fb116994026150ff2e74caa6e4b077?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/65fb116994026150ff2e74caa6e4b077?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Harsha</span>
<span class="date">April 2, 2018 at 9:27 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-433928" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>getting the same error for me<br/>
 File “fittingmodel.py”, line 189, in<br/>
    model.fit([X1train, X2train], ytrain, epochs=20, verbose=2, callbacks=[checkpoint], validation_data=([X1test, X2test], ytest))<br/>
  File “C:\Users\pranyaram\Anaconda3\envs\tensorflow\lib\site-packages\keras\engine\training.py”, line 1630, in fit<br/>
    batch_size=batch_size)<br/>
  File “C:\Users\pranyaram\Anaconda3\envs\tensorflow\lib\site-packages\keras\engine\training.py”, line 1476, in _standardize_user_data<br/>
    exception_prefix=’input’)<br/>
  File “C:\Users\pranyaram\Anaconda3\envs\tensorflow\lib\site-packages\keras\engine\training.py”, line 123, in _standardize_input_data<br/>
    str(data_shape))<br/>
ValueError: Error when checking input: expected input_1 to have shape (4096,) but got array with shape (1,)</p>
<div class="reply">
<a aria-label="Reply to Harsha" class="comment-reply-link" href="#comment-433928" onclick='return addComment.moveForm( "comment-433928", "433928", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-3" id="comment-433961">
<div class="comment-container" id="li-comment-433961">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 3, 2018 at 6:33 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-433961" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>What version of libs are you using?</p>
<p>Here’s what I’m running:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca373386bd022237766" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
python: 3.6.5
scipy: 1.0.1
numpy: 1.14.2
matplotlib: 2.1.1
pandas: 0.22.0
statsmodels: 0.8.0
sklearn: 0.19.1
nltk: 3.2.5
gensim: 3.4.0
xgboost 0.6
tensorflow: 1.7.0
theano: 1.0.1
Using TensorFlow backend.
keras: 2.1.5</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca373386bd022237766-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373386bd022237766-2">2</div><div class="crayon-num" data-line="crayon-5c0ca373386bd022237766-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373386bd022237766-4">4</div><div class="crayon-num" data-line="crayon-5c0ca373386bd022237766-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373386bd022237766-6">6</div><div class="crayon-num" data-line="crayon-5c0ca373386bd022237766-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373386bd022237766-8">8</div><div class="crayon-num" data-line="crayon-5c0ca373386bd022237766-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373386bd022237766-10">10</div><div class="crayon-num" data-line="crayon-5c0ca373386bd022237766-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373386bd022237766-12">12</div><div class="crayon-num" data-line="crayon-5c0ca373386bd022237766-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373386bd022237766-14">14</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca373386bd022237766-1"><span class="crayon-v">python</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">3.6.5</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373386bd022237766-2"><span class="crayon-v">scipy</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">1.0.1</span></div><div class="crayon-line" id="crayon-5c0ca373386bd022237766-3"><span class="crayon-v">numpy</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">1.14.2</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373386bd022237766-4"><span class="crayon-v">matplotlib</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">2.1.1</span></div><div class="crayon-line" id="crayon-5c0ca373386bd022237766-5"><span class="crayon-v">pandas</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">0.22.0</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373386bd022237766-6"><span class="crayon-v">statsmodels</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">0.8.0</span></div><div class="crayon-line" id="crayon-5c0ca373386bd022237766-7"><span class="crayon-v">sklearn</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">0.19.1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373386bd022237766-8"><span class="crayon-v">nltk</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">3.2.5</span></div><div class="crayon-line" id="crayon-5c0ca373386bd022237766-9"><span class="crayon-v">gensim</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">3.4.0</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373386bd022237766-10"><span class="crayon-i">xgboost</span><span class="crayon-h"> </span><span class="crayon-cn">0.6</span></div><div class="crayon-line" id="crayon-5c0ca373386bd022237766-11"><span class="crayon-v">tensorflow</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">1.7.0</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373386bd022237766-12"><span class="crayon-v">theano</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">1.0.1</span></div><div class="crayon-line" id="crayon-5c0ca373386bd022237766-13"><span class="crayon-e">Using </span><span class="crayon-e">TensorFlow </span><span class="crayon-v">backend</span><span class="crayon-sy">.</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373386bd022237766-14"><span class="crayon-v">keras</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">2.1.5</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0005 seconds] -->
<p></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-433961" onclick='return addComment.moveForm( "comment-433961", "433961", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-433766">
<div class="comment-container" id="li-comment-433766">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/01966d4c589166c443fe4634f9c827b2?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/01966d4c589166c443fe4634f9c827b2?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Tanisha</span>
<span class="date">March 31, 2018 at 5:50 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-433766" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,<br/>
Thanks for the article.</p>
<p>Due to lack of resources I tried running this in small amount of data.Everything worked fine but the generating new description part is giving this error. </p>
<p>C:\Users\Tanisha\AppData\Local\conda\conda\envs\tensorflow\lib\site-packages\h5py\__init__.py:36: FutureWarning: Conversion of the second argument of issubdtype from <code>float</code> to <code>np.floating</code> is deprecated. In future, it will be treated as <code>np.float64 == np.dtype(float).type</code>.<br/>
  from ._conv import register_converters as _register_converters<br/>
Using TensorFlow backend.<br/>
2018-03-31 12:07:43.176707: I C:\tf_jenkins\workspace\rel-win\M\windows-gpu\PY\35\tensorflow\core\platform\cpu_feature_guard.cc:140] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2<br/>
2018-03-31 12:07:43.574792: I C:\tf_jenkins\workspace\rel-win\M\windows-gpu\PY\35\tensorflow\core\common_runtime\gpu\gpu_device.cc:1212] Found device 0 with properties:<br/>
name: GeForce 820M major: 2 minor: 1 memoryClockRate(GHz): 1.25<br/>
pciBusID: 0000:08:00.0<br/>
totalMemory: 2.00GiB freeMemory: 1.65GiB<br/>
2018-03-31 12:07:43.584220: I C:\tf_jenkins\workspace\rel-win\M\windows-gpu\PY\35\tensorflow\core\common_runtime\gpu\gpu_device.cc:1283] Ignoring visible gpu device (device: 0, name: GeForce 820M, pci bus id: 0000:08:00.0, compute capability: 2.1) with Cuda compute capability 2.1. The minimum required Cuda capability is 3.0.<br/>
Traceback (most recent call last):<br/>
  File “7_generate_discription.py”, line 72, in<br/>
    description = generate_desc(model, tokenizer, photo, max_length)<br/>
  File “7_generate_discription.py”, line 48, in generate_desc<br/>
    yhat = model.predict([photo,sequence], verbose=0)<br/>
  File “C:\Users\Tanisha\AppData\Local\conda\conda\envs\tensorflow\lib\site-packages\keras\engine\training.py”, line 1817, in predict<br/>
    check_batch_axis=False)<br/>
  File “C:\Users\Tanisha\AppData\Local\conda\conda\envs\tensorflow\lib\site-packages\keras\engine\training.py”, line 123, in _standardize_input_data<br/>
    str(data_shape))<br/>
ValueError: Error when checking : expected input_2 to have shape (25,) but got array with shape (34,)</p>
<p>Any idea how can i fix this ?<br/>
Thanks.</p>
<div class="reply">
<a aria-label="Reply to Tanisha" class="comment-reply-link" href="#comment-433766" onclick='return addComment.moveForm( "comment-433766", "433766", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-433800">
<div class="comment-container" id="li-comment-433800">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 1, 2018 at 5:46 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-433800" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Are you able to confirm that your Keras version and TF are up to date?</p>
<p>Did you copy all of the code as is?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-433800" onclick='return addComment.moveForm( "comment-433800", "433800", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-434198">
<div class="comment-container" id="li-comment-434198">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/01966d4c589166c443fe4634f9c827b2?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/01966d4c589166c443fe4634f9c827b2?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Tanisha</span>
<span class="date">April 5, 2018 at 11:52 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434198" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Yeah those two are updated i just changed “max_length = 34” to “max_length = 25” in the code and now its working.</p>
<div class="reply">
<a aria-label="Reply to Tanisha" class="comment-reply-link" href="#comment-434198" onclick='return addComment.moveForm( "comment-434198", "434198", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-434215">
<div class="comment-container" id="li-comment-434215">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 5, 2018 at 3:13 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434215" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I’m glad to hear you worked it out.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-434215" onclick='return addComment.moveForm( "comment-434215", "434215", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-433823">
<div class="comment-container" id="li-comment-433823">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/65fb116994026150ff2e74caa6e4b077?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/65fb116994026150ff2e74caa6e4b077?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Harsha</span>
<span class="date">April 1, 2018 at 2:46 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-433823" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>i am getting this error<br/>
X1train, X2train, ytrain = create_sequences(tokenizer, max_length, train_descriptions, train_features)<br/>
  File “fittingmodel.py”, line 109, in create_sequences<br/>
    return array(X1), array(X2), array(y)<br/>
MemoryError</p>
<div class="reply">
<a aria-label="Reply to Harsha" class="comment-reply-link" href="#comment-433823" onclick='return addComment.moveForm( "comment-433823", "433823", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-433869">
<div class="comment-container" id="li-comment-433869">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 2, 2018 at 5:19 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-433869" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps try running the example on a machine with more RAM, or update the example to use progressive loading described in this post:<br/>
<a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/" rel="nofollow">https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-433869" onclick='return addComment.moveForm( "comment-433869", "433869", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-433830">
<div class="comment-container" id="li-comment-433830">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/df49cd9108e5b3e385a503cd9b9a8b49?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/df49cd9108e5b3e385a503cd9b9a8b49?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">pramod choudhari</span>
<span class="date">April 1, 2018 at 4:07 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-433830" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>what backend are you using??</p>
<div class="reply">
<a aria-label="Reply to pramod choudhari" class="comment-reply-link" href="#comment-433830" onclick='return addComment.moveForm( "comment-433830", "433830", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-433872">
<div class="comment-container" id="li-comment-433872">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 2, 2018 at 5:20 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-433872" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>TensorFlow.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-433872" onclick='return addComment.moveForm( "comment-433872", "433872", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-433908">
<div class="comment-container" id="li-comment-433908">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/66f93af559a4285ad89fe276a5c0b4c1?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/66f93af559a4285ad89fe276a5c0b4c1?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">anurag vats</span>
<span class="date">April 2, 2018 at 3:26 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-433908" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>can some one give me this file “model-ep{epoch:03d}-loss{loss:.3f}-val_loss{val_loss:.3f}.h5”<br/>
my pc don’t have enough processing power .</p>
<div class="reply">
<a aria-label="Reply to anurag vats" class="comment-reply-link" href="#comment-433908" onclick='return addComment.moveForm( "comment-433908", "433908", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-433953">
<div class="comment-container" id="li-comment-433953">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 3, 2018 at 6:27 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-433953" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps you could train the model on an EC2 instance:<br/>
<a href="https://machinelearningmastery.com/develop-evaluate-large-deep-learning-models-keras-amazon-web-services/" rel="nofollow">https://machinelearningmastery.com/develop-evaluate-large-deep-learning-models-keras-amazon-web-services/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-433953" onclick='return addComment.moveForm( "comment-433953", "433953", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-433921">
<div class="comment-container" id="li-comment-433921">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/65fb116994026150ff2e74caa6e4b077?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/65fb116994026150ff2e74caa6e4b077?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Harsha</span>
<span class="date">April 2, 2018 at 6:14 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-433921" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>ile “fittingmodel.py”, line 189, in<br/>
    model.fit([X1train, X2train], ytrain, epochs=20, verbose=2, callbacks=[checkpoint], validation_data=([X1test, X2test], ytest))<br/>
  File “C:\Users\pranyaram\Anaconda3\envs\tensorflow\lib\site-packages\keras\engine\training.py”, line 1522, in fit<br/>
    batch_size=batch_size)<br/>
  File “C:\Users\pranyaram\Anaconda3\envs\tensorflow\lib\site-packages\keras\engine\training.py”, line 1378, in _standardize_user_data<br/>
    exception_prefix=’input’)<br/>
  File “C:\Users\pranyaram\Anaconda3\envs\tensorflow\lib\site-packages\keras\engine\training.py”, line 144, in _standardize_input_data<br/>
    str(array.shape))<br/>
ValueError: Error when checking input: expected input_1 to have shape (None, 4096) but got array with shape (0, 1)</p>
<div class="reply">
<a aria-label="Reply to Harsha" class="comment-reply-link" href="#comment-433921" onclick='return addComment.moveForm( "comment-433921", "433921", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-433959">
<div class="comment-container" id="li-comment-433959">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 3, 2018 at 6:32 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-433959" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Are you able to confirm that you are using Python 3 and that your version of Keras is up to date?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-433959" onclick='return addComment.moveForm( "comment-433959", "433959", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-433992">
<div class="comment-container" id="li-comment-433992">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/65fb116994026150ff2e74caa6e4b077?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/65fb116994026150ff2e74caa6e4b077?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Harsha</span>
<span class="date">April 3, 2018 at 2:31 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-433992" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>which keras version should i use</p>
<div class="reply">
<a aria-label="Reply to Harsha" class="comment-reply-link" href="#comment-433992" onclick='return addComment.moveForm( "comment-433992", "433992", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-434052">
<div class="comment-container" id="li-comment-434052">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 4, 2018 at 6:04 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434052" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>The most recent.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-434052" onclick='return addComment.moveForm( "comment-434052", "434052", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-5" id="comment-434102">
<div class="comment-container" id="li-comment-434102">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/65fb116994026150ff2e74caa6e4b077?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/65fb116994026150ff2e74caa6e4b077?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Harsha</span>
<span class="date">April 4, 2018 at 1:42 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434102" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>even still i am getting the same error once check the model training file how to reduce the training size to avoid memory error.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-434164">
<div class="comment-container" id="li-comment-434164">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 5, 2018 at 5:52 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434164" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You can use progressive loading to reduce the memory requirements for the model.</p>
<p>Update: I have updated the tutorial to include an example of training using progressive loading (a data generator).</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-433947">
<div class="comment-container" id="li-comment-433947">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/f18e0457c1d44ede518499510870d1d1?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/f18e0457c1d44ede518499510870d1d1?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Lazuardi</span>
<span class="date">April 3, 2018 at 3:44 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-433947" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hello, Jason! Thank you for your tutorial.</p>
<p>I tried to use pre-trained model and copy-paste the code above to my Anaconda python 3.6 and Keras version of 2.1.5. First, it will run smoothly without any problem, and it begins to crawl on several image files. Unfortunately, after a while, I get this kind of error:</p>
<p>“OSError: cannot identify image file ‘Flicker8k_Dataset/find.py”</p>
<p>Any idea what is wrong? I am running it on my laptop with GPU NVIDIA GeForce 1050 Ti with Intel Core i7-7700HQ with Windows 10 OS.</p>
<p>Thank you in advance!</p>
<div class="reply">
<a aria-label="Reply to Lazuardi" class="comment-reply-link" href="#comment-433947" onclick='return addComment.moveForm( "comment-433947", "433947", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-433971">
<div class="comment-container" id="li-comment-433971">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 3, 2018 at 6:40 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-433971" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Looks like something very strange is going on.</p>
<p>I have not seen this error. Perhaps try running from the commandline, often notebooks and IDEs introduce new and crazy faults of their own.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-433971" onclick='return addComment.moveForm( "comment-433971", "433971", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-434103">
<div class="comment-container" id="li-comment-434103">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/41cdd7e7e6f2405a03cb5a2f7633d114?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/41cdd7e7e6f2405a03cb5a2f7633d114?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">goutham</span>
<span class="date">April 4, 2018 at 1:48 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434103" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Using TensorFlow backend.<br/>
Dataset: 6000<br/>
Descriptions: train=6000<br/>
Photos: train=6000<br/>
Vocabulary Size: 7579<br/>
Description Length: 34<br/>
Traceback (most recent call last):<br/>
  File “model_fit.py”, line 154, in<br/>
    X1train, X2train, ytrain = create_sequences(tokenizer, max_length, train_descriptions, train_features)<br/>
  File “model_fit.py”, line 109, in create_sequences<br/>
    return array(X1), array(X2), array(y)<br/>
MemoryError</p>
<p>how to reduce the training size to avoid this error.</p>
<div class="reply">
<a aria-label="Reply to goutham" class="comment-reply-link" href="#comment-434103" onclick='return addComment.moveForm( "comment-434103", "434103", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-434165">
<div class="comment-container" id="li-comment-434165">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 5, 2018 at 5:52 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434165" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You can use progressive loading to reduce the memory requirements for the model.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-434165" onclick='return addComment.moveForm( "comment-434165", "434165", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-2" id="comment-435081">
<div class="comment-container" id="li-comment-435081">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/f381c71a25c012d6dcfa500aa573d27b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/f381c71a25c012d6dcfa500aa573d27b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Belgaroui</span>
<span class="date">April 15, 2018 at 10:22 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435081" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I got the same error “OSError: cannot identify image file ‘Flicker8k_Dataset/desktop.ini'” did you fix it?</p>
<div class="reply">
<a aria-label="Reply to Belgaroui" class="comment-reply-link" href="#comment-435081" onclick='return addComment.moveForm( "comment-435081", "435081", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-3" id="comment-435109">
<div class="comment-container" id="li-comment-435109">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 16, 2018 at 6:10 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435109" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Looks like you have a windows file called desktop.ini in the directory for some reason. Delete it.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-435109" onclick='return addComment.moveForm( "comment-435109", "435109", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-434114">
<div class="comment-container" id="li-comment-434114">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/65fb116994026150ff2e74caa6e4b077?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/65fb116994026150ff2e74caa6e4b077?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">harsha</span>
<span class="date">April 4, 2018 at 5:58 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434114" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi,  can you provide me the weights file. My laptop is having 12GB RAM, NVIDIA GeForce 820M Graphics, all supported drivers. But Iam getting the memory error issue.</p>
<p>I have tried progressive loading also.. But it is not working.. It is not saving the weights file even after steps per epoch=70000 is completed even. I cant afford for the AWS.<br/>
So, I request you to give me the weights file.<br/>
Thanks in advance.</p>
<div class="reply">
<a aria-label="Reply to harsha" class="comment-reply-link" href="#comment-434114" onclick='return addComment.moveForm( "comment-434114", "434114", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-434166">
<div class="comment-container" id="li-comment-434166">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 5, 2018 at 5:53 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434166" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Sorry, I cannot share the weights file.</p>
<p>I will schedule time into updating the tutorial to add a progressive loading example.</p>
<p>Update: I have updated the tutorial to include an example of training using progressive loading (a data generator).</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-434166" onclick='return addComment.moveForm( "comment-434166", "434166", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-434137">
<div class="comment-container" id="li-comment-434137">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/80515d043860349a1a6a11babc8b3f77?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/80515d043860349a1a6a11babc8b3f77?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">manish</span>
<span class="date">April 5, 2018 at 12:58 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434137" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi,<br/>
I got an error while generating the captions.</p>
<p>Here is the error:</p>
<p>Traceback (most recent call last):<br/>
  File “generate_captions5.py”, line 64, in<br/>
    tokenizer = load(open(‘descriptions.txt’, ‘rb’))<br/>
_pickle.UnpicklingError: could not find MARK</p>
<div class="reply">
<a aria-label="Reply to manish" class="comment-reply-link" href="#comment-434137" onclick='return addComment.moveForm( "comment-434137", "434137", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-434179">
<div class="comment-container" id="li-comment-434179">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 5, 2018 at 6:09 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434179" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I have not seen this error before, sorry. Perhaps try running the code again?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-434179" onclick='return addComment.moveForm( "comment-434179", "434179", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-434149">
<div class="comment-container" id="li-comment-434149">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/65fb116994026150ff2e74caa6e4b077?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/65fb116994026150ff2e74caa6e4b077?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">harsha</span>
<span class="date">April 5, 2018 at 4:50 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434149" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>startseq man in red shirt is standing on the street endseq</p>
<p>caption is generating but it is giving same caption for different images.</p>
<div class="reply">
<a aria-label="Reply to harsha" class="comment-reply-link" href="#comment-434149" onclick='return addComment.moveForm( "comment-434149", "434149", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-434187">
<div class="comment-container" id="li-comment-434187">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 5, 2018 at 6:15 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434187" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps your model requires further training?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-434187" onclick='return addComment.moveForm( "comment-434187", "434187", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-434207">
<div class="comment-container" id="li-comment-434207">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/80515d043860349a1a6a11babc8b3f77?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/80515d043860349a1a6a11babc8b3f77?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">manish</span>
<span class="date">April 5, 2018 at 2:16 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434207" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>val-loss is improving up to 3 epoches only, there’s no any improvement in further epoches.</p>
<p>model-ep003-loss3.662-val_loss3.824.h5. This is the last epoche that has improved till now.</p>
<div class="reply">
<a aria-label="Reply to manish" class="comment-reply-link" href="#comment-434207" onclick='return addComment.moveForm( "comment-434207", "434207", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-434413">
<div class="comment-container" id="li-comment-434413">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/c9f3b1afb9c01b9c71bcad127eaa71e8?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/c9f3b1afb9c01b9c71bcad127eaa71e8?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">SAI</span>
<span class="date">April 8, 2018 at 12:49 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434413" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>File “”, line 1, in<br/>
    runfile(‘C:/Users/Owner/.spyder-py3/ML/4.py’, wdir=’C:/Users/Owner/.spyder-py3/ML’)</p>
<p>  File “C:\Users\Owner\Anaconda_3\lib\site-packages\spyder\utils\site\sitecustomize.py”, line 705, in runfile<br/>
    execfile(filename, namespace)</p>
<p>  File “C:\Users\Owner\Anaconda_3\lib\site-packages\spyder\utils\site\sitecustomize.py”, line 102, in execfile<br/>
    exec(compile(f.read(), filename, ‘exec’), namespace)</p>
<p>  File “C:/Users/Owner/.spyder-py3/ML/4.py”, line 161, in<br/>
    model = define_model(vocab_size, max_length)</p>
<p>  File “C:/Users/Owner/.spyder-py3/ML/4.py”, line 129, in define_model<br/>
    plot_model(model, to_file=’model.png’, show_shapes=True)</p>
<p>  File “C:\Users\Owner\Anaconda_3\lib\site-packages\keras\utils\vis_utils.py”, line 135, in plot_model<br/>
    dot = model_to_dot(model, show_shapes, show_layer_names, rankdir)</p>
<p>  File “C:\Users\Owner\Anaconda_3\lib\site-packages\keras\utils\vis_utils.py”, line 56, in model_to_dot<br/>
    _check_pydot()</p>
<p>  File “C:\Users\Owner\Anaconda_3\lib\site-packages\keras\utils\vis_utils.py”, line 31, in _check_pydot<br/>
    raise ImportError(‘Failed to import pydot. You must install pydot’</p>
<p>ImportError: Failed to import pydot. You must install pydot and graphviz for <code>pydotprint</code> to work.</p>
<p>getting this even if i installed pydot and graphviz</p>
<div class="reply">
<a aria-label="Reply to SAI" class="comment-reply-link" href="#comment-434413" onclick='return addComment.moveForm( "comment-434413", "434413", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-434437">
<div class="comment-container" id="li-comment-434437">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 8, 2018 at 6:22 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434437" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps restart your machine?</p>
<p>Perhaps comment out the part where you visualize the model?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-434437" onclick='return addComment.moveForm( "comment-434437", "434437", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment odd alt depth-2" id="comment-434479">
<div class="comment-container" id="li-comment-434479">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/767168516364d31712f2617681ec973c?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/767168516364d31712f2617681ec973c?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">deep_ml</span>
<span class="date">April 9, 2018 at 3:23 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434479" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>getting same error!<br/>
Tried using solution from stackoverflow, upgraded packages..but it ain’t working..</p>
<div class="reply">
<a aria-label="Reply to deep_ml" class="comment-reply-link" href="#comment-434479" onclick='return addComment.moveForm( "comment-434479", "434479", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-3" id="comment-434500">
<div class="comment-container" id="li-comment-434500">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 9, 2018 at 6:12 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434500" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>No problem, just skip that part and proceed. Comment out the plotting of the model.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-434500" onclick='return addComment.moveForm( "comment-434500", "434500", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-434530">
<div class="comment-container" id="li-comment-434530">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/767168516364d31712f2617681ec973c?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/767168516364d31712f2617681ec973c?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">deep_ml</span>
<span class="date">April 9, 2018 at 4:06 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434530" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I have trained the data using progressive loading and I stopped after 4 iterations, with a loss of 3.4952.</p>
<p>I am unable to understand this part,<br/>
In this simple example we will discard the loading of the development dataset and model checkpointing and simply save the model after each training epoch. You can then go back and load/evaluate each saved model after training to find the one we the lowest loss that you can then use in the next section. </p>
<p>Do you mean we have to load test set in the same way using progressive loading ?<br/>
Please help me understanding how to load the test set.</p>
<div class="reply">
<a aria-label="Reply to deep_ml" class="comment-reply-link" href="#comment-434530" onclick='return addComment.moveForm( "comment-434530", "434530", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-434593">
<div class="comment-container" id="li-comment-434593">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 10, 2018 at 6:15 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434593" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I am suggesting that you may want to load the test data in the existing way and evaluate your model (next section).</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-434593" onclick='return addComment.moveForm( "comment-434593", "434593", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-434741">
<div class="comment-container" id="li-comment-434741">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/429586250cec7db8efd2d17f8c00854b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/429586250cec7db8efd2d17f8c00854b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Jesia</span>
<span class="date">April 11, 2018 at 6:25 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434741" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Error by runing “The complete code example is listed below.” in the Loading Data section:</p>
<p>Message Body:<br/>
Dataset: 6000<br/>
Descriptions: train=6000<br/>
Traceback (most recent call last):<br/>
  File “task2.py”, line 64, in<br/>
    train_features = load_photo_features(‘features.pkl’, train)<br/>
  File “task2.py”, line 53, in load_photo_features<br/>
    features = {k: all_features[k] for k in dataset}<br/>
  File “task2.py”, line 53, in<br/>
    features = {k: all_features[k] for k in dataset}<br/>
KeyError: ‘878758390_dd2cdc42f6’</p>
<div class="reply">
<a aria-label="Reply to Jesia" class="comment-reply-link" href="#comment-434741" onclick='return addComment.moveForm( "comment-434741", "434741", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-434792">
<div class="comment-container" id="li-comment-434792">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 12, 2018 at 8:35 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434792" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps confirm that you have the full dataset in place?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-434792" onclick='return addComment.moveForm( "comment-434792", "434792", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-435825">
<div class="comment-container" id="li-comment-435825">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/429586250cec7db8efd2d17f8c00854b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/429586250cec7db8efd2d17f8c00854b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Jesia</span>
<span class="date">April 24, 2018 at 11:22 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435825" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Yes, some images were missed.</p>
<p>Thank you</p>
<div class="reply">
<a aria-label="Reply to Jesia" class="comment-reply-link" href="#comment-435825" onclick='return addComment.moveForm( "comment-435825", "435825", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-434774">
<div class="comment-container" id="li-comment-434774">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/f381c71a25c012d6dcfa500aa573d27b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/f381c71a25c012d6dcfa500aa573d27b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Belgaroui</span>
<span class="date">April 12, 2018 at 12:31 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434774" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hello sir I’m learning from your articles that I find very informative and educational, I’ve been trying to compile this code :<br/>
# extract features from all images<br/>
directory = ‘Flicker8k_Dataset’<br/>
features = extract_features(directory)<br/>
print(‘Extracted Features: %d’ % len(features))<br/>
# save to file<br/>
dump(features, open(‘features.pkl’, ‘wb’))</p>
<p>but an error occurred and I don’t understand it can you help me fix it and thanks for all of you<br/>
here’s the mistake I made:<br/>
PermissionError                           Traceback (most recent call last)<br/>
 in ()<br/>
      1 # extract features from all images<br/>
      2 directory = ‘Flicker8k_Dataset’<br/>
—-&gt; 3 features = extract_features(directory)<br/>
      4 print(‘Extracted Features: %d’ % len(features))<br/>
      5 # save to file</p>
<p> in extract_features(directory)<br/>
     13                 # load an image from file<br/>
     14                 filename = directory + ‘/’ + name<br/>
—&gt; 15                 image = load_img(filename, target_size=(224, 224))<br/>
     16                 # convert the image pixels to a numpy array<br/>
     17                 image = img_to_array(image)</p>
<p>~\Anaconda3\envs\envir1\lib\site-packages\keras\preprocessing\image.py in load_img(path, grayscale, target_size, interpolation)<br/>
    360         raise ImportError(‘Could not import PIL.Image. ‘<br/>
    361                           ‘The use of <code>array_to_img</code> requires PIL.’)<br/>
–&gt; 362     img = pil_image.open(path)<br/>
    363     if grayscale:<br/>
    364         if img.mode != ‘L’:</p>
<p>~\Anaconda3\envs\envir1\lib\site-packages\PIL\Image.py in open(fp, mode)<br/>
   2546<br/>
   2547     if filename:<br/>
-&gt; 2548         fp = builtins.open(filename, “rb”)<br/>
   2549         exclusive_fp = True<br/>
   2550 </p>
<p>PermissionError: [Errno 13] Permission denied: ‘Flicker8k_Dataset/Flicker8k_Dataset’</p>
<div class="reply">
<a aria-label="Reply to Belgaroui" class="comment-reply-link" href="#comment-434774" onclick='return addComment.moveForm( "comment-434774", "434774", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-434809">
<div class="comment-container" id="li-comment-434809">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 12, 2018 at 8:47 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434809" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Looks like the dataset is missing or is not available on your workstation.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-434809" onclick='return addComment.moveForm( "comment-434809", "434809", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-434860">
<div class="comment-container" id="li-comment-434860">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/d4c1fe917e9b669f735c30878f24fff8?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d4c1fe917e9b669f735c30878f24fff8?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Seaf</span>
<span class="date">April 13, 2018 at 1:33 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434860" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hello sir, Thanks for your effort</p>
<p>I have trained the data using progressive loading and my machine restarted after 11 iterations,<br/>
how can i continue training from that checkpoint ?</p>
<div class="reply">
<a aria-label="Reply to Seaf" class="comment-reply-link" href="#comment-434860" onclick='return addComment.moveForm( "comment-434860", "434860", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-434884">
<div class="comment-container" id="li-comment-434884">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 13, 2018 at 6:42 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434884" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Load the last saved model, then continue training. As simple as that.</p>
<p>I doubt more than a handful of epochs is required on this problem.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-434884" onclick='return addComment.moveForm( "comment-434884", "434884", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-434897">
<div class="comment-container" id="li-comment-434897">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/d4c1fe917e9b669f735c30878f24fff8?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d4c1fe917e9b669f735c30878f24fff8?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Seaf</span>
<span class="date">April 13, 2018 at 12:44 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434897" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>thank you !</p>
<p>i have loaded the last model (‘model_11.h5’) that has 3.445 loss, now it continue training with 5.4461 loss, is that normal ?</p>
<div class="reply">
<a aria-label="Reply to Seaf" class="comment-reply-link" href="#comment-434897" onclick='return addComment.moveForm( "comment-434897", "434897", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-434904">
<div class="comment-container" id="li-comment-434904">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 13, 2018 at 3:32 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434904" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Interesting, that is a little surprising. I wonder if there is a fault or if indeed the model loss has gotten worse.</p>
<p>Some careful experiments may be required.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-434904" onclick='return addComment.moveForm( "comment-434904", "434904", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-434866">
<div class="comment-container" id="li-comment-434866">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/f381c71a25c012d6dcfa500aa573d27b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/f381c71a25c012d6dcfa500aa573d27b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Belgaroui</span>
<span class="date">April 13, 2018 at 3:07 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434866" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thank you, I think so too….</p>
<p>I already downloaded Flicker8k_Datasets and extracted it in the same file where I work with jupyter notebook.</p>
<p>I consulted Google and Youtube to try to fix this error but in vain…</p>
<p>I don’t know but could you be so kind as to direct me and help me fix the problem.<br/>
Thank you very much for your efforts…</p>
<div class="reply">
<a aria-label="Reply to Belgaroui" class="comment-reply-link" href="#comment-434866" onclick='return addComment.moveForm( "comment-434866", "434866", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-434887">
<div class="comment-container" id="li-comment-434887">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 13, 2018 at 6:43 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434887" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>What problem?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-434887" onclick='return addComment.moveForm( "comment-434887", "434887", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-434942">
<div class="comment-container" id="li-comment-434942">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/f381c71a25c012d6dcfa500aa573d27b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/f381c71a25c012d6dcfa500aa573d27b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Belgaroui</span>
<span class="date">April 14, 2018 at 12:46 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434942" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,<br/>
 when I try to compile code related to the extracted features from all images I get this error that is “Permission denied” you told me earlier that Looks like the dataset is missing or is not available on my workstation I tried to fix the trick but in vain.<br/>
Do you have any idea how I could do that?<br/>
Do I need a user right or something like that?<br/>
or maybe I need to reload the database?</p>
<p>*the error :<br/>
~\Anaconda3\envs\envir1\lib\site-packages\PIL\Image.py in open(fp, mode)2546<br/>
2547 if filename:<br/>
-&gt; 2548 fp = builtins.open(filename, “rb”)<br/>
2549 exclusive_fp = True<br/>
2550</p>
<p>PermissionError: [Errno 13] Permission denied: ‘Flicker8k_Dataset/Flicker8k_Dataset’</p>
<p>thanks a lot 🙂 🙂</p>
<div class="reply">
<a aria-label="Reply to Belgaroui" class="comment-reply-link" href="#comment-434942" onclick='return addComment.moveForm( "comment-434942", "434942", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-434972">
<div class="comment-container" id="li-comment-434972">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 14, 2018 at 6:47 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-434972" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You appear to have a problem loading the data from your hard drive. Perhaps you stored the data in a location where you/your code does not have permission to read?</p>
<p>Perhaps you are using a notebook or an IDE as another user?</p>
<p>Try running from the command line and check file permissions.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-434972" onclick='return addComment.moveForm( "comment-434972", "434972", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-435003">
<div class="comment-container" id="li-comment-435003">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/bd5097ac9d77ab43e33cf2f385c9d41d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/bd5097ac9d77ab43e33cf2f385c9d41d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">@nkish</span>
<span class="date">April 14, 2018 at 4:56 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435003" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks Jason. I really appreciate your knowledge and the way you express it to us through your articles, it’s amazing.</p>
<div class="reply">
<a aria-label="Reply to @nkish" class="comment-reply-link" href="#comment-435003" onclick='return addComment.moveForm( "comment-435003", "435003", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-435042">
<div class="comment-container" id="li-comment-435042">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 15, 2018 at 6:24 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435042" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks, I’m glad the tutorials help!</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-435042" onclick='return addComment.moveForm( "comment-435042", "435042", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-435012">
<div class="comment-container" id="li-comment-435012">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/88ee247af204fb9453d5e73f062bc395?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/88ee247af204fb9453d5e73f062bc395?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Abdallah</span>
<span class="date">April 14, 2018 at 7:15 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435012" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thank you very much mr.jason but I have some problems after download the pretrained model when make the model prediction<br/>
‘<br/>
—————————————————————————<br/>
FailedPreconditionError                   Traceback (most recent call last)<br/>
~/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py in _do_call(self, fn, *args)<br/>
   1349     try:<br/>
-&gt; 1350       return fn(*args)<br/>
   1351     except errors.OpError as e:</p>
<p>~/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py in _run_fn(session, feed_dict, fetch_list, target_list, options, run_metadata)<br/>
   1328                                    feed_dict, fetch_list, target_list,<br/>
-&gt; 1329                                    status, run_metadata)<br/>
   1330 </p>
<p>~/.local/lib/python3.6/site-packages/tensorflow/python/framework/errors_impl.py in __exit__(self, type_arg, value_arg, traceback_arg)<br/>
    472             compat.as_text(c_api.TF_Message(self.status.status)),<br/>
–&gt; 473             c_api.TF_GetCode(self.status.status))<br/>
    474     # Delete the underlying status object from memory otherwise it stays alive</p>
<p>FailedPreconditionError: Attempting to use uninitialized value block1_conv2_5/kernel<br/>
	 [[Node: block1_conv2_5/kernel/read = Identity[T=DT_FLOAT, _class=[“loc:@block1_conv2_5/kernel”], _device=”/job:localhost/replica:0/task:0/device:CPU:0″](block1_conv2_5/kernel)]]</p>
<p>During handling of the above exception, another exception occurred:</p>
<p>FailedPreconditionError                   Traceback (most recent call last)<br/>
 in ()<br/>
     24     return features<br/>
     25 directory = ‘../ProjectPattern/Flickr8k_Dataset/Flicker8k_Dataset’<br/>
—&gt; 26 features =extract_feature(directory)<br/>
     27 dump(features,open(“feature.pkl”,”wb”))</p>
<p> in extract_feature(directory)<br/>
     17         img =preprocess_input(img)<br/>
     18         #extract feature by make prediction use the pretrained model<br/>
—&gt; 19         feature = model.predict(img,verbose=0)<br/>
     20         #extract img_id<br/>
     21         img_id = name.split(‘.’)[0]</p>
<p>~/.local/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/engine/training.py in predict(self, x, batch_size, verbose, steps)<br/>
   1811     f = self.predict_function<br/>
   1812     return self._predict_loop(<br/>
-&gt; 1813         f, ins, batch_size=batch_size, verbose=verbose, steps=steps)<br/>
   1814<br/>
   1815   def train_on_batch(self, x, y, sample_weight=None, class_weight=None):</p>
<p>~/.local/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/engine/training.py in _predict_loop(self, f, ins, batch_size, verbose, steps)<br/>
   1306         else:<br/>
   1307           ins_batch = _slice_arrays(ins, batch_ids)<br/>
-&gt; 1308         batch_outs = f(ins_batch)<br/>
   1309         if not isinstance(batch_outs, list):<br/>
   1310           batch_outs = [batch_outs]</p>
<p>~/.local/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/backend.py in __call__(self, inputs)<br/>
   2551     session = get_session()<br/>
   2552     updated = session.run(<br/>
-&gt; 2553         fetches=fetches, feed_dict=feed_dict, **self.session_kwargs)<br/>
   2554     return updated[:len(self.outputs)]<br/>
   2555 </p>
<p>~/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py in run(self, fetches, feed_dict, options, run_metadata)<br/>
    893     try:<br/>
    894       result = self._run(None, fetches, feed_dict, options_ptr,<br/>
–&gt; 895                          run_metadata_ptr)<br/>
    896       if run_metadata:<br/>
    897         proto_data = tf_session.TF_GetBuffer(run_metadata_ptr)</p>
<p>~/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py in _run(self, handle, fetches, feed_dict, options, run_metadata)<br/>
   1126     if final_fetches or final_targets or (handle and feed_dict_tensor):<br/>
   1127       results = self._do_run(handle, final_targets, final_fetches,<br/>
-&gt; 1128                              feed_dict_tensor, options, run_metadata)<br/>
   1129     else:<br/>
   1130       results = []</p>
<p>~/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py in _do_run(self, handle, target_list, fetch_list, feed_dict, options, run_metadata)<br/>
   1342     if handle is None:<br/>
   1343       return self._do_call(_run_fn, self._session, feeds, fetches, targets,<br/>
-&gt; 1344                            options, run_metadata)<br/>
   1345     else:<br/>
   1346       return self._do_call(_prun_fn, self._session, handle, feeds, fetches)</p>
<p>~/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py in _do_call(self, fn, *args)<br/>
   1361         except KeyError:<br/>
   1362           pass<br/>
-&gt; 1363       raise type(e)(node_def, op, message)<br/>
   1364<br/>
   1365   def _extend_graph(self):</p>
<p>FailedPreconditionError: Attempting to use uninitialized value block1_conv2_5/kernel<br/>
	 [[Node: block1_conv2_5/kernel/read = Identity[T=DT_FLOAT, _class=[“loc:@block1_conv2_5/kernel”], _device=”/job:localhost/replica:0/task:0/device:CPU:0″](block1_conv2_5/kernel)]]</p>
<p>Caused by op ‘block1_conv2_5/kernel/read’, defined at:<br/>
  File “/usr/lib/python3.6/runpy.py”, line 193, in _run_module_as_main<br/>
    “__main__”, mod_spec)<br/>
  File “/usr/lib/python3.6/runpy.py”, line 85, in _run_code<br/>
    exec(code, run_globals)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/ipykernel_launcher.py”, line 16, in<br/>
    app.launch_new_instance()<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/traitlets/config/application.py”, line 658, in launch_instance<br/>
    app.start()<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/ipykernel/kernelapp.py”, line 478, in start<br/>
    self.io_loop.start()<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/zmq/eventloop/ioloop.py”, line 177, in start<br/>
    super(ZMQIOLoop, self).start()<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/tornado/ioloop.py”, line 888, in start<br/>
    handler_func(fd_obj, events)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/tornado/stack_context.py”, line 277, in null_wrapper<br/>
    return fn(*args, **kwargs)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/zmq/eventloop/zmqstream.py”, line 440, in _handle_events<br/>
    self._handle_recv()<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/zmq/eventloop/zmqstream.py”, line 472, in _handle_recv<br/>
    self._run_callback(callback, msg)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/zmq/eventloop/zmqstream.py”, line 414, in _run_callback<br/>
    callback(*args, **kwargs)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/tornado/stack_context.py”, line 277, in null_wrapper<br/>
    return fn(*args, **kwargs)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/ipykernel/kernelbase.py”, line 283, in dispatcher<br/>
    return self.dispatch_shell(stream, msg)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/ipykernel/kernelbase.py”, line 233, in dispatch_shell<br/>
    handler(stream, idents, msg)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/ipykernel/kernelbase.py”, line 399, in execute_request<br/>
    user_expressions, allow_stdin)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/ipykernel/ipkernel.py”, line 208, in do_execute<br/>
    res = shell.run_cell(code, store_history=store_history, silent=silent)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/ipykernel/zmqshell.py”, line 537, in run_cell<br/>
    return super(ZMQInteractiveShell, self).run_cell(*args, **kwargs)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/IPython/core/interactiveshell.py”, line 2728, in run_cell<br/>
    interactivity=interactivity, compiler=compiler, result=result)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/IPython/core/interactiveshell.py”, line 2850, in run_ast_nodes<br/>
    if self.run_code(code, result):<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/IPython/core/interactiveshell.py”, line 2910, in run_code<br/>
    exec(code_obj, self.user_global_ns, self.user_ns)<br/>
  File “”, line 26, in<br/>
    features =extract_feature(directory)<br/>
  File “”, line 2, in extract_feature<br/>
    model = VGG19()<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/keras/applications/vgg19.py”, line 117, in VGG19<br/>
    x = Conv2D(64, (3, 3), activation=’relu’, padding=’same’, name=’block1_conv2′)(x)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/keras/engine/topology.py”, line 590, in __call__<br/>
    self.build(input_shapes[0])<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/keras/layers/convolutional.py”, line 138, in build<br/>
    constraint=self.kernel_constraint)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/keras/legacy/interfaces.py”, line 91, in wrapper<br/>
    return func(*args, **kwargs)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/keras/engine/topology.py”, line 414, in add_weight<br/>
    constraint=constraint)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/keras/backend/tensorflow_backend.py”, line 392, in variable<br/>
    v = tf.Variable(value, dtype=tf.as_dtype(dtype), name=name)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/tensorflow/python/ops/variables.py”, line 229, in __init__<br/>
    constraint=constraint)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/tensorflow/python/ops/variables.py”, line 376, in _init_from_args<br/>
    self._snapshot = array_ops.identity(self._variable, name=”read”)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/tensorflow/python/ops/array_ops.py”, line 127, in identity<br/>
    return gen_array_ops.identity(input, name=name)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py”, line 2134, in identity<br/>
    “Identity”, input=input, name=name)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py”, line 787, in _apply_op_helper<br/>
    op_def=op_def)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py”, line 3160, in create_op<br/>
    op_def=op_def)<br/>
  File “/home/abdo96/.local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py”, line 1625, in __init__<br/>
    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access</p>
<p>FailedPreconditionError (see above for traceback): Attempting to use uninitialized value block1_conv2_5/kernel<br/>
	 [[Node: block1_conv2_5/kernel/read = Identity[T=DT_FLOAT, _class=[“loc:@block1_conv2_5/kernel”], _device=”/job:localhost/replica:0/task:0/device:CPU:0″](block1_conv2_5/kernel)]]<br/>
‘</p>
<div class="reply">
<a aria-label="Reply to Abdallah" class="comment-reply-link" href="#comment-435012" onclick='return addComment.moveForm( "comment-435012", "435012", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-435043">
<div class="comment-container" id="li-comment-435043">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 15, 2018 at 6:25 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435043" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Wow. I have not seen this before, sorry.</p>
<p>Perhaps try searching or posting on stackoverflow?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-435043" onclick='return addComment.moveForm( "comment-435043", "435043", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-435256">
<div class="comment-container" id="li-comment-435256">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/88ee247af204fb9453d5e73f062bc395?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/88ee247af204fb9453d5e73f062bc395?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Abdallah</span>
<span class="date">April 17, 2018 at 9:18 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435256" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>so the problem solved by specifying which weights used not None(random initialization)<br/>
but used pretraining on ‘imagenet’ and specify the include_top argument to be True</p>
<div class="reply">
<a aria-label="Reply to Abdallah" class="comment-reply-link" href="#comment-435256" onclick='return addComment.moveForm( "comment-435256", "435256", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-435301">
<div class="comment-container" id="li-comment-435301">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 18, 2018 at 8:04 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435301" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Well done, I’m glad to hear that.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-435301" onclick='return addComment.moveForm( "comment-435301", "435301", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-435052">
<div class="comment-container" id="li-comment-435052">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/88ee247af204fb9453d5e73f062bc395?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/88ee247af204fb9453d5e73f062bc395?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Abdallah</span>
<span class="date">April 15, 2018 at 9:45 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435052" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>When using Merged input in model the error below showed<br/>
Thanks in advance</p>
<p> in ()<br/>
     29     plot_model(model,to_file=’model.png’,show_shapes=True,show_layer_names=True)<br/>
     30     return model<br/>
—&gt; 31 define_model(vocab_size,max_len)</p>
<p> in define_model(vocab_size, max_length)<br/>
     26     model = Model(inputs=[input1,input2],outputs=output)<br/>
     27<br/>
—&gt; 28     model.compile(loss=’categorical_crossentropy’,optimizer=’Adam’)(mask)<br/>
     29     plot_model(model,to_file=’model.png’,show_shapes=True,show_layer_names=True)<br/>
     30     return model</p>
<p>~/.local/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/engine/training.py in compile(self, optimizer, loss, metrics, loss_weights, sample_weight_mode, weighted_metrics, target_tensors, **kwargs)<br/>
    679<br/>
    680     # Prepare output masks.<br/>
–&gt; 681     masks = self.compute_mask(self.inputs, mask=None)<br/>
    682     if masks is None:<br/>
    683       masks = [None for _ in self.outputs]</p>
<p>~/.local/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/engine/topology.py in compute_mask(self, inputs, mask)<br/>
    785       return self._output_mask_cache[cache_key]<br/>
    786     else:<br/>
–&gt; 787       _, output_masks = self._run_internal_graph(inputs, masks)<br/>
    788       return output_masks<br/>
    789 </p>
<p>~/.local/lib/python3.6/site-packages/tensorflow/python/layers/network.py in _run_internal_graph(self, inputs, masks)<br/>
    896<br/>
    897             # Apply activity regularizer if any:<br/>
–&gt; 898             if layer.activity_regularizer is not None:<br/>
    899               regularization_losses = [<br/>
    900                   layer.activity_regularizer(x) for x in computed_tensors</p>
<p>AttributeError: ‘InputLayer’ object has no attribute ‘activity_regularizer’</p>
<div class="reply">
<a aria-label="Reply to Abdallah" class="comment-reply-link" href="#comment-435052" onclick='return addComment.moveForm( "comment-435052", "435052", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-435098">
<div class="comment-container" id="li-comment-435098">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 16, 2018 at 6:01 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435098" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>What version of Keras are you using?</p>
<p>Did you copy all of the code exactly?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-435098" onclick='return addComment.moveForm( "comment-435098", "435098", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-435148">
<div class="comment-container" id="li-comment-435148">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/88ee247af204fb9453d5e73f062bc395?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/88ee247af204fb9453d5e73f062bc395?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Abdallah</span>
<span class="date">April 16, 2018 at 7:07 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435148" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I used verison 2.1.5<br/>
the another question No, I didn’t copy all the code exactly but I understand the idea and imitate it in some parts and in other parts are written in my own</p>
<div class="reply">
<a aria-label="Reply to Abdallah" class="comment-reply-link" href="#comment-435148" onclick='return addComment.moveForm( "comment-435148", "435148", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-435187">
<div class="comment-container" id="li-comment-435187">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 17, 2018 at 5:56 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435187" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Sorry, I cannot help you debug your own modifications.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-435187" onclick='return addComment.moveForm( "comment-435187", "435187", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-5" id="comment-435255">
<div class="comment-container" id="li-comment-435255">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/88ee247af204fb9453d5e73f062bc395?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/88ee247af204fb9453d5e73f062bc395?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Abdallah</span>
<span class="date">April 17, 2018 at 9:10 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435255" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I wrote this problem in the stack overflow but no one answer so I will try to fix this problem in my own Thank you for your answers</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-435300">
<div class="comment-container" id="li-comment-435300">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 18, 2018 at 8:04 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435300" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hang in there.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-435578">
<div class="comment-container" id="li-comment-435578">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/b5724d83a89f8a9315fa79b7e3a79846?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/b5724d83a89f8a9315fa79b7e3a79846?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">prateek bansal</span>
<span class="date">April 21, 2018 at 4:03 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435578" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi, jason brownlee thanks for this fatanstic article.<br/>
I am curios to know that how he while loop is getting stopped in  progressive training data genertor function ?<br/>
Please explain this to me </p>
<p>def data_generator(descriptions, photos, tokenizer, max_length):</p>
<p># loop for ever over images<br/>
	while 1:<br/>
		for key, desc_list in descriptions.items():<br/>
			# retrieve the photo feature<br/>
			photo = photos[key][0]<br/>
			in_img, in_seq, out_word = create_sequences(tokenizer, max_length, desc_list, photo)<br/>
			yield [[in_img, in_seq], out_word]</p>
<div class="reply">
<a aria-label="Reply to prateek bansal" class="comment-reply-link" href="#comment-435578" onclick='return addComment.moveForm( "comment-435578", "435578", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-435618">
<div class="comment-container" id="li-comment-435618">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 22, 2018 at 5:58 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435618" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Note the yield.</p>
<p>The number of epochs will decide how many times the yeild to the caller will be performed.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-435618" onclick='return addComment.moveForm( "comment-435618", "435618", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-435751">
<div class="comment-container" id="li-comment-435751">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/b5724d83a89f8a9315fa79b7e3a79846?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/b5724d83a89f8a9315fa79b7e3a79846?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Prateek Bansal</span>
<span class="date">April 24, 2018 at 6:03 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435751" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi jason Brownlee,<br/>
Can you please tell me what is the heighest BLEU Scores you got from this approach on standard dataset like flickr 8k, 30k etc.</p>
<p>Please guide me how u you mananged to acheive this much Blue scores.<br/>
What is the architecutre You used.</p>
<p>Is there any result comparable to “show and tell model” ?</p>
<div class="reply">
<a aria-label="Reply to Prateek Bansal" class="comment-reply-link" href="#comment-435751" onclick='return addComment.moveForm( "comment-435751", "435751", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-435773">
<div class="comment-container" id="li-comment-435773">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 24, 2018 at 6:38 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435773" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>All details of the model are in the post.</p>
<p>You can learn more about the chosen architecture here:<br/>
<a href="https://machinelearningmastery.com/caption-generation-inject-merge-architectures-encoder-decoder-model/" rel="nofollow">https://machinelearningmastery.com/caption-generation-inject-merge-architectures-encoder-decoder-model/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-435773" onclick='return addComment.moveForm( "comment-435773", "435773", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-435603">
<div class="comment-container" id="li-comment-435603">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/bcab1a3a8c23c3f52148707ec003b594?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/bcab1a3a8c23c3f52148707ec003b594?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Jubaer Hossain</span>
<span class="date">April 22, 2018 at 12:31 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435603" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Sir,<br/>
Great article indeed! But I’m facing problems downloading the model. Every time I try to download the model with the code you provided, after sometimes the connection gets lost and shows this message:  “ConnectionResetError: [WinError 10054] An existing connection was forcibly closed by the remote host”</p>
<p>Can you give any alternate solution to this problem? I have tried several times but failed.</p>
<div class="reply">
<a aria-label="Reply to Jubaer Hossain" class="comment-reply-link" href="#comment-435603" onclick='return addComment.moveForm( "comment-435603", "435603", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-435622">
<div class="comment-container" id="li-comment-435622">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 22, 2018 at 6:01 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435622" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I’m sorry to hear that, I have some ideas:</p>
<p>– Perhaps you can review the code in Keras that downloads the model and download it manually?<br/>
– Perhaps you can use an alternate internet connection to download the model?<br/>
– Perhaps you can setup an EC2 instance and download the model there to work with?<br/>
– Perhaps you can ask a friend or peer to download the model for you?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-435622" onclick='return addComment.moveForm( "comment-435622", "435622", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-435800">
<div class="comment-container" id="li-comment-435800">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/f434fad602b1cfcb83a8acd2994e44c0?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/f434fad602b1cfcb83a8acd2994e44c0?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Sailee</span>
<span class="date">April 24, 2018 at 4:15 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435800" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hello Sir,<br/>
Your article is very interesting and easy to understand. </p>
<p>For the above code I am getting a very accurate caption if I use the same image as you have shown in the figure. But if I use some other image I am getting some description but not a correct one. So could you please tell me what is the problem here?<br/>
Thanks in advance.</p>
<div class="reply">
<a aria-label="Reply to Sailee" class="comment-reply-link" href="#comment-435800" onclick='return addComment.moveForm( "comment-435800", "435800", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-435840">
<div class="comment-container" id="li-comment-435840">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 25, 2018 at 6:18 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435840" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps try a suite of images to see how the model performs on average?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-435840" onclick='return addComment.moveForm( "comment-435840", "435840", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-435827">
<div class="comment-container" id="li-comment-435827">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/429586250cec7db8efd2d17f8c00854b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/429586250cec7db8efd2d17f8c00854b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Jesia</span>
<span class="date">April 24, 2018 at 11:36 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435827" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I have trained the data using progressive loading untill 19 iterations.<br/>
Caption for your provided test image is generated. However, for new one( image of rabbit and other animals) i got the caption “dog is running …”.<br/>
Is there a way to train the models more than 19 iterations to get a better result or how to solve this issue?</p>
<p>thank you</p>
<div class="reply">
<a aria-label="Reply to Jesia" class="comment-reply-link" href="#comment-435827" onclick='return addComment.moveForm( "comment-435827", "435827", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-435852">
<div class="comment-container" id="li-comment-435852">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 25, 2018 at 6:31 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-435852" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>The model may only need 2-5 training iterations.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-435852" onclick='return addComment.moveForm( "comment-435852", "435852", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-437150">
<div class="comment-container" id="li-comment-437150">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/c0327507bd0769fdb1bac35af0a38b9f?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/c0327507bd0769fdb1bac35af0a38b9f?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Kingson</span>
<span class="date">May 10, 2018 at 11:49 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-437150" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>Can you please share me full github repository of image captioning?</p>
<div class="reply">
<a aria-label="Reply to Kingson" class="comment-reply-link" href="#comment-437150" onclick='return addComment.moveForm( "comment-437150", "437150", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-437181">
<div class="comment-container" id="li-comment-437181">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">May 11, 2018 at 6:37 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-437181" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>No need, all of the code is listed above.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-437181" onclick='return addComment.moveForm( "comment-437181", "437181", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-437274">
<div class="comment-container" id="li-comment-437274">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/985a10deb076723f0ba92d7559a32d00?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/985a10deb076723f0ba92d7559a32d00?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Sayan</span>
<span class="date">May 12, 2018 at 4:25 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-437274" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hey , Jason the post is really amazing , but can you help to load me this especially the first step (Keras) which will probably take 1hour in CPU , I wanna test that I’m in GPU , how shall I be able to get that , Keras (GPU) so as to save time tho.<br/>
Thanks Jason.</p>
<div class="reply">
<a aria-label="Reply to Sayan" class="comment-reply-link" href="#comment-437274" onclick='return addComment.moveForm( "comment-437274", "437274", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-437303">
<div class="comment-container" id="li-comment-437303">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">May 12, 2018 at 6:51 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-437303" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>There are some commands on this post to check if you are using the GPU:<br/>
<a href="https://machinelearningmastery.com/command-line-recipes-deep-learning-amazon-web-services/" rel="nofollow">https://machinelearningmastery.com/command-line-recipes-deep-learning-amazon-web-services/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-437303" onclick='return addComment.moveForm( "comment-437303", "437303", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-437333">
<div class="comment-container" id="li-comment-437333">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/985a10deb076723f0ba92d7559a32d00?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/985a10deb076723f0ba92d7559a32d00?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Sayan</span>
<span class="date">May 12, 2018 at 2:24 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-437333" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks Jason , one more thing i wanna ask is that in the FILENAME i must put the complete path to working directory right?</p>
<div class="reply">
<a aria-label="Reply to Sayan" class="comment-reply-link" href="#comment-437333" onclick='return addComment.moveForm( "comment-437333", "437333", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-437371">
<div class="comment-container" id="li-comment-437371">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">May 13, 2018 at 6:33 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-437371" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>If the data is in the current working directory, then the path can be relative.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-437371" onclick='return addComment.moveForm( "comment-437371", "437371", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-437410">
<div class="comment-container" id="li-comment-437410">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/985a10deb076723f0ba92d7559a32d00?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/985a10deb076723f0ba92d7559a32d00?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Sayan</span>
<span class="date">May 13, 2018 at 10:33 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-437410" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hey Jason wassup ,  can you please explain what is meant by these lines :-<br/>
filepath = ‘model-ep{epoch:03d}-loss{loss:.3f}-val_loss{val_loss:.3f}.h5′<br/>
checkpoint = ModelCheckpoint(filepath, monitor=’val_loss’, verbose=1, save_best_only=True, mode=’min’)<br/>
1. The line in filepath especially this – epoch:03d}-loss{loss:.3f}-val_loss{val_loss:.3f}    ?</p>
<div class="reply">
<a aria-label="Reply to Sayan" class="comment-reply-link" href="#comment-437410" onclick='return addComment.moveForm( "comment-437410", "437410", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-437451">
<div class="comment-container" id="li-comment-437451">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">May 14, 2018 at 6:34 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-437451" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>It is the name of the file that will be saved with placeholders for specific values of the model at the time of saving.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-437451" onclick='return addComment.moveForm( "comment-437451", "437451", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-438043">
<div class="comment-container" id="li-comment-438043">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas khan</span>
<span class="date">May 20, 2018 at 4:59 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-438043" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>hey jason!! I ran the code that returns a dictionary of image identifier to image features. but did nt work and gave the following error. Please Guide me how to fix this bug.</p>
<p>FileNotFoundError                         Traceback (most recent call last)<br/>
 in ()<br/>
     39 # extract features from all images<br/>
     40 directory = ‘Flicker8k_Dataset’<br/>
—&gt; 41 features = extract_features(directory)<br/>
     42 print(‘Extracted Features: %d’ % len(features))<br/>
     43 # save to file</p>
<p> in extract_features(directory)<br/>
     18         # extract features from each photo<br/>
     19         features = dict()<br/>
—&gt; 20         for name in listdir(directory):<br/>
     21                 # load an image from file<br/>
     22                 filename = directory + ‘/’ + name</p>
<p>FileNotFoundError: [WinError 3] The system cannot find the path specified: ‘Flicker8k_Dataset’</p>
<div class="reply">
<a aria-label="Reply to abbas khan" class="comment-reply-link" href="#comment-438043" onclick='return addComment.moveForm( "comment-438043", "438043", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-438092">
<div class="comment-container" id="li-comment-438092">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">May 21, 2018 at 6:27 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-438092" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>It looks like you do not have the dataset in the same directory as the code.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-438092" onclick='return addComment.moveForm( "comment-438092", "438092", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-441654">
<div class="comment-container" id="li-comment-441654">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">June 22, 2018 at 4:17 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-441654" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>jason i have code and dataset in the same directory.I can access a test png image from the same directory but i am unable to access the dataset images..I don’t know whats wrong with it.Please help me solving the issue because i can also access the flick_text dataset.The only issue i have with images dataset.</p>
<div class="reply">
<a aria-label="Reply to abbas" class="comment-reply-link" href="#comment-441654" onclick='return addComment.moveForm( "comment-441654", "441654", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-441712">
<div class="comment-container" id="li-comment-441712">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 23, 2018 at 6:13 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-441712" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I have list of things to try here:<br/>
<a href="https://machinelearningmastery.com/faq/single-faq/why-does-the-code-in-the-tutorial-not-work-for-me" rel="nofollow">https://machinelearningmastery.com/faq/single-faq/why-does-the-code-in-the-tutorial-not-work-for-me</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-441712" onclick='return addComment.moveForm( "comment-441712", "441712", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-5" id="comment-441970">
<div class="comment-container" id="li-comment-441970">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">June 25, 2018 at 2:03 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-441970" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>1) I have installed the latest environment except tensorflow 1.5 becuase higher versions not working for me.<br/>
2) I have dataset and code in the same directory<br/>
3) I ran the code from command line but still found no luck.<br/>
4) I have exactly copied the code.<br/>
5) I searched the error on stackoverflow but never found any authentic solution yet.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-441978">
<div class="comment-container" id="li-comment-441978">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 25, 2018 at 2:40 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-441978" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>If you type “ls” is the “Flicker8k_Dataset” directory in the current directory beside the code file/s?</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-5" id="comment-442629">
<div class="comment-container" id="li-comment-442629">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">July 4, 2018 at 2:18 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442629" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I replaced the relative path(as in the tutorial) with absolute full path and it worked for me</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-442635">
<div class="comment-container" id="li-comment-442635">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">July 4, 2018 at 2:56 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442635" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Glad to hear it.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-5" id="comment-442630">
<div class="comment-container" id="li-comment-442630">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">July 4, 2018 at 2:39 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442630" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Now i am facing an error while running the code “# define the model<br/>
model = define_model(vocab_size, max_length)” in the progressive training section.I have installed pydot and graphviz libraries but still come up with the following error.</p>
<p>—————————————————————————<br/>
FileNotFoundError                         Traceback (most recent call last)<br/>
C:\anaconda3\lib\site-packages\pydot.py in create(self, prog, format)<br/>
   1877                 shell=False,<br/>
-&gt; 1878                 stderr=subprocess.PIPE, stdout=subprocess.PIPE)<br/>
   1879         except OSError as e:</p>
<p>C:\anaconda3\lib\subprocess.py in __init__(self, args, bufsize, executable, stdin, stdout, stderr, preexec_fn, close_fds, shell, cwd, env, universal_newlines, startupinfo, creationflags, restore_signals, start_new_session, pass_fds, encoding, errors)<br/>
    708                                 errread, errwrite,<br/>
–&gt; 709                                 restore_signals, start_new_session)<br/>
    710         except:</p>
<p>C:\anaconda3\lib\subprocess.py in _execute_child(self, args, executable, preexec_fn, close_fds, pass_fds, cwd, env, startupinfo, creationflags, shell, p2cread, p2cwrite, c2pread, c2pwrite, errread, errwrite, unused_restore_signals, unused_start_new_session)<br/>
    996                                          os.fspath(cwd) if cwd is not None else None,<br/>
–&gt; 997                                          startupinfo)<br/>
    998             finally:</p>
<p>FileNotFoundError: [WinError 2] The system cannot find the file specified</p>
<p>During handling of the above exception, another exception occurred:</p>
<p>Exception                                 Traceback (most recent call last)<br/>
 in ()<br/>
      1 # define the model<br/>
—-&gt; 2 model = define_model(vocab_size, max_length)</p>
<p> in define_model(vocab_size, max_length)<br/>
     20         # summarize model<br/>
     21         model.summary()<br/>
—&gt; 22         plot_model(model, to_file=’model.png’, show_shapes=True)<br/>
     23         return model</p>
<p>C:\anaconda3\lib\site-packages\keras\utils\vis_utils.py in plot_model(model, to_file, show_shapes, show_layer_names, rankdir)<br/>
    131             ‘LR’ creates a horizontal plot.<br/>
    132     “””<br/>
–&gt; 133     dot = model_to_dot(model, show_shapes, show_layer_names, rankdir)<br/>
    134     _, extension = os.path.splitext(to_file)<br/>
    135     if not extension:</p>
<p>C:\anaconda3\lib\site-packages\keras\utils\vis_utils.py in model_to_dot(model, show_shapes, show_layer_names, rankdir)<br/>
     53     from ..models import Sequential<br/>
     54<br/>
—&gt; 55     _check_pydot()<br/>
     56     dot = pydot.Dot()<br/>
     57     dot.set(‘rankdir’, rankdir)</p>
<p>C:\anaconda3\lib\site-packages\keras\utils\vis_utils.py in _check_pydot()<br/>
     24         # Attempt to create an image of a blank graph<br/>
     25         # to check the pydot/graphviz installation.<br/>
—&gt; 26         pydot.Dot.create(pydot.Dot())<br/>
     27     except OSError:<br/>
     28         raise OSError(</p>
<p>C:\anaconda3\lib\site-packages\pydot.py in create(self, prog, format)<br/>
   1881                 raise Exception(<br/>
   1882                     ‘”{prog}” not found in path.’.format(<br/>
-&gt; 1883                         prog=prog))<br/>
   1884             else:<br/>
   1885                 raise</p>
<p>Exception: “dot.exe” not found in path.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-442636">
<div class="comment-container" id="li-comment-442636">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">July 4, 2018 at 2:57 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442636" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Try commenting out the call to plot_model().</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-5" id="comment-442896">
<div class="comment-container" id="li-comment-442896">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">July 7, 2018 at 1:53 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442896" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>thanks jason! my training is in progress.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-442929">
<div class="comment-container" id="li-comment-442929">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">July 8, 2018 at 6:15 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442929" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Glad to hear it.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-5" id="comment-442908">
<div class="comment-container" id="li-comment-442908">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">July 7, 2018 at 6:17 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442908" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>In model evaluation section when i come to run the code<br/>
” filename = ‘model-ep002-loss3.245-val_loss3.612.h5’<br/>
model = load_model(filename)”<br/>
I come up with the error<br/>
“OSError: Unable to open file (unable to open file: name = ‘model-ep002-loss3.245-val_loss3.612.h5’, errno = 2, error message = ‘No such file or directory’, flags = 0, o_flags = 0)”</p>
<p>i want to ask where is the file ‘model-ep002-loss3.245-val_loss3.612.h5’??and how to select the file??should i pick up the file with least loss value???</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-442935">
<div class="comment-container" id="li-comment-442935">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">July 8, 2018 at 6:18 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442935" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You must change the filename to the model that you saved while training.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-5" id="comment-443018">
<div class="comment-container" id="li-comment-443018">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">July 9, 2018 at 2:16 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-443018" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Jason i trained the model upto 20 epochs.Now please explain which model i should use for prediction? and if i should select from 1-5 then why i am running it for 20 epochs?</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-443071">
<div class="comment-container" id="li-comment-443071">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">July 10, 2018 at 6:40 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-443071" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>The one with the lowest error on a validation set.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-5" id="comment-444268">
<div class="comment-container" id="li-comment-444268">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">July 24, 2018 at 2:12 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-444268" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I just want to understand the the whole pipeline.The CNN-VGG16 extracts the the features of image to a fixed length 256 vector.The text is cleaned and preprocesed , the RNN-LSTM predicts the next words of the sequence.<br/>
What is the strategy and intuition of the encoder/decoder?<br/>
how these two modalities (image and text) are merged by FF?</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-444273">
<div class="comment-container" id="li-comment-444273">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">July 24, 2018 at 2:31 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-444273" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>More on the model architecture here:<br/>
<a href="https://machinelearningmastery.com/caption-generation-inject-merge-architectures-encoder-decoder-model/" rel="nofollow">https://machinelearningmastery.com/caption-generation-inject-merge-architectures-encoder-decoder-model/</a></p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-5" id="comment-444890">
<div class="comment-container" id="li-comment-444890">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">July 31, 2018 at 3:26 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-444890" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>What alternative algorithms i can used for photo feature extraction or what extra modifications in the model is likely to perform better results?? or what extra building blocks needs to be added to the current tutorial for getting even refined results?</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-444948">
<div class="comment-container" id="li-comment-444948">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">August 1, 2018 at 7:38 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-444948" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I have some suggestions here:<br/>
<a href="http://machinelearningmastery.com/improve-deep-learning-performance/" rel="nofollow">http://machinelearningmastery.com/improve-deep-learning-performance/</a></p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-5" id="comment-445243">
<div class="comment-container" id="li-comment-445243">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">August 5, 2018 at 3:55 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-445243" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Dropout layer usually used to get rid of over-fitting.While Dense layer is usually used to change the dimensions.<br/>
Why Dropout_1 and dropout_2 are not changing the dimensions while we set some of the connections to 0 ??What is the the intuition behind Dropout_1 and Dropout_2 Layer??Please suggest some links or explaination</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-445270">
<div class="comment-container" id="li-comment-445270">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">August 5, 2018 at 5:38 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-445270" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Not get rid of, but reduce the likelihood of overfitting.</p>
<p>You can learn more about the intuitions for dropout here:<br/>
<a href="https://machinelearningmastery.com/dropout-regularization-deep-learning-models-keras/" rel="nofollow">https://machinelearningmastery.com/dropout-regularization-deep-learning-models-keras/</a></p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-5" id="comment-454407">
<div class="comment-container" id="li-comment-454407">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">November 11, 2018 at 3:06 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-454407" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason!<br/>
 I implemented the above mentioned tutorial using VGG16 CNN architecture.Please let me know the code or tutorial that implements Inceptin model for image captioning.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-454470">
<div class="comment-container" id="li-comment-454470">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 12, 2018 at 5:35 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-454470" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You can change the example to use inception if you wish.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-438499">
<div class="comment-container" id="li-comment-438499">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/879457b34d2b4bff8c176c55d93a42c4?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/879457b34d2b4bff8c176c55d93a42c4?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">wasif</span>
<span class="date">May 24, 2018 at 10:56 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-438499" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason Brownlee! Good tutorial. I doubt how model guarantee to generate semantically correct sentences. Please share your intuition or any available resource. For example, there is three word in vocabulary “is, dog, running”, so how could we guarantee model will generate a sentence with correct grammar structure like ‘dog is running’. Thank you</p>
<div class="reply">
<a aria-label="Reply to wasif" class="comment-reply-link" href="#comment-438499" onclick='return addComment.moveForm( "comment-438499", "438499", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-438563">
<div class="comment-container" id="li-comment-438563">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">May 25, 2018 at 9:27 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-438563" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps you can run the generated sentences through another process that corrects grammar.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-438563" onclick='return addComment.moveForm( "comment-438563", "438563", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-2" id="comment-452875">
<div class="comment-container" id="li-comment-452875">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">October 27, 2018 at 3:21 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-452875" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Sir where can i find the implemented tutorial for extracting features from images using inception v3?</p>
<div class="reply">
<a aria-label="Reply to abbas" class="comment-reply-link" href="#comment-452875" onclick='return addComment.moveForm( "comment-452875", "452875", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-3" id="comment-452922">
<div class="comment-container" id="li-comment-452922">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 28, 2018 at 6:07 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-452922" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You can remove the VGG and add the Inception model yourself.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-452922" onclick='return addComment.moveForm( "comment-452922", "452922", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-4" id="comment-455194">
<div class="comment-container" id="li-comment-455194">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">November 18, 2018 at 3:28 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-455194" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I am trying to train my model using inception model.While training i come with the following error.How do i change the Shape of the input?</p>
<p>CODE:<br/>
# train the model, run epochs manually and save after each epoch<br/>
epochs = 5<br/>
steps = len(train_descriptions)<br/>
for i in range(epochs):<br/>
	# create the data generator<br/>
	generator = data_generator(train_descriptions, train_features, tokenizer, max_length)<br/>
	# fit for one epoch<br/>
	model.fit_generator(generator, epochs=1, steps_per_epoch=steps, verbose=1)<br/>
	# save model<br/>
	model.save(‘inception-model_’ + str(i) + ‘.h5’)</p>
<p>ERROR:<br/>
Error when checking input: expected input_3 to have shape (4096,) but got array with shape (2048,)</p>
<div class="reply">
<a aria-label="Reply to abbas" class="comment-reply-link" href="#comment-455194" onclick='return addComment.moveForm( "comment-455194", "455194", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-455240">
<div class="comment-container" id="li-comment-455240">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 18, 2018 at 6:46 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-455240" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>It looks like you model and data have differing shapes, perhaps change the model or change the data.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-5" id="comment-455488">
<div class="comment-container" id="li-comment-455488">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">November 19, 2018 at 2:51 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-455488" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>do you have any working example for changing data dimensions?</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-455554">
<div class="comment-container" id="li-comment-455554">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 20, 2018 at 6:31 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-455554" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You can learn about the reshape() function here:<br/>
<a href="https://machinelearningmastery.com/index-slice-reshape-numpy-arrays-machine-learning-python/" rel="nofollow">https://machinelearningmastery.com/index-slice-reshape-numpy-arrays-machine-learning-python/</a></p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-5" id="comment-455632">
<div class="comment-container" id="li-comment-455632">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">November 20, 2018 at 7:04 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-455632" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>my input has dimension of 4096 while its giving error that its 2048.</p>
<p>__________________________________________________________________________________________________<br/>
Layer (type)                    Output Shape         Param #     Connected to<br/>
==================================================================================================<br/>
input_4 (InputLayer)            (None, 34)           0<br/>
__________________________________________________________________________________________________<br/>
input_3 (InputLayer)            (None, 4096)         0<br/>
__________________________________________________________________________________________________<br/>
embedding_2 (Embedding)         (None, 34, 256)      1940224     input_4[0][0]<br/>
__________________________________________________________________________________________________<br/>
dropout_3 (Dropout)             (None, 4096)         0           input_3[0][0]<br/>
__________________________________________________________________________________________________<br/>
dropout_4 (Dropout)             (None, 34, 256)      0           embedding_2[0][0]<br/>
__________________________________________________________________________________________________<br/>
dense_4 (Dense)                 (None, 256)          1048832     dropout_3[0][0]<br/>
__________________________________________________________________________________________________<br/>
lstm_2 (LSTM)                   (None, 256)          525312      dropout_4[0][0]<br/>
__________________________________________________________________________________________________<br/>
add_2 (Add)                     (None, 256)          0           dense_4[0][0]<br/>
                                                                 lstm_2[0][0]<br/>
__________________________________________________________________________________________________<br/>
dense_5 (Dense)                 (None, 256)          65792       add_2[0][0]<br/>
__________________________________________________________________________________________________<br/>
dense_6 (Dense)                 (None, 7579)         1947803     dense_5[0][0]<br/>
==================================================================================================<br/>
Total params: 5,527,963<br/>
Trainable params: 5,527,963<br/>
Non-trainable params: 0</p>
<p>ERROR:<br/>
Error when checking input: expected input_3 to have shape (4096,) but got array with shape (2048,)</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-455691">
<div class="comment-container" id="li-comment-455691">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 21, 2018 at 7:50 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-455691" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Looks like there is a mismatch between your data and the model.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-5" id="comment-455729">
<div class="comment-container" id="li-comment-455729">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">November 21, 2018 at 3:04 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-455729" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>so then how to make data and model inter harmony?</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-455785">
<div class="comment-container" id="li-comment-455785">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 22, 2018 at 6:20 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-455785" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Sorry, I don’t understand, can you elaborate?</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-438696">
<div class="comment-container" id="li-comment-438696">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/cc4b74174fbae2f9eeeeb9f5588da263?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/cc4b74174fbae2f9eeeeb9f5588da263?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Andreas</span>
<span class="date">May 26, 2018 at 7:27 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-438696" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks for the great post.</p>
<p>I trained the model when I save the image from “http://media.einfachtierisch.de/thumbnail/600/0/media.einfachtierisch.de/images/2017/07/glueckliche-freigaenger-katze-Shutterstock-Olga-Visav_504063007.jpg” then I am still getting the text </p>
<p>startseq dog is running through the grass endseq</p>
<p>what do I make wrong?<br/>
The test image appears as intended.</p>
<div class="reply">
<a aria-label="Reply to Andreas" class="comment-reply-link" href="#comment-438696" onclick='return addComment.moveForm( "comment-438696", "438696", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-438779">
<div class="comment-container" id="li-comment-438779">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">May 27, 2018 at 6:42 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-438779" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps a bug in your check?<br/>
Perhaps try other images?<br/>
Perhaps the model is overfit?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-438779" onclick='return addComment.moveForm( "comment-438779", "438779", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-440327">
<div class="comment-container" id="li-comment-440327">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/cc4b74174fbae2f9eeeeb9f5588da263?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/cc4b74174fbae2f9eeeeb9f5588da263?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Andi</span>
<span class="date">June 9, 2018 at 10:55 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-440327" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi, I have tried other images and the same result. Even after only 2 or 3 iterations I mostly get the same text. As Paul described below.</p>
<div class="reply">
<a aria-label="Reply to Andi" class="comment-reply-link" href="#comment-440327" onclick='return addComment.moveForm( "comment-440327", "440327", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-440350">
<div class="comment-container" id="li-comment-440350">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 10, 2018 at 6:03 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-440350" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>That is surprising.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-440350" onclick='return addComment.moveForm( "comment-440350", "440350", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even depth-2" id="comment-455833">
<div class="comment-container" id="li-comment-455833">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">November 22, 2018 at 3:41 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-455833" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>How can i change my data or my model accordingly to match it??</p>
<div class="reply">
<a aria-label="Reply to abbas" class="comment-reply-link" href="#comment-455833" onclick='return addComment.moveForm( "comment-455833", "455833", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-438922">
<div class="comment-container" id="li-comment-438922">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/99e419e8b64aaa4f3672045a54e111e6?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/99e419e8b64aaa4f3672045a54e111e6?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Paul</span>
<span class="date">May 28, 2018 at 4:17 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-438922" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason<br/>
It was a nice article.<br/>
I trained the model for 12 epochs in my gpu.<br/>
But the prediction was not so accurate.<br/>
Most of the times I got the prediction with “man in blue shirt is riding his bohemian on the street” . with the keywords in this sentence. </p>
<p>Help me out .</p>
<div class="reply">
<a aria-label="Reply to Paul" class="comment-reply-link" href="#comment-438922" onclick='return addComment.moveForm( "comment-438922", "438922", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-438958">
<div class="comment-container" id="li-comment-438958">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">May 29, 2018 at 6:23 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-438958" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>It needs far fewer epochs, try early stopping against a validation set.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-438958" onclick='return addComment.moveForm( "comment-438958", "438958", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment odd alt depth-2" id="comment-440328">
<div class="comment-container" id="li-comment-440328">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/cc4b74174fbae2f9eeeeb9f5588da263?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/cc4b74174fbae2f9eeeeb9f5588da263?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Andi</span>
<span class="date">June 9, 2018 at 10:56 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-440328" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>HI Paul, have you found a solution to this? I have a similiar issue.</p>
<div class="reply">
<a aria-label="Reply to Andi" class="comment-reply-link" href="#comment-440328" onclick='return addComment.moveForm( "comment-440328", "440328", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-439782">
<div class="comment-container" id="li-comment-439782">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/3da9bb126499a6ef9b57d5b2a4b04732?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3da9bb126499a6ef9b57d5b2a4b04732?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Ravi</span>
<span class="date">June 4, 2018 at 10:21 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-439782" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi jason,<br/>
 While progressive loading, we will get 20 models. Which model is choosen for prediction?</p>
<div class="reply">
<a aria-label="Reply to Ravi" class="comment-reply-link" href="#comment-439782" onclick='return addComment.moveForm( "comment-439782", "439782", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-439833">
<div class="comment-container" id="li-comment-439833">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 5, 2018 at 6:39 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-439833" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>The one with the best skill on the hold out set, likely within epoch 1-5.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-439833" onclick='return addComment.moveForm( "comment-439833", "439833", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-439882">
<div class="comment-container" id="li-comment-439882">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/8e355bb28682f78e6551b7ac11b01b24?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/8e355bb28682f78e6551b7ac11b01b24?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Praharsha Singaraju</span>
<span class="date">June 5, 2018 at 5:12 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-439882" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi jason,</p>
<p>I got the following error when i ran the extract_features function.<br/>
can you please help me fix it?</p>
<p>field_value = self._fields.get(field)<br/>
TypeError: descriptor ‘_fields’ for ‘OpDef’ objects doesn’t apply to ‘OpDef’ object</p>
<div class="reply">
<a aria-label="Reply to Praharsha Singaraju" class="comment-reply-link" href="#comment-439882" onclick='return addComment.moveForm( "comment-439882", "439882", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-439935">
<div class="comment-container" id="li-comment-439935">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 6, 2018 at 6:37 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-439935" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>This might give you some ideas:<br/>
<a href="https://machinelearningmastery.com/faq/single-faq/why-does-the-code-in-the-tutorial-not-work-for-me" rel="nofollow">https://machinelearningmastery.com/faq/single-faq/why-does-the-code-in-the-tutorial-not-work-for-me</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-439935" onclick='return addComment.moveForm( "comment-439935", "439935", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-440806">
<div class="comment-container" id="li-comment-440806">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/de44f9e14a6f1d00d18d8a2a4fa890a6?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/de44f9e14a6f1d00d18d8a2a4fa890a6?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Ananya</span>
<span class="date">June 14, 2018 at 2:26 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-440806" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hello Jason! I just wanted to know why aren’t we validating the trained model in progressive loading…</p>
<div class="reply">
<a aria-label="Reply to Ananya" class="comment-reply-link" href="#comment-440806" onclick='return addComment.moveForm( "comment-440806", "440806", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-440817">
<div class="comment-container" id="li-comment-440817">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 14, 2018 at 4:09 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-440817" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You can, as I note in the tutorial. The progressive loading is just a small example to help those who don’t have enough RAM to run the main example.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-440817" onclick='return addComment.moveForm( "comment-440817", "440817", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-440808">
<div class="comment-container" id="li-comment-440808">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/de44f9e14a6f1d00d18d8a2a4fa890a6?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/de44f9e14a6f1d00d18d8a2a4fa890a6?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Ananya</span>
<span class="date">June 14, 2018 at 2:44 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-440808" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I meant to ask, ‘Why cant we simultaneously validate, as in the previous code wherein no progressive loading is used?”</p>
<div class="reply">
<a aria-label="Reply to Ananya" class="comment-reply-link" href="#comment-440808" onclick='return addComment.moveForm( "comment-440808", "440808", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-440884">
<div class="comment-container" id="li-comment-440884">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/d0327888a7510d5a3ae26fa470b1f1c2?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d0327888a7510d5a3ae26fa470b1f1c2?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Malik</span>
<span class="date">June 15, 2018 at 12:41 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-440884" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Finally someone who understands the importance of separating mathematics from ‘implementation’. The drawback most tutorials have is that they try to discuss both simultaneously and hence making things quite confusing. ‘Implementation’ requires a completely different approach from understanding the theory. </p>
<p>Another wonderful thing about this tutorial is that you actually go through the preprocessing steps. This is where I usually get stuck because most university and online courses and tutorials do not discuss them at all.</p>
<div class="reply">
<a aria-label="Reply to Malik" class="comment-reply-link" href="#comment-440884" onclick='return addComment.moveForm( "comment-440884", "440884", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-440893">
<div class="comment-container" id="li-comment-440893">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 15, 2018 at 2:50 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-440893" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I’m glad the tutorial helps Malik.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-440893" onclick='return addComment.moveForm( "comment-440893", "440893", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-441007">
<div class="comment-container" id="li-comment-441007">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/5d7e12f9e5790a1ff52c2e1028e952d2?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/5d7e12f9e5790a1ff52c2e1028e952d2?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">DIKSHA SINGLA</span>
<span class="date">June 16, 2018 at 5:59 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-441007" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Traceback (most recent call last):<br/>
  File “C:\Users\hp\AppData\Local\Programs\Python\Python36\lib\site-packages\pydot.py”, line 1861, in create<br/>
    stderr=subprocess.PIPE, stdout=subprocess.PIPE)<br/>
  File “C:\Users\hp\AppData\Local\Programs\Python\Python36\lib\subprocess.py”, line 709, in __init__<br/>
    restore_signals, start_new_session)<br/>
  File “C:\Users\hp\AppData\Local\Programs\Python\Python36\lib\subprocess.py”, line 997, in _execute_child<br/>
    startupinfo)<br/>
FileNotFoundError: [WinError 2] The system cannot find the file specified</p>
<p>During handling of the above exception, another exception occurred:</p>
<p>Traceback (most recent call last):<br/>
  File “C:\Users\hp\AppData\Local\Programs\Python\Python36\lib\site-packages\keras\utils\vis_utils.py”, line 26, in _check_pydot<br/>
    pydot.Dot.create(pydot.Dot())<br/>
  File “C:\Users\hp\AppData\Local\Programs\Python\Python36\lib\site-packages\pydot.py”, line 1867, in create<br/>
    raise OSError(*args)<br/>
FileNotFoundError: [WinError 2] “dot.exe” not found in path.</p>
<p>During handling of the above exception, another exception occurred:</p>
<p>Traceback (most recent call last):<br/>
  File “C:\Users\hp\Desktop\iitp\caption_new\5.py”, line 163, in<br/>
    model = define_model(vocab_size, max_length)<br/>
  File “C:\Users\hp\Desktop\iitp\caption_new\5.py”, line 131, in define_model<br/>
    plot_model(model, to_file=’model.png’, show_shapes=True)<br/>
  File “C:\Users\hp\AppData\Local\Programs\Python\Python36\lib\site-packages\keras\utils\vis_utils.py”, line 133, in plot_model<br/>
    dot = model_to_dot(model, show_shapes, show_layer_names, rankdir)<br/>
  File “C:\Users\hp\AppData\Local\Programs\Python\Python36\lib\site-packages\keras\utils\vis_utils.py”, line 55, in model_to_dot<br/>
    _check_pydot()<br/>
  File “C:\Users\hp\AppData\Local\Programs\Python\Python36\lib\site-packages\keras\utils\vis_utils.py”, line 29, in _check_pydot<br/>
    ‘<code>pydot</code> failed to call GraphViz.’<br/>
OSError: <code>pydot</code> failed to call GraphViz.Please install GraphViz (<a href="https://www.graphviz.org/" rel="nofollow">https://www.graphviz.org/</a>) and ensure that its executables are in the $PATH.</p>
<div class="reply">
<a aria-label="Reply to DIKSHA SINGLA" class="comment-reply-link" href="#comment-441007" onclick='return addComment.moveForm( "comment-441007", "441007", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-441043">
<div class="comment-container" id="li-comment-441043">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 17, 2018 at 5:38 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-441043" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Looks like you need to install pygraphviz, or comment out the plotting of the model.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-441043" onclick='return addComment.moveForm( "comment-441043", "441043", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-441276">
<div class="comment-container" id="li-comment-441276">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/2683480bd28ad1cda6f9236f1c16ad62?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/2683480bd28ad1cda6f9236f1c16ad62?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">shantanu singh</span>
<span class="date">June 19, 2018 at 3:31 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-441276" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>—-&gt; 1 description = generate_desc(model, tokenizer, photo, max_length)<br/>
      2 print(description)</p>
<p> in generate_desc(model, tokenizer, photo, max_length)<br/>
     10         sequence = tokenizer.texts_to_sequences([in_text])[0]<br/>
     11         sequence = pad_sequences([sequence], maxlen=max_length)<br/>
—&gt; 12         yhat = model.predict([photo,sequence], verbose=0)<br/>
     13         yhat = argmax(yhat)<br/>
     14         word = word_for_id(yhat, tokenizer)<br/>
AttributeError: ‘dict’ object has no attribute ‘ndim’</p>
<div class="reply">
<a aria-label="Reply to shantanu singh" class="comment-reply-link" href="#comment-441276" onclick='return addComment.moveForm( "comment-441276", "441276", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-441356">
<div class="comment-container" id="li-comment-441356">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 20, 2018 at 6:21 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-441356" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Ensure that you copy all code for the example.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-441356" onclick='return addComment.moveForm( "comment-441356", "441356", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-441454">
<div class="comment-container" id="li-comment-441454">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/8720ecbf38c65a563d5e840866f1d62f?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/8720ecbf38c65a563d5e840866f1d62f?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">vinay</span>
<span class="date">June 21, 2018 at 12:13 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-441454" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>When i am training, i am getting an vocab length of 8359. It is less than what you are getting.<br/>
Will it be a problem?</p>
<div class="reply">
<a aria-label="Reply to vinay" class="comment-reply-link" href="#comment-441454" onclick='return addComment.moveForm( "comment-441454", "441454", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-441492">
<div class="comment-container" id="li-comment-441492">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 21, 2018 at 6:18 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-441492" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Maybe.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-441492" onclick='return addComment.moveForm( "comment-441492", "441492", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-441826">
<div class="comment-container" id="li-comment-441826">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/5e168e18d96c23692c1dcff1cc378785?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/5e168e18d96c23692c1dcff1cc378785?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">mun</span>
<span class="date">June 24, 2018 at 6:43 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-441826" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hello, i  am stuck into this..’startseq’ and ‘endseq’ are not added in the Description.txt file but there is no error when i am running that module</p>
<div class="reply">
<a aria-label="Reply to mun" class="comment-reply-link" href="#comment-441826" onclick='return addComment.moveForm( "comment-441826", "441826", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-441845">
<div class="comment-container" id="li-comment-441845">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 24, 2018 at 7:37 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-441845" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>We add them in the load_clean_descriptions() function after loading the data.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-441845" onclick='return addComment.moveForm( "comment-441845", "441845", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-441850">
<div class="comment-container" id="li-comment-441850">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/2865b62767028520e38d0344d1256a76?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/2865b62767028520e38d0344d1256a76?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Ben</span>
<span class="date">June 24, 2018 at 8:22 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-441850" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>So,I followed exactly all the steps as shown above and after progressive loading,when the model is getting compiled,it keeps on running epoch 1/1 over and over again and keeps saving different .h5 files. So,I stopped the process after 5 iterations and got a loss of ~3.38 and when I am generating captions,it is not giving even close captions. What should I do to improve my results? Should I let the model to be trained for more iterations or will it cause over-fitting?</p>
<div class="reply">
<a aria-label="Reply to Ben" class="comment-reply-link" href="#comment-441850" onclick='return addComment.moveForm( "comment-441850", "441850", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-441930">
<div class="comment-container" id="li-comment-441930">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 25, 2018 at 6:16 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-441930" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>The progressive loading example runs epochs manually, not the same epoch again and again.</p>
<p>Perhaps test each saved model and use the one with the lowest loss to generate captions.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-441930" onclick='return addComment.moveForm( "comment-441930", "441930", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-442187">
<div class="comment-container" id="li-comment-442187">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/59e5a59704909e4d46a96c1174a50a4a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/59e5a59704909e4d46a96c1174a50a4a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Kingson</span>
<span class="date">June 28, 2018 at 4:11 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442187" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,<br/>
I am trying to create image caption for my own datasets. Like I have 4k images with single caption. I am able to run and create model for Flickr8K dataset.Its work properly. But when I use my dataset I am able to generate all required files  except model. When I try to train the model it gives error –<br/>
__________________________________________________________________________________________________<br/>
Layer (type) Output Shape Param # Connected to<br/>
==================================================================================================<br/>
input_2 (InputLayer) (None, 27) 0<br/>
__________________________________________________________________________________________________<br/>
input_1 (InputLayer) (None, 4096) 0<br/>
__________________________________________________________________________________________________<br/>
embedding_1 (Embedding) (None, 27, 256) 1058048 input_2[0][0]<br/>
__________________________________________________________________________________________________<br/>
dropout_1 (Dropout) (None, 4096) 0 input_1[0][0]<br/>
__________________________________________________________________________________________________<br/>
dropout_2 (Dropout) (None, 27, 256) 0 embedding_1[0][0]<br/>
__________________________________________________________________________________________________<br/>
dense_1 (Dense) (None, 256) 1048832 dropout_1[0][0]<br/>
__________________________________________________________________________________________________<br/>
lstm_1 (LSTM) (None, 256) 525312 dropout_2[0][0]<br/>
__________________________________________________________________________________________________<br/>
add_1 (Add) (None, 256) 0 dense_1[0][0]<br/>
lstm_1[0][0]<br/>
__________________________________________________________________________________________________<br/>
dense_2 (Dense) (None, 256) 65792 add_1[0][0]<br/>
__________________________________________________________________________________________________<br/>
dense_3 (Dense) (None, 4133) 1062181 dense_2[0][0]<br/>
==================================================================================================<br/>
Total params: 3,760,165<br/>
Trainable params: 3,760,165<br/>
Non-trainable params: 0<br/>
__________________________________________________________________________________________________<br/>
None<br/>
Traceback (most recent call last):<br/>
File “train2.py”, line 179, in<br/>
model.fit([X1train, X2train], ytrain, epochs=20, verbose=2, callbacks=[checkpoint], validation_data=([X1test, X2test], ytest))</p>
<p>ValueError: Error when checking input: expected input_1 to have 2 dimensions, but got array with shape (10931, 7, 7, 512)</p>
<p>keras version is – 2.2.0</p>
<p>How I can solve this error?<br/>
Please help me out.</p>
<div class="reply">
<a aria-label="Reply to Kingson" class="comment-reply-link" href="#comment-442187" onclick='return addComment.moveForm( "comment-442187", "442187", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-442212">
<div class="comment-container" id="li-comment-442212">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 28, 2018 at 6:26 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442212" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Looks like the dimensions of your data do not match the expected dimensions of the model. You can change the data or the model.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-442212" onclick='return addComment.moveForm( "comment-442212", "442212", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-442259">
<div class="comment-container" id="li-comment-442259">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/59e5a59704909e4d46a96c1174a50a4a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/59e5a59704909e4d46a96c1174a50a4a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Kingson</span>
<span class="date">June 28, 2018 at 7:59 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442259" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Ok thanks Jason,<br/>
I will try to change the model.</p>
<div class="reply">
<a aria-label="Reply to Kingson" class="comment-reply-link" href="#comment-442259" onclick='return addComment.moveForm( "comment-442259", "442259", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-4" id="comment-445146">
<div class="comment-container" id="li-comment-445146">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/d9ccdaeab22c2462cefa987cd1034eeb?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d9ccdaeab22c2462cefa987cd1034eeb?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Gaurav Anand</span>
<span class="date">August 3, 2018 at 3:26 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-445146" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Kingson</p>
<p>Were you able to get rid of the above problem? Since I am also getting the same error while training the model.</p>
<p>Thanks in advance</p>
<div class="reply">
<a aria-label="Reply to Gaurav Anand" class="comment-reply-link" href="#comment-445146" onclick='return addComment.moveForm( "comment-445146", "445146", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-442564">
<div class="comment-container" id="li-comment-442564">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/e46e4612ff1dc719fd2446e546ba319a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/e46e4612ff1dc719fd2446e546ba319a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Satendra Varma</span>
<span class="date">July 3, 2018 at 2:11 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442564" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hey Jason,</p>
<p>Great article. I just wanted to ask where to do you start developing code for such implementations. Do you refer papers and code from scratch or refer material that explains implementation code in detail and translate it to keras ?</p>
<p>Thanks,<br/>
Satendra</p>
<div class="reply">
<a aria-label="Reply to Satendra Varma" class="comment-reply-link" href="#comment-442564" onclick='return addComment.moveForm( "comment-442564", "442564", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-442604">
<div class="comment-container" id="li-comment-442604">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">July 4, 2018 at 8:18 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442604" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Start by understanding the principle of the approach (from multiple papers), then implement it using whatever tools, e.g. keras.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-442604" onclick='return addComment.moveForm( "comment-442604", "442604", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-442920">
<div class="comment-container" id="li-comment-442920">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/336db9f5f15cc7fc0e0ca9e4d68a8404?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/336db9f5f15cc7fc0e0ca9e4d68a8404?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Peter Bonac</span>
<span class="date">July 8, 2018 at 2:53 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442920" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>Great tutorial. I am wondering what the best way to limit the vocabulary size. As num_words does not influence tokenizer.fit_on_text, are these changes correct:</p>
<p>def create_tokenizer(descriptions):<br/>
	lines = to_lines(descriptions)<br/>
	tokenizer = Tokenizer(num_words = VOCAB_NUM_WORDS)<br/>
	tokenizer.fit_on_texts(lines)<br/>
	tokenizer.texts_to_sequences(lines)<br/>
	return tokenizer</p>
<p>and </p>
<p>vocab_size = VOCAB_NUM_WORDS</p>
<div class="reply">
<a aria-label="Reply to Peter Bonac" class="comment-reply-link" href="#comment-442920" onclick='return addComment.moveForm( "comment-442920", "442920", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-442944">
<div class="comment-container" id="li-comment-442944">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">July 8, 2018 at 6:24 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442944" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Create a list of the n most frequent words you want to work with from the dataset, save them to file, then use them to filter the dataset prior to modeling.</p>
<p>I have many examples of this on the blog, for example:<br/>
<a href="https://machinelearningmastery.com/develop-word-embedding-model-predicting-movie-review-sentiment/" rel="nofollow">https://machinelearningmastery.com/develop-word-embedding-model-predicting-movie-review-sentiment/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-442944" onclick='return addComment.moveForm( "comment-442944", "442944", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-442959">
<div class="comment-container" id="li-comment-442959">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/336db9f5f15cc7fc0e0ca9e4d68a8404?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/336db9f5f15cc7fc0e0ca9e4d68a8404?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Peter Bonac</span>
<span class="date">July 8, 2018 at 2:14 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442959" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thank you!</p>
<p>One more question. For Progressive Loading it seems that the batch size is 1 from the data_generator. If I would like to create a batch i run into the problem of size defining as the “create_sequences” output is variable in size from:</p>
<p>in_img, in_seq, out_word = create_sequences(tokenizer, max_length, desc_list, photo)</p>
<p>For example i can’t size define to something like:</p>
<p>batch_features = np.zeros((batch_size, 17, 1280))<br/>
batch_labels = np.zeros((batch_size, 17, 40000))</p>
<p>How can I create a batch of “in_img, in_seq, out_word” (if each sequence will be a different length)? Is there an easy way to make a larger batch size? Again thank you for your help.</p>
<div class="reply">
<a aria-label="Reply to Peter Bonac" class="comment-reply-link" href="#comment-442959" onclick='return addComment.moveForm( "comment-442959", "442959", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-4" id="comment-442989">
<div class="comment-container" id="li-comment-442989">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">July 9, 2018 at 6:32 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-442989" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Not sure I follow.</p>
<p>In progressive loading, the generator will release a batch of data. You can change the code to make this as few or as many samples as you wish.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-442989" onclick='return addComment.moveForm( "comment-442989", "442989", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-5" id="comment-443004">
<div class="comment-container" id="li-comment-443004">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/336db9f5f15cc7fc0e0ca9e4d68a8404?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/336db9f5f15cc7fc0e0ca9e4d68a8404?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Peter Bonac</span>
<span class="date">July 9, 2018 at 8:12 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-443004" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Sorry I didn’t explain well. From my understanding your “data_generator” releases data for 1 image into “model.fit_generator” at a time. I would like to change this to a batch of images. </p>
<p>The problem I am having is if I try to use a code structure like below, I am not able to create the empty arrays (unless I pad each line to “max_length”, and  make “batch_features = np.zeros((batch_size, max_length, NN_input_shape))”).</p>
<p>#code structure<br/>
def generator(features, labels, batch_size):<br/>
 # Create empty arrays to contain batch of features and labels#<br/>
 batch_features = np.zeros((batch_size, 64, 64, 3))<br/>
 batch_labels = np.zeros((batch_size,1))<br/>
 while True:<br/>
   for i in range(batch_size):<br/>
     # choose random index in features<br/>
     index= random.choice(len(features),1)<br/>
     batch_features[i] = some_processing(features[index])<br/>
     batch_labels[i] = labels[index]<br/>
   yield batch_features, batch_labels</p>
<p>Also, is there somewhere I can donate money to your site?</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor even depth-5" id="comment-443067">
<div class="comment-container" id="li-comment-443067">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">July 10, 2018 at 6:37 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-443067" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Correct.</p>
<p>Yes, you can build up data as Python lists then covert the lists to numpy arrays before you return them. It is a strategy I use all the time.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-443204">
<div class="comment-container" id="li-comment-443204">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/032c03de9ea01d550f9388d2b115baa8?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/032c03de9ea01d550f9388d2b115baa8?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Fathi</span>
<span class="date">July 11, 2018 at 12:01 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-443204" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Here the part of my code where I have a problem : </p>
<p>size = 64<br/>
img1 = load_img(‘00598546-9.jpg’, target_size=(1, size, size))<br/>
imshow(img1)</p>
<p>X1 = (TimeDistributed(Conv2D(32, (3,3), activation=’relu’), input_shape=(None, size, size, 3)))(img1)</p>
<p>Error message:<br/>
ayer time_distributed_11 was called with an input that isn’t a symbolic tensor. Received type: . Full input: []. All inputs to the layer should be tensors.</p>
<p>I’m looking to find the output X1 by using (img1) as an input but I get this error message.</p>
<p>How can I use (img1) to find the output ?</p>
<div class="reply">
<a aria-label="Reply to Fathi" class="comment-reply-link" href="#comment-443204" onclick='return addComment.moveForm( "comment-443204", "443204", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-443215">
<div class="comment-container" id="li-comment-443215">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">July 11, 2018 at 2:57 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-443215" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Are you able to confirm that your libraries are up to date?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-443215" onclick='return addComment.moveForm( "comment-443215", "443215", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-443441">
<div class="comment-container" id="li-comment-443441">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/032c03de9ea01d550f9388d2b115baa8?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/032c03de9ea01d550f9388d2b115baa8?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Fathi</span>
<span class="date">July 14, 2018 at 7:01 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-443441" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>How can I make sure it’s up to date ?</p>
<p>Thank you.</p>
<div class="reply">
<a aria-label="Reply to Fathi" class="comment-reply-link" href="#comment-443441" onclick='return addComment.moveForm( "comment-443441", "443441", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-4" id="comment-443502">
<div class="comment-container" id="li-comment-443502">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">July 15, 2018 at 6:01 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-443502" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>It depends on the method you used to install the libraries.</p>
<p>Perhaps this post will help:<br/>
<a href="https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/" rel="nofollow">https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-443502" onclick='return addComment.moveForm( "comment-443502", "443502", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-443613">
<div class="comment-container" id="li-comment-443613">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/6f4e2ce25233f9549baa23d4e01eb969?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/6f4e2ce25233f9549baa23d4e01eb969?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Maqsood</span>
<span class="date">July 16, 2018 at 6:24 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-443613" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>I am trying to use the model you presented above for recognizing handwritten documents. In literature the feature extraction stage for OCR produces another 2-D matrix for each image (a feature vector is found for each column vector in the image). How can I then convert this 2-D matrix into a 1-D vector?</p>
<div class="reply">
<a aria-label="Reply to Maqsood" class="comment-reply-link" href="#comment-443613" onclick='return addComment.moveForm( "comment-443613", "443613", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-443656">
<div class="comment-container" id="li-comment-443656">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">July 17, 2018 at 6:13 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-443656" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>The vector output will be a the probability of an image belonging to each output class.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-443656" onclick='return addComment.moveForm( "comment-443656", "443656", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-443918">
<div class="comment-container" id="li-comment-443918">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/a9703651ec06c44770145c1228bf7987?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/a9703651ec06c44770145c1228bf7987?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="https://shantanupatil.in" rel="external nofollow">Shantanu Patil</a></span>
<span class="date">July 19, 2018 at 11:38 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-443918" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>After training it for two epoch it gives caption as “man in red shirt standing on Street” for every other image i put</p>
<div class="reply">
<a aria-label="Reply to Shantanu Patil" class="comment-reply-link" href="#comment-443918" onclick='return addComment.moveForm( "comment-443918", "443918", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-443941">
<div class="comment-container" id="li-comment-443941">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">July 20, 2018 at 5:59 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-443941" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Sounds like it got stuck, try training it again?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-443941" onclick='return addComment.moveForm( "comment-443941", "443941", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-444072">
<div class="comment-container" id="li-comment-444072">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/a9703651ec06c44770145c1228bf7987?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/a9703651ec06c44770145c1228bf7987?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="https://shantanupatil.in" rel="external nofollow">Shantanu Patil</a></span>
<span class="date">July 21, 2018 at 10:35 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-444072" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>After training again for 6 epoch and loss of 3.3 its showing captions for girls as boys and calling a bird as a dog, should I train it for 20 epoch?</p>
<div class="reply">
<a aria-label="Reply to Shantanu Patil" class="comment-reply-link" href="#comment-444072" onclick='return addComment.moveForm( "comment-444072", "444072", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-4" id="comment-444094">
<div class="comment-container" id="li-comment-444094">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">July 22, 2018 at 6:23 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-444094" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>No, the model does not need very much training.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-444094" onclick='return addComment.moveForm( "comment-444094", "444094", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-5" id="comment-444387">
<div class="comment-container" id="li-comment-444387">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/a9703651ec06c44770145c1228bf7987?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/a9703651ec06c44770145c1228bf7987?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://www.shantanupatil.in" rel="external nofollow">Shantanu Patil</a></span>
<span class="date">July 25, 2018 at 11:52 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-444387" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>For new Images it is not working, can you send me a trained model? because I tried up to 10 epoch and it is not working</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor even depth-5" id="comment-444410">
<div class="comment-container" id="li-comment-444410">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">July 26, 2018 at 7:43 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-444410" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>What do you mean it is not working?</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-444452">
<div class="comment-container" id="li-comment-444452">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/cd52f371977365d8a7d73e4121838a76?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/cd52f371977365d8a7d73e4121838a76?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Moha</span>
<span class="date">July 26, 2018 at 5:22 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-444452" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Is the sequence length the number of words in a sequence?</p>
<div class="reply">
<a aria-label="Reply to Moha" class="comment-reply-link" href="#comment-444452" onclick='return addComment.moveForm( "comment-444452", "444452", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-444491">
<div class="comment-container" id="li-comment-444491">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">July 27, 2018 at 5:48 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-444491" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Yes. Or rather, the maximum number of words that may appear in a sequence.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-444491" onclick='return addComment.moveForm( "comment-444491", "444491", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-444545">
<div class="comment-container" id="li-comment-444545">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/436ef9f6bb037ae00614e4965d45983a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/436ef9f6bb037ae00614e4965d45983a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Rishav</span>
<span class="date">July 27, 2018 at 8:45 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-444545" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>Firstly I would like to thank you for sharing your knowledge and helping everyone. I am new to this field now. Could you please explain, why are removing all single letter words?</p>
<p>Yes, removing words having numbers and removing punctuation does make sense. Even removing single letter word also makes sense, but by removing “a”, wont it affect formation of new sentences?</p>
<div class="reply">
<a aria-label="Reply to Rishav" class="comment-reply-link" href="#comment-444545" onclick='return addComment.moveForm( "comment-444545", "444545", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-444593">
<div class="comment-container" id="li-comment-444593">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">July 28, 2018 at 6:34 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-444593" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>It does, but it makes the problem simpler to model with little effect on meaning.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-444593" onclick='return addComment.moveForm( "comment-444593", "444593", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-445053">
<div class="comment-container" id="li-comment-445053">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/d9ccdaeab22c2462cefa987cd1034eeb?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d9ccdaeab22c2462cefa987cd1034eeb?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Gaurav Anand</span>
<span class="date">August 2, 2018 at 3:21 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-445053" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hello Jason</p>
<p>I am facing the following error while training the model with progressive loading.<br/>
Could you please help to fix this?</p>
<p>ImportError                               Traceback (most recent call last)<br/>
~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\site-packages\tensorflow\python\pywrap_tensorflow_internal.py in swig_import_helper()<br/>
     13         try:<br/>
—&gt; 14             return importlib.import_module(mname)<br/>
     15         except ImportError:</p>
<p>~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\importlib\__init__.py in import_module(name, package)<br/>
    125             level += 1<br/>
–&gt; 126     return _bootstrap._gcd_import(name[level:], package, level)<br/>
    127 </p>
<p>~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\importlib\_bootstrap.py in _gcd_import(name, package, level)</p>
<p>~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\importlib\_bootstrap.py in _find_and_load(name, import_)</p>
<p>~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\importlib\_bootstrap.py in _find_and_load_unlocked(name, import_)</p>
<p>~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\importlib\_bootstrap.py in _load_unlocked(spec)</p>
<p>~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\importlib\_bootstrap.py in module_from_spec(spec)</p>
<p>~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\importlib\_bootstrap_external.py in create_module(self, spec)</p>
<p>~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\importlib\_bootstrap.py in _call_with_frames_removed(f, *args, **kwds)</p>
<p>ImportError: DLL load failed: The specified module could not be found.</p>
<p>During handling of the above exception, another exception occurred:</p>
<p>ModuleNotFoundError                       Traceback (most recent call last)<br/>
~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\site-packages\tensorflow\python\pywrap_tensorflow.py in ()<br/>
     57<br/>
—&gt; 58   from tensorflow.python.pywrap_tensorflow_internal import *<br/>
     59   from tensorflow.python.pywrap_tensorflow_internal import __version__</p>
<p>~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\site-packages\tensorflow\python\pywrap_tensorflow_internal.py in ()<br/>
     16             return importlib.import_module(‘_pywrap_tensorflow_internal’)<br/>
—&gt; 17     _pywrap_tensorflow_internal = swig_import_helper()<br/>
     18     del swig_import_helper</p>
<p>~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\site-packages\tensorflow\python\pywrap_tensorflow_internal.py in swig_import_helper()<br/>
     15         except ImportError:<br/>
—&gt; 16             return importlib.import_module(‘_pywrap_tensorflow_internal’)<br/>
     17     _pywrap_tensorflow_internal = swig_import_helper()</p>
<p>~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\importlib\__init__.py in import_module(name, package)<br/>
    125             level += 1<br/>
–&gt; 126     return _bootstrap._gcd_import(name[level:], package, level)<br/>
    127 </p>
<p>ModuleNotFoundError: No module named ‘_pywrap_tensorflow_internal’</p>
<p>During handling of the above exception, another exception occurred:</p>
<p>ImportError                               Traceback (most recent call last)<br/>
 in ()<br/>
      1 from numpy import array<br/>
      2 from pickle import load<br/>
—-&gt; 3 from keras.preprocessing.text import Tokenizer<br/>
      4 from keras.preprocessing.sequence import pad_sequences<br/>
      5 from keras.utils import to_categorical</p>
<p>~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\site-packages\keras\__init__.py in ()<br/>
      1 from __future__ import absolute_import<br/>
      2<br/>
—-&gt; 3 from . import utils<br/>
      4 from . import activations<br/>
      5 from . import applications</p>
<p>~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\site-packages\keras\utils\__init__.py in ()<br/>
      4 from . import data_utils<br/>
      5 from . import io_utils<br/>
—-&gt; 6 from . import conv_utils<br/>
      7<br/>
      8 # Globally-importable utils.</p>
<p>~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\site-packages\keras\utils\conv_utils.py in ()<br/>
      7 from six.moves import range<br/>
      8 import numpy as np<br/>
—-&gt; 9 from .. import backend as K<br/>
     10<br/>
     11 </p>
<p>~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\site-packages\keras\backend\__init__.py in ()<br/>
     85 elif _BACKEND == ‘tensorflow’:<br/>
     86     sys.stderr.write(‘Using TensorFlow backend.\n’)<br/>
—&gt; 87     from .tensorflow_backend import *<br/>
     88 else:<br/>
     89     # Try and load external backend.</p>
<p>~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\site-packages\keras\backend\tensorflow_backend.py in ()<br/>
      4<br/>
      5 import tensorflow as tf<br/>
—-&gt; 6 from tensorflow.python.framework import ops as tf_ops<br/>
      7 from tensorflow.python.training import moving_averages<br/>
      8 from tensorflow.python.ops import tensor_array_ops</p>
<p>~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\site-packages\tensorflow\python\__init__.py in ()<br/>
     47 import numpy as np<br/>
     48<br/>
—&gt; 49 from tensorflow.python import pywrap_tensorflow<br/>
     50<br/>
     51 # Protocol buffers</p>
<p>~\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\site-packages\tensorflow\python\pywrap_tensorflow.py in ()<br/>
     72 for some common reasons and solutions.  Include the entire stack trace<br/>
     73 above this error message when asking for help.””” % traceback.format_exc()<br/>
—&gt; 74   raise ImportError(msg)<br/>
     75<br/>
     76 # pylint: enable=wildcard-import,g-import-not-at-top,unused-import,line-too-long</p>
<p>ImportError: Traceback (most recent call last):<br/>
  File “C:\Users\gaurav.anand\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\site-packages\tensorflow\python\pywrap_tensorflow_internal.py”, line 14, in swig_import_helper<br/>
    return importlib.import_module(mname)<br/>
  File “C:\Users\gaurav.anand\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\importlib\__init__.py”, line 126, in import_module<br/>
    return _bootstrap._gcd_import(name[level:], package, level)<br/>
  File “”, line 994, in _gcd_import<br/>
  File “”, line 971, in _find_and_load<br/>
  File “”, line 955, in _find_and_load_unlocked<br/>
  File “”, line 658, in _load_unlocked<br/>
  File “”, line 571, in module_from_spec<br/>
  File “”, line 922, in create_module<br/>
  File “”, line 219, in _call_with_frames_removed<br/>
ImportError: DLL load failed: The specified module could not be found.</p>
<p>During handling of the above exception, another exception occurred:</p>
<p>Traceback (most recent call last):<br/>
  File “C:\Users\gaurav.anand\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\site-packages\tensorflow\python\pywrap_tensorflow.py”, line 58, in<br/>
    from tensorflow.python.pywrap_tensorflow_internal import *<br/>
  File “C:\Users\gaurav.anand\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\site-packages\tensorflow\python\pywrap_tensorflow_internal.py”, line 17, in<br/>
    _pywrap_tensorflow_internal = swig_import_helper()<br/>
  File “C:\Users\gaurav.anand\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\site-packages\tensorflow\python\pywrap_tensorflow_internal.py”, line 16, in swig_import_helper<br/>
    return importlib.import_module(‘_pywrap_tensorflow_internal’)<br/>
  File “C:\Users\gaurav.anand\AppData\Local\Continuum\anaconda3\envs\tensorflow\lib\importlib\__init__.py”, line 126, in import_module<br/>
    return _bootstrap._gcd_import(name[level:], package, level)<br/>
ModuleNotFoundError: No module named ‘_pywrap_tensorflow_internal’</p>
<p>Failed to load the native TensorFlow runtime.</p>
<p>See <a href="https://www.tensorflow.org/install/install_sources#common_installation_problems" rel="nofollow">https://www.tensorflow.org/install/install_sources#common_installation_problems</a></p>
<p>for some common reasons and solutions.  Include the entire stack trace<br/>
above this error message when asking for help.</p>
<div class="reply">
<a aria-label="Reply to Gaurav Anand" class="comment-reply-link" href="#comment-445053" onclick='return addComment.moveForm( "comment-445053", "445053", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-445102">
<div class="comment-container" id="li-comment-445102">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">August 3, 2018 at 5:58 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-445102" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Sorry to hear that.</p>
<p>Perhaps post your error to stackoverflow?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-445102" onclick='return addComment.moveForm( "comment-445102", "445102", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment odd alt depth-2" id="comment-445135">
<div class="comment-container" id="li-comment-445135">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">August 3, 2018 at 1:41 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-445135" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>downgrade your tensorflow to version 1.5, i hope it will work for you.</p>
<div class="reply">
<a aria-label="Reply to abbas" class="comment-reply-link" href="#comment-445135" onclick='return addComment.moveForm( "comment-445135", "445135", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-445144">
<div class="comment-container" id="li-comment-445144">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/d9ccdaeab22c2462cefa987cd1034eeb?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d9ccdaeab22c2462cefa987cd1034eeb?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Gaurav Anand</span>
<span class="date">August 3, 2018 at 3:19 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-445144" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Yes, it has now worked somehow after creating new environment with latest tensorflow version. However, it is giving me another possibly known error. Please have a look once.</p>
<p>Model:<br/>
__________________________________________________________________________________________________<br/>
Layer (type)                    Output Shape         Param #     Connected to<br/>
==================================================================================================<br/>
input_4 (InputLayer)            (None, 30)           0<br/>
__________________________________________________________________________________________________<br/>
input_3 (InputLayer)            (None, 7, 7, 512)    0<br/>
__________________________________________________________________________________________________<br/>
embedding_2 (Embedding)         (None, 30, 256)      987392      input_4[0][0]<br/>
__________________________________________________________________________________________________<br/>
dropout_3 (Dropout)             (None, 7, 7, 512)    0           input_3[0][0]<br/>
__________________________________________________________________________________________________<br/>
dropout_4 (Dropout)             (None, 30, 256)      0           embedding_2[0][0]<br/>
__________________________________________________________________________________________________<br/>
dense_4 (Dense)                 (None, 7, 7, 256)    131328      dropout_3[0][0]<br/>
__________________________________________________________________________________________________<br/>
lstm_2 (LSTM)                   (None, 256)          525312      dropout_4[0][0]<br/>
__________________________________________________________________________________________________<br/>
add_2 (Add)                     (None, 7, 7, 256)    0           dense_4[0][0]<br/>
                                                                 lstm_2[0][0]<br/>
__________________________________________________________________________________________________<br/>
dense_5 (Dense)                 (None, 7, 7, 256)    65792       add_2[0][0]<br/>
__________________________________________________________________________________________________<br/>
dense_6 (Dense)                 (None, 7, 7, 3857)   991249      dense_5[0][0]<br/>
==================================================================================================</p>
<p>—————————————————————————<br/>
ValueError                                Traceback (most recent call last)<br/>
 in ()<br/>
    178         generator = data_generator(train_descriptions, train_features, tokenizer, max_length)<br/>
    179         # fit for one epoch<br/>
–&gt; 180         model.fit_generator(generator, epochs=1, steps_per_epoch=steps, verbose=1)<br/>
    181         # save model<br/>
    182         model.save(‘model_’ + str(i) + ‘.h5’)</p>
<p>c:\users\gaurav.anand\appdata\local\continuum\anaconda3\envs\tensorflow1.7\lib\site-packages\keras\legacy\interfaces.py in wrapper(*args, **kwargs)<br/>
     89                 warnings.warn(‘Update your <code>' + object_name +<br/>
     90                               '</code> call to the Keras 2 API: ‘ + signature, stacklevel=2)<br/>
—&gt; 91             return func(*args, **kwargs)<br/>
     92         wrapper._original_function = func<br/>
     93         return wrapper</p>
<p>c:\users\gaurav.anand\appdata\local\continuum\anaconda3\envs\tensorflow1.7\lib\site-packages\keras\engine\training.py in fit_generator(self, generator, steps_per_epoch, epochs, verbose, callbacks, validation_data, validation_steps, class_weight, max_queue_size, workers, use_multiprocessing, shuffle, initial_epoch)<br/>
   1413             use_multiprocessing=use_multiprocessing,<br/>
   1414             shuffle=shuffle,<br/>
-&gt; 1415             initial_epoch=initial_epoch)<br/>
   1416<br/>
   1417     @interfaces.legacy_generator_methods_support</p>
<p>c:\users\gaurav.anand\appdata\local\continuum\anaconda3\envs\tensorflow1.7\lib\site-packages\keras\engine\training_generator.py in fit_generator(model, generator, steps_per_epoch, epochs, verbose, callbacks, validation_data, validation_steps, class_weight, max_queue_size, workers, use_multiprocessing, shuffle, initial_epoch)<br/>
    211                 outs = model.train_on_batch(x, y,<br/>
    212                                             sample_weight=sample_weight,<br/>
–&gt; 213                                             class_weight=class_weight)<br/>
    214<br/>
    215                 outs = to_list(outs)</p>
<p>c:\users\gaurav.anand\appdata\local\continuum\anaconda3\envs\tensorflow1.7\lib\site-packages\keras\engine\training.py in train_on_batch(self, x, y, sample_weight, class_weight)<br/>
   1207             x, y,<br/>
   1208             sample_weight=sample_weight,<br/>
-&gt; 1209             class_weight=class_weight)<br/>
   1210         if self._uses_dynamic_learning_phase():<br/>
   1211             ins = x + y + sample_weights + [1.]</p>
<p>c:\users\gaurav.anand\appdata\local\continuum\anaconda3\envs\tensorflow1.7\lib\site-packages\keras\engine\training.py in _standardize_user_data(self, x, y, sample_weight, class_weight, check_array_lengths, batch_size)<br/>
    785                 feed_output_shapes,<br/>
    786                 check_batch_axis=False,  # Don’t enforce the batch size.<br/>
–&gt; 787                 exception_prefix=’target’)<br/>
    788<br/>
    789             # Generate sample-wise weight values given the <code>sample_weight</code> and</p>
<p>c:\users\gaurav.anand\appdata\local\continuum\anaconda3\envs\tensorflow1.7\lib\site-packages\keras\engine\training_utils.py in standardize_input_data(data, names, shapes, check_batch_axis, exception_prefix)<br/>
    125                         ‘: expected ‘ + names[i] + ‘ to have ‘ +<br/>
    126                         str(len(shape)) + ‘ dimensions, but got array ‘<br/>
–&gt; 127                         ‘with shape ‘ + str(data_shape))<br/>
    128                 if not check_batch_axis:<br/>
    129                     data_shape = data_shape[1:]</p>
<p>ValueError: Error when checking target: expected dense_6 to have 4 dimensions, but got array with shape (11, 1, 3857)</p>
<p>I have made an only change in line 114:<br/>
inputs1 = Input(shape=(4096,))  &gt;&gt; inputs1 = Input(shape=(7, 7, 512,))<br/>
Because, it was earlier giving error for Data structure mismatch for inputs1 but now it is giving same error in 3rd dense layer.</p>
<p>As I read other comments, it is a common issue.<br/>
Could you please share your opinion how to get rid of this ?</p>
<p>Any external guide to data structure mismatch would be much appreciated.</p>
<div class="reply">
<a aria-label="Reply to Gaurav Anand" class="comment-reply-link" href="#comment-445144" onclick='return addComment.moveForm( "comment-445144", "445144", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-445189">
<div class="comment-container" id="li-comment-445189">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">August 4, 2018 at 5:58 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-445189" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I have some suggestions here:<br/>
<a href="https://machinelearningmastery.com/faq/single-faq/why-does-the-code-in-the-tutorial-not-work-for-me" rel="nofollow">https://machinelearningmastery.com/faq/single-faq/why-does-the-code-in-the-tutorial-not-work-for-me</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-445189" onclick='return addComment.moveForm( "comment-445189", "445189", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-5" id="comment-445375">
<div class="comment-container" id="li-comment-445375">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/d9ccdaeab22c2462cefa987cd1034eeb?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d9ccdaeab22c2462cefa987cd1034eeb?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Gaurav Anand</span>
<span class="date">August 6, 2018 at 6:45 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-445375" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks for FAQ page.</p>
<p>I guess the problem is that I am defining model’s inputs1 with shape<br/>
inputs1 = Input(shape=(4096,))<br/>
but data_generator() method is generating in_img of shape (11,7,7,512).<br/>
Probably there is a need to change format of features.pkl file’s data.</p>
<p>Is it right to move in this direction?</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-445159">
<div class="comment-container" id="li-comment-445159">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/0cdd504b36e0066895bea6f0b679a696?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/0cdd504b36e0066895bea6f0b679a696?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Moha</span>
<span class="date">August 3, 2018 at 7:51 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-445159" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Some image captioning libraries (such as Im2txt) are able to provide a confidence score for their generated captions. This helps us when we have a caption that is wrong, so that we can at least tell whether or not by the confidence if the model was ‘unsure’ about the text it generated. How would we go about adding something like that to this?</p>
<div class="reply">
<a aria-label="Reply to Moha" class="comment-reply-link" href="#comment-445159" onclick='return addComment.moveForm( "comment-445159", "445159", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-445196">
<div class="comment-container" id="li-comment-445196">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">August 4, 2018 at 6:03 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-445196" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Good question. Perhaps contact the developers and ask their approach?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-445196" onclick='return addComment.moveForm( "comment-445196", "445196", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-445160">
<div class="comment-container" id="li-comment-445160">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/0cdd504b36e0066895bea6f0b679a696?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/0cdd504b36e0066895bea6f0b679a696?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Moha</span>
<span class="date">August 3, 2018 at 7:53 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-445160" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I have got to say. This is the best image captioning tutorial I have found online. Thank you for helping me understand it better.</p>
<div class="reply">
<a aria-label="Reply to Moha" class="comment-reply-link" href="#comment-445160" onclick='return addComment.moveForm( "comment-445160", "445160", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-445197">
<div class="comment-container" id="li-comment-445197">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">August 4, 2018 at 6:03 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-445197" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks, I’m glad it helped.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-445197" onclick='return addComment.moveForm( "comment-445197", "445197", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-446013">
<div class="comment-container" id="li-comment-446013">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/0cdd504b36e0066895bea6f0b679a696?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/0cdd504b36e0066895bea6f0b679a696?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Mmed</span>
<span class="date">August 14, 2018 at 1:13 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-446013" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Would it make sense to monitor the accuracy and validation accuracy for image captioning? </p>
<p>That is what I added to model.compile:</p>
<p>    model.compile(loss=’categorical_crossentropy’, optimizer=’adam’, metrics=[‘accuracy’]) </p>
<p>That gave for the first epoch an accuracy of 0.9463.<br/>
And a validation accuracy of 0.9903.</p>
<p>Doesn’t that seem too high though for the 1st epoch?</p>
<div class="reply">
<a aria-label="Reply to Mmed" class="comment-reply-link" href="#comment-446013" onclick='return addComment.moveForm( "comment-446013", "446013", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-446046">
<div class="comment-container" id="li-comment-446046">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">August 14, 2018 at 6:22 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-446046" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>No accuracy does not tell us much about the performance of the model. We must use a score like BLEU.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-446046" onclick='return addComment.moveForm( "comment-446046", "446046", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-446109">
<div class="comment-container" id="li-comment-446109">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/0cdd504b36e0066895bea6f0b679a696?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/0cdd504b36e0066895bea6f0b679a696?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Mmed</span>
<span class="date">August 15, 2018 at 1:16 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-446109" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thank you for your response, Dr. Bronwlee. Okay, but does ‘accuracy’ mean anything? I mean Keras is doing some calculations to get these numbers, right? Even if it does not help us to learn about the model’s performance, does the accuracy metric represent anything?</p>
<div class="reply">
<a aria-label="Reply to Mmed" class="comment-reply-link" href="#comment-446109" onclick='return addComment.moveForm( "comment-446109", "446109", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-4" id="comment-446138">
<div class="comment-container" id="li-comment-446138">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">August 15, 2018 at 6:06 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-446138" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>No. You can monitor loss though.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-446138" onclick='return addComment.moveForm( "comment-446138", "446138", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-446437">
<div class="comment-container" id="li-comment-446437">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/15995b25c23dd28762c43c946d3d3f21?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/15995b25c23dd28762c43c946d3d3f21?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="https://sites.google.com/view/proflaskari/home" rel="external nofollow">Naveen Kumar</a></span>
<span class="date">August 19, 2018 at 3:24 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-446437" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I am Unable to make Progressive Loading, After first epoch I am getting error like</p>
<p>5995/6000 [============================&gt;.] – ETA: 2s – loss: 4.6600<br/>
5996/6000 [============================&gt;.] – ETA: 2s – loss: 4.6597<br/>
5997/6000 [============================&gt;.] – ETA: 1s – loss: 4.6597<br/>
5998/6000 [============================&gt;.] – ETA: 1s – loss: 4.6595<br/>
5999/6000 [============================&gt;.] – ETA: 0s – loss: 4.6595<br/>
6000/6000 [==============================] – 3329s 555ms/step – loss: 4.6598</p>
<p>Process finished with exit code -1073741819 (0xC0000005)</p>
<div class="reply">
<a aria-label="Reply to Naveen Kumar" class="comment-reply-link" href="#comment-446437" onclick='return addComment.moveForm( "comment-446437", "446437", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-2" id="comment-446438">
<div class="comment-container" id="li-comment-446438">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/15995b25c23dd28762c43c946d3d3f21?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/15995b25c23dd28762c43c946d3d3f21?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="https://sites.google.com/view/proflaskari/home" rel="external nofollow">Naveen Kumar</a></span>
<span class="date">August 19, 2018 at 3:25 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-446438" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I am running on Lenovo Laptop with 16 GB RAM., Intel i5, Pychram IDE</p>
<div class="reply">
<a aria-label="Reply to Naveen Kumar" class="comment-reply-link" href="#comment-446438" onclick='return addComment.moveForm( "comment-446438", "446438", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-3" id="comment-446463">
<div class="comment-container" id="li-comment-446463">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">August 19, 2018 at 6:30 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-446463" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>First, confirm your environment is up to date:<br/>
<a href="https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/" rel="nofollow">https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/</a></p>
<p>Then, I have some suggestions here:<br/>
<a href="https://machinelearningmastery.com/faq/single-faq/why-does-the-code-in-the-tutorial-not-work-for-me" rel="nofollow">https://machinelearningmastery.com/faq/single-faq/why-does-the-code-in-the-tutorial-not-work-for-me</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-446463" onclick='return addComment.moveForm( "comment-446463", "446463", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-4" id="comment-446473">
<div class="comment-container" id="li-comment-446473">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/15995b25c23dd28762c43c946d3d3f21?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/15995b25c23dd28762c43c946d3d3f21?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="https://sites.google.com/view/proflaskari/home" rel="external nofollow">Naveen Kumar</a></span>
<span class="date">August 19, 2018 at 1:37 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-446473" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>C:\Users\navee\Anaconda3\python.exe “D:/Image Caption/versions.py”<br/>
Using TensorFlow backend.<br/>
Anaconda Version3.6.6 |Anaconda 4.3.1 (64-bit)| (default, Jun 28 2018, 11:27:44) [MSC v.1900 64 bit (AMD64)]<br/>
Keras Version2.1.5<br/>
Tensorflow Version1.9.0<br/>
Matplotlib Version2.2.2<br/>
Numpy Version1.15.0</p>
<p>Process finished with exit code 0</p>
<div class="reply">
<a aria-label="Reply to Naveen Kumar" class="comment-reply-link" href="#comment-446473" onclick='return addComment.moveForm( "comment-446473", "446473", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-446503">
<div class="comment-container" id="li-comment-446503">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">August 20, 2018 at 6:32 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-446503" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Well done!</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-446525">
<div class="comment-container" id="li-comment-446525">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/23eb1e18b23953db5114e577a3cbe098?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/23eb1e18b23953db5114e577a3cbe098?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Emil Lundh</span>
<span class="date">August 20, 2018 at 5:28 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-446525" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>5,5 million parameters… and 8000 examples? Clearly, the old rule doesn’t apply that the training data should be at least as many as the # parameters. Is there a way to think about this? Clearly, I shouldn’t use my intuition from a linear system of equations?</p>
<div class="reply">
<a aria-label="Reply to Emil Lundh" class="comment-reply-link" href="#comment-446525" onclick='return addComment.moveForm( "comment-446525", "446525", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-446576">
<div class="comment-container" id="li-comment-446576">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">August 21, 2018 at 6:12 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-446576" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Yes, the old ways of thinking do not apply.</p>
<p>I have not seen a good conceptual model for thinking about highly over-specified models.</p>
<p>Nevertheless, they are skillful and do generalize.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-446576" onclick='return addComment.moveForm( "comment-446576", "446576", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-446809">
<div class="comment-container" id="li-comment-446809">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/12ed3149b74a47f721a8a42d130b88d2?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/12ed3149b74a47f721a8a42d130b88d2?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Md. Zakir Hossain</span>
<span class="date">August 23, 2018 at 11:08 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-446809" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>Many thanks for your kind help. When we use model.fit for training, we are using training data as well as validation data. But When we use mode.fit_generator (Progressive Loading), in that case why we are not using validation data?</p>
<div class="reply">
<a aria-label="Reply to Md. Zakir Hossain" class="comment-reply-link" href="#comment-446809" onclick='return addComment.moveForm( "comment-446809", "446809", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-446832">
<div class="comment-container" id="li-comment-446832">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">August 24, 2018 at 6:08 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-446832" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I added that progressive loading much later, as a simpler version for those that were having trouble. You can update it to use validation data if you wish.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-446832" onclick='return addComment.moveForm( "comment-446832", "446832", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-447133">
<div class="comment-container" id="li-comment-447133">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/392c40198aa516fc51cb94b8a0f3e9ad?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/392c40198aa516fc51cb94b8a0f3e9ad?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">nehna</span>
<span class="date">August 28, 2018 at 7:13 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-447133" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>hi Jason</p>
<p>Due to internet connectivity, my download when i run feature_extraction.py code.</p>
<p>later i tried to run the code again and it is not downloading and not showing error also.<br/>
without  features.pkl file i cant proceed furthur.<br/>
is there any other way to make it download</p>
<div class="reply">
<a aria-label="Reply to nehna" class="comment-reply-link" href="#comment-447133" onclick='return addComment.moveForm( "comment-447133", "447133", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-447178">
<div class="comment-container" id="li-comment-447178">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">August 29, 2018 at 8:08 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-447178" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>No, sorry. You require the dataset to work through the example.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-447178" onclick='return addComment.moveForm( "comment-447178", "447178", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-447487">
<div class="comment-container" id="li-comment-447487">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/392c40198aa516fc51cb94b8a0f3e9ad?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/392c40198aa516fc51cb94b8a0f3e9ad?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">nehna</span>
<span class="date">September 1, 2018 at 12:52 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-447487" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>thank you jason </p>
<p>i got the dataset </p>
<p>but due to memory error , i am doing with progressive loading </p>
<p>I am getting value error </p>
<p>valueError: Error when checking input : expected input_1 to have 4 dimensions but got array with shape (28,4096)</p>
<p>thank you Jason in advance</p>
<div class="reply">
<a aria-label="Reply to nehna" class="comment-reply-link" href="#comment-447487" onclick='return addComment.moveForm( "comment-447487", "447487", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-447535">
<div class="comment-container" id="li-comment-447535">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">September 2, 2018 at 5:27 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-447535" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps ensure that you have copied the data exactly and that your libraries are up to date?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-447535" onclick='return addComment.moveForm( "comment-447535", "447535", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-448159">
<div class="comment-container" id="li-comment-448159">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/5e550bec93953c2ad182f48bb3ed762b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/5e550bec93953c2ad182f48bb3ed762b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Michael</span>
<span class="date">September 8, 2018 at 4:23 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-448159" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,<br/>
thank you for this super tutorial. </p>
<p>But I have a question :):</p>
<p>My generated caption is for the sample picture: </p>
<p>“startseq dog is running through the snow endseq” </p>
<p>and not </p>
<p>“startseq dog is running across the beach endseq”</p>
<p>My BLUE Score is also lower as in your tutorial.</p>
<p>BLEU-1: 0.553073<br/>
BLEU-2: 0.293371<br/>
BLEU-3: 0.200420<br/>
BLEU-4: 0.090321</p>
<p>Do have any idea why, or better how can I improve my result?</p>
<p>TIA<br/>
Michael</p>
<div class="reply">
<a aria-label="Reply to Michael" class="comment-reply-link" href="#comment-448159" onclick='return addComment.moveForm( "comment-448159", "448159", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-448180">
<div class="comment-container" id="li-comment-448180">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">September 8, 2018 at 6:16 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-448180" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps try fitting the model again?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-448180" onclick='return addComment.moveForm( "comment-448180", "448180", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-448332">
<div class="comment-container" id="li-comment-448332">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/edd49cca6c28c223c19391203730f9bb?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/edd49cca6c28c223c19391203730f9bb?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">kalverk</span>
<span class="date">September 10, 2018 at 11:10 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-448332" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi!</p>
<p>Is the feature order directly tied to the caption? How much does the model rely on input’s order?</p>
<p>Imagine if the extracted features of an image are [‘dog’, ‘water’, ‘blue’, ‘sand’] and the caption is “dog at the beach”, now this is correct and expected caption.</p>
<p>Now the same image, but the features are [‘sand’, ‘water’, ‘dog’, ‘blue’], how different might the new caption be?</p>
<p>Can we achieve the same caption with differently ordered features vector?</p>
<div class="reply">
<a aria-label="Reply to kalverk" class="comment-reply-link" href="#comment-448332" onclick='return addComment.moveForm( "comment-448332", "448332", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-448360">
<div class="comment-container" id="li-comment-448360">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">September 11, 2018 at 6:30 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-448360" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Yes, the order of the generated words is important for the design of this specific model.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-448360" onclick='return addComment.moveForm( "comment-448360", "448360", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-448581">
<div class="comment-container" id="li-comment-448581">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/732ea93e283493dd20b004780fa4ee8d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/732ea93e283493dd20b004780fa4ee8d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Jeff</span>
<span class="date">September 12, 2018 at 6:15 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-448581" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Jason – given the model architecture, if I use my own data, with only 1 caption per image, would it impact the quality of the outcome?</p>
<div class="reply">
<a aria-label="Reply to Jeff" class="comment-reply-link" href="#comment-448581" onclick='return addComment.moveForm( "comment-448581", "448581", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-448594">
<div class="comment-container" id="li-comment-448594">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">September 12, 2018 at 8:16 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-448594" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>It will, perhaps some changes to the model configuration or training will be required. Experiment.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-448594" onclick='return addComment.moveForm( "comment-448594", "448594", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-448909">
<div class="comment-container" id="li-comment-448909">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/392c40198aa516fc51cb94b8a0f3e9ad?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/392c40198aa516fc51cb94b8a0f3e9ad?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">nehna</span>
<span class="date">September 15, 2018 at 12:00 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-448909" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>hiii Jason </p>
<p>your tutorial is super and its working fine </p>
<p>but </p>
<p>i have a doubt !!</p>
<p>in generating new caption , will it  generate captions to only images in Flickr data set or general to normal images (downloaded in google)?</p>
<p>thank you very much Jason</p>
<div class="reply">
<a aria-label="Reply to nehna" class="comment-reply-link" href="#comment-448909" onclick='return addComment.moveForm( "comment-448909", "448909", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-448989">
<div class="comment-container" id="li-comment-448989">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">September 16, 2018 at 5:56 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-448989" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>It will generate captions for any photo you provide.</p>
<p>Remember, it is just an experiment, not an application.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-448989" onclick='return addComment.moveForm( "comment-448989", "448989", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-449683">
<div class="comment-container" id="li-comment-449683">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/392c40198aa516fc51cb94b8a0f3e9ad?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/392c40198aa516fc51cb94b8a0f3e9ad?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">nehna</span>
<span class="date">September 24, 2018 at 3:42 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-449683" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>hii Jason</p>
<p>yeah , just to test how it is generaing captions for images other than present in flickr dataset</p>
<p>but it is giving appropriate captions only for images in dataset . For all the other images , generating some caption which no way related to image</p>
<div class="reply">
<a aria-label="Reply to nehna" class="comment-reply-link" href="#comment-449683" onclick='return addComment.moveForm( "comment-449683", "449683", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-449722">
<div class="comment-container" id="li-comment-449722">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">September 25, 2018 at 6:17 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-449722" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps your model has overfit. You could try adding some regularization.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-449722" onclick='return addComment.moveForm( "comment-449722", "449722", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-5" id="comment-450128">
<div class="comment-container" id="li-comment-450128">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/60e9e3ff3b3625295a9b0bb62e379e05?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/60e9e3ff3b3625295a9b0bb62e379e05?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Priyam</span>
<span class="date">September 29, 2018 at 1:25 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-450128" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>what should i do to add regularization</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-450176">
<div class="comment-container" id="li-comment-450176">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">September 29, 2018 at 6:36 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-450176" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Try Dropout, weight noise, weight regularization, activation regularization, early stopping, etc.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-5" id="comment-450338">
<div class="comment-container" id="li-comment-450338">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/60e9e3ff3b3625295a9b0bb62e379e05?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/60e9e3ff3b3625295a9b0bb62e379e05?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Priyam</span>
<span class="date">October 1, 2018 at 3:56 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-450338" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>On which part of the program should i apply the given techniques.<br/>
And how to apply all of them?</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-450357">
<div class="comment-container" id="li-comment-450357">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 1, 2018 at 6:30 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-450357" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I cannot know, I recommend testing a number of different approaches and discover what works.</p>
<p>If this is a challenge, then I am currently writing a series of tutorials on this exact topic (e.g. how to improve model performance).</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-5" id="comment-450342">
<div class="comment-container" id="li-comment-450342">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/60e9e3ff3b3625295a9b0bb62e379e05?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/60e9e3ff3b3625295a9b0bb62e379e05?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Priyam</span>
<span class="date">October 1, 2018 at 4:09 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-450342" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I am new to deep learning implementation.I dont know where to insert the required techniques inside the code written by you.? Can you suggest a tutorial or some sourse for it</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-449163">
<div class="comment-container" id="li-comment-449163">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/0cdd504b36e0066895bea6f0b679a696?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/0cdd504b36e0066895bea6f0b679a696?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Mmed</span>
<span class="date">September 18, 2018 at 5:31 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-449163" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hello Jason, </p>
<p>Why is there ” + 1 ” every time you find the vocabulary size from the tokenizer?</p>
<div class="reply">
<a aria-label="Reply to Mmed" class="comment-reply-link" href="#comment-449163" onclick='return addComment.moveForm( "comment-449163", "449163", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-449194">
<div class="comment-container" id="li-comment-449194">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">September 18, 2018 at 6:25 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-449194" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>To start numbering of tokenized words at “1” rather than “0”. We need room for the “0” value for “unknown word”.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-449194" onclick='return addComment.moveForm( "comment-449194", "449194", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-449200">
<div class="comment-container" id="li-comment-449200">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/0cdd504b36e0066895bea6f0b679a696?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/0cdd504b36e0066895bea6f0b679a696?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Mmed</span>
<span class="date">September 18, 2018 at 7:16 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-449200" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>When would we encounter an unknown word if the vocabulary consists of all the words in the training data?</p>
<div class="reply">
<a aria-label="Reply to Mmed" class="comment-reply-link" href="#comment-449200" onclick='return addComment.moveForm( "comment-449200", "449200", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-449218">
<div class="comment-container" id="li-comment-449218">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">September 18, 2018 at 2:15 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-449218" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>There may be words in the test set not in the training set.</p>
<p>There may be works in new data not in the training set.</p>
<p>Does that help?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-449218" onclick='return addComment.moveForm( "comment-449218", "449218", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-449348">
<div class="comment-container" id="li-comment-449348">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/0cdd504b36e0066895bea6f0b679a696?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/0cdd504b36e0066895bea6f0b679a696?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Mmed</span>
<span class="date">September 20, 2018 at 4:05 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-449348" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I am still a bit confused to be honest. </p>
<p>1. The training vocab and the testing vocab are different, that I can see. Why would a trained model ever encounter a word only in the test set? Wouldn’t test set captions (and hence the words in the test) only be used when calculating BLEU scores?</p>
<p>2. Could this ‘unknown word’ token  ever be generated by the model?</p>
<p>3. When adding new data with new words to the training data, why would you stick with the older vocabulary and not ‘evaluate’ the newer one?</p>
<div class="reply">
<a aria-label="Reply to Mmed" class="comment-reply-link" href="#comment-449348" onclick='return addComment.moveForm( "comment-449348", "449348", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-4" id="comment-449375">
<div class="comment-container" id="li-comment-449375">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">September 20, 2018 at 8:08 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-449375" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Yes, it is an artefact of evaluating the model.</p>
<p>In the future, you would finalize the model by training it on all available data and use it to generate captions.</p>
<p>The model may still generate unknown word tokens if it gets confused.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-449375" onclick='return addComment.moveForm( "comment-449375", "449375", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-449272">
<div class="comment-container" id="li-comment-449272">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/8cd0b571b772938500094f02d3a7858f?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/8cd0b571b772938500094f02d3a7858f?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">RD</span>
<span class="date">September 19, 2018 at 2:32 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-449272" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Jason,</p>
<p>Thank you for this clear and thorough tutorial.  I have two questions to make sure I understand things correctly:</p>
<p>1. By removing single letters from the descriptions, the generated descriptions will never include/generate descriptions with  ‘a’ or ‘I’.  Is that correct?</p>
<p>2. Because load_clean_descriptions filters by testing/training the tokenizer may be missing words that are in the test set but not the training set.  Is this correct?  And for fitting I understand you want to keep test/training data separate, but for the vocabulary ideally you would include the entire vocabulary from both the test and training set.  Is this correct?  </p>
<p>3. If I understand correctly one could use an even larger vocabulary (would be a bigger model) but in principle there is no reason not to include a larger vocabulary?</p>
<div class="reply">
<a aria-label="Reply to RD" class="comment-reply-link" href="#comment-449272" onclick='return addComment.moveForm( "comment-449272", "449272", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-449298">
<div class="comment-container" id="li-comment-449298">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">September 19, 2018 at 6:26 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-449298" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Yes, you can add them back if you like. It just makes the vocab larger/model slower to train.</p>
<p>Yes, train defines the vocab. Ideally you want your model to have all the words that may be seen.</p>
<p>Yes, there is good reason to use a larger vocab, it will be more expressive, but I was trying to keep the example fast/simple.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-449298" onclick='return addComment.moveForm( "comment-449298", "449298", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-449961">
<div class="comment-container" id="li-comment-449961">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/5953cd3dcb289d2670ae73b241268b9f?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/5953cd3dcb289d2670ae73b241268b9f?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Vikas</span>
<span class="date">September 27, 2018 at 8:54 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-449961" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hello<br/>
I wanted to know what should be the target validation loss.<br/>
Right now, I am getting the best validation loss of 3.86 after 5 epochs.  However, you have a lower validation as well as training loss than mine just after two epochs.<br/>
Is my model trained enough or should I train again?</p>
<div class="reply">
<a aria-label="Reply to Vikas" class="comment-reply-link" href="#comment-449961" onclick='return addComment.moveForm( "comment-449961", "449961", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-449996">
<div class="comment-container" id="li-comment-449996">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">September 28, 2018 at 6:13 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-449996" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Lower is better.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-449996" onclick='return addComment.moveForm( "comment-449996", "449996", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-450125">
<div class="comment-container" id="li-comment-450125">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/60e9e3ff3b3625295a9b0bb62e379e05?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/60e9e3ff3b3625295a9b0bb62e379e05?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Priyam</span>
<span class="date">September 29, 2018 at 1:00 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-450125" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I want to test the model with more images.<br/>
Can you tell me the source from which i can get  images which will run efficiently using the code.Itried some randon images from google but they were unsatisfactory.Also tell me steps to add new image along with model to train it?</p>
<div class="reply">
<a aria-label="Reply to Priyam" class="comment-reply-link" href="#comment-450125" onclick='return addComment.moveForm( "comment-450125", "450125", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-450175">
<div class="comment-container" id="li-comment-450175">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">September 29, 2018 at 6:35 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-450175" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I expect there are other image captioning datasets you can use.</p>
<p>Sorry, I cannot point you to them off the cuff.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-450175" onclick='return addComment.moveForm( "comment-450175", "450175", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-450515">
<div class="comment-container" id="li-comment-450515">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ff04d371d0f0a3ccf39aa95c106b4142?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ff04d371d0f0a3ccf39aa95c106b4142?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Omnia</span>
<span class="date">October 3, 2018 at 3:25 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-450515" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason </p>
<p>I really like this post, it helped a lot </p>
<p>your post is better than my daily DL learning class</p>
<p>I have a question </p>
<p>I ran the code until fitting the model, actually till this line</p>
<p>“Train on 306404 samples, validate on 50903 samples<br/>
Epoch 1/20”</p>
<p>until now it took 20 mins but nothing has appeared </p>
<p>Does it take so much of time to run each epoch?</p>
<p>Or am I doing something wrong?</p>
<p>I really hope this code work properly with me so I can optimize it and see different results </p>
<p>Thanks</p>
<div class="reply">
<a aria-label="Reply to Omnia" class="comment-reply-link" href="#comment-450515" onclick='return addComment.moveForm( "comment-450515", "450515", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-450534">
<div class="comment-container" id="li-comment-450534">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 3, 2018 at 6:22 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-450534" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>It can take a while.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-450534" onclick='return addComment.moveForm( "comment-450534", "450534", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-450527">
<div class="comment-container" id="li-comment-450527">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ff04d371d0f0a3ccf39aa95c106b4142?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ff04d371d0f0a3ccf39aa95c106b4142?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">omnia</span>
<span class="date">October 3, 2018 at 6:17 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-450527" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Another question is that if feature.pkl file has been created the first time I ran the code and I have it in my directory </p>
<p>do I have to run these commands if I ran the code another time </p>
<p> # extract features from all images<br/>
directory = ‘Flicker8k_Dataset’<br/>
features = extract_features(directory)<br/>
print(‘Extracted Features: %d’ % len(features))<br/>
# save to file<br/>
dump(features, open(‘features.pkl’, ‘wb’))</p>
<p>Thanks again</p>
<div class="reply">
<a aria-label="Reply to omnia" class="comment-reply-link" href="#comment-450527" onclick='return addComment.moveForm( "comment-450527", "450527", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-450536">
<div class="comment-container" id="li-comment-450536">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 3, 2018 at 6:23 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-450536" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Once you have created the features, you don’t need to create them again.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-450536" onclick='return addComment.moveForm( "comment-450536", "450536", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-450540">
<div class="comment-container" id="li-comment-450540">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ff04d371d0f0a3ccf39aa95c106b4142?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ff04d371d0f0a3ccf39aa95c106b4142?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Omnia</span>
<span class="date">October 3, 2018 at 7:20 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-450540" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks a lot </p>
<p>now it’s working properly </p>
<p>will let you know what I will get at the end </p>
<p>Thanks again, really appreciate your hard work, so happy that I understand your code very well</p>
<div class="reply">
<a aria-label="Reply to Omnia" class="comment-reply-link" href="#comment-450540" onclick='return addComment.moveForm( "comment-450540", "450540", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-450568">
<div class="comment-container" id="li-comment-450568">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 3, 2018 at 4:13 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-450568" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Well done!</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-450568" onclick='return addComment.moveForm( "comment-450568", "450568", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-450609">
<div class="comment-container" id="li-comment-450609">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/3e8800d14361da74ed4deb1555559064?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3e8800d14361da74ed4deb1555559064?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Xuan</span>
<span class="date">October 3, 2018 at 8:35 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-450609" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hey Jason, thanks for the tutorial. The model trained fine for me but when I tried to generate caption for a single new image I encountered the following error:</p>
<p>ValueError: Error when checking input: expected input_8 to have shape (110,) but got array with shape (34,)</p>
<div class="reply">
<a aria-label="Reply to Xuan" class="comment-reply-link" href="#comment-450609" onclick='return addComment.moveForm( "comment-450609", "450609", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-450640">
<div class="comment-container" id="li-comment-450640">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 4, 2018 at 6:15 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-450640" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Sorry to hear that, I have some suggestions here:<br/>
<a href="https://machinelearningmastery.com/faq/single-faq/why-does-the-code-in-the-tutorial-not-work-for-me" rel="nofollow">https://machinelearningmastery.com/faq/single-faq/why-does-the-code-in-the-tutorial-not-work-for-me</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-450640" onclick='return addComment.moveForm( "comment-450640", "450640", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-450954">
<div class="comment-container" id="li-comment-450954">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/fd977e7ef2d756cbfd98272dcca5d6d4?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/fd977e7ef2d756cbfd98272dcca5d6d4?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Diana</span>
<span class="date">October 8, 2018 at 6:25 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-450954" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason! Thanks a lot for this!  </p>
<p>I tried your model with ResNet50 and got model-ep005-loss3.417-val_loss3.767.h5, so yours works a little bit better even when it comes to BLEU. </p>
<p>I’m gonna try to reduce the vocabulary size and see what happens.</p>
<div class="reply">
<a aria-label="Reply to Diana" class="comment-reply-link" href="#comment-450954" onclick='return addComment.moveForm( "comment-450954", "450954", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-450971">
<div class="comment-container" id="li-comment-450971">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 8, 2018 at 9:29 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-450971" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Nice work!</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-450971" onclick='return addComment.moveForm( "comment-450971", "450971", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-450976">
<div class="comment-container" id="li-comment-450976">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/fd977e7ef2d756cbfd98272dcca5d6d4?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/fd977e7ef2d756cbfd98272dcca5d6d4?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Diana</span>
<span class="date">October 8, 2018 at 11:47 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-450976" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I cannot clearly see how to ‘correct’ misspelling. I have already gone through the vocabulary and there are about 1000 misspelled words. </p>
<p>Any thoughts on how I could go over that?</p>
<div class="reply">
<a aria-label="Reply to Diana" class="comment-reply-link" href="#comment-450976" onclick='return addComment.moveForm( "comment-450976", "450976", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-4" id="comment-451046">
<div class="comment-container" id="li-comment-451046">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 9, 2018 at 8:32 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-451046" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps remove or correct all captions with misspellings?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-451046" onclick='return addComment.moveForm( "comment-451046", "451046", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-451235">
<div class="comment-container" id="li-comment-451235">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/9311294124938c08922d2a9ad7900199?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/9311294124938c08922d2a9ad7900199?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Oliver</span>
<span class="date">October 10, 2018 at 9:30 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-451235" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Getting the following error when calling train_features = load_photo_features(‘features.pkl’, train)</p>
<p>The error occurs when trying to run all_features = load(open(filename, ‘rb’))</p>
<p>UnpicklingError: pickle data was truncated</p>
<p>Has anybody a solution to this?</p>
<div class="reply">
<a aria-label="Reply to Oliver" class="comment-reply-link" href="#comment-451235" onclick='return addComment.moveForm( "comment-451235", "451235", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-451295">
<div class="comment-container" id="li-comment-451295">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 11, 2018 at 7:55 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-451295" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I have some suggestions here:<br/>
<a href="https://machinelearningmastery.com/faq/single-faq/why-does-the-code-in-the-tutorial-not-work-for-me" rel="nofollow">https://machinelearningmastery.com/faq/single-faq/why-does-the-code-in-the-tutorial-not-work-for-me</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-451295" onclick='return addComment.moveForm( "comment-451295", "451295", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-451340">
<div class="comment-container" id="li-comment-451340">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/c135376b695ae35d060f01a1151c43d6?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/c135376b695ae35d060f01a1151c43d6?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="https://iafrance.blogspot.com/" rel="external nofollow">Jerome MASSOT</a></span>
<span class="date">October 11, 2018 at 5:54 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-451340" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,<br/>
I come back tonight with the question regarding the VGG16.layers.pop() method which seems not to work with Keras 2.2.2…<br/>
Before and after pop() and reshaping the model, the light one has exactly the same architecture as the original one…<br/>
Features extracted has dim = 1000 which cause me trouble with my Input = (4096,)…<br/>
If I change the input to (1000,) the performance is low…<br/>
Thanks for the help<br/>
Best regards<br/>
Jerome</p>
<div class="reply">
<a aria-label="Reply to Jerome MASSOT" class="comment-reply-link" href="#comment-451340" onclick='return addComment.moveForm( "comment-451340", "451340", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-451385">
<div class="comment-container" id="li-comment-451385">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 12, 2018 at 6:35 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-451385" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks, I’ll investigate.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-451385" onclick='return addComment.moveForm( "comment-451385", "451385", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-451619">
<div class="comment-container" id="li-comment-451619">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/35ea58bfc20c5d86108ff6b86e32ac65?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/35ea58bfc20c5d86108ff6b86e32ac65?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Prasanna Kumar Behera</span>
<span class="date">October 15, 2018 at 12:35 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-451619" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>My question is, are we retraining all the parameters of the VGG16 models in this example?</p>
<p>If yes, why should we train since we are using already trained model?<br/>
If no, then what part of the above coding is doing since we have not set layer.trainable = False for any layer?<br/>
Please let me when we should train all the layers or when we should not when using a pretrained model like VGG16?</p>
<div class="reply">
<a aria-label="Reply to Prasanna Kumar Behera" class="comment-reply-link" href="#comment-451619" onclick='return addComment.moveForm( "comment-451619", "451619", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-451651">
<div class="comment-container" id="li-comment-451651">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 15, 2018 at 7:28 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-451651" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>No, we are not re-training the vgg, we are using the vgg to output features that are fed into the captioning model.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-451651" onclick='return addComment.moveForm( "comment-451651", "451651", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-451704">
<div class="comment-container" id="li-comment-451704">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/f2f124a96834dd55581683b2dc907947?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/f2f124a96834dd55581683b2dc907947?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Vidyush Bakshi</span>
<span class="date">October 15, 2018 at 11:56 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-451704" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>My BLEU scores with progressive loading<br/>
BLEU-1: 0.547871<br/>
BLEU-2: 0.293608<br/>
BLEU-3: 0.196752<br/>
BLEU-4: 0.086692</p>
<div class="reply">
<a aria-label="Reply to Vidyush Bakshi" class="comment-reply-link" href="#comment-451704" onclick='return addComment.moveForm( "comment-451704", "451704", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-451737">
<div class="comment-container" id="li-comment-451737">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 16, 2018 at 6:37 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-451737" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Nice work.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-451737" onclick='return addComment.moveForm( "comment-451737", "451737", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-452448">
<div class="comment-container" id="li-comment-452448">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1214a388eb8c81ba62f10edf993483b7?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1214a388eb8c81ba62f10edf993483b7?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Hassaan</span>
<span class="date">October 23, 2018 at 5:26 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-452448" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hy Jason. I am new to ML and you are the source which rise my interest in ML. I am following your above tutorial. I am confuse to get some concept, where you are applying tokenization to the text. You mentioned that ” The model will be provided one word and the photo and generate the next word. After that it recursively run to generate new sentence”.I am just confuse here that what are you doing here? What is the purpose of doing that?  Please explain in detail that point or suggest me a source to get help from somewhere else.<br/>
Second question is that when we will done with that, the model will generate captions, which are in the data-set (I mean to say exact some captions will be suggested for new unseen images or it can be new captions based on image )..plz explain it in details..</p>
<div class="reply">
<a aria-label="Reply to Hassaan" class="comment-reply-link" href="#comment-452448" onclick='return addComment.moveForm( "comment-452448", "452448", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-452514">
<div class="comment-container" id="li-comment-452514">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 24, 2018 at 6:26 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-452514" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps it will be helpful to learn more about this type of model:<br/>
<a href="https://machinelearningmastery.com/caption-generation-inject-merge-architectures-encoder-decoder-model/" rel="nofollow">https://machinelearningmastery.com/caption-generation-inject-merge-architectures-encoder-decoder-model/</a></p>
<p>Yes, the model can be used to generate captions for new unseen photos, we do this at the end of the tutorial.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-452514" onclick='return addComment.moveForm( "comment-452514", "452514", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-452612">
<div class="comment-container" id="li-comment-452612">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/55a2e2ba81a7b3c7e196496c889e7b97?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/55a2e2ba81a7b3c7e196496c889e7b97?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Ahmed</span>
<span class="date">October 24, 2018 at 9:20 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-452612" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>valueError: Error when checking input: expected input_2 to have shape (40,) but got array with shape (34,)</p>
<p>I am getting that error, I am unable to figure it out. Can you please help me to get that?</p>
<div class="reply">
<a aria-label="Reply to Ahmed" class="comment-reply-link" href="#comment-452612" onclick='return addComment.moveForm( "comment-452612", "452612", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-452664">
<div class="comment-container" id="li-comment-452664">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 25, 2018 at 7:54 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-452664" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I have some suggestions here:<br/>
<a href="https://machinelearningmastery.com/faq/single-faq/why-does-the-code-in-the-tutorial-not-work-for-me" rel="nofollow">https://machinelearningmastery.com/faq/single-faq/why-does-the-code-in-the-tutorial-not-work-for-me</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-452664" onclick='return addComment.moveForm( "comment-452664", "452664", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-452712">
<div class="comment-container" id="li-comment-452712">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/55a2e2ba81a7b3c7e196496c889e7b97?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/55a2e2ba81a7b3c7e196496c889e7b97?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Ahmed</span>
<span class="date">October 25, 2018 at 8:25 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-452712" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I am just confused about the max_length method. </p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5c0ca373368b4404105137" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
def max_length(descriptions):
    lines = to_lines(descriptions)
    return max(len(d.split()) for d in lines)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c0ca373368b4404105137-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c0ca373368b4404105137-2">2</div><div class="crayon-num" data-line="crayon-5c0ca373368b4404105137-3">3</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c0ca373368b4404105137-1"><span class="crayon-e">def </span><span class="crayon-e">max_length</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c0ca373368b4404105137-2"><span class="crayon-h">    </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5c0ca373368b4404105137-3"><span class="crayon-h">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">max</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0004 seconds] -->
<p></p>
<p>What is the purpose of that method. Why we are trying to find that. Please slightly explain ti</p>
<div class="reply">
<a aria-label="Reply to Ahmed" class="comment-reply-link" href="#comment-452712" onclick='return addComment.moveForm( "comment-452712", "452712", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-452757">
<div class="comment-container" id="li-comment-452757">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 26, 2018 at 5:35 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-452757" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>To find the number of words in the longest description.</p>
<p>We need this so we can pad all other descriptions to that length (in terms of numbers of words).</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-452757" onclick='return addComment.moveForm( "comment-452757", "452757", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-452733">
<div class="comment-container" id="li-comment-452733">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ff04d371d0f0a3ccf39aa95c106b4142?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ff04d371d0f0a3ccf39aa95c106b4142?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Omnia</span>
<span class="date">October 26, 2018 at 1:52 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-452733" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>hi Jason</p>
<p>my BLEU scores are like this </p>
<p>BLEU-1: 0.528302<br/>
BLEU-2: 0.277568<br/>
BLEU-3: 0.227300<br/>
BLEU-4: 0.117189</p>
<p>and here is my validation loss </p>
<p>Train on 306404 samples, validate on 50903 samples<br/>
Epoch 1/20<br/>
306404/306404 [==============================] – 9983s 33ms/step – loss: 4.5003 – val_loss: 4.0387</p>
<p>Epoch 00001: val_loss improved from inf to 4.03874, saving model to model-ep001-loss4.500-val_loss4.039.h5<br/>
Epoch 2/20<br/>
306404/306404 [==============================] – 9512s 31ms/step – loss: 3.8575 – val_loss: 3.8717</p>
<p>Epoch 00002: val_loss improved from 4.03874 to 3.87171, saving model to model-ep002-loss3.857-val_loss3.872.h5<br/>
Epoch 3/20<br/>
306404/306404 [==============================] – 7866s 26ms/step – loss: 3.6712 – val_loss: 3.8360</p>
<p>Epoch 00003: val_loss improved from 3.87171 to 3.83603, saving model to model-ep003-loss3.671-val_loss3.836.h5<br/>
Epoch 4/20<br/>
306404/306404 [==============================] – 10109s 33ms/step – loss: 3.5803 – val_loss: 3.8296</p>
<p>Epoch 00004: val_loss improved from 3.83603 to 3.82960, saving model to model-ep004-loss3.580-val_loss3.830.h5<br/>
Epoch 5/20<br/>
306404/306404 [==============================] – 5384s 18ms/step – loss: 3.5246 – val_loss: 3.8364</p>
<p>Though, when I try to generate a description for a random image from the intern the model seems not working properly</p>
<p>it gives me the same sentence for  different kind of images </p>
<p>any suggestion?</p>
<div class="reply">
<a aria-label="Reply to Omnia" class="comment-reply-link" href="#comment-452733" onclick='return addComment.moveForm( "comment-452733", "452733", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-452761">
<div class="comment-container" id="li-comment-452761">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 26, 2018 at 5:38 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-452761" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>It suggests the model may be overfit, perhaps try re-fitting the model or using a model it over fewer epochs or using some regularization.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-452761" onclick='return addComment.moveForm( "comment-452761", "452761", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-452780">
<div class="comment-container" id="li-comment-452780">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ff04d371d0f0a3ccf39aa95c106b4142?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ff04d371d0f0a3ccf39aa95c106b4142?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Omnia</span>
<span class="date">October 26, 2018 at 10:19 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-452780" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I see </p>
<p>Thanks </p>
<p>I will try and post my experiment</p>
<div class="reply">
<a aria-label="Reply to Omnia" class="comment-reply-link" href="#comment-452780" onclick='return addComment.moveForm( "comment-452780", "452780", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-452984">
<div class="comment-container" id="li-comment-452984">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/9cb2c3643a2daf7724c4c6c739684970?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/9cb2c3643a2daf7724c4c6c739684970?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Saifullah</span>
<span class="date">October 29, 2018 at 3:25 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-452984" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>Thanks for such nice work.<br/>
I want to know how I print actual caption for the test image. If I am using a new image from the test set.</p>
<div class="reply">
<a aria-label="Reply to Saifullah" class="comment-reply-link" href="#comment-452984" onclick='return addComment.moveForm( "comment-452984", "452984", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-453007">
<div class="comment-container" id="li-comment-453007">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 29, 2018 at 6:00 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-453007" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I show how to print a caption for a new image in the tutorial.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-453007" onclick='return addComment.moveForm( "comment-453007", "453007", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-453130">
<div class="comment-container" id="li-comment-453130">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ff04d371d0f0a3ccf39aa95c106b4142?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ff04d371d0f0a3ccf39aa95c106b4142?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Omnia</span>
<span class="date">October 30, 2018 at 2:21 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-453130" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>in fitting the model, I’m not sure if my thought of input and output is correct </p>
<p>here is the command<br/>
model.fit([X1train, X2train], ytrain, epochs=20, verbose=2, validation_data=([X1test, X2test], ytest) </p>
<p>I understand that X1train contains the photo which should be the feature of the photo as integers, correct me if I’m wrong </p>
<p>X2train is sequence text which is the ground truth captions corresponding to the photo </p>
<p>I didn’t understand what is ytrain </p>
<p>would you please explain it briefly </p>
<p>another question is that how does the output penalize if it generates a wrong caption?</p>
<p>Thanks</p>
<div class="reply">
<a aria-label="Reply to Omnia" class="comment-reply-link" href="#comment-453130" onclick='return addComment.moveForm( "comment-453130", "453130", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-453190">
<div class="comment-container" id="li-comment-453190">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 31, 2018 at 6:21 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-453190" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Correct.</p>
<p>ytrain is the next word to be predicted by the model for each sample.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-453190" onclick='return addComment.moveForm( "comment-453190", "453190", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-453315">
<div class="comment-container" id="li-comment-453315">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/0cdd504b36e0066895bea6f0b679a696?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/0cdd504b36e0066895bea6f0b679a696?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Mmed</span>
<span class="date">November 1, 2018 at 8:53 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-453315" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Dear Dr. Brownlee.</p>
<p>The create_sequences() function that returns for us input-output pairs of training data makes teacher forcing possible in this example, right?</p>
<div class="reply">
<a aria-label="Reply to Mmed" class="comment-reply-link" href="#comment-453315" onclick='return addComment.moveForm( "comment-453315", "453315", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-453330">
<div class="comment-container" id="li-comment-453330">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 1, 2018 at 2:28 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-453330" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I guess so, or more accurately, the way we use the sequences during training.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-453330" onclick='return addComment.moveForm( "comment-453330", "453330", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-453425">
<div class="comment-container" id="li-comment-453425">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ff04d371d0f0a3ccf39aa95c106b4142?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ff04d371d0f0a3ccf39aa95c106b4142?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Omnia</span>
<span class="date">November 2, 2018 at 10:35 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-453425" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason </p>
<p>Thanks a lot for your advice </p>
<p>I’m using Pycharm </p>
<p>I tried different types of regularization until I picked the best one, also different optimizers  </p>
<p>I got pretty good bleu scores and predictions, the model was predicting everything in details for flicker image </p>
<p>and good enough for some images from the internet </p>
<p>Though for images from the internet, the model couldn’t clearly recognize cat from dog face, I’m still working on that </p>
<p>These are my blue score </p>
<p>BLEU-1: 0.601031<br/>
BLEU-2: 0.380297<br/>
BLEU-3: 0.279632<br/>
BLEU-4: 0.151589</p>
<p>Thanks again</p>
<div class="reply">
<a aria-label="Reply to Omnia" class="comment-reply-link" href="#comment-453425" onclick='return addComment.moveForm( "comment-453425", "453425", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-453444">
<div class="comment-container" id="li-comment-453444">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 2, 2018 at 2:49 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-453444" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Well done!</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-453444" onclick='return addComment.moveForm( "comment-453444", "453444", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment even depth-2" id="comment-455199">
<div class="comment-container" id="li-comment-455199">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/264d3607dd0afa0f79b6aec593044f9d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">abbas</span>
<span class="date">November 18, 2018 at 3:51 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-455199" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Omnia! Please can you share the code using inception model?IF yes then let me know..also i would like to check your results</p>
<div class="reply">
<a aria-label="Reply to abbas" class="comment-reply-link" href="#comment-455199" onclick='return addComment.moveForm( "comment-455199", "455199", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-454774">
<div class="comment-container" id="li-comment-454774">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/9887f54b731c3baa7229c573003046f4?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/9887f54b731c3baa7229c573003046f4?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Vishwa Dadhania</span>
<span class="date">November 14, 2018 at 11:02 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-454774" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,<br/>
Thank you for an amazing tutorial. I learnt many things here. esp. progressive loading. So here I have one query as you explain in “progressive loading” section:<br/>
“Finally, we can use the fit_generator() function on the model to train the model with this data generator.</p>
<p>In this simple example we will discard the loading of the development dataset and model checkpointing and simply save the model after each training epoch. You can then go back and load/evaluate each saved model after training to find the one we the lowest loss that you can then use in the next section.”</p>
<p>I have already got all 20 models from 20 epochs by training the “training” dataset. Now how do I check which model is best using the development set?? Because we have not included development set in the fit_generator(). So how to choose the best model from 20 saved models ? Should I apply evaluate() function on development set for each model?? It would be great if you could give me some idea/hint further on this!! Thanks.</p>
<div class="reply">
<a aria-label="Reply to Vishwa Dadhania" class="comment-reply-link" href="#comment-454774" onclick='return addComment.moveForm( "comment-454774", "454774", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-454802">
<div class="comment-container" id="li-comment-454802">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 15, 2018 at 5:31 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-454802" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Good question.</p>
<p>Evaluate each of the saved mode on a validation dataset and use the one with the best performance. Probably around epoch 3-4.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-454802" onclick='return addComment.moveForm( "comment-454802", "454802", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-454915">
<div class="comment-container" id="li-comment-454915">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ff04d371d0f0a3ccf39aa95c106b4142?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ff04d371d0f0a3ccf39aa95c106b4142?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Omnia</span>
<span class="date">November 16, 2018 at 4:31 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-454915" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason </p>
<p>If I want to generate descriptions for the test images, how do I pass the photo features </p>
<p>(which we already have extracted) to the generate_desc model? </p>
<p>As in the following command, we are passing a single extracted feature for a given image </p>
<p>photo = extract_features(cat.jpg)</p>
<p>description = generate_desc(model, tokenizer, photo, max_length)</p>
<p>I want to generate a description for the test image using test features without using the </p>
<p>function extract feature again, could you please suggest any way to do it?</p>
<p>Thanks</p>
<div class="reply">
<a aria-label="Reply to Omnia" class="comment-reply-link" href="#comment-454915" onclick='return addComment.moveForm( "comment-454915", "454915", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-454935">
<div class="comment-container" id="li-comment-454935">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 16, 2018 at 6:18 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-454935" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>The example at the end of the tutorial shows you how to generate a description for one photo.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-454935" onclick='return addComment.moveForm( "comment-454935", "454935", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-454950">
<div class="comment-container" id="li-comment-454950">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ff04d371d0f0a3ccf39aa95c106b4142?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ff04d371d0f0a3ccf39aa95c106b4142?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Omnia</span>
<span class="date">November 16, 2018 at 8:51 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-454950" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Correct </p>
<p>That’s what I meant to say </p>
<p>in the example, it shows how to generate for one photo but with using the extract feature function,  </p>
<p>If we already extracted features for the test images </p>
<p>why do we need to use extract_features again to generate a description </p>
<p>can’t we use our saved features in the test?</p>
<div class="reply">
<a aria-label="Reply to Omnia" class="comment-reply-link" href="#comment-454950" onclick='return addComment.moveForm( "comment-454950", "454950", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-454972">
<div class="comment-container" id="li-comment-454972">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 16, 2018 at 1:57 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-454972" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Yes, if you have already extracted the feature, then you can pass the extracted feature directly to generate_desc().</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-454972" onclick='return addComment.moveForm( "comment-454972", "454972", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-455261">
<div class="comment-container" id="li-comment-455261">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/4bba17ebf06e7bebedc51c44ef38a024?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/4bba17ebf06e7bebedc51c44ef38a024?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Sapar</span>
<span class="date">November 18, 2018 at 10:12 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-455261" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hello,<br/>
This is a very good work.<br/>
What Machine learning techniques do you use in this work?</p>
<p>Thank you.</p>
<div class="reply">
<a aria-label="Reply to Sapar" class="comment-reply-link" href="#comment-455261" onclick='return addComment.moveForm( "comment-455261", "455261", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-455427">
<div class="comment-container" id="li-comment-455427">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 19, 2018 at 6:41 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-455427" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>LSTMs.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-455427" onclick='return addComment.moveForm( "comment-455427", "455427", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-456198">
<div class="comment-container" id="li-comment-456198">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/c6f3dbd55264de418d0d557c04ab171a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/c6f3dbd55264de418d0d557c04ab171a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://no" rel="external nofollow">Chen Mei</a></span>
<span class="date">November 26, 2018 at 3:51 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-456198" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Anyone received this problem during test phase?</p>
<p>OSError: Unable to open file (unable to open file: name = ‘model-ep001-loss3.245-val_loss3.612.h5’, errno = 2, error message = ‘No such file or directory’, flags = 0, o_flags = 0)</p>
<div class="reply">
<a aria-label="Reply to Chen Mei" class="comment-reply-link" href="#comment-456198" onclick='return addComment.moveForm( "comment-456198", "456198", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-456265">
<div class="comment-container" id="li-comment-456265">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 27, 2018 at 6:31 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-456265" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You must change the code to load the file that you saved.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-456265" onclick='return addComment.moveForm( "comment-456265", "456265", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-457797">
<div class="comment-container" id="li-comment-457797">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/4c300a004d3daab71f6e112523544473?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/4c300a004d3daab71f6e112523544473?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Sunny</span>
<span class="date">December 7, 2018 at 5:57 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-457797" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Mr.Jason,</p>
<p>I am a computer science and engineering student. Me and team mates are doing the same project. Reply me,<br/>
1.Can we develop this using MATLab?<br/>
2.Can we use the same code to our project for reference purpose using python?<br/>
3.In how many months we can complete it?<br/>
4.Suggest me what to use either python or matlab?</p>
<div class="reply">
<a aria-label="Reply to Sunny" class="comment-reply-link" href="#comment-457797" onclick='return addComment.moveForm( "comment-457797", "457797", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-457861">
<div class="comment-container" id="li-comment-457861">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 8, 2018 at 7:00 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-457861" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Sorry, I don’t have examples in matlab, I can’t give you good advice.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="#comment-457861" onclick='return addComment.moveForm( "comment-457861", "457861", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ol>
</div> <div class="comment-respond" id="respond">
<h3 class="comment-reply-title" id="reply-title">Leave a Reply <small><a href="/develop-a-deep-learning-caption-generation-model-in-python/#respond" id="cancel-comment-reply-link" rel="nofollow" style="display:none;">Click here to cancel reply.</a></small></h3> <form action="https://machinelearningmastery.com/wp-comments-post.php?wpe-comment-post=mlmastery" class="comment-form" id="commentform" method="post">
<p class="comment-form-comment"><label class="hide" for="comment">Comment</label> <textarea cols="50" id="comment" maxlength="65525" name="comment" required="required" rows="10" tabindex="4"></textarea></p><p class="comment-form-author"><input aria-required="true" class="txt" id="author" name="author" size="30" tabindex="1" type="text" value=""/><label for="author">Name <span class="required">(required)</span></label> </p>
<p class="comment-form-email"><input aria-required="true" class="txt" id="email" name="email" size="30" tabindex="2" type="text" value=""/><label for="email">Email (will not be published) <span class="required">(required)</span></label> </p>
<p class="comment-form-url"><input class="txt" id="url" name="url" size="30" tabindex="3" type="text" value=""/><label for="url">Website</label></p>
<p class="form-submit"><input class="submit" id="submit" name="submit" type="submit" value="Submit Comment"/> <input id="comment_post_ID" name="comment_post_ID" type="hidden" value="4459"/>
<input id="comment_parent" name="comment_parent" type="hidden" value="0"/>
</p><p style="display: none;"><input id="akismet_comment_nonce" name="akismet_comment_nonce" type="hidden" value="3b5751bc9e"/></p><p style="display: none;"><input id="ak_js" name="ak_js" type="hidden" value="138"/></p> </form>
</div><!-- #respond -->
</section><!-- /#main -->
<aside id="sidebar">
<div class="widget widget_woo_blogauthorinfo" id="woo_blogauthorinfo-2"><h3>Welcome to Machine Learning Mastery!</h3><span class="left"><img alt="" class="avatar avatar-100 photo" height="100" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=100&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=200&amp;d=mm&amp;r=g 2x" width="100"/></span>
<p>Hi, I'm Jason Brownlee, PhD
<br/>
I write tutorials to help developers (<i>like you</i>) get results with machine learning.</p>
<p><a href="/about">Read More</a></p>
<div class="fix"></div>
</div><div class="widget widget_text" id="text-43"> <div class="textwidget"><p></p><center><br/>
<strong>Deep Learning for NLP</strong><br/>
Develop deep learning models for text data.
<p><a href="/deep-learning-for-nlp/">Click to Get Started Now!</a><br/>
<a href="/deep-learning-for-nlp/"><img src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/DLFNLP-Cover-220.png"/></a><br/>
</p></center>
</div>
</div>
<div class="widget widget_woo_tabs" id="woo_tabs-2"> <div id="tabs">
<ul class="wooTabs">
<li class="popular"><a href="#tab-pop">Popular</a></li> </ul>
<div class="clear"></div>
<div class="boxes box inside">
<ul class="list" id="tab-pop">
<li>
<a href="https://machinelearningmastery.com/develop-neural-machine-translation-system-keras/" title="How to Develop a Neural Machine Translation System from Scratch"><img alt="How to Develop a Neural Machine Translation System in Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/01/How-to-Develop-a-Neural-Machine-Translation-System-in-Keras-150x150.jpg" title="How to Develop a Neural Machine Translation System from Scratch" width="45"/></a> <a href="https://machinelearningmastery.com/develop-neural-machine-translation-system-keras/" title="How to Develop a Neural Machine Translation System from Scratch">How to Develop a Neural Machine Translation System from Scratch</a>
<span class="meta">January 10, 2018</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/classification-versus-regression-in-machine-learning/" title="Difference Between Classification and Regression in Machine Learning"><img alt="Difference Between Classification and Regression in Machine Learning" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/12/Difference-Between-Classification-and-Regression-in-Machine-Learning-150x150.jpg" title="Difference Between Classification and Regression in Machine Learning" width="45"/></a> <a href="https://machinelearningmastery.com/classification-versus-regression-in-machine-learning/" title="Difference Between Classification and Regression in Machine Learning">Difference Between Classification and Regression in Machine Learning</a>
<span class="meta">December 11, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/working-machine-learning-problem/" title="So, You are Working on a Machine Learning Problem..."><img alt="So, You are Working on a Machine Learning Problem..." class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/04/So-You-are-Working-on-a-Machine-Learning-Problem...-150x150.jpg" title="So, You are Working on a Machine Learning Problem..." width="45"/></a> <a href="https://machinelearningmastery.com/working-machine-learning-problem/" title="So, You are Working on a Machine Learning Problem…">So, You are Working on a Machine Learning Problem…</a>
<span class="meta">April 4, 2018</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/develop-n-gram-multichannel-convolutional-neural-network-sentiment-analysis/" title="How to Develop an N-gram Multichannel Convolutional Neural Network for Sentiment Analysis"><img alt="Plot of the Multichannel Convolutional Neural Network For Text" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/10/Plot-of-the-Multichannel-Convolutional-Neural-Network-For-Text-150x150.png" title="How to Develop an N-gram Multichannel Convolutional Neural Network for Sentiment Analysis" width="45"/></a> <a href="https://machinelearningmastery.com/develop-n-gram-multichannel-convolutional-neural-network-sentiment-analysis/" title="How to Develop an N-gram Multichannel Convolutional Neural Network for Sentiment Analysis">How to Develop an N-gram Multichannel Convolutional Neural Network for Sentiment Analysis</a>
<span class="meta">January 12, 2018</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/how-to-make-classification-and-regression-predictions-for-deep-learning-models-in-keras/" title="How to Make Predictions with Keras"><img alt="How to Make Classification and Regression Predictions for Deep Learning Models in Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/04/How-to-Make-Classification-and-Regression-Predictions-for-Deep-Learning-Models-in-Keras-150x150.jpg" title="How to Make Predictions with Keras" width="45"/></a> <a href="https://machinelearningmastery.com/how-to-make-classification-and-regression-predictions-for-deep-learning-models-in-keras/" title="How to Make Predictions with Keras">How to Make Predictions with Keras</a>
<span class="meta">April 9, 2018</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/time-series-forecasting-methods-in-python-cheat-sheet/" title="11 Classical Time Series Forecasting Methods in Python (Cheat Sheet)"><img alt="11 Classical Time Series Forecasting Methods in Python (Cheat Sheet)" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2018/08/11-Classical-Time-Series-Forecasting-Methods-in-Python-Cheat-Sheet-150x150.jpg" title="11 Classical Time Series Forecasting Methods in Python (Cheat Sheet)" width="45"/></a> <a href="https://machinelearningmastery.com/time-series-forecasting-methods-in-python-cheat-sheet/" title="11 Classical Time Series Forecasting Methods in Python (Cheat Sheet)">11 Classical Time Series Forecasting Methods in Python (Cheat Sheet)</a>
<span class="meta">August 6, 2018</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/visualize-deep-learning-neural-network-model-keras/" title="How to Visualize a Deep Learning Neural Network Model in Keras"><img alt="How to Visualize a Deep Learning Neural Network Model in Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/12/How-to-Visualize-a-Deep-Learning-Neural-Network-Model-in-Keras-150x150.jpg" title="How to Visualize a Deep Learning Neural Network Model in Keras" width="45"/></a> <a href="https://machinelearningmastery.com/visualize-deep-learning-neural-network-model-keras/" title="How to Visualize a Deep Learning Neural Network Model in Keras">How to Visualize a Deep Learning Neural Network Model in Keras</a>
<span class="meta">December 13, 2017</span>
<div class="fix"></div>
</li>
</ul>
</div><!-- /.boxes -->
</div><!-- /wooTabs -->
</div> <div class="widget_text widget widget_custom_html" id="custom_html-2"><h3>You might also like…</h3><div class="textwidget custom-html-widget"><ul>
<li><a href="/setup-python-environment-machine-learning-deep-learning-anaconda/">How to Install Python for Machine Learning</a></li>
<li><a href="/machine-learning-in-python-step-by-step/">Your First Machine Learning Project in Python</a></li>
<li><a href="/tutorial-first-neural-network-python-keras/">Your First Neural Network in Python</a></li>
<li><a href="/how-to-run-your-first-classifier-in-weka/">Your First Classifier in Weka</a></li>
<li><a href="/arima-for-time-series-forecasting-with-python/">Your First Time Series Forecasting Project</a></li>
</ul></div></div></aside><!-- /#sidebar -->
</div><!-- /#main-sidebar-container -->
</div><!-- /#content -->
<footer class="col-full" id="footer">
<div class="col-left" id="copyright">
<p>© 2018 Machine Learning Mastery. All Rights Reserved. </p> </div>
<div class="col-right" id="credit">
<p></p><p>
<a href="/privacy/">Privacy</a> | 
<a href="/disclaimer/">Disclaimer</a> | 
<a href="/terms-of-service/">Terms</a> | 
<a href="/contact/">Contact</a>
</p> </div>
</footer>
</div><!-- /#inner-wrapper -->
</div><!-- /#wrapper -->
<div class="fix"></div><!--/.fix-->
<!-- Drip -->
<script type="text/javascript">
  var _dcq = _dcq || [];
  var _dcs = _dcs || {};
  _dcs.account = '9556588';

  (function() {
    var dc = document.createElement('script');
    dc.type = 'text/javascript'; dc.async = true;
    dc.src = '//tag.getdrip.com/9556588.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(dc, s);
  })();
</script>
<!-- end Drip --><!-- Woo Tabs Widget -->
<script type="text/javascript">
jQuery(document).ready(function(){
	// UL = .wooTabs
	// Tab contents = .inside

	var tag_cloud_class = '#tagcloud';

	//Fix for tag clouds - unexpected height before .hide()
	var tag_cloud_height = jQuery( '#tagcloud').height();

	jQuery( '.inside ul li:last-child').css( 'border-bottom','0px' ); // remove last border-bottom from list in tab content
	jQuery( '.wooTabs').each(function(){
		jQuery(this).children( 'li').children( 'a:first').addClass( 'selected' ); // Add .selected class to first tab on load
	});
	jQuery( '.inside > *').hide();
	jQuery( '.inside > *:first-child').show();

	jQuery( '.wooTabs li a').click(function(evt){ // Init Click funtion on Tabs

		var clicked_tab_ref = jQuery(this).attr( 'href' ); // Strore Href value

		jQuery(this).parent().parent().children( 'li').children( 'a').removeClass( 'selected' ); //Remove selected from all tabs
		jQuery(this).addClass( 'selected' );
		jQuery(this).parent().parent().parent().children( '.inside').children( '*').hide();

		jQuery( '.inside ' + clicked_tab_ref).fadeIn(500);

		 evt.preventDefault();

	})
})
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/comment-reply.min.js?ver=4.9.8" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var wpcf7 = {"apiSettings":{"root":"https:\/\/machinelearningmastery.com\/wp-json\/contact-form-7\/v1","namespace":"contact-form-7\/v1"},"recaptcha":{"messages":{"empty":"Please verify that you are not a robot."}},"cached":"1"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/contact-form-7/includes/js/scripts.js?ver=5.0.5" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/wp-embed.min.js?ver=4.9.8" type="text/javascript"></script>
<script async="async" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/akismet/_inc/form.js?ver=4.1" type="text/javascript"></script>
</body>
</html>